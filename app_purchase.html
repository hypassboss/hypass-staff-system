<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | æ¡è³¼ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background: #e2e8f0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding-bottom: 80px;}
        #app-container { background: #f1f5f9; min-height: 100vh; position: relative; overflow-x: hidden; }
        .view-panel { display: none; animation: fadeIn 0.3s ease; } .view-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: rgba(255, 255, 255, 0.98); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.8); }
        .modal { display: none !important; } .modal.active { display: flex !important; z-index: 200; }
        .select-arrow { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-size: 1.5em 1.5em; background-position: right 0.5rem center; background-repeat: no-repeat; padding-right: 2rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* ğŸš¨ åˆ—å° PDF é»‘ç§‘æŠ€ */
        @media print {
            body * { visibility: hidden; }
            #po-print-zone, #po-print-zone * { visibility: visible; }
            #po-print-zone { display: block !important; position: absolute; left: 0; top: 0; width: 100vw; background: white; z-index: 9999; padding: 20px;}
            #app-container, nav { display: none !important; }
            .print-break { page-break-after: always; }
        }

        /* ğŸš¨ çµ‚æ¥µé˜²ç¦¦è£ç”²ï¼šå°æ®º shared.js ç”¢ç”Ÿçš„èˆŠå°è¦½åˆ— */
        nav { display: none !important; }
        #core-bottom-nav { display: flex !important; }
    </style>
</head>
<body class="text-slate-800 relative">

    <div id="po-print-zone" style="display:none; font-family: 'Microsoft JhengHei', sans-serif;"></div>

    <div id="app-container" class="max-w-md mx-auto shadow-2xl relative">
        <header class="bg-slate-900 text-white px-4 py-3 shadow-md sticky top-0 z-50 flex items-center justify-between h-14 relative">
            <button id="btn-back" onclick="backToDash()" class="hidden mr-2 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-xs font-bold transition shrink-0 flex items-center">ğŸ”™ è¿”å›</button>
            <div class="flex-1 min-w-0 flex justify-center text-center">
                <h1 class="text-base sm:text-lg font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-amber-300 to-orange-200 truncate px-2" id="header-title">æ¡è³¼ç®¡ç†ä¸­å¿ƒ</h1>
            </div>
            <div class="shrink-0 text-[10px] font-bold bg-white/10 px-2 py-1 rounded-full border border-white/20" id="user-badge">è¼‰å…¥ä¸­</div>
        </header>

        <main class="p-4 relative z-10">
            
            <div id="view-dashboard" class="view-panel active space-y-4">
                
                <div class="glass-card p-4 rounded-[2rem] shadow-sm border-t-4 border-slate-700 relative overflow-hidden">
                    <div class="flex items-center justify-between mb-3 border-b border-slate-100 pb-2">
                        <h3 class="font-black text-slate-800 text-sm flex items-center"><span class="mr-1.5 text-lg">ğŸ“‹</span>æ¡è³¼å–®æœ€æ–°ç‹€æ³è¡¨</h3>
                        <div class="flex items-center space-x-1.5 text-[9px] font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-md border border-slate-200">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span><span>æ­£å¸¸</span>
                            <span class="w-2 h-2 rounded-full bg-amber-400 ml-1"></span><span>è­¦ç¤º</span>
                            <span class="w-2 h-2 rounded-full bg-red-500 ml-1 animate-pulse"></span><span>é²äº¤</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto no-scrollbar border border-slate-200 rounded-xl shadow-inner bg-slate-50 p-1">
                        <table class="w-full text-left text-[10px] whitespace-nowrap min-w-[300px]">
                            <thead class="text-slate-500 border-b border-slate-200">
                                <tr>
                                    <th class="p-2 font-bold w-16">å–®è™Ÿ</th>
                                    <th class="p-2 font-bold">ä¾›æ‡‰å•†</th>
                                    <th class="p-2 font-bold text-center">ç‹€æ…‹</th>
                                    <th class="p-2 font-bold text-center">äº¤è²¨æ—¥</th>
                                </tr>
                            </thead>
                            <tbody id="ui-dash-po-status" class="divide-y divide-slate-100 bg-white rounded-lg">
                                <tr><td colspan="4" class="p-4 text-center text-slate-400 font-bold">è³‡æ–™è¨ˆç®—ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-[2rem] p-5 text-white shadow-lg relative overflow-hidden mt-4">
                    <div class="absolute -right-4 -top-4 text-7xl opacity-20">ğŸ›’</div>
                    <h2 class="text-xl font-black mb-1">æ¡è³¼åŸ·è¡Œå¼•æ“</h2>
                    <p class="text-[10px] font-bold text-amber-100 mb-3 tracking-wider">ä¾›æ‡‰éˆè¿½è¹¤èˆ‡ PDF ç”Ÿæˆ</p>
                    
                    <div class="bg-white/20 p-3 rounded-xl border border-white/20 backdrop-blur-sm mt-2 flex justify-between items-center">
                        <span class="text-[10px] font-bold tracking-widest uppercase">ğŸ“¦ å¾…è™•ç†åŸæ–™éœ€æ±‚</span>
                        <span class="bg-red-500 text-white px-2 py-0.5 rounded text-[10px] font-black shadow-sm" id="draft-count">0 ä»¶</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openPendingList()" class="glass-card p-5 rounded-[1.5rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-amber-200 hover:bg-amber-50 col-span-2 bg-amber-50/50">
                        <span class="text-3xl mb-2 drop-shadow-md">ğŸ“</span>
                        <span class="font-black text-amber-800 tracking-wider text-base mb-0.5">æ¡è³¼æ¸…å–®ç®¡ç†</span>
                        <span class="font-bold text-amber-600/70 text-[10px] tracking-wider">ç¨ç«‹åŸæ–™æŒ‡æ´¾ / ç”¢å‡º PDF</span>
                    </button>
                    
                    <button onclick="openView('supplier-add', 'æ–°å»ºä¾›æ‡‰å•†è³‡æ–™')" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-indigo-200 hover:bg-indigo-50">
                        <span class="text-3xl mb-1.5 drop-shadow-md">ğŸ¢</span>
                        <span class="font-black text-slate-700 text-xs tracking-widest mb-0.5">æ–°å»ºä¾›æ‡‰å•†</span>
                        <span class="font-bold text-indigo-500/70 text-[9px] tracking-wider">å»ºç«‹åˆä½œæª”æ¡ˆ</span>
                    </button>

                    <button onclick="checkDrafts(false)" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-slate-200 hover:bg-slate-50">
                        <span class="text-3xl mb-1.5 drop-shadow-md">ğŸ“¥</span>
                        <span class="font-black text-slate-700 text-xs tracking-widest mb-0.5">åŒ¯å…¥åº«å­˜éœ€æ±‚</span>
                        <span class="font-bold text-slate-500/70 text-[9px] tracking-wider">è¨ˆç®— BOM éœ€æ±‚</span>
                    </button>
                </div>
            </div>

            <div id="view-supplier-add" class="view-panel space-y-5">
                <div class="glass-card p-5 rounded-[2rem] shadow-sm border-t-4 border-indigo-500">
                    <h3 class="font-black text-slate-800 pl-1 text-lg mb-4 flex items-center"><span class="mr-2">ğŸ¢</span> å»ºç«‹ä¾›æ‡‰å•†æª”æ¡ˆ</h3>
                    <form onsubmit="saveSupplier(event)" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2"><input type="text" id="s-name" placeholder="ä¾›æ‡‰å•†åç¨± (å¿…å¡«)" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 outline-none focus:border-indigo-500" required></div>
                            <div><input type="text" id="s-code" placeholder="å» å•†ä»£è™Ÿ (ä¾‹: S001)" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 uppercase outline-none focus:border-indigo-500" required></div>
                            <div><input type="text" id="s-tax" placeholder="çµ±ä¸€ç·¨è™Ÿ" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 outline-none focus:border-indigo-500"></div>
                            
                            <div class="col-span-2 border-t border-slate-100 pt-3"><h5 class="text-[10px] font-black text-slate-500 mb-2">ğŸ“ è¯çµ¡çª—å£</h5></div>
                            <div><input type="text" id="s-contact" placeholder="è¯çµ¡äººå§“å" class="w-full p-3 bg-white rounded-xl text-sm border border-slate-200 outline-none focus:border-indigo-500"></div>
                            <div><input type="text" id="s-phone" placeholder="è¯çµ¡é›»è©±" class="w-full p-3 bg-white rounded-xl text-sm border border-slate-200 outline-none focus:border-indigo-500"></div>

                            <div class="col-span-2 border-t border-slate-100 pt-3"><h5 class="text-[10px] font-black text-slate-500 mb-2">ğŸ’° è²¡å‹™èˆ‡ä»˜æ¬¾</h5></div>
                            <div class="col-span-2"><select id="s-pay" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 select-arrow outline-none focus:border-indigo-500" required><option value="æœˆçµ30å¤©">æœˆçµ 30 å¤©</option><option value="æœˆçµ60å¤©">æœˆçµ 60 å¤©</option><option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾ (C.O.D)</option><option value="åŒ¯æ¬¾é ä»˜">åŒ¯æ¬¾é ä»˜ (T/T)</option></select></div>
                            <div class="col-span-2"><input type="text" id="s-bank" placeholder="åŒ¯æ¬¾éŠ€è¡Œå¸³è™Ÿè³‡è¨Š (éŠ€è¡Œ/ä»£ç¢¼/å¸³è™Ÿ/æˆ¶å)" class="w-full p-3 bg-white rounded-xl text-sm border border-slate-200 outline-none focus:border-indigo-500"></div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-md active:scale-95 transition tracking-widest text-base mt-4">ğŸ’¾ å„²å­˜ä¾›æ‡‰å•†æª”æ¡ˆ</button>
                    </form>
                </div>
            </div>

            <div id="view-purchase" class="view-panel space-y-5">
                <div class="glass-card p-5 rounded-[2rem] shadow-sm border-t-4 border-amber-500">
                    <h3 class="font-black text-slate-800 pl-1 text-lg mb-1 flex items-center"><span class="mr-2">ğŸ“¥</span> åŒ¯å…¥åº«å­˜éœ€æ±‚</h3>
                    <p class="text-[10px] text-slate-500 font-bold mb-4 pl-1">è¼¸å…¥ç”Ÿç”¢æ•¸é‡ï¼Œç³»çµ±å°‡ç²¾ç®— BOM åŸæ–™ä¸¦å­˜å…¥å¾…è™•ç†æ¸…å–®</p>
                    
                    <div id="ui-purchase-list" class="space-y-3 mb-5 border-b border-slate-100 pb-5"></div>

                    <div class="bg-amber-50 p-4 rounded-2xl border border-amber-200 shadow-inner mb-5">
                        <h4 class="font-black text-amber-900 text-xs mb-3 flex items-center justify-between"><span class="flex items-center"><span class="mr-1">âš™ï¸</span>åŸæ–™éœ€æ±‚ç¸½è¦½</span></h4>
                        <div id="ui-raw-materials-summary" class="space-y-2">
                            <p class="text-xs text-amber-700/70 font-bold text-center py-2">è«‹æ–¼ä¸Šæ–¹è¼¸å…¥æ•¸é‡...</p>
                        </div>
                    </div>
                    <button id="btn-submit-po" onclick="submitPurchaseOrder()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-black py-3.5 rounded-xl shadow-lg active:scale-95 transition tracking-widest text-sm">ğŸ’¾ ç²¾ç®—ä¸¦å­˜å…¥æ¡è³¼æ¸…å–®</button>
                </div>
            </div>

            <div id="view-pending-list" class="view-panel space-y-4">
                <div class="glass-card p-4 rounded-[2rem] shadow-sm border-t-4 border-amber-600 relative pb-16">
                    <div class="flex flex-col mb-4 border-b border-slate-100 pb-3">
                        <h3 class="font-black text-slate-800 text-lg flex items-center mb-1"><span class="mr-2 text-xl">ğŸ“</span>æ¡è³¼æ¸…å–®ç®¡ç†</h3>
                        <p class="text-[10px] text-slate-500 font-bold">å‹¾é¸å¾…è™•ç†åŸæ–™ï¼Œ<strong class="text-amber-600">åˆ†é…ä¾›æ‡‰å•†</strong>å¾Œå¯ä¸€éµç”¢å‡º PDF æ­£å¼æ¡è³¼å–®ã€‚</p>
                    </div>
                    
                    <div id="ui-pending-materials" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar pr-1 pb-10">
                        <p class="text-center text-xs text-slate-400 py-6">è¼‰å…¥ä¸­...</p>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-md border-t border-slate-200 rounded-b-[2rem]">
                        <button onclick="generatePO_PDF()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-black py-3.5 rounded-xl shadow-lg active:scale-95 transition tracking-widest text-sm flex justify-center items-center">
                            <span class="mr-2 text-lg">ğŸ–¨ï¸</span> ç¢ºèªç”¢å‡ºæ¡è³¼å–® (PDF)
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <nav id="core-bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-md border-t border-slate-200 flex justify-around text-[10px] font-bold text-slate-400 pb-5 pt-2 z-[9999] shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <div onclick="event.stopPropagation(); window.location.href='app_hr.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-sky-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ‘¨â€ğŸ’¼</span><span class="scale-90">å“¡å·¥</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_inventory.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-emerald-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ“¦</span><span class="scale-90">åº«å­˜</span></div>
        
        <div onclick="event.stopPropagation(); window.location.href='app_purchase.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition text-amber-600"><span class="text-xl mb-1">ğŸ›’</span><span class="scale-90">æ¡è³¼</span></div>
        
        <div onclick="event.stopPropagation(); window.location.href='app_sales.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-indigo-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ’¼</span><span class="scale-90">æ¥­å‹™</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_finance.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-blue-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ’°</span><span class="scale-90">è²¡å‹™</span></div>
    </nav>

    <script src="shared.js"></script>
    <script>
        window.inventoryData = []; window.supplierData = []; let pendingMats = [];

        async function bootPurchase() {
            const isAuth = await authGuard('purchase'); 
            if(isAuth) { 
                document.getElementById('user-badge').innerText = window.currentUser.full_name; 
                await loadItems();
                await loadSuppliers();
                await loadDashboardPOStatus();
                checkDrafts(true);
            }
        }

        async function loadItems() {
            const { data } = await window._sb.from('items').select('*'); 
            window.inventoryData = data || [];
        }

        async function loadSuppliers() {
            const { data } = await window._sb.from('suppliers').select('*').order('supplier_name', {ascending: true});
            window.supplierData = data || [];
        }

        function checkDrafts(isAuto = false) {
            let drafts = JSON.parse(localStorage.getItem('hypass_draft_po') || '[]');
            if(drafts.length > 0) { renderPurchaseCart(drafts); } 
            else if (!isAuto) { alert('ç›®å‰ç„¡ä¾†è‡ªåº«å­˜çš„æ–°éœ€æ±‚ï¼è«‹å…ˆå»ã€Œåº«å­˜ç³»çµ±ã€å‹¾é¸æ–™è™Ÿä¸¦ç™¼é€ã€‚'); }
        }

        function openView(viewId, title) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-' + viewId).classList.add('active');
            document.getElementById('header-title').innerText = title; 
            document.getElementById('btn-back').classList.remove('hidden'); 
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function backToDash() { 
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-dashboard').classList.add('active'); 
            document.getElementById('header-title').innerText = 'æ¡è³¼ç®¡ç†ä¸­å¿ƒ'; 
            document.getElementById('btn-back').classList.add('hidden'); 
            loadDashboardPOStatus();
            checkDrafts(true);
        }

        // ğŸŒŸ Dashboard æˆ°æƒ…è¡¨ (ç´…é»ƒç¶ è­¦ç¤º)
        async function loadDashboardPOStatus() {
            const container = document.getElementById('ui-dash-po-status');
            const { data, error } = await window._sb.from('po_documents').select('po_no, supplier_name, status, expected_date').order('expected_date', {ascending: true});
            
            // è¨ˆç®—å¾…è™•ç†æ•¸é‡
            const { data: rawDrafts } = await window._sb.from('purchase_orders').select('id, raw_materials').eq('status', 'å·²å»ºæª”');
            let draftCnt = 0;
            if(rawDrafts) { rawDrafts.forEach(po => { if(po.raw_materials) draftCnt += po.raw_materials.length; }); }
            document.getElementById('draft-count').innerText = `${draftCnt} ä»¶`;

            if(error || !data || data.length === 0) { container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 font-bold">ç„¡é€²è¡Œä¸­çš„æ¡è³¼å–®</td></tr>'; return; }
            
            const today = new Date(); today.setHours(0,0,0,0);

            let html = '';
            data.forEach(po => {
                let expDate = new Date(po.expected_date);
                let diffTime = expDate - today;
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let statusBadge = ''; let textClass = 'text-slate-700';
                
                if(po.status === 'å·²åˆ°è²¨') {
                    statusBadge = '<span class="text-[9px] font-black text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">çµæ¡ˆ</span>';
                    textClass = 'text-slate-400 opacity-70';
                } else {
                    if (diffDays < 0) {
                        statusBadge = '<span class="text-[9px] font-black text-red-600 bg-red-100 px-1.5 py-0.5 rounded border border-red-200 animate-pulse">é²äº¤</span>';
                        textClass = 'text-red-600 font-black';
                    } else if (diffDays <= 3) {
                        statusBadge = '<span class="text-[9px] font-black text-amber-700 bg-amber-100 px-1.5 py-0.5 rounded border border-amber-300">è­¦ç¤º</span>';
                        textClass = 'text-amber-600 font-black';
                    } else {
                        statusBadge = '<span class="text-[9px] font-black text-emerald-700 bg-emerald-100 px-1.5 py-0.5 rounded border border-emerald-200">æ­£å¸¸</span>';
                        textClass = 'text-slate-800 font-bold';
                    }
                }

                html += `
                <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50 transition">
                    <td class="p-2 font-mono font-black text-[9px] ${textClass}">${po.po_no.replace('PO-','')}</td>
                    <td class="p-2 font-bold text-xs truncate max-w-[80px] ${textClass}">${po.supplier_name}</td>
                    <td class="p-2 text-center">${statusBadge}</td>
                    <td class="p-2 text-center font-bold text-[10px] ${textClass}">${po.expected_date.slice(5)}</td>
                </tr>`;
            });
            container.innerHTML = html;
        }

        // ğŸŒŸ æ–°å¢ä¾›æ‡‰å•†
        async function saveSupplier(e) {
            e.preventDefault();
            const p = {
                supplier_name: document.getElementById('s-name').value,
                supplier_code: document.getElementById('s-code').value.toUpperCase(),
                tax_id: document.getElementById('s-tax').value,
                contact_name: document.getElementById('s-contact').value,
                contact_phone: document.getElementById('s-phone').value,
                payment_method: document.getElementById('s-pay').value,
                bank_details: document.getElementById('s-bank').value
            };
            const { error } = await window._sb.from('suppliers').insert([p]);
            if(error) { alert('å„²å­˜å¤±æ•—:' + error.message); }
            else { alert('âœ… ä¾›æ‡‰å•†å»ºç«‹æˆåŠŸï¼'); e.target.reset(); await loadSuppliers(); backToDash(); }
        }

        // ç”¢å‡ºåˆéš BOM éœ€æ±‚ (èˆŠåŠŸèƒ½å„ªåŒ–)
        function renderPurchaseCart(draftIds) {
            openView('purchase', 'ğŸ“¥ åŒ¯å…¥åº«å­˜éœ€æ±‚');
            const container = document.getElementById('ui-purchase-list');
            let html = '';
            draftIds.forEach(id => { 
                const i = window.inventoryData.find(x => x.id === id); 
                if(i) html += `<div class="bg-slate-50 p-3 rounded-xl border border-slate-200 flex items-center justify-between shadow-inner po-target-row mb-2" data-id="${i.id}"><div class="flex-1 pr-2"><span class="text-[9px] font-mono font-black text-slate-500 bg-slate-200 px-1.5 py-0.5 rounded">${i.item_code}</span><h4 class="font-black text-sm text-slate-800 leading-tight mt-1 truncate">${i.item_name}</h4></div><div class="w-20 shrink-0"><input type="number" min="1" class="w-full p-1.5 border border-amber-300 rounded-lg text-sm font-black text-center text-amber-900 focus:border-amber-500 po-target-qty shadow-sm" placeholder="ç”¢é‡" oninput="calculatePOBOM()"></div></div>`; 
            });
            container.innerHTML = html; calculatePOBOM();
        }

        function calculatePOBOM() {
            let rawTotals = {}; let allEmpty = true;
            document.querySelectorAll('.po-target-row').forEach(row => {
                let id = row.getAttribute('data-id'); let qty = parseInt(row.querySelector('.po-target-qty').value) || 0;
                let item = window.inventoryData.find(x => x.id === id);
                if (qty > 0 && item) {
                    allEmpty = false;
                    if (item.bom_data && item.bom_data.length > 0) {
                        item.bom_data.forEach(b => { let key = b.material + '_' + b.unit; if (!rawTotals[key]) rawTotals[key] = { name: b.material, unit: b.unit, qty: 0 }; rawTotals[key].qty += (parseFloat(b.total_qty) * qty); });
                    } else { let key = item.item_name + '_ç®±/ä»¶'; if (!rawTotals[key]) rawTotals[key] = { name: item.item_name, unit: 'ç®±/ä»¶', qty: 0 }; rawTotals[key].qty += qty; }
                }
            });

            const summaryDiv = document.getElementById('ui-raw-materials-summary');
            if(allEmpty) { summaryDiv.innerHTML = '<p class="text-xs text-amber-700/70 font-bold text-center py-2">è«‹æ–¼ä¸Šæ–¹è¼¸å…¥æ•¸é‡...</p>'; window.currentCalculatedRawMaterials = []; return; }
            
            let sHtml = ''; for(let k in rawTotals) { let r = rawTotals[k]; sHtml += `<div class="flex justify-between items-center bg-white p-2.5 rounded-lg border border-amber-100 shadow-sm mb-1.5"><span class="text-xs font-bold text-slate-700">${r.name}</span><span class="text-sm font-black text-amber-600">${r.qty.toFixed(2)} <span class="text-[9px] text-slate-400">${r.unit}</span></span></div>`; }
            summaryDiv.innerHTML = sHtml; window.currentCalculatedRawMaterials = Object.values(rawTotals);
        }

        async function submitPurchaseOrder() {
            let isValid = true; document.querySelectorAll('.po-target-qty').forEach(inp => { if((parseInt(inp.value)||0) <= 0) isValid = false; });
            if(!isValid) { alert('è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸é‡ï¼'); return; }
            if(!window.currentCalculatedRawMaterials || window.currentCalculatedRawMaterials.length === 0) { alert('ç„¡åŸæ–™å¯å­˜ï¼'); return; }

            let targetItems = []; document.querySelectorAll('.po-target-row').forEach(row => { let id = row.getAttribute('data-id'); let qty = parseInt(row.querySelector('.po-target-qty').value) || 0; let item = window.inventoryData.find(x => x.id === id); if(item) targetItems.push({ id: item.item_code, name: item.item_name, qty: qty }); });

            // ç‚ºäº†ä¸ç ´å£èˆŠçµæ§‹ï¼Œä¾èˆŠå­˜å…¥ purchase_orders åšç‚º "è‰ç¨¿æ± "
            const payload = { employee_id: window.currentUser.id, total_items: window.currentCalculatedRawMaterials.length, expected_date: null, target_items: targetItems, raw_materials: window.currentCalculatedRawMaterials, status: 'å·²å»ºæª”' };
            const { error: poErr } = await window._sb.from('purchase_orders').insert([payload]);
            if(poErr) { alert('å»ºç«‹å¤±æ•—:' + poErr.message); return; }

            alert('âœ… éœ€æ±‚å·²ç²¾ç®—ä¸¦å­˜å…¥ã€Œæ¡è³¼æ¸…å–®ç®¡ç†ã€ï¼'); 
            localStorage.removeItem('hypass_draft_po'); 
            backToDash();
        }

        // ğŸŒŸ æ¡è³¼æ¸…å–®ç®¡ç† (å–®ä¸€åŸæ–™èˆ‡ä¾›æ‡‰å•†æŒ‡æ´¾)
        async function openPendingList() {
            openView('pending-list', 'ğŸ“ æ¡è³¼æ¸…å–®ç®¡ç†');
            const container = document.getElementById('ui-pending-materials');
            container.innerHTML = '<p class="text-center text-xs text-slate-400 py-6">è®€å–ä¸­...</p>';
            
            const { data, error } = await window._sb.from('purchase_orders').select('id, raw_materials, created_at').eq('status', 'å·²å»ºæª”');
            if(error || !data || data.length === 0) { container.innerHTML = '<p class="text-center text-sm font-bold text-slate-400 py-10 bg-slate-50 rounded-2xl border border-dashed border-slate-200">ç›®å‰ç„¡å¾…è™•ç†çš„åŸæ–™</p>'; return; }

            pendingMats = [];
            data.forEach(po => {
                if(po.raw_materials) {
                    po.raw_materials.forEach((rm, idx) => {
                        pendingMats.push({
                            uid: `${po.id}_${idx}`,
                            po_id: po.id,
                            name: rm.name,
                            qty: rm.qty,
                            unit: rm.unit,
                            date: po.created_at
                        });
                    });
                }
            });

            const supOptions = '<option value="">(è«‹é¸æ“‡ä¾›æ‡‰å•†...)</option>' + window.supplierData.map(s => `<option value="${s.supplier_name}">${s.supplier_name}</option>`).join('');

            container.innerHTML = pendingMats.map(pm => `
                <div class="bg-white p-4 rounded-2xl border-2 border-slate-200 shadow-sm relative pending-mat-item" data-uid="${pm.uid}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-mono font-black text-slate-400 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">ä¾†æº: æ‹‹è½‰è‰ç¨¿</span>
                        <label class="flex items-center space-x-1.5 cursor-pointer bg-white p-1 rounded-md z-10 border border-slate-200 shadow-sm"><input type="checkbox" class="w-4 h-4 accent-amber-600 print-chk"><span class="text-[10px] font-black text-slate-700">å‹¾é¸æ¡è³¼</span></label>
                    </div>
                    <div class="flex justify-between items-end mb-3 border-b border-slate-100 pb-3">
                        <h4 class="font-black text-base text-slate-800 leading-tight flex-1 pr-2">${pm.name}</h4>
                        <div class="text-right">
                            <span class="text-[9px] text-slate-500 font-bold block mb-0.5">ç¸½éœ€æ±‚é‡</span>
                            <span class="font-black text-amber-600 text-lg tracking-tight leading-none">${pm.qty.toFixed(2)} <span class="text-[10px] text-slate-400">${pm.unit}</span></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 ml-1 block mb-1">æŒ‡æ´¾ä¾›æ‡‰å•†</label>
                            <select class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold text-slate-700 select-arrow focus:border-amber-500 outline-none pm-sup">${supOptions}</select>
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 ml-1 block mb-1">è¦æ±‚åˆ°è²¨æ—¥</label>
                            <input type="date" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold focus:border-amber-500 outline-none pm-date" required>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ğŸŒŸ ä¸€éµç”¢å‡ºæ­£å¼æ¡è³¼å–® (å­˜å…¥ po_documents + PDF åˆ—å°)
        async function generatePO_PDF() {
            const items = document.querySelectorAll('.pending-mat-item');
            let selected = [];
            let poIdsToUpdate = new Set();
            let missingData = false;

            items.forEach(el => {
                const isChecked = el.querySelector('.print-chk').checked;
                if(isChecked) {
                    const uid = el.getAttribute('data-uid');
                    const pm = pendingMats.find(x => x.uid === uid);
                    const sup = el.querySelector('.pm-sup').value;
                    const date = el.querySelector('.pm-date').value;
                    
                    if(!sup || !date) missingData = true;

                    selected.push({ ...pm, supplier: sup, expected_date: date });
                    poIdsToUpdate.add(pm.po_id);
                }
            });

            if(selected.length === 0) { alert('è«‹è‡³å°‘å‹¾é¸ä¸€é …åŸæ–™ä»¥ç”¢å‡ºæ¡è³¼å–®ï¼'); return; }
            if(missingData) { alert('è«‹ç¢ºä¿å·²å‹¾é¸çš„é …ç›®çš†æœ‰é¸æ“‡ã€Œä¾›æ‡‰å•†ã€èˆ‡ã€Œåˆ°è²¨æ—¥ã€ï¼'); return; }

            // ä¾æ“šä¾›æ‡‰å•†åˆ†çµ„ï¼Œç”¢ç”Ÿç¨ç«‹çš„ PO å–®
            let groupedPO = {};
            selected.forEach(s => {
                if(!groupedPO[s.supplier]) groupedPO[s.supplier] = { items: [], maxDate: s.expected_date };
                groupedPO[s.supplier].items.push(s);
                if(s.expected_date > groupedPO[s.supplier].maxDate) groupedPO[s.supplier].maxDate = s.expected_date;
            });

            const dateStr = new Date().toLocaleDateString('zh-TW');
            let printHtml = '';

            for (const [supName, data] of Object.entries(groupedPO)) {
                // ç”¢ç”Ÿéš¨æ©Ÿå–®è™Ÿ
                const poNo = 'PO-' + new Date().getFullYear() + String(new Date().getMonth()+1).padStart(2,'0') + String(new Date().getDate()).padStart(2,'0') + '-' + Math.floor(Math.random()*1000).toString().padStart(3,'0');
                
                // å­˜å…¥è³‡æ–™åº«
                await window._sb.from('po_documents').insert([{
                    po_no: poNo,
                    supplier_name: supName,
                    expected_date: data.maxDate,
                    items_json: data.items,
                    status: 'å·²ä¸‹å–®'
                }]);

                // ç”¢ç”Ÿ PDF HTML (åˆ†é )
                let tableRows = data.items.map((s, i) => `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; text-align: center;">${i+1}</td>
                        <td style="padding: 12px; font-weight: bold;">${s.name}</td>
                        <td style="padding: 12px; text-align: right; color: #d97706; font-weight: bold; font-size: 16px;">${s.qty.toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 12px; color: #64748b;">${s.unit}</td>
                        <td style="padding: 12px; text-align: center; color: #ef4444; font-weight: bold;">${s.expected_date}</td>
                    </tr>
                `).join('');

                const supInfo = window.supplierData.find(x => x.supplier_name === supName) || {};

                printHtml += `
                    <div class="print-break" style="max-width: 800px; margin: 0 auto; padding: 40px; color: #1e293b; font-family: sans-serif;">
                        <div style="text-align: center; border-bottom: 4px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px;">
                            <h1 style="font-size: 36px; font-weight: 900; margin: 0; letter-spacing: 2px;">HYPASS æ¡è³¼å–®</h1>
                            <p style="font-size: 14px; color: #64748b; margin-top: 10px; font-weight: bold; letter-spacing: 1px;">PURCHASE ORDER</p>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; width: 45%;">
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #334155; border-bottom: 2px solid #cbd5e1; padding-bottom: 5px;">ä¾›æ‡‰å•†è³‡è¨Š</h3>
                                <p style="margin: 5px 0;"><strong>åç¨±ï¼š</strong>${supName}</p>
                                <p style="margin: 5px 0;"><strong>çµ±ç·¨ï¼š</strong>${supInfo.tax_id||'--'}</p>
                                <p style="margin: 5px 0;"><strong>è¯çµ¡äººï¼š</strong>${supInfo.contact_name||'--'} / ${supInfo.contact_phone||'--'}</p>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; width: 45%;">
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #334155; border-bottom: 2px solid #cbd5e1; padding-bottom: 5px;">å–®æ“šè³‡è¨Š</h3>
                                <p style="margin: 5px 0;"><strong>å–®è™Ÿï¼š</strong><span style="font-family: monospace; font-weight: bold;">${poNo}</span></p>
                                <p style="margin: 5px 0;"><strong>æ—¥æœŸï¼š</strong>${dateStr}</p>
                                <p style="margin: 5px 0;"><strong>é–‹å–®äººï¼š</strong>${window.currentUser.full_name}</p>
                            </div>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 30px;">
                            <thead style="background: #1e293b; color: white;">
                                <tr>
                                    <th style="padding: 12px; text-align: center; width: 50px;">é …æ¬¡</th>
                                    <th style="padding: 12px; text-align: left;">æ¡è³¼å“å/è¦æ ¼</th>
                                    <th style="padding: 12px; text-align: right;">æ•¸é‡</th>
                                    <th style="padding: 12px; text-align: center;">å–®ä½</th>
                                    <th style="padding: 12px; text-align: center;">æŒ‡å®šåˆ°è²¨æ—¥</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>

                        <div style="background: #fffbeb; border: 1px solid #fde68a; padding: 15px; border-radius: 8px; font-size: 12px; color: #92400e; margin-bottom: 40px;">
                            <strong>å‚™è¨»èªªæ˜ï¼š</strong><br>
                            1. ç…©è«‹æ–¼æŒ‡å®šåˆ°è²¨æ—¥å‰å®Œæˆäº¤è²¨ï¼Œè‹¥æœ‰å»¶é²è«‹æå‰å‘ŠçŸ¥ã€‚<br>
                            2. è«‹æ–¼å‡ºè²¨å–®/ç™¼ç¥¨ä¸Šè¨»æ˜æœ¬æ¡è³¼å–®è™Ÿï¼š${poNo}ã€‚<br>
                            3. ç´„å®šä»˜æ¬¾æ–¹å¼ï¼š${supInfo.payment_method||'ä¾åŸåˆç´„'}ã€‚
                        </div>

                        <div style="display: flex; justify-content: space-between; border-top: 2px solid #1e293b; padding-top: 20px;">
                            <div style="text-align: center; width: 200px;">
                                <p style="margin-bottom: 40px; color: #64748b;">æ¡è³¼ä¸»ç®¡ç°½æ ¸</p>
                                <div style="border-bottom: 1px solid #94a3b8;"></div>
                            </div>
                            <div style="text-align: center; width: 200px;">
                                <p style="margin-bottom: 40px; color: #64748b;">ä¾›æ‡‰å•†ç¢ºèªç°½å›</p>
                                <div style="border-bottom: 1px solid #94a3b8;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // æ›´æ–°èˆŠè‰ç¨¿ç‹€æ…‹ï¼Œé¿å…é‡è¤‡æŠ“å–
            let arrPoIds = Array.from(poIdsToUpdate);
            for(let pid of arrPoIds) {
                await window._sb.from('purchase_orders').update({status: 'å·²è½‰æ›æ­£å¼å–®'}).eq('id', pid);
            }

            document.getElementById('po-print-zone').innerHTML = printHtml;
            
            // å»¶é²å–šèµ·åˆ—å°
            setTimeout(() => { 
                window.print(); 
                alert('âœ… æ­£å¼æ¡è³¼å–®å·²ç”Ÿæˆä¸¦å­˜å…¥å¾Œå°è³‡æ–™åº«ï¼');
                backToDash();
            }, 300);
        }

        window.onload = bootPurchase;

        const enforceNavObserver = new MutationObserver(() => {
            const oldNav = document.querySelector('nav:not(#core-bottom-nav)');
            if (oldNav) oldNav.remove();
        });
        enforceNavObserver.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
