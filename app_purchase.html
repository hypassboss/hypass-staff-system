<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | æ¡è³¼ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background: #e2e8f0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding-bottom: 80px;}
        #app-container { background: #f1f5f9; min-height: 100vh; position: relative; overflow-x: hidden; }
        .view-panel { display: none; animation: fadeIn 0.3s ease; } .view-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: rgba(255, 255, 255, 0.98); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.8); }
        .modal { display: none !important; } .modal.active { display: flex !important; z-index: 200; }
        .select-arrow { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-size: 1.5em 1.5em; background-position: right 0.5rem center; background-repeat: no-repeat; padding-right: 2rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* ğŸš¨ åˆ—å° PDF é»‘ç§‘æŠ€ */
        @media print {
            body * { visibility: hidden; }
            #po-print-zone, #po-print-zone * { visibility: visible; }
            #po-print-zone { display: block !important; position: absolute; left: 0; top: 0; width: 100vw; background: white; z-index: 9999; padding: 20px;}
            #app-container, nav { display: none !important; }
        }

        /* ğŸš¨ çµ‚æ¥µé˜²ç¦¦è£ç”²ï¼šå°æ®º shared.js ç”¢ç”Ÿçš„èˆŠå°è¦½åˆ— */
        nav { display: none !important; }
        #core-bottom-nav { display: flex !important; }
    </style>
</head>
<body class="text-slate-800 relative">

    <div id="po-print-zone" style="display:none; font-family: 'Microsoft JhengHei', sans-serif;"></div>

    <div id="app-container" class="max-w-md mx-auto shadow-2xl relative">
        <header class="bg-slate-900 text-white px-5 py-4 shadow-md sticky top-0 z-50 flex items-center h-16 relative">
            <button id="btn-back" onclick="backToDash()" class="hidden mr-3 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-xs font-bold transition">ğŸ”™ è¿”å›</button>
            <div><h1 class="text-xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-amber-300 to-orange-200" id="header-title">æ¡è³¼ç®¡ç†ä¸­å¿ƒ</h1></div>
            <div class="ml-auto text-[10px] font-bold bg-white/10 px-3 py-1 rounded-full border border-white/20" id="user-badge">è¼‰å…¥ä¸­</div>
        </header>

        <main class="p-5 relative z-10">
            <div id="view-dashboard" class="view-panel active space-y-5">
                <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-[2rem] p-6 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-7xl opacity-20">ğŸ›’</div>
                    <h2 class="text-2xl font-black mb-1">è¡Œå‹•æ¡è³¼ä¸­å¿ƒ</h2>
                    <p class="text-xs font-bold text-amber-100 mb-4 tracking-wider">ä¾›æ‡‰éˆè¿½è¹¤èˆ‡ PDF ç”Ÿæˆ</p>
                    
                    <div class="bg-white/20 p-4 rounded-xl border border-white/20 backdrop-blur-sm mt-4">
                        <p class="text-[10px] font-bold mb-2 tracking-widest uppercase flex items-center justify-between">
                            <span>ğŸ“¦ å¾…è™•ç†çš„æ¡è³¼éœ€æ±‚</span>
                            <span class="bg-red-500 text-white px-2 py-0.5 rounded text-[9px] font-black shadow-sm" id="draft-count">0 ä»¶</span>
                        </p>
                        <button onclick="checkDrafts()" class="w-full bg-white text-amber-600 font-black py-3 rounded-lg text-xs shadow-sm mt-2 active:scale-95 transition">æª¢æŸ¥ä¸¦è¼‰å…¥æ–°éœ€æ±‚</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openPendingList()" class="glass-card p-6 rounded-[2rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-amber-200 hover:bg-amber-50 col-span-2 bg-amber-50/50">
                        <span class="text-4xl mb-3 drop-shadow-md">ğŸ“</span>
                        <span class="font-black text-amber-800 tracking-wider text-lg mb-0.5">æ¡è³¼æ¸…å–®ç®¡ç†</span>
                        <span class="font-bold text-amber-600/70 text-xs tracking-wider">å–®ä¸€åŸæ–™ç¨ç«‹æ¡è³¼ / ç”¢å‡º PDF</span>
                    </button>
                    <button onclick="openPOStatusTable()" class="glass-card p-5 rounded-[2rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-slate-200 hover:bg-slate-50 col-span-2">
                        <span class="text-4xl mb-2 drop-shadow-md">ğŸ“‹</span>
                        <span class="font-black text-slate-700 text-[13px] tracking-widest mb-0.5">æ¡è³¼å–®æœ€æ–°ç‹€æ³è¡¨</span>
                        <span class="font-bold text-slate-500/70 text-[10px] tracking-wider">å³æ™‚ç‹€æ…‹è¿½è¹¤ (ç¶ /é»ƒ/ç´…)</span>
                    </button>
                </div>
            </div>

            <div id="view-purchase" class="view-panel space-y-5">
                <div class="glass-card p-5 md:p-6 rounded-[2rem] shadow-sm border-t-4 border-amber-500">
                    <h3 class="font-black text-slate-800 pl-1 text-xl mb-1 flex items-center"><span class="mr-2">ğŸ›’</span> ç”¢å‡ºæ¡è³¼éœ€æ±‚</h3>
                    <p class="text-[10px] text-slate-500 font-bold mb-4 pl-1">è¼¸å…¥ç”Ÿç”¢æ•¸é‡ï¼Œç³»çµ±å°‡ç²¾ç®—åŸæ–™ä¸¦å­˜å…¥å¾…è™•ç†æ¸…å–®</p>
                    
                    <div id="ui-purchase-list" class="space-y-3 mb-6 border-b border-slate-200 pb-6"></div>

                    <div class="bg-amber-50 p-4 rounded-2xl border border-amber-200 shadow-inner mb-6">
                        <h4 class="font-black text-amber-900 text-sm mb-3 flex items-center justify-between"><span class="flex items-center"><span class="mr-1">âš™ï¸</span>åŸæ–™éœ€æ±‚ç¸½è¦½</span></h4>
                        <div id="ui-raw-materials-summary" class="space-y-2">
                            <p class="text-xs text-amber-700/70 font-bold text-center py-2">è«‹æ–¼ä¸Šæ–¹è¼¸å…¥æ•¸é‡...</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="col-span-2"><label class="text-[10px] font-bold text-slate-500 ml-1">é è¨ˆæœ€æ™šåˆ°å» æ™‚é–“</label><input type="date" id="po-expected-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold shadow-inner" required></div>
                    </div>

                    <button id="btn-submit-po" onclick="submitPurchaseOrder()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition tracking-widest text-lg">ğŸ’¾ å„²å­˜è‡³æ¡è³¼æ¸…å–®</button>
                </div>
            </div>

            <div id="view-pending-list" class="view-panel space-y-4">
                <div class="glass-card p-4 md:p-5 rounded-[2rem] shadow-sm border-t-4 border-amber-600 relative pb-10">
                    <div class="flex flex-col mb-4 border-b border-slate-100 pb-3">
                        <h3 class="font-black text-slate-800 text-lg flex items-center mb-1"><span class="mr-2 text-xl">ğŸ“</span>æ¡è³¼æ¸…å–®ç®¡ç†</h3>
                        <p class="text-[10px] text-slate-500 font-bold">å‹¾é¸ä¸‹æ–¹å¾…è™•ç†åŸæ–™ï¼Œå¡«å¯«ä¾›æ‡‰å•†å¾Œå¯ä¸€éµç”¢å‡º PDF æ¡è³¼å–®ã€‚</p>
                    </div>
                    
                    <div id="ui-pending-materials" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar pr-1 pb-10">
                        <p class="text-center text-xs text-slate-400 py-6">è¼‰å…¥ä¸­...</p>
                    </div>

                    <div class="fixed bottom-[80px] left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-slate-200 shadow-[0_-10px_20px_rgba(0,0,0,0.05)] z-50">
                        <button onclick="generatePO_PDF()" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white font-black py-3.5 rounded-xl shadow-lg active:scale-95 transition tracking-widest text-sm flex justify-center items-center">
                            <span class="mr-2 text-lg">ğŸ–¨ï¸</span> ç¢ºèªç”¢å‡ºæ¡è³¼å–® (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-po-status" class="view-panel space-y-4">
                <div class="glass-card p-4 md:p-5 rounded-[2rem] shadow-sm border-t-4 border-slate-700 relative pb-10">
                    <div class="flex items-center justify-between mb-4 border-b border-slate-100 pb-3">
                        <h3 class="font-black text-slate-800 text-lg flex items-center"><span class="mr-2 text-xl">ğŸ“‹</span>æ¡è³¼ç‹€æ³è¡¨</h3>
                        <div class="flex space-x-1">
                            <span class="w-3 h-3 rounded-full bg-emerald-500 shadow-sm"></span>
                            <span class="w-3 h-3 rounded-full bg-amber-400 shadow-sm"></span>
                            <span class="w-3 h-3 rounded-full bg-red-500 shadow-sm animate-pulse"></span>
                        </div>
                    </div>
                    
                    <div id="ui-po-status-list" class="space-y-3 max-h-[70vh] overflow-y-auto no-scrollbar pr-1 pb-10">
                        <p class="text-center text-xs text-slate-400 py-6">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <nav id="core-bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-md border-t border-slate-200 flex justify-around text-[10px] font-bold text-slate-400 pb-5 pt-2 z-[9999] shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <div onclick="event.stopPropagation(); window.location.href='app_hr.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-sky-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ‘¨â€ğŸ’¼</span><span class="scale-90">å“¡å·¥</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_inventory.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-emerald-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ“¦</span><span class="scale-90">åº«å­˜</span></div>
        
        <div onclick="event.stopPropagation(); window.location.href='app_purchase.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition text-amber-600"><span class="text-xl mb-1">ğŸ›’</span><span class="scale-90">æ¡è³¼</span></div>
        
        <div onclick="event.stopPropagation(); window.location.href='app_sales.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-indigo-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ’¼</span><span class="scale-90">æ¥­å‹™</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_finance.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-blue-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ’°</span><span class="scale-90">è²¡å‹™</span></div>
    </nav>

    <script src="shared.js"></script>
    <script>
        window.inventoryData = []; window.currentPOs = []; let pendingMats = [];

        async function bootPurchase() {
            const isAuth = await authGuard('purchase'); 
            if(isAuth) { 
                document.getElementById('user-badge').innerText = window.currentUser.full_name; 
                await loadItems();
                checkDrafts(true);
            }
        }

        async function loadItems() {
            const { data } = await window._sb.from('items').select('*'); 
            window.inventoryData = data || [];
        }

        function checkDrafts(isAuto = false) {
            let drafts = JSON.parse(localStorage.getItem('hypass_draft_po') || '[]');
            document.getElementById('draft-count').innerText = `${drafts.length} ä»¶`;
            if(drafts.length > 0) { renderPurchaseCart(drafts); } 
            else if (!isAuto) { alert('ç›®å‰ç„¡ä¾†è‡ªåº«å­˜çš„æ–°éœ€æ±‚ï¼è«‹ä½¿ç”¨æ¡è³¼æ¸…å–®ç®¡ç†ã€‚'); }
        }

        function openView(viewId, title) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-' + viewId).classList.add('active');
            document.getElementById('header-title').innerText = title; 
            document.getElementById('btn-back').classList.remove('hidden'); 
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function backToDash() { 
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-dashboard').classList.add('active'); 
            document.getElementById('header-title').innerText = 'æ¡è³¼ç®¡ç†ä¸­å¿ƒ'; 
            document.getElementById('btn-back').classList.add('hidden'); 
            checkDrafts(true);
        }

        // ğŸŒŸ ç”Ÿæˆåˆéšæ¡è³¼éœ€æ±‚å–® (å­˜å…¥ DB ç‚ºå¾…è™•ç†)
        function renderPurchaseCart(draftIds) {
            openView('purchase', 'ğŸ›’ ç”¢å‡ºæ¡è³¼éœ€æ±‚');
            const container = document.getElementById('ui-purchase-list');
            let html = '';
            draftIds.forEach(id => { 
                const i = window.inventoryData.find(x => x.id === id); 
                if(i) html += `<div class="bg-slate-50 p-4 rounded-xl border border-slate-200 flex items-center justify-between shadow-inner po-target-row mb-3" data-id="${i.id}"><div class="flex-1 pr-2"><span class="text-[10px] font-mono font-black text-slate-500 bg-slate-200 px-2 py-0.5 rounded">${i.item_code}</span><h4 class="font-black text-base text-slate-800 leading-tight mt-1.5 truncate">${i.item_name}</h4></div><div class="w-24 shrink-0"><input type="number" min="1" class="w-full p-2 border border-amber-300 rounded-lg text-base font-black text-center text-amber-900 focus:border-amber-500 po-target-qty shadow-sm" placeholder="ç”¢/è³¼é‡" oninput="calculatePOBOM()"></div></div>`; 
            });
            container.innerHTML = html; calculatePOBOM();
        }

        function calculatePOBOM() {
            let rawTotals = {}; let allEmpty = true;
            document.querySelectorAll('.po-target-row').forEach(row => {
                let id = row.getAttribute('data-id'); let qty = parseInt(row.querySelector('.po-target-qty').value) || 0;
                let item = window.inventoryData.find(x => x.id === id);
                if (qty > 0 && item) {
                    allEmpty = false;
                    if (item.bom_data && item.bom_data.length > 0) {
                        item.bom_data.forEach(b => { let key = b.material + '_' + b.unit; if (!rawTotals[key]) rawTotals[key] = { name: b.material, unit: b.unit, qty: 0 }; rawTotals[key].qty += (parseFloat(b.total_qty) * qty); });
                    } else { let key = item.item_name + '_ç®±/ä»¶'; if (!rawTotals[key]) rawTotals[key] = { name: item.item_name, unit: 'ç®±/ä»¶', qty: 0 }; rawTotals[key].qty += qty; }
                }
            });

            const summaryDiv = document.getElementById('ui-raw-materials-summary');
            if(allEmpty) { summaryDiv.innerHTML = '<p class="text-xs text-amber-700/70 font-bold text-center py-2">è«‹æ–¼ä¸Šæ–¹è¼¸å…¥æ•¸é‡ä»¥ç²¾ç®—åŸæ–™...</p>'; window.currentCalculatedRawMaterials = []; return; }
            
            let sHtml = ''; for(let k in rawTotals) { let r = rawTotals[k]; sHtml += `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-amber-100 shadow-sm"><span class="text-xs font-bold text-slate-700">${r.name}</span><span class="text-base font-black text-amber-600">${r.qty.toFixed(2)} <span class="text-[10px] text-slate-400">${r.unit}</span></span></div>`; }
            summaryDiv.innerHTML = sHtml; window.currentCalculatedRawMaterials = Object.values(rawTotals);
        }

        async function submitPurchaseOrder() {
            let isValid = true; document.querySelectorAll('.po-target-qty').forEach(inp => { if((parseInt(inp.value)||0) <= 0) isValid = false; });
            if(!isValid) { alert('è«‹ç¢ºä¿æ‰€æœ‰é …ç›®éƒ½æœ‰è¼¸å…¥å¤§æ–¼ 0 çš„æ•¸é‡ï¼'); return; }
            if(!window.currentCalculatedRawMaterials || window.currentCalculatedRawMaterials.length === 0) { alert('è¨ˆç®—éŒ¯èª¤ï¼Œç„¡åŸæ–™å¯æ¡è³¼ï¼'); return; }
            const exDate = document.getElementById('po-expected-date').value; if(!exDate) { alert('è«‹å¡«å¯«ã€Œé è¨ˆæœ€æ™šåˆ°å» æ™‚é–“ã€ï¼'); return; }

            let targetItems = []; document.querySelectorAll('.po-target-row').forEach(row => { let id = row.getAttribute('data-id'); let qty = parseInt(row.querySelector('.po-target-qty').value) || 0; let item = window.inventoryData.find(x => x.id === id); if(item) targetItems.push({ id: item.item_code, name: item.item_name, qty: qty }); });

            const payload = { employee_id: window.currentUser.id, total_items: window.currentCalculatedRawMaterials.length, expected_date: exDate, target_items: targetItems, raw_materials: window.currentCalculatedRawMaterials, status: 'å·²å»ºæª”' };
            const { data: po, error: poErr } = await window._sb.from('purchase_orders').insert([payload]).select();
            if(poErr || !po) { alert('æ¡è³¼å–®å»ºç«‹å¤±æ•—:' + poErr.message); return; }

            alert('âœ… æ¡è³¼éœ€æ±‚å·²ç²¾ç®—ä¸¦å­˜å…¥ã€Œæ¡è³¼æ¸…å–®ç®¡ç†ã€ï¼'); 
            localStorage.removeItem('hypass_draft_po'); 
            document.getElementById('po-expected-date').value = ''; 
            backToDash();
        }

        // ğŸŒŸ å…¨æ–°ï¼šæ¡è³¼æ¸…å–®ç®¡ç† (å–®ä¸€åŸæ–™)
        async function openPendingList() {
            openView('pending-list', 'ğŸ“ æ¡è³¼æ¸…å–®ç®¡ç†');
            const container = document.getElementById('ui-pending-materials');
            container.innerHTML = '<p class="text-center text-xs text-slate-400 py-6">è®€å–ä¸­...</p>';
            
            const { data, error } = await window._sb.from('purchase_orders').select('id, raw_materials, expected_date').eq('status', 'å·²å»ºæª”');
            if(error || !data || data.length === 0) { container.innerHTML = '<p class="text-center text-sm font-bold text-slate-400 py-10 bg-slate-50 rounded-2xl border border-dashed border-slate-200">ç›®å‰ç„¡å¾…è™•ç†çš„åŸæ–™</p>'; return; }

            pendingMats = [];
            data.forEach(po => {
                if(po.raw_materials) {
                    po.raw_materials.forEach((rm, idx) => {
                        pendingMats.push({
                            uid: `${po.id}_${idx}`,
                            po_id: po.id,
                            name: rm.name,
                            qty: rm.qty,
                            unit: rm.unit,
                            original_date: po.expected_date
                        });
                    });
                }
            });

            container.innerHTML = pendingMats.map(pm => `
                <div class="bg-white p-4 rounded-2xl border-2 border-slate-200 shadow-sm relative pending-mat-item" data-uid="${pm.uid}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-mono font-black text-slate-400 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">PO-${pm.po_id.slice(0,6)}</span>
                        <label class="flex items-center space-x-1.5 cursor-pointer bg-white p-1 rounded-md z-10"><input type="checkbox" class="w-4 h-4 accent-amber-600 print-chk"><span class="text-[10px] font-black text-slate-600">ç”¢å‡ºå–®æ“š</span></label>
                    </div>
                    <div class="flex justify-between items-end mb-3 border-b border-slate-100 pb-3">
                        <h4 class="font-black text-base text-slate-800 leading-tight flex-1 pr-2">${pm.name}</h4>
                        <div class="text-right">
                            <span class="text-[10px] text-slate-500 font-bold block mb-0.5">éœ€æ±‚é‡</span>
                            <span class="font-black text-amber-600 text-lg tracking-tight leading-none">${pm.qty.toFixed(2)} <span class="text-[10px] text-slate-400">${pm.unit}</span></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[9px] font-bold text-slate-500 ml-1 block mb-1">æŒ‡å®šä¾›æ‡‰å•†</label><input type="text" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold focus:border-amber-500 outline-none pm-sup" placeholder="è¼¸å…¥å» å•†åç¨±..."></div>
                        <div><label class="text-[9px] font-bold text-slate-500 ml-1 block mb-1">éœ€æ±‚äº¤è²¨æ—¥</label><input type="date" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold focus:border-amber-500 outline-none pm-date" value="${pm.original_date}"></div>
                    </div>
                </div>
            `).join('');
        }

        // ğŸŒŸ ä¸€éµç”¢å‡º PDF åˆ—å°å¼•æ“
        function generatePO_PDF() {
            const items = document.querySelectorAll('.pending-mat-item');
            let selected = [];
            
            items.forEach(el => {
                const isChecked = el.querySelector('.print-chk').checked;
                if(isChecked) {
                    const uid = el.getAttribute('data-uid');
                    const pm = pendingMats.find(x => x.uid === uid);
                    const sup = el.querySelector('.pm-sup').value || 'æœªæŒ‡å®šä¾›æ‡‰å•†';
                    const date = el.querySelector('.pm-date').value || pm.original_date;
                    selected.push({ ...pm, supplier: sup, expected_date: date });
                }
            });

            if(selected.length === 0) { alert('è«‹è‡³å°‘å‹¾é¸ä¸€é …åŸæ–™ä»¥ç”¢å‡ºæ¡è³¼å–®ï¼'); return; }

            // å»ºç«‹ A4 åˆ—å°æ’ç‰ˆ
            const dateStr = new Date().toLocaleDateString('zh-TW');
            let tableRows = selected.map((s, i) => `
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 10px; text-align: center;">${i+1}</td>
                    <td style="padding: 10px; font-weight: bold;">${s.name}</td>
                    <td style="padding: 10px; text-align: right; color: #d97706; font-weight: bold;">${s.qty.toFixed(2)}</td>
                    <td style="padding: 10px; text-align: center; font-size: 12px;">${s.unit}</td>
                    <td style="padding: 10px;">${s.supplier}</td>
                    <td style="padding: 10px; text-align: center;">${s.expected_date}</td>
                </tr>
            `).join('');

            const printHtml = `
                <div style="max-width: 800px; margin: 0 auto; padding: 20px; color: #1e293b;">
                    <div style="text-align: center; border-bottom: 3px solid #f59e0b; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="font-size: 32px; font-weight: 900; margin: 0; color: #0f172a;">HYPASS åŸæ–™æ¡è³¼å–®</h1>
                        <p style="font-size: 14px; color: #64748b; margin-top: 5px;">åˆ—å°æ—¥æœŸï¼š${dateStr} | ç”³è«‹äººï¼š${window.currentUser.full_name}</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead style="background: #f8fafc; border-bottom: 2px solid #cbd5e1;">
                            <tr>
                                <th style="padding: 12px 10px; text-align: center; width: 50px;">é …æ¬¡</th>
                                <th style="padding: 12px 10px; text-align: left;">æ¡è³¼åŸæ–™åç¨±</th>
                                <th style="padding: 12px 10px; text-align: right;">éœ€æ±‚æ•¸é‡</th>
                                <th style="padding: 12px 10px; text-align: center;">å–®ä½</th>
                                <th style="padding: 12px 10px; text-align: left;">æŒ‡å®šä¾›æ‡‰å•†</th>
                                <th style="padding: 12px 10px; text-align: center;">éœ€æ±‚äº¤æœŸ</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    <div style="margin-top: 50px; font-size: 12px; color: #94a3b8; text-align: center; border-top: 1px dashed #e2e8f0; padding-top: 20px;">
                        æœ¬å–®æ“šç”± HYPASS ERP ç³»çµ±è‡ªå‹•ç”¢å‡ºã€‚è«‹æ¡è³¼å–®ä½ä¾æ“šä¸Šæ–¹æ˜ç´°å‘ä¾›æ‡‰å•†é€²è¡Œä¸‹å–®ä½œæ¥­ã€‚
                    </div>
                </div>
            `;

            document.getElementById('po-print-zone').innerHTML = printHtml;
            setTimeout(() => { 
                window.print(); 
                setTimeout(() => {
                    if(confirm('åˆ—å°å®Œæˆï¼\næ˜¯å¦è¦å°‡ç³»çµ±ä¸­çš„é€™äº›æ¡è³¼å–®ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²ä¸‹å–®ã€ï¼Ÿ')) {
                        // ç°¡åŒ–è™•ç†ï¼šå°‡æ¶‰åŠåˆ°çš„ po_id æ›´æ–°ç‚ºå·²ä¸‹å–®
                        let poIds = [...new Set(selected.map(s => s.po_id))];
                        poIds.forEach(async (id) => {
                            await window._sb.from('purchase_orders').update({status: 'å·²ä¸‹å–®'}).eq('id', id);
                        });
                        alert('âœ… ç‹€æ…‹å·²æ›´æ–°ï¼');
                        openPendingList();
                    }
                }, 500);
            }, 300);
        }

        // ğŸŒŸ å…¨æ–°ï¼šæ¡è³¼å–®æœ€æ–°ç‹€æ³è¡¨ (ç´…é»ƒç¶ è­¦ç¤º)
        async function openPOStatusTable() {
            openView('po-status', 'ğŸ“‹ æ¡è³¼å–®æœ€æ–°ç‹€æ³è¡¨');
            const container = document.getElementById('ui-po-status-list');
            container.innerHTML = '<p class="text-center text-xs text-slate-400 py-6">è¼‰å…¥ä¸­...</p>';
            
            const { data, error } = await window._sb.from('purchase_orders').select('*, employees(full_name)').order('expected_date', {ascending: true});
            if(error || !data || data.length === 0) { container.innerHTML = '<p class="text-center text-xs text-slate-400 py-6 bg-slate-50 rounded-2xl border border-dashed border-slate-200">ç„¡ä»»ä½•æ¡è³¼ç´€éŒ„</p>'; return; }
            
            const today = new Date();
            today.setHours(0,0,0,0);

            container.innerHTML = data.map(po => {
                let rmText = po.raw_materials ? po.raw_materials.map(r=>r.name).join(', ') : 'ç„¡æ˜ç´°';
                let expDate = new Date(po.expected_date);
                let diffTime = expDate - today;
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let statusBadge = ''; let borderClass = ''; let dateClass = 'text-slate-500';

                if (po.status === 'å·²åˆ°è²¨') {
                    statusBadge = '<span class="text-[10px] font-black bg-emerald-100 text-emerald-700 px-2 py-1 rounded-md border border-emerald-200">âœ… å·²åˆ°è²¨çµæ¡ˆ</span>';
                    borderClass = 'border-emerald-200 bg-emerald-50/30 opacity-70';
                } else {
                    if (diffDays < 0) {
                        statusBadge = '<span class="text-[10px] font-black bg-red-600 text-white px-2 py-1 rounded-md shadow-sm animate-pulse">ğŸš¨ é²äº¤é€¾æœŸ</span>';
                        borderClass = 'border-red-400 bg-red-50/50 shadow-md';
                        dateClass = 'text-red-600 font-black';
                    } else if (diffDays <= 3) {
                        statusBadge = '<span class="text-[10px] font-black bg-amber-100 text-amber-700 px-2 py-1 rounded-md border border-amber-300">âš ï¸ å³å°‡åˆ°æœŸ</span>';
                        borderClass = 'border-amber-400 bg-amber-50/50';
                        dateClass = 'text-amber-600 font-black';
                    } else {
                        statusBadge = '<span class="text-[10px] font-black bg-sky-100 text-sky-700 px-2 py-1 rounded-md border border-sky-200">â³ æ­£å¸¸æ’ç¨‹</span>';
                        borderClass = 'border-slate-200';
                    }
                }

                return `
                <div class="bg-white p-4 rounded-2xl border-2 ${borderClass} relative transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-mono font-black text-slate-400 bg-slate-100 px-2 py-0.5 rounded border border-slate-200">PO-${po.id.slice(0,6)}</span>
                        ${statusBadge}
                    </div>
                    <h4 class="font-black text-sm text-slate-800 leading-relaxed mb-3 line-clamp-2">${rmText}</h4>
                    <div class="flex justify-between items-end border-t border-slate-100 pt-3">
                        <div class="text-[10px] text-slate-500 font-bold"><span class="mr-1">ğŸ‘¤</span>${po.employees?.full_name||'æœªçŸ¥'}</div>
                        <div class="text-xs ${dateClass} flex items-center bg-white px-2 py-1 rounded-lg border border-slate-100 shadow-sm"><span class="mr-1.5">ğŸšš</span>äº¤æœŸ: ${po.expected_date||'æœªå®š'}</div>
                    </div>
                </div>`;
            }).join('');
        }

        window.onload = bootPurchase;

        const enforceNavObserver = new MutationObserver(() => {
            const oldNav = document.querySelector('nav:not(#core-bottom-nav)');
            if (oldNav) oldNav.remove();
        });
        enforceNavObserver.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
