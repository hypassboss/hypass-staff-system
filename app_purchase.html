<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | æ¡è³¼ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background: #e2e8f0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding-bottom: 80px;}
        #app-container { background: #f1f5f9; min-height: 100vh; position: relative; overflow-x: hidden; }
        .view-panel { display: none; animation: fadeIn 0.3s ease; } .view-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: rgba(255, 255, 255, 0.98); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.8); }
        .modal { display: none !important; } .modal.active { display: flex !important; z-index: 200; }
        .select-arrow { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-size: 1.5em 1.5em; background-position: right 0.5rem center; background-repeat: no-repeat; padding-right: 2rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        @media print {
            body * { visibility: hidden; }
            #po-print-zone, #po-print-zone * { visibility: visible; }
            #po-print-zone { display: block !important; position: absolute; left: 0; top: 0; width: 100vw; background: white; z-index: 9999; padding: 20px;}
            #app-container, nav { display: none !important; }
            .print-break { page-break-after: always; }
        }

        nav { display: none !important; }
        #core-bottom-nav { display: flex !important; }
    </style>
</head>
<body class="text-slate-800 relative">

    <div id="po-print-zone" style="display:none; font-family: 'Microsoft JhengHei', sans-serif;"></div>

    <div id="app-container" class="max-w-md mx-auto shadow-2xl relative">
        <header class="bg-slate-900 text-white px-4 py-3 shadow-md sticky top-0 z-50 flex items-center justify-between h-14 relative">
            <button id="btn-back" onclick="backToDash()" class="hidden mr-2 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-xs font-bold transition shrink-0 flex items-center">ğŸ”™ è¿”å›</button>
            <div class="flex-1 min-w-0 flex justify-center text-center">
                <h1 class="text-base sm:text-lg font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-amber-300 to-orange-200 truncate px-2" id="header-title">æ¡è³¼ç®¡ç†ä¸­å¿ƒ</h1>
            </div>
            <div class="shrink-0 text-[10px] font-bold bg-white/10 px-2 py-1 rounded-full border border-white/20" id="user-badge">è¼‰å…¥ä¸­</div>
        </header>

        <main class="p-4 relative z-10">
            
            <div id="view-dashboard" class="view-panel active space-y-4">
                
                <div class="glass-card p-4 rounded-[1.5rem] shadow-sm border-t-4 border-sky-500 relative overflow-hidden">
                    <div class="flex items-center justify-between mb-2 border-b border-slate-100 pb-2">
                        <h3 class="font-black text-slate-800 text-sm flex items-center"><span class="mr-1.5 text-lg">ğŸ“¥</span>å…§éƒ¨è«‹è³¼æœ€æ–°ç‹€æ³</h3>
                        <span class="text-[9px] text-slate-400 font-bold bg-slate-50 px-2 py-1 rounded">30å¤©å…§å‹•æ…‹</span>
                    </div>
                    <div class="overflow-x-auto no-scrollbar border border-slate-200 rounded-xl shadow-inner bg-slate-50 p-1">
                        <table class="w-full text-left text-[10px] whitespace-nowrap min-w-[280px]">
                            <thead class="text-slate-500 border-b border-slate-200"><tr><th class="p-2 font-bold">è«‹è³¼å–®è™Ÿ</th><th class="p-2 font-bold">ç”³è«‹äºº</th><th class="p-2 font-bold text-center">ç‹€æ…‹</th><th class="p-2 font-bold text-right">æ—¥æœŸ</th></tr></thead>
                            <tbody id="ui-dash-req-status" class="divide-y divide-slate-100 bg-white rounded-lg"><tr><td colspan="4" class="p-4 text-center text-slate-400 font-bold">è³‡æ–™è¨ˆç®—ä¸­...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="glass-card p-4 rounded-[1.5rem] shadow-sm border-t-4 border-amber-500 relative overflow-hidden">
                    <div class="flex items-center justify-between mb-2 border-b border-slate-100 pb-2">
                        <h3 class="font-black text-slate-800 text-sm flex items-center"><span class="mr-1.5 text-lg">ğŸ“¤</span>å°å¤–æ¡è³¼å–®ç‹€æ³</h3>
                        <div class="flex items-center space-x-1 text-[8px] font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-md border border-slate-200">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span><span>æ­£å¸¸</span>
                            <span class="w-2 h-2 rounded-full bg-red-500 ml-1 animate-pulse"></span><span>ç•°å¸¸/é²äº¤</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto no-scrollbar border border-slate-200 rounded-xl shadow-inner bg-slate-50 p-1">
                        <table class="w-full text-left text-[10px] whitespace-nowrap min-w-[300px]">
                            <thead class="text-slate-500 border-b border-slate-200"><tr><th class="p-2 font-bold w-16">æ¡è³¼å–®è™Ÿ</th><th class="p-2 font-bold">ä¾›æ‡‰å•†</th><th class="p-2 font-bold text-center">ç‹€æ…‹</th><th class="p-2 font-bold text-center">äº¤è²¨æ—¥</th></tr></thead>
                            <tbody id="ui-dash-po-status" class="divide-y divide-slate-100 bg-white rounded-lg"><tr><td colspan="4" class="p-4 text-center text-slate-400 font-bold">è³‡æ–™è¨ˆç®—ä¸­...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button onclick="openReqManagement()" class="glass-card p-5 rounded-[1.5rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-amber-200 hover:bg-amber-50 col-span-2 bg-amber-50/50">
                        <span class="text-3xl mb-2 drop-shadow-md">ğŸ“</span>
                        <span class="font-black text-amber-800 tracking-wider text-base mb-0.5">è«‹è³¼å–®ç®¡ç† (è™•ç†éœ€æ±‚)</span>
                        <span class="font-bold text-amber-600/70 text-[10px] tracking-wider">ç¨ç«‹åŸæ–™æŒ‡æ´¾ / ç”¢å‡º PDF æ¡è³¼å–®</span>
                    </button>
                    
                    <button onclick="openView('supplier-add', 'æ–°å»ºä¾›æ‡‰å•†è³‡æ–™')" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-indigo-200 hover:bg-indigo-50">
                        <span class="text-3xl mb-1.5 drop-shadow-md">ğŸ¢</span>
                        <span class="font-black text-slate-700 text-xs tracking-widest mb-0.5">æ–°å»ºä¾›æ‡‰å•†</span>
                    </button>

                    <button onclick="openHistory()" class="glass-card p-4 rounded-[1.5rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-slate-200 hover:bg-slate-50">
                        <span class="text-3xl mb-1.5 drop-shadow-md">ğŸ—‚ï¸</span>
                        <span class="font-black text-slate-700 text-xs tracking-widest mb-0.5">è«‹/æ¡è³¼ç´€éŒ„ä¸­å¿ƒ</span>
                    </button>
                </div>
            </div>

            <div id="view-supplier-add" class="view-panel space-y-5">
                <div class="glass-card p-5 rounded-[2rem] shadow-sm border-t-4 border-indigo-500">
                    <h3 class="font-black text-slate-800 pl-1 text-lg mb-4 flex items-center"><span class="mr-2">ğŸ¢</span> å»ºç«‹ä¾›æ‡‰å•†æª”æ¡ˆ</h3>
                    <form onsubmit="saveSupplier(event)" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2"><input type="text" id="s-name" placeholder="ä¾›æ‡‰å•†åç¨± (å¿…å¡«)" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 outline-none focus:border-indigo-500" required></div>
                            <div><input type="text" id="s-code" placeholder="å» å•†ä»£è™Ÿ (ä¾‹: S001)" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 uppercase outline-none focus:border-indigo-500" required></div>
                            <div><input type="text" id="s-tax" placeholder="çµ±ä¸€ç·¨è™Ÿ" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 outline-none focus:border-indigo-500"></div>
                            
                            <div class="col-span-2 border-t border-slate-100 pt-3"><h5 class="text-[10px] font-black text-slate-500 mb-2">ğŸ“ è¯çµ¡çª—å£</h5></div>
                            <div><input type="text" id="s-contact" placeholder="è¯çµ¡äººå§“å" class="w-full p-3 bg-white rounded-xl text-sm border border-slate-200 outline-none focus:border-indigo-500"></div>
                            <div><input type="text" id="s-phone" placeholder="è¯çµ¡é›»è©±" class="w-full p-3 bg-white rounded-xl text-sm border border-slate-200 outline-none focus:border-indigo-500"></div>

                            <div class="col-span-2 border-t border-slate-100 pt-3"><h5 class="text-[10px] font-black text-slate-500 mb-2">ğŸ’° è²¡å‹™èˆ‡ä»˜æ¬¾</h5></div>
                            <div class="col-span-2"><select id="s-pay" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border border-slate-200 select-arrow outline-none focus:border-indigo-500" required><option value="æœˆçµ30å¤©">æœˆçµ 30 å¤©</option><option value="æœˆçµ60å¤©">æœˆçµ 60 å¤©</option><option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾ (C.O.D)</option><option value="åŒ¯æ¬¾é ä»˜">åŒ¯æ¬¾é ä»˜ (T/T)</option></select></div>
                            <div class="col-span-2"><input type="text" id="s-bank" placeholder="åŒ¯æ¬¾éŠ€è¡Œå¸³è™Ÿè³‡è¨Š (éŠ€è¡Œ/ä»£ç¢¼/å¸³è™Ÿ/æˆ¶å)" class="w-full p-3 bg-white rounded-xl text-sm border border-slate-200 outline-none focus:border-indigo-500"></div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-md active:scale-95 transition tracking-widest text-base mt-4">ğŸ’¾ å„²å­˜ä¾›æ‡‰å•†æª”æ¡ˆ</button>
                    </form>
                </div>
            </div>

            <div id="view-req-management" class="view-panel space-y-4">
                <div class="glass-card p-4 md:p-5 rounded-[2rem] shadow-sm border-t-4 border-amber-600 relative pb-16">
                    <div class="flex flex-col mb-4 border-b border-slate-100 pb-3">
                        <h3 class="font-black text-slate-800 text-lg flex items-center mb-1"><span class="mr-2 text-xl">ğŸ“</span>è«‹è³¼å–®ç®¡ç†</h3>
                        <p class="text-[10px] text-slate-500 font-bold">å‹¾é¸å¾…è™•ç†çš„åŸæ–™ï¼Œ<strong class="text-amber-600">æŒ‡æ´¾ä¾›æ‡‰å•†</strong>å¾Œå¯ä¸€éµç”¢å‡º PDF æ¡è³¼å–®ã€‚</p>
                    </div>
                    
                    <div id="ui-pending-materials" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar pr-1 pb-10">
                        <p class="text-center text-xs text-slate-400 py-6">è¼‰å…¥ä¸­...</p>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-md border-t border-slate-200 rounded-b-[2rem]">
                        <button onclick="generatePO_PDF()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-black py-3.5 rounded-xl shadow-lg active:scale-95 transition tracking-widest text-sm flex justify-center items-center">
                            <span class="mr-2 text-lg">ğŸ–¨ï¸</span> ç¢ºèªç”¢å‡ºæ¡è³¼å–® (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-history" class="view-panel space-y-4">
                <div class="glass-card p-4 md:p-5 rounded-[2rem] shadow-sm border-t-4 border-slate-700 relative pb-10">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-slate-800 text-lg flex items-center"><span class="mr-2 text-xl">ğŸ—‚ï¸</span>è«‹è³¼å–®ã€æ¡è³¼å–®è¨˜éŒ„ä¸­å¿ƒ</h3>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-[11px] font-black text-sky-700 border-b border-sky-200 pb-1 mb-3">ğŸ“¥ å…§éƒ¨è«‹è³¼å–®ç´€éŒ„ (å¯ç·¨è¼¯/åˆªé™¤)</h4>
                        <div id="ui-hist-req" class="space-y-3 max-h-64 overflow-y-auto no-scrollbar pr-1"></div>
                    </div>

                    <div>
                        <h4 class="text-[11px] font-black text-amber-700 border-b border-amber-200 pb-1 mb-3">ğŸ“¤ å°å¤–æ¡è³¼å–®ç´€éŒ„ (å¯ç·¨è¼¯/åˆªé™¤)</h4>
                        <div id="ui-hist-po" class="space-y-3 max-h-64 overflow-y-auto no-scrollbar pr-1"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <nav id="core-bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-md border-t border-slate-200 flex justify-around text-[10px] font-bold text-slate-400 pb-5 pt-2 z-[9999] shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <div onclick="event.stopPropagation(); window.location.href='app_hr.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-sky-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ‘¨â€ğŸ’¼</span><span class="scale-90">å“¡å·¥</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_inventory.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-emerald-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ“¦</span><span class="scale-90">åº«å­˜</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_purchase.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition text-amber-600"><span class="text-xl mb-1">ğŸ›’</span><span class="scale-90">æ¡è³¼</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_sales.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-indigo-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ’¼</span><span class="scale-90">æ¥­å‹™</span></div>
        <div onclick="event.stopPropagation(); window.location.href='app_finance.html'" class="flex-1 flex flex-col items-center py-1 cursor-pointer transition hover:text-blue-600"><span class="text-xl mb-1 opacity-60 grayscale">ğŸ’°</span><span class="scale-90">è²¡å‹™</span></div>
    </nav>

    <script src="shared.js"></script>
    <script>
        window.supplierData = []; let pendingMats = [];

        function getSafeArray(data) {
            if (!data) return [];
            if (Array.isArray(data)) return data;
            try { return JSON.parse(data); } catch(e) { return []; }
        }

        async function safeUpdate(table, payload, id) {
            try { await window._sb.from(table).update(payload).eq('id', id); } catch(e) { console.error(`Update ${table} failed`, e); }
        }
        async function safeDelete(table, id) {
            try { await window._sb.from(table).delete().eq('id', id); } catch(e) { console.error(`Delete ${table} failed`, e); }
        }

        async function bootPurchase() {
            const isAuth = await authGuard('purchase'); 
            if(isAuth) { 
                document.getElementById('user-badge').innerText = window.currentUser?.full_name || 'ä½¿ç”¨è€…'; 
                await loadSuppliers();
                await loadDashboardData();
            }
        }

        async function loadSuppliers() {
            try {
                const { data } = await window._sb.from('suppliers').select('*').order('supplier_name', {ascending: true});
                window.supplierData = data || [];
            } catch(e) { window.supplierData = []; }
        }

        function openView(viewId, title) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-' + viewId).classList.add('active');
            document.getElementById('header-title').innerText = title; 
            document.getElementById('btn-back').classList.remove('hidden'); 
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function backToDash() { 
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-dashboard').classList.add('active'); 
            document.getElementById('header-title').innerText = 'æ¡è³¼ç®¡ç†ä¸­å¿ƒ'; 
            document.getElementById('btn-back').classList.add('hidden'); 
            loadDashboardData();
        }

        // ğŸŒŸ è‡ªå‹•å®¹éŒ¯ï¼šé›™è»ŒæƒæèˆŠè¡¨ purchase_orders çš„è³‡æ–™
        async function fetchSafeReqs() {
            let reqData = [];
            try {
                const { data: r1, error: e1 } = await window._sb.from('requisitions').select('*, employees(full_name)').order('created_at', {ascending: false});
                if (!e1 && r1) reqData = r1;
            } catch(e) {}

            try {
                const { data: r2 } = await window._sb.from('purchase_orders').select('*, employees(full_name)').in('status', ['å¾…è™•ç†', 'å·²å»ºæª”', 'æ¡è³¼ä¸­', 'è«‹è³¼å¾…è™•ç†']).order('created_at', {ascending: false});
                if (r2 && r2.length > 0) {
                    let oldReqs = r2.filter(x => x.note && x.note.startsWith('REQ-')).map(x => ({
                        id: x.id,
                        req_no: x.note,
                        employee_id: x.employee_id,
                        employees: x.employees,
                        items_json: x.raw_materials, 
                        status: (x.status === 'å·²å»ºæª”' || x.status === 'è«‹è³¼å¾…è™•ç†') ? 'å¾…è™•ç†' : x.status,
                        created_at: x.created_at,
                        is_legacy: true
                    }));
                    reqData = [...reqData, ...oldReqs];
                }
            } catch(e) { console.error('Fetch Reqs Error:', e); }
            return reqData;
        }

        async function fetchSafePOs() {
            let poData = [];
            try {
                const { data: pos } = await window._sb.from('po_documents').select('po_no, supplier_name, status, expected_date').order('expected_date', {ascending: true});
                if (pos && pos.length > 0) {
                    poData = pos.map(x => {
                        let parts = x.note.split('|||');
                        return {
                            id: x.id,
                            po_no: parts[0] || 'PO-UNKNOWN',
                            supplier_name: parts[1] || 'æœªæŒ‡å®šä¾›æ‡‰å•†',
                            status: x.status,
                            expected_date: x.expected_date || 'æœªå®š',
                            items_json: x.raw_materials,
                            created_at: x.created_at,
                            is_legacy: true
                        };
                    });
                }
            } catch(e) { console.error('Fetch POs Error:', e); }
            return poData;
        }

        async function loadDashboardData() {
            const reqs = await fetchSafeReqs();
            const reqContainer = document.getElementById('ui-dash-req-status');
            
            const thirtyDaysAgo = new Date(Date.now() - 30*24*60*60*1000);
            const recentReqs = reqs.filter(r => new Date(r.created_at) >= thirtyDaysAgo);

            if(!recentReqs || recentReqs.length === 0) { reqContainer.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 font-bold">è¿‘æœŸç„¡è«‹è³¼å–®</td></tr>'; }
            else {
                reqContainer.innerHTML = recentReqs.map(r => {
                    let stCol = r.status === 'å·²å®Œæˆ' ? 'text-emerald-700 bg-emerald-100 border-emerald-200' : (r.status === 'æ¡è³¼ä¸­' ? 'text-sky-700 bg-sky-100 border-sky-200' : 'text-amber-700 bg-amber-100 border-amber-200');
                    return `<tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                        <td class="p-2 font-mono font-black text-[9px] text-slate-600">${r.req_no.replace('REQ-','')}</td>
                        <td class="p-2 font-bold text-xs truncate max-w-[60px] text-slate-700">${r.employees?.full_name||'æœªçŸ¥'}</td>
                        <td class="p-2 text-center"><span class="text-[9px] font-black px-1.5 py-0.5 rounded border ${stCol}">${r.status}</span></td>
                        <td class="p-2 text-right font-bold text-[9px] text-slate-500">${new Date(r.created_at).toLocaleDateString('zh-TW').slice(5)}</td>
                    </tr>`;
                }).join('');
            }

            const pos = await fetchSafePOs();
            const poContainer = document.getElementById('ui-dash-po-status');
            
            if(!pos || pos.length === 0) { poContainer.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 font-bold">ç„¡é€²è¡Œä¸­çš„æ¡è³¼å–®</td></tr>'; }
            else {
                const today = new Date(); today.setHours(0,0,0,0);
                let poHtml = '';
                pos.forEach(po => {
                    let expDate = new Date(po.expected_date);
                    let diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                    let statusBadge = ''; let textClass = 'text-slate-700';
                    
                    if(po.status === 'å®Œæˆ' || po.status === 'POå®Œæˆ') {
                        statusBadge = '<span class="text-[9px] font-black text-emerald-700 bg-emerald-100 px-1.5 py-0.5 rounded border border-emerald-200">å®Œæˆ</span>';
                        textClass = 'text-emerald-700 font-bold';
                    } else if (po.status.includes('ç•°å¸¸') || po.status.includes('æ‹’æ”¶') || po.status.includes('é²äº¤')) {
                        statusBadge = `<span class="text-[9px] font-black text-white bg-red-600 px-1.5 py-0.5 rounded shadow-sm animate-pulse">${po.status.replace('PO','')}</span>`;
                        textClass = 'text-red-600 font-black';
                    } else {
                        if (diffDays < 0) {
                            statusBadge = '<span class="text-[9px] font-black text-white bg-red-500 px-1.5 py-0.5 rounded shadow-sm animate-pulse">é²äº¤</span>';
                            textClass = 'text-red-600 font-black';
                        } else if (diffDays <= 3) {
                            statusBadge = '<span class="text-[9px] font-black text-amber-700 bg-amber-100 px-1.5 py-0.5 rounded border border-amber-300">è­¦ç¤º</span>';
                            textClass = 'text-amber-600 font-black';
                        } else {
                            statusBadge = '<span class="text-[9px] font-black text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">å·²ç™¼é€</span>';
                        }
                    }

                    let dateText = (po.expected_date && po.expected_date !== 'æœªå®š') ? po.expected_date.slice(5) : 'æœªå®š';

                    poHtml += `<tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                        <td class="p-2 font-mono font-black text-[9px] ${textClass}">${po.po_no.replace('PO-','')}</td>
                        <td class="p-2 font-bold text-xs truncate max-w-[80px] ${textClass}">${po.supplier_name}</td>
                        <td class="p-2 text-center">${statusBadge}</td>
                        <td class="p-2 text-center font-bold text-[10px] ${textClass}">${dateText}</td>
                    </tr>`;
                });
                poContainer.innerHTML = poHtml;
            }
        }

        async function saveSupplier(e) {
            e.preventDefault();
            const p = { supplier_name: document.getElementById('s-name').value, supplier_code: document.getElementById('s-code').value.toUpperCase(), tax_id: document.getElementById('s-tax').value, contact_name: document.getElementById('s-contact').value, contact_phone: document.getElementById('s-phone').value, payment_method: document.getElementById('s-pay').value, bank_details: document.getElementById('s-bank').value };
            try { await window._sb.from('suppliers').insert([p]); alert('âœ… ä¾›æ‡‰å•†å»ºç«‹æˆåŠŸï¼'); e.target.reset(); await loadSuppliers(); backToDash(); } catch(err) { alert('å„²å­˜å¤±æ•—'); }
        }

        async function openReqManagement() {
            openView('req-management', 'ğŸ“ è«‹è³¼å–®ç®¡ç†');
            const container = document.getElementById('ui-pending-materials');
            container.innerHTML = '<p class="text-center text-xs text-slate-400 py-6">è®€å–ä¸­...</p>';
            
            const reqs = await fetchSafeReqs();
            const pending = reqs.filter(r => r.status === 'å¾…è™•ç†' || r.status === 'æ¡è³¼ä¸­');

            if(pending.length === 0) { container.innerHTML = '<p class="text-center text-sm font-bold text-slate-400 py-10 bg-slate-50 rounded-2xl border border-dashed border-slate-200">ç›®å‰ç„¡å¾…è™•ç†çš„è«‹è³¼éœ€æ±‚</p>'; return; }

            pendingMats = [];
            pending.forEach(req => {
                let itemsArr = getSafeArray(req.items_json);
                itemsArr.forEach((rm, idx) => {
                    pendingMats.push({ uid: `${req.id}_${idx}`, req_id: req.id, req_no: req.req_no, name: rm.name, qty: rm.qty, unit: rm.unit, is_legacy: req.is_legacy });
                });
            });

            const supOptions = '<option value="">(è«‹é¸æ“‡ä¾›æ‡‰å•†...)</option>' + window.supplierData.map(s => `<option value="${s.supplier_name}">${s.supplier_name}</option>`).join('');

            container.innerHTML = pendingMats.map(pm => `
                <div class="bg-white p-4 rounded-2xl border-2 border-slate-200 shadow-sm relative pending-mat-item" data-uid="${pm.uid}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-mono font-black text-sky-700 bg-sky-50 px-2 py-0.5 rounded border border-sky-200">ä¾†æº: ${pm.req_no}</span>
                        <label class="flex items-center space-x-1.5 cursor-pointer bg-white p-1 rounded-md z-10 border border-slate-200 shadow-sm"><input type="checkbox" class="w-4 h-4 accent-amber-600 print-chk"><span class="text-[10px] font-black text-slate-700">å‹¾é¸æ¡è³¼</span></label>
                    </div>
                    <div class="flex justify-between items-end mb-3 border-b border-slate-100 pb-3">
                        <h4 class="font-black text-base text-slate-800 leading-tight flex-1 pr-2">${pm.name}</h4>
                        <div class="text-right">
                            <span class="text-[9px] text-slate-500 font-bold block mb-0.5">éœ€æ±‚é‡</span>
                            <span class="font-black text-amber-600 text-lg tracking-tight leading-none">${parseFloat(pm.qty).toFixed(2)} <span class="text-[10px] text-slate-400">${pm.unit}</span></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[9px] font-bold text-slate-500 ml-1 block mb-1">æŒ‡æ´¾ä¾›æ‡‰å•†</label><select class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold text-slate-700 select-arrow focus:border-amber-500 outline-none pm-sup">${supOptions}</select></div>
                        <div><label class="text-[9px] font-bold text-slate-500 ml-1 block mb-1">è¦æ±‚åˆ°è²¨æ—¥</label><input type="date" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold focus:border-amber-500 outline-none pm-date" required></div>
                    </div>
                </div>
            `).join('');
        }

        async function generatePO_PDF() {
            const items = document.querySelectorAll('.pending-mat-item');
            let selected = []; let reqIdsToUpdate = []; let missingData = false;

            items.forEach(el => {
                const isChecked = el.querySelector('.print-chk').checked;
                if(isChecked) {
                    const uid = el.getAttribute('data-uid');
                    const pm = pendingMats.find(x => x.uid === uid);
                    const sup = el.querySelector('.pm-sup').value;
                    const date = el.querySelector('.pm-date').value;
                    if(!sup || !date) missingData = true;
                    selected.push({ ...pm, supplier: sup, expected_date: date });
                    reqIdsToUpdate.push({ id: pm.req_id, is_legacy: pm.is_legacy });
                }
            });

            if(selected.length === 0) { alert('è«‹è‡³å°‘å‹¾é¸ä¸€é …åŸæ–™ä»¥ç”¢å‡ºæ¡è³¼å–®ï¼'); return; }
            if(missingData) { alert('è«‹ç¢ºä¿å·²å‹¾é¸çš„é …ç›®çš†æœ‰é¸æ“‡ã€Œä¾›æ‡‰å•†ã€èˆ‡ã€Œåˆ°è²¨æ—¥ã€ï¼'); return; }

            let groupedPO = {};
            selected.forEach(s => {
                if(!groupedPO[s.supplier]) groupedPO[s.supplier] = { items: [], maxDate: s.expected_date };
                groupedPO[s.supplier].items.push(s);
                if(s.expected_date > groupedPO[s.supplier].maxDate) groupedPO[s.supplier].maxDate = s.expected_date;
            });

            const dateStr = new Date().toLocaleDateString('zh-TW');
            let printHtml = '';

            for (const [supName, data] of Object.entries(groupedPO)) {
                const poNo = 'PO-' + new Date().getFullYear() + String(new Date().getMonth()+1).padStart(2,'0') + String(new Date().getDate()).padStart(2,'0') + '-' + Math.floor(Math.random()*1000).toString().padStart(3,'0');
                
                try {
                    await window._sb.from('po_documents').insert([{ po_no: poNo, supplier_name: supName, expected_date: data.maxDate, items_json: data.items, status: 'å·²ç™¼é€' }]);
                } catch(e) { 
                    await window._sb.from('purchase_orders').insert([{ employee_id: window.currentUser?.id || null, status: 'POå·²ç™¼é€', note: poNo + '|||' + supName, raw_materials: data.items, expected_date: data.maxDate }]);
                }

                let tableRows = data.items.map((s, i) => `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; text-align: center;">${i+1}</td>
                        <td style="padding: 12px; font-weight: bold;">${s.name}</td>
                        <td style="padding: 12px; text-align: right; color: #d97706; font-weight: bold; font-size: 16px;">${parseFloat(s.qty).toFixed(2)}</td>
                        <td style="padding: 12px; text-align: center; font-size: 12px; color: #64748b;">${s.unit}</td>
                        <td style="padding: 12px; text-align: center; color: #ef4444; font-weight: bold;">${s.expected_date}</td>
                        <td style="padding: 12px; text-align: left; font-size: 10px; color: #94a3b8;">${s.req_no}</td>
                    </tr>
                `).join('');

                const supInfo = window.supplierData.find(x => x.supplier_name === supName) || {};

                printHtml += `
                    <div class="print-break" style="max-width: 800px; margin: 0 auto; padding: 40px; color: #1e293b; font-family: sans-serif;">
                        <div style="text-align: center; border-bottom: 4px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px;">
                            <h1 style="font-size: 36px; font-weight: 900; margin: 0; letter-spacing: 2px;">HYPASS æ¡è³¼å–®</h1>
                            <p style="font-size: 14px; color: #64748b; margin-top: 10px; font-weight: bold; letter-spacing: 1px;">PURCHASE ORDER</p>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; width: 45%;">
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #334155; border-bottom: 2px solid #cbd5e1; padding-bottom: 5px;">ä¾›æ‡‰å•†è³‡è¨Š</h3>
                                <p style="margin: 5px 0;"><strong>åç¨±ï¼š</strong>${supName}</p>
                                <p style="margin: 5px 0;"><strong>çµ±ç·¨ï¼š</strong>${supInfo.tax_id||'--'}</p>
                                <p style="margin: 5px 0;"><strong>è¯çµ¡äººï¼š</strong>${supInfo.contact_name||'--'} / ${supInfo.contact_phone||'--'}</p>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; width: 45%;">
                                <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #334155; border-bottom: 2px solid #cbd5e1; padding-bottom: 5px;">å–®æ“šè³‡è¨Š</h3>
                                <p style="margin: 5px 0;"><strong>å–®è™Ÿï¼š</strong><span style="font-family: monospace; font-weight: bold;">${poNo}</span></p>
                                <p style="margin: 5px 0;"><strong>æ—¥æœŸï¼š</strong>${dateStr}</p>
                                <p style="margin: 5px 0;"><strong>é–‹å–®äººï¼š</strong>${window.currentUser?.full_name||'ä½¿ç”¨è€…'}</p>
                            </div>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 30px;">
                            <thead style="background: #1e293b; color: white;">
                                <tr>
                                    <th style="padding: 12px; text-align: center; width: 50px;">é …æ¬¡</th>
                                    <th style="padding: 12px; text-align: left;">æ¡è³¼å“å/è¦æ ¼</th>
                                    <th style="padding: 12px; text-align: right;">æ•¸é‡</th>
                                    <th style="padding: 12px; text-align: center;">å–®ä½</th>
                                    <th style="padding: 12px; text-align: center;">æŒ‡å®šåˆ°è²¨æ—¥</th>
                                    <th style="padding: 12px; text-align: left;">ä¾†æºè«‹è³¼</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>

                        <div style="background: #fffbeb; border: 1px solid #fde68a; padding: 15px; border-radius: 8px; font-size: 12px; color: #92400e; margin-bottom: 40px;">
                            <strong>å‚™è¨»èªªæ˜ï¼š</strong><br>
                            1. ç…©è«‹æ–¼æŒ‡å®šåˆ°è²¨æ—¥å‰å®Œæˆäº¤è²¨ï¼Œè‹¥æœ‰å»¶é²è«‹æå‰å‘ŠçŸ¥ã€‚<br>
                            2. è«‹æ–¼å‡ºè²¨å–®/ç™¼ç¥¨ä¸Šè¨»æ˜æœ¬æ¡è³¼å–®è™Ÿï¼š${poNo}ã€‚<br>
                            3. ç´„å®šä»˜æ¬¾æ–¹å¼ï¼š${supInfo.payment_method||'ä¾åŸåˆç´„'}ã€‚
                        </div>

                        <div style="display: flex; justify-content: space-between; border-top: 2px solid #1e293b; padding-top: 20px;">
                            <div style="text-align: center; width: 200px;">
                                <p style="margin-bottom: 40px; color: #64748b;">æ¡è³¼ä¸»ç®¡ç°½æ ¸</p>
                                <div style="border-bottom: 1px solid #94a3b8;"></div>
                            </div>
                            <div style="text-align: center; width: 200px;">
                                <p style="margin-bottom: 40px; color: #64748b;">ä¾›æ‡‰å•†ç¢ºèªç°½å›</p>
                                <div style="border-bottom: 1px solid #94a3b8;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            try {
                let uniqueReqs = [];
                reqIdsToUpdate.forEach(r => { if(!uniqueReqs.some(x=>x.id===r.id)) uniqueReqs.push(r); });

                for(let req of uniqueReqs) { 
                    if(req.is_legacy) await safeUpdate('purchase_orders', {status: 'å·²å®Œæˆ'}, req.id);
                    else await safeUpdate('requisitions', {status: 'å·²å®Œæˆ'}, req.id);
                }
            } catch(e) { console.log('Update req error', e); }

            document.getElementById('po-print-zone').innerHTML = printHtml;
            
            setTimeout(() => { 
                window.print(); 
                alert('âœ… æ­£å¼æ¡è³¼å–® (PDF) å·²ç”Ÿæˆï¼\nåŸè«‹è³¼å–®å·²çµæ¡ˆã€‚');
                backToDash();
            }, 300);
        }

        async function openHistory() {
            openView('history', 'ğŸ—‚ï¸ è«‹è³¼å–®ã€æ¡è³¼å–®è¨˜éŒ„ä¸­å¿ƒ');
            const elReq = document.getElementById('ui-hist-req');
            const elPo = document.getElementById('ui-hist-po');
            elReq.innerHTML = 'è¼‰å…¥ä¸­...'; elPo.innerHTML = 'è¼‰å…¥ä¸­...';

            const reqs = await fetchSafeReqs();
            if(reqs && reqs.length > 0) {
                elReq.innerHTML = reqs.map(r => `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                        <div>
                            <span class="text-[10px] font-mono font-bold text-slate-500">${r.req_no}</span>
                            <span class="text-[9px] font-black ml-1 text-sky-700 bg-sky-50 px-1 rounded">${r.status}</span>
                            <p class="text-xs font-black text-slate-700 mt-0.5">${r.employees?.full_name||'æœªçŸ¥'} çš„éœ€æ±‚</p>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <select onchange="updateReqStatus('${r.id}', this.value, ${r.is_legacy?true:false})" class="text-[9px] p-1 border border-slate-300 rounded outline-none font-bold">
                                <option value="è«‹è³¼å¾…è™•ç†" ${r.status==='å¾…è™•ç†'?'selected':''}>å¾…è™•ç†</option>
                                <option value="æ¡è³¼ä¸­" ${r.status==='æ¡è³¼ä¸­'?'selected':''}>æ¡è³¼ä¸­</option>
                                <option value="å·²å®Œæˆ" ${r.status==='å·²å®Œæˆ'?'selected':''}>å·²å®Œæˆ</option>
                            </select>
                            <button onclick="delReq('${r.id}', ${r.is_legacy?true:false})" class="text-[9px] text-red-600 bg-red-50 px-2 py-1 rounded font-bold">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('');
            } else { elReq.innerHTML = '<p class="text-xs text-slate-400">ç„¡ç´€éŒ„</p>'; }

            const pos = await fetchSafePOs();
            if(pos && pos.length > 0) {
                elPo.innerHTML = pos.map(p => `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                        <div>
                            <span class="text-[10px] font-mono font-bold text-slate-500">${p.po_no}</span>
                            <span class="text-[9px] font-black ml-1 text-amber-700 bg-amber-50 px-1 rounded">${p.status.replace('PO','')}</span>
                            <p class="text-xs font-black text-slate-700 mt-0.5 truncate max-w-[120px]">${p.supplier_name}</p>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <select onchange="updatePOStatus('${p.id}', this.value, ${p.is_legacy?true:false})" class="text-[9px] p-1 border border-slate-300 rounded outline-none font-bold">
                                <option value="POå·²ç™¼é€" ${p.status==='POå·²ç™¼é€'?'selected':''}>å·²ç™¼é€</option>
                                <option value="POå®Œæˆ" ${p.status==='POå®Œæˆ'?'selected':''}>å®Œæˆ</option>
                                <option value="POç•°å¸¸(é²äº¤)" ${p.status==='POç•°å¸¸(é²äº¤)'?'selected':''}>ç•°å¸¸(é²äº¤)</option>
                                <option value="POç•°å¸¸(æ‹’æ”¶)" ${p.status==='POç•°å¸¸(æ‹’æ”¶)'?'selected':''}>ç•°å¸¸(æ‹’æ”¶)</option>
                            </select>
                            <button onclick="delPO('${p.id}', ${p.is_legacy?true:false})" class="text-[9px] text-red-600 bg-red-50 px-2 py-1 rounded font-bold">åˆªé™¤</button>
                        </div>
                    </div>
                `).join('');
            } else { elPo.innerHTML = '<p class="text-xs text-slate-400">ç„¡ç´€éŒ„</p>'; }
        }

        async function updateReqStatus(id, st, isLegacy) { if(isLegacy) await safeUpdate('purchase_orders', {status:st}, id); else await safeUpdate('requisitions', {status:st}, id); alert('æ›´æ–°æˆåŠŸ'); }
        async function delReq(id, isLegacy) { if(confirm('åˆªé™¤?')) { if(isLegacy) await safeDelete('purchase_orders', id); else await safeDelete('requisitions', id); openHistory(); } }
        async function updatePOStatus(id, st, isLegacy) { if(isLegacy) await safeUpdate('purchase_orders', {status:'PO'+st}, id); else await safeUpdate('po_documents', {status:st}, id); alert('æ›´æ–°æˆåŠŸ'); }
        async function delPO(id, isLegacy) { if(confirm('åˆªé™¤?')) { if(isLegacy) await safeDelete('purchase_orders', id); else await safeDelete('po_documents', id); openHistory(); } }

        window.onload = bootPurchase;

        const enforceNavObserver = new MutationObserver(() => { const oldNav = document.querySelector('nav:not(#core-bottom-nav)'); if (oldNav) oldNav.remove(); });
        enforceNavObserver.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
