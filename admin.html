<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPASS | ä¼æ¥­æŒ‡æ®ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #f8fafc; -webkit-tap-highlight-color: transparent; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;} 
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; } 
        @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} } 
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .glass-panel { background: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); border: 1px solid #e2e8f0; } 
        .admin-input { width: 100%; padding: 0.875rem; border: 1px solid #cbd5e1; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.2s; } 
        .admin-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); } 
        .modal { display: none; } .modal.active { display: flex; z-index: 100; } 
        .dt-btn.active { background-color: #0284c7; color: white; }
        .select-arrow { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-size: 1.5em 1.5em; background-position: right 0.5rem center; background-repeat: no-repeat; padding-right: 2rem; }
    </style>
</head>
<body class="text-slate-800 font-sans min-h-screen md:h-screen md:overflow-hidden md:flex bg-slate-50">

    <div id="login-box" class="flex flex-col items-center justify-center min-h-screen px-5 md:w-full z-50">
        <div class="glass-panel p-8 w-full max-w-sm text-center relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-sky-600 text-white text-[9px] font-bold px-2 py-1 rounded-bl-lg">ERP Admin</div>
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">ğŸ‘‘</div>
            <h2 class="text-2xl font-black mb-2 text-slate-800">æœ€é«˜æ¬Šé™é©—è­‰</h2>
            <p class="text-xs text-slate-500 mb-6">è«‹è¼¸å…¥ç®¡ç†é‡‘é‘°è§£é–æŒ‡æ®ä¸­å¿ƒ</p>
            <input type="password" id="pin" placeholder="PIN CODE" class="admin-input text-center text-2xl tracking-[0.5em] mb-6 bg-slate-50 font-black text-slate-700" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform">é©—è­‰ä¸¦ç™»å…¥</button>
        </div>
    </div>

    <div id="dashboard-ui" class="hidden flex-col md:flex-row h-screen w-full md:overflow-hidden">
        <header class="md:hidden bg-gradient-to-r from-slate-900 to-slate-800 text-white p-5 flex justify-between items-center shadow-lg sticky top-0 z-50 shrink-0">
            <div><h1 class="text-xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-300">HYPASS</h1><span class="text-[9px] text-slate-400 tracking-[0.2em] uppercase font-bold">Admin ERP</span></div>
            <button onclick="location.reload()" class="text-[10px] bg-white/10 border border-white/20 hover:bg-red-500 hover:border-red-500 px-3 py-1.5 rounded-full font-bold transition-all">å®‰å…¨ç™»å‡º</button>
        </header>

        <aside class="hidden md:flex w-64 bg-slate-900 text-white flex-col h-full shadow-2xl shrink-0 z-20 overflow-y-auto no-scrollbar">
            <div class="p-6 pb-2 border-b border-slate-800 mb-4"><h1 class="text-2xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-300">HYPASS</h1><span class="text-[10px] text-slate-400 tracking-[0.2em] uppercase font-bold">Admin Dashboard</span></div>
            <nav class="flex-1 px-4 space-y-2 pb-6">
                <button onclick="st('pend')" id="dt-pend" class="dt-btn active w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ”´</span> å¾…è¾¦å¯©æ ¸</button>
                <button onclick="st('pay')" id="dt-pay" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ’°</span> ç¶œåˆè–ªè³‡ç™¼æ”¾</button>
                <button onclick="st('emps')" id="dt-emps" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ‘¥</span> å“¡å·¥ç¸½è¡¨/é›¢è·</button>
                <button onclick="st('att')" id="dt-att" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“‹</span> å‡ºå‹¤ç´€éŒ„å¤§ç›¤</button>
                <button onclick="st('inv')" id="dt-inv" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“¦</span> åº«å­˜æ¸…å–®ç®¡ç†</button>
                <button onclick="st('brs')" id="dt-brs" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“</span> ä¼æ¥­æ“šé»ç®¡ç†</button>
                <button onclick="st('bull')" id="dt-bull" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“¢</span> ç³»çµ±å…¬å‘Šæ¨æ’­</button>
            </nav>
            <div class="p-4 border-t border-slate-800"><button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-red-500 text-slate-300 hover:text-white py-3 rounded-xl font-bold transition">å®‰å…¨ç™»å‡º</button></div>
        </aside>

        <main class="flex-1 overflow-y-auto w-full p-4 md:p-8 bg-slate-50">
            <div class="grid grid-cols-3 gap-3 mb-8 md:hidden">
                <button onclick="st('pend')" id="m-pend" class="m-btn active flex flex-col items-center justify-center py-4 bg-slate-900 text-white rounded-2xl shadow-md border border-transparent transition-all"><span class="text-3xl mb-1.5 drop-shadow-md">ğŸ”´</span><span class="m-text text-xs font-black tracking-widest">å¾…è¾¦å¯©æ ¸</span></button>
                <button onclick="st('pay')" id="m-pay" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm">ğŸ’°</span><span class="m-text text-xs font-bold tracking-widest">è–ªè³‡ç™¼æ”¾</span></button>
                <button onclick="st('emps')" id="m-emps" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ‘¥</span><span class="m-text text-xs font-bold tracking-widest">å“¡å·¥/é›¢è·</span></button>
                <button onclick="st('att')" id="m-att" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“‹</span><span class="m-text text-xs font-bold tracking-widest">å‡ºå‹¤å¤§ç›¤</span></button>
                <button onclick="st('inv')" id="m-inv" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“¦</span><span class="m-text text-xs font-bold tracking-widest">åº«å­˜æ¸…å–®</span></button>
                <button onclick="st('brs')" id="m-brs" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“</span><span class="m-text text-xs font-bold tracking-widest">æ“šé»ç®¡ç†</span></button>
                <button onclick="st('bull')" id="m-bull" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm col-span-3"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“¢</span><span class="m-text text-xs font-bold tracking-widest">ç³»çµ±å…¬å‘Šæ¨æ’­</span></button>
            </div>

            <section id="pend" class="tab-content active space-y-6 max-w-4xl">
                <div>
                    <h3 class="font-black text-slate-800 border-l-4 border-blue-500 pl-3 text-lg mb-3">æ–°é€²å“¡å·¥å¯©æ ¸</h3>
                    <div id="list-pend" class="space-y-3"></div>
                </div>
                <div>
                    <h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-3">ç°½æ ¸ä¸­å¿ƒ (å«è£œç™»ç”³è«‹)</h3>
                    <div id="list-leaves" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </section>

            <section id="pay" class="tab-content space-y-6 max-w-4xl">
                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-[1.5rem] shadow-lg text-white relative overflow-hidden"><div class="absolute -right-4 -bottom-4 text-7xl opacity-20">ğŸ¦</div><h3 class="font-black text-lg mb-1 relative z-10">éŠ€è¡Œè–ªè³‡è½‰å¸³æª” (CSV)</h3><p class="text-xs text-emerald-100 mb-4 relative z-10 font-medium">æ”¯æ´éŠ€è¡Œä»£ç¢¼ï¼Œå¯ç›´æ¥åŒ¯å…¥ç¶²éŠ€æ‰¹æ¬¡è½‰å¸³</p><div class="flex space-x-2 relative z-10"><input type="month" id="export-mon" class="admin-input bg-white/20 border-white/30 text-white placeholder-white/50 flex-1" style="color-scheme: dark;"><button onclick="exportBankCSV()" class="bg-white text-emerald-700 font-black px-5 py-3 rounded-xl shadow-md active:scale-95 transition">ç«‹å³ä¸‹è¼‰</button></div></div>
                
                <div class="glass-panel p-6 space-y-4 border-t-4 border-indigo-500">
                    <h3 class="font-black text-slate-800 pl-1 text-lg mb-4 flex items-center"><span class="mr-2">ğŸ’°</span>ç¶œåˆè–ªè³‡èˆ‡å¹´çµ‚ç™¼æ”¾ä¸­å¿ƒ</h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <select id="p-emp" class="admin-input bg-slate-50 font-bold select-arrow" onchange="onEmpChange()"></select>
                        <input type="month" id="p-mon" class="admin-input bg-slate-50 font-bold" onchange="updateAttendanceRate()">
                    </div>
                    
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[10px] font-bold text-slate-500 ml-1">ç•¶æœˆæœ¬è–ª</label><input type="number" id="p-base" oninput="calcPayroll()" class="admin-input font-black text-slate-800 bg-white"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 ml-1">ç•¶æœˆçé‡‘æ´¥è²¼</label><input type="number" id="p-bonus" oninput="calcPayroll()" class="admin-input font-black text-emerald-600 bg-white"></div>
                        </div>
                        
                        <div class="border-t border-slate-200 pt-4">
                            <label class="flex items-center space-x-2 cursor-pointer text-sm font-black text-amber-700 mb-2 p-2 hover:bg-amber-50 rounded-lg transition select-none">
                                <input type="checkbox" id="toggle-yeb" class="w-5 h-5 accent-amber-500" onchange="handleYebToggle()">
                                <span>ğŸ å•Ÿç”¨å¹´çµ‚çé‡‘èˆ‡æœªä¼‘ç‰¹ä¼‘çµç®— (å¹´åº•/å¹´åˆé©ç”¨)</span>
                            </label>
                            
                            <div id="yeb-section" class="hidden grid grid-cols-2 gap-3 bg-amber-50 p-4 rounded-xl border border-amber-200 shadow-inner">
                                <div>
                                    <label class="text-[11px] font-black text-amber-800 ml-1">æ ¸å®šå¹´çµ‚çé‡‘</label>
                                    <input type="number" id="p-yeb" oninput="calcPayroll()" class="admin-input font-black text-amber-600 bg-white border-amber-300 text-lg mt-1" value="0">
                                </div>
                                <div>
                                    <label class="text-[11px] font-black text-emerald-700 ml-1 flex justify-between"><span>æœªä¼‘ç‰¹ä¼‘çµç®—</span><span class="text-[9px] text-emerald-600/70 font-bold mt-0.5">ç³»çµ±è‡ªå‹•æ›ç®—</span></label>
                                    <input type="number" id="p-ulp" oninput="calcPayroll()" class="admin-input font-black text-emerald-600 bg-white border-emerald-300 text-lg mt-1" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                        <div class="flex justify-between items-center mb-2"><h4 class="text-[10px] font-black text-indigo-800 tracking-widest">ğŸ¤– ç•¶æœˆå‡ºå‹¤åˆ†æ (ä¾ä¸Šæ–¹æœˆä»½)</h4><button onclick="updateAttendanceRate()" class="text-[9px] bg-indigo-200 text-indigo-800 px-2 py-1 rounded font-bold hover:bg-indigo-300">é‡æ–°è®€å–</button></div>
                        <div class="grid grid-cols-6 gap-1 text-center text-[10px] font-bold text-slate-600 bg-white p-2 rounded-lg border border-indigo-100 shadow-sm mb-3">
                            <div>ç—…å‡<br><span id="sd-sick" class="text-indigo-600 text-sm font-black">0</span>h</div>
                            <div>äº‹å‡<br><span id="sd-per" class="text-indigo-600 text-sm font-black">0</span>h</div>
                            <div>é¢±é¢¨<br><span id="sd-typ" class="text-indigo-600 text-sm font-black">0</span>h</div>
                            <div>é²åˆ°<br><span id="sd-lat" class="text-indigo-600 text-sm font-black">0</span>æ¬¡</div>
                            <div>åŠ ç­<br><span id="sd-ovt" class="text-emerald-600 text-sm font-black">0</span>h</div>
                            <div>è¨ˆé»<br><span id="sd-pnt" class="text-red-600 text-sm font-black">0</span>æ¬¡</div>
                        </div>
                        <div class="flex space-x-3"><div class="flex-1"><label class="text-[10px] font-bold text-indigo-800 ml-1">è«‹å‡æ‰£è–ªç¸½é¡ (ç³»çµ±ç²¾ç®—)</label><input type="number" id="p-lvd" oninput="calcNet()" class="admin-input font-black text-indigo-600 border-indigo-200 bg-white" value="0"></div></div>
                    </div>

                    <div class="p-4 bg-amber-50 rounded-xl border border-amber-200 shadow-sm">
                        <h4 class="text-[10px] font-black text-amber-800 tracking-widest mb-2 flex justify-between items-center"><span>ğŸ“Š ç•¶å¹´åº¦å‡ºå‹¤èˆ‡ç´€å¾‹ç¸½è©•ä¼° (ä¾ä¸Šæ–¹å¹´ä»½)</span></h4>
                        <div class="grid grid-cols-3 gap-2 text-center text-[11px] font-bold text-slate-600 bg-white p-3 rounded-lg border border-amber-100 shadow-inner">
                            <div>æœªä¼‘ç‰¹ä¼‘<br><span id="sy-ann" class="text-amber-600 text-base font-black">0</span>h</div>
                            <div>äº‹å‡<br><span id="sy-per" class="text-amber-600 text-base font-black">0</span>h</div>
                            <div>ç—…å‡<br><span id="sy-sic" class="text-amber-600 text-base font-black">0</span>h</div>
                            <div>é²åˆ°<br><span id="sy-lat" class="text-amber-600 text-base font-black">0</span>æ¬¡</div>
                            <div>åŠ ç­<br><span id="sy-ovt" class="text-emerald-600 text-base font-black">0</span>h</div>
                            <div>è¨ˆé»<br><span id="sy-pnt" class="text-red-600 text-base font-black">0</span>æ¬¡</div>
                        </div>
                        <p class="text-[9px] text-amber-700 mt-2 font-bold leading-relaxed">â€» å¹´çµ‚ç™¼æ”¾åŸºæº–ï¼šå‹åŸºæ³•è¦å®šï¼Œä¸Šè¿°å¹´åº¦ä¹‹è€ƒå‹¤èˆ‡é•è¦è¨ˆé»ç‹€æ³å¯ä½œç‚ºå¹´çµ‚çé‡‘èˆ‡ç¸¾æ•ˆç™¼æ”¾ä¹‹è©•ä¼°ä¾æ“šã€‚</p>
                    </div>
                    
                    <div class="p-4 bg-red-50 rounded-xl border border-red-100 grid grid-cols-2 gap-3 relative"><button onclick="calcPayroll()" class="absolute -top-3 right-3 text-[9px] bg-slate-800 text-white font-bold px-2 py-1 rounded shadow-sm">ğŸ¤– ä¾çœ·å±¬é‡æ–°è¨ˆç®—</button><div><label class="text-[10px] font-bold text-red-800 ml-1">å‹å¥ä¿æ‰£é™¤</label><input type="number" id="p-ins" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200 bg-white"></div><div><label class="text-[10px] font-bold text-red-800 ml-1">äºŒä»£å¥ä¿ (å«å¹´çµ‚)</label><input type="number" id="p-2nd" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200 bg-white"></div></div>
                    
                    <div class="flex justify-between items-center p-5 mt-2 bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl border border-sky-200 shadow-inner"><span class="text-sm font-black text-slate-700">ç¶œåˆçµç®—å¯¦é ˜</span><span class="text-4xl font-black text-sky-600 tracking-tighter" id="p-net-display">NT$ 0</span><input type="hidden" id="p-net"><input type="hidden" id="p-pen"></div>
                    
                    <button onclick="issuePayroll()" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform mt-2 tracking-widest text-lg">ğŸš€ æ­£å¼ç™¼é€ç¶œåˆè–ªè³‡å–®</button>
                </div>

                <div class="glass-panel p-6 space-y-4 border-t-4 border-slate-600">
                    <h3 class="font-black text-slate-800 pl-1 text-lg mb-4 flex items-center"><span class="mr-2">ğŸ“œ</span>æ­·å²è–ªè³‡å–®ç®¡ç† (å‰å°å³æ™‚åŒæ­¥)</h3>
                    <select id="hist-emp" class="admin-input bg-slate-50 font-bold mb-4 select-arrow" onchange="loadPayrollHistory()"></select>
                    <div id="ui-payroll-hist" class="space-y-3 max-h-[400px] overflow-y-auto pr-1 no-scrollbar">
                        <div class="text-center text-xs text-slate-400 py-6 bg-slate-50 rounded-xl border border-dashed border-slate-300">è«‹å…ˆé¸æ“‡å“¡å·¥ä»¥è¼‰å…¥æ­·å²è–ªè³‡å–®</div>
                    </div>
                </div>
            </section>

            <section id="emps" class="tab-content space-y-5 max-w-6xl">
                <div>
                    <h3 class="font-black text-slate-800 border-l-4 border-sky-500 pl-3 text-lg mb-4">å“¡å·¥è³‡æ–™ç¸½è¡¨èˆ‡ç®¡ç†</h3>
                    <div id="list-emps-mobile" class="space-y-3 md:hidden">è¼‰å…¥ä¸­...</div>
                    <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold">
                                <tr>
                                    <th class="px-6 py-4">ç·¨è™Ÿ</th>
                                    <th class="px-6 py-4">å§“å / æ“šé»</th>
                                    <th class="px-6 py-4">è¯çµ¡é›»è©±</th>
                                    <th class="px-6 py-4">æ ¸å®šåº•è–ª</th>
                                    <th class="px-6 py-4 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="list-emps-desktop" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="inv" class="tab-content space-y-5 max-w-6xl">
                <div>
                    <h3 class="font-black text-slate-800 border-l-4 border-emerald-500 pl-3 text-lg mb-4">åº«å­˜æ¸…å–®èˆ‡æ–™è™Ÿç®¡ç†</h3>
                    <div class="glass-panel p-5 shadow-sm mb-4 flex space-x-2">
                        <select id="admin-inv-cat-filter" class="w-1/3 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold outline-none select-arrow shadow-inner" onchange="filterAdminInventory()">
                            <option value="">å…¨éƒ¨åˆ†é¡</option>
                        </select>
                        <input type="text" id="admin-inv-search" placeholder="ğŸ” æœå°‹æ–™è™Ÿ/å“å/è¦æ ¼..." class="w-2/3 admin-input bg-slate-50 font-bold shadow-inner" onkeyup="filterAdminInventory()">
                    </div>
                    <div id="list-inv-mobile" class="space-y-3 md:hidden">è¼‰å…¥ä¸­...</div>
                    <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold">
                                <tr><th class="px-6 py-4">æ–™è™Ÿ / å“å / è¦æ ¼</th><th class="px-6 py-4 text-right">ç•¶å‰åº«å­˜</th><th class="px-6 py-4 text-right">å®‰å…¨ä½æ°´ä½(ä»¶)</th><th class="px-6 py-4 text-center">ç”Ÿç”¢é€±æœŸ</th><th class="px-6 py-4 text-center">æ“ä½œ</th></tr>
                            </thead>
                            <tbody id="list-inv-desktop" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="att" class="tab-content space-y-5 max-w-6xl">
                <h3 class="font-black text-slate-800 border-l-4 border-slate-500 pl-3 text-lg mb-4">å…¨é«”å‡ºå‹¤ç‹€æ…‹ç¸½è¦½</h3>
                <div class="glass-panel p-5 shadow-sm mb-4 max-w-sm"><label class="text-[10px] font-bold text-slate-500 ml-1 block mb-2">è«‹é¸æ“‡æŸ¥è©¢æ—¥æœŸ</label><input type="date" id="att-date" onchange="loadAttendance()" class="admin-input bg-slate-50 font-black text-lg shadow-inner"></div>
                <div id="list-attendance-mobile" class="space-y-3 pb-8 md:hidden">è«‹é¸æ“‡æ—¥æœŸ...</div>
                <div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold"><tr><th class="px-6 py-4">å“¡å·¥å§“å</th><th class="px-6 py-4">æ’å®šç­åˆ¥</th><th class="px-6 py-4">ä¸Šç­æ‰“å¡</th><th class="px-6 py-4">ä¸‹ç­æ‰“å¡</th></tr></thead><tbody id="list-attendance-desktop" class="divide-y divide-slate-100"><tr><td colspan="4" class="px-6 py-8 text-center text-slate-400 font-bold">è«‹é¸æ“‡æ—¥æœŸ...</td></tr></tbody></table></div>
            </section>

            <section id="brs" class="tab-content space-y-5 max-w-4xl">
                <div class="glass-panel p-6 shadow-sm mb-4">
                    <h3 class="font-black text-slate-800 border-l-4 border-emerald-500 pl-3 text-lg mb-4" id="br-form-title">æ–°å¢æ‰“å¡æ“šé»</h3>
                    <input type="hidden" id="b-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3"><input type="text" id="b-n" placeholder="åˆ†åº—åç¨±" class="admin-input font-bold"><input type="text" id="b-a" placeholder="åœ°å€" class="admin-input bg-white"></div>
                    <div class="grid grid-cols-2 gap-3 mb-5"><input type="number" step="any" id="b-la" placeholder="ç·¯åº¦" class="admin-input bg-slate-50 font-mono text-sm shadow-inner" required><input type="number" step="any" id="b-ln" placeholder="ç¶“åº¦" class="admin-input bg-slate-50 font-mono text-sm shadow-inner" required></div>
                    <div class="flex space-x-2"><button type="button" onclick="cancelEditBr()" id="btn-cancel-br" class="hidden w-1/3 bg-slate-200 text-slate-700 font-bold py-3.5 rounded-xl shadow-sm active:scale-95 transition">å–æ¶ˆ</button><button onclick="saveBr()" id="btn-save-br" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-black py-3.5 rounded-xl shadow-md active:scale-95 transition tracking-widest">å„²å­˜æ–°æ“šé»</button></div>
                </div>
                <h4 class="font-black text-sm text-slate-600 px-2">ç¾æœ‰æ“šé»æ¸…å–®</h4>
                <div id="list-brs" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </section>
            
            <section id="bull" class="tab-content space-y-5 max-w-4xl">
                <div class="glass-panel p-6 shadow-sm"><h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-4" id="blt-form-title">ç™¼å¸ƒä¼æ¥­é›»å­å…¬å‘Š</h3><input type="hidden" id="blt-edit-id"><input type="text" id="blt-title" placeholder="ä¸»æ—¨æ¨™é¡Œ" class="admin-input mb-3 font-bold text-lg"><textarea id="blt-content" placeholder="è«‹è¼¸å…¥è©³ç´°å…¬å‘Šå…§å®¹..." class="admin-input mb-5 h-40 resize-none leading-relaxed shadow-inner"></textarea><div class="flex space-x-2"><button type="button" onclick="cancelEditBlt()" id="btn-cancel-blt" class="hidden w-1/3 bg-slate-200 text-slate-700 font-bold py-4 rounded-xl shadow-sm active:scale-95 transition-transform">å–æ¶ˆç·¨è¼¯</button><button onclick="postBlt()" id="btn-post-blt" class="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform tracking-widest">ç«‹å³æ¨æ’­è‡³å…¨å“¡é¦–é </button></div></div>
                <div class="glass-panel p-6 shadow-sm"><h3 class="font-black text-slate-600 text-sm mb-3">å·²å…¬å‘Šæ­·å²ç´€éŒ„</h3><div id="list-admin-blt" class="space-y-3">è¼‰å…¥ä¸­...</div></div>
            </section>
        </main>
    </div>

    <div id="payroll-edit-modal" class="modal fixed inset-0 bg-slate-900/70 backdrop-blur-sm items-center justify-center p-5 z-[100]">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 relative flex flex-col shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-black text-lg border-b pb-3 mb-4 text-slate-800">âœï¸ ç·¨è¼¯æ­·å²è–ªè³‡å–®</h3>
            <input type="hidden" id="edit-pr-id">
            <div class="space-y-3">
                <div><label class="text-[10px] font-bold text-slate-500 ml-1">ç™¼æ”¾æœˆä»½</label><input type="text" id="edit-pr-month" class="admin-input font-bold bg-slate-100 text-slate-500" disabled></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">æœ¬è–ª</label><input type="number" id="edit-pr-base" class="admin-input font-black bg-slate-50" oninput="calcEditPayrollNet()"></div>
                    <div><label class="text-[10px] font-bold text-emerald-600 ml-1">çé‡‘æ´¥è²¼</label><input type="number" id="edit-pr-bonus" class="admin-input font-black text-emerald-600 bg-emerald-50 border-emerald-200" oninput="calcEditPayrollNet()"></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-amber-600 ml-1">å¹´çµ‚çé‡‘</label><input type="number" id="edit-pr-yeb" class="admin-input font-black text-amber-600 bg-amber-50 border-amber-200" oninput="calcEditPayrollNet()"></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-sky-600 ml-1">æœªä¼‘ç‰¹ä¼‘çµç®—</label><input type="number" id="edit-pr-ulp" class="admin-input font-black text-sky-600 bg-sky-50 border-sky-200" oninput="calcEditPayrollNet()"></div>
                    
                    <div><label class="text-[10px] font-bold text-red-600 ml-1">å‹å¥ä¿æ‰£é™¤</label><input type="number" id="edit-pr-ins" class="admin-input font-black text-red-600 bg-red-50 border-red-200" oninput="calcEditPayrollNet()"></div>
                    <div><label class="text-[10px] font-bold text-red-600 ml-1">äºŒä»£å¥ä¿</label><input type="number" id="edit-pr-2nd" class="admin-input font-black text-red-600 bg-red-50 border-red-200" oninput="calcEditPayrollNet()"></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-red-600 ml-1">è«‹å‡æ‰£è–ª</label><input type="number" id="edit-pr-lvd" class="admin-input font-black text-red-600 bg-red-50 border-red-200" oninput="calcEditPayrollNet()"></div>
                </div>
                <div class="flex justify-between items-center bg-slate-100 p-4 rounded-xl mt-3 border border-slate-200 shadow-inner">
                    <span class="font-bold text-slate-600">é‡ç®—å¯¦é ˜ç¸½é¡</span>
                    <span id="edit-pr-net" class="text-2xl font-black text-sky-600 tracking-tight">NT$ 0</span>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button onclick="closeModal('payroll-edit-modal')" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3.5 rounded-xl transition">å–æ¶ˆ</button>
                <button onclick="saveEditPayroll()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-black py-3.5 rounded-xl transition shadow-md tracking-widest">å„²å­˜ä¸¦è¦†å¯«</button>
            </div>
        </div>
    </div>

    <div id="item-edit-modal" class="modal fixed inset-0 bg-slate-900/70 backdrop-blur-sm items-center justify-center p-5 z-[100]">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 relative flex flex-col shadow-2xl">
            <h3 class="font-black text-lg border-b pb-3 mb-4 text-slate-800 flex items-center"><span class="mr-2">âœï¸</span> ä¿®æ”¹åº«å­˜æ–™è™Ÿ</h3>
            <input type="hidden" id="edit-item-id">
            <div class="space-y-3">
                <div><label class="text-[10px] font-bold text-slate-500 ml-1">å“å</label><input type="text" id="edit-item-name" class="admin-input font-bold bg-slate-50"></div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 ml-1">é¡åˆ¥</label>
                    <select id="edit-item-cat" class="admin-input bg-white font-bold select-arrow">
                        <option value="æ±½è»Šå†·æ°£æ¿¾ç¶²">æ±½è»Šå†·æ°£æ¿¾ç¶²</option><option value="VESTAç³»åˆ—ç”¢å“">VESTAç³»åˆ—ç”¢å“</option><option value="å¡å¡å¸ç®¡">å¡å¡å¸ç®¡</option><option value="ç©ºæ°£ç“¶å­">ç©ºæ°£ç“¶å­</option><option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-red-600 ml-1">å®‰å…¨åº«å­˜ä½æ°´ä½(ä»¶)</label><input type="number" id="edit-item-safe" class="admin-input font-black text-red-600 bg-red-50 border-red-200"></div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 ml-1">ç”Ÿç”¢é€±æœŸ</label>
                        <select id="edit-item-lead" class="admin-input bg-white font-bold select-arrow">
                            <option value="15">15 å¤©</option><option value="30">30 å¤©</option><option value="45">45 å¤©</option><option value="60">60 å¤©</option><option value="90">90 å¤©</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex space-x-3 mt-6">
                <button onclick="closeModal('item-edit-modal')" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3.5 rounded-xl transition">å–æ¶ˆ</button>
                <button onclick="saveAdminItem()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-black py-3.5 rounded-xl transition shadow-md tracking-widest">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <div id="emp-detail-modal" class="modal fixed inset-0 bg-slate-900/70 backdrop-blur-sm items-end justify-center pb-0 z-[100] md:items-center">
        <div class="bg-slate-50 w-full max-w-3xl md:max-w-4xl rounded-t-[2rem] md:rounded-3xl h-[92vh] flex flex-col shadow-2xl relative overflow-hidden">
            <div class="bg-white flex justify-between items-center p-5 md:p-6 border-b border-slate-200 shrink-0 shadow-sm z-10">
                <h3 class="font-black text-xl text-slate-800 flex items-center"><span class="text-2xl mr-2">ğŸªª</span>å“¡å·¥æª”æ¡ˆç®¡ç†ä¸­å¿ƒ</h3>
                <div class="flex space-x-2">
                    <button id="btn-edit-emp" class="bg-sky-50 hover:bg-sky-600 text-sky-700 hover:text-white border border-sky-200 px-4 py-2 rounded-full font-black text-xs transition shadow-sm">âœï¸ ç·¨è¼¯è³‡æ–™</button>
                    <button onclick="document.getElementById('emp-detail-modal').classList.remove('active')" class="bg-slate-100 hover:bg-slate-800 text-slate-600 hover:text-white px-4 py-2 rounded-full font-black text-xs transition shadow-sm">âœ• é—œé–‰</button>
                </div>
            </div>
            <div class="overflow-y-auto p-5 md:p-8 space-y-6 flex-1 no-scrollbar">
                <div id="ui-emp-full-info"></div>
                <div class="bg-white p-6 rounded-2xl border border-red-200 shadow-sm" id="ui-emp-offboard-section">
                    <h4 class="font-black text-red-700 mb-3 border-l-4 border-red-500 pl-2 text-lg">âš–ï¸ é›¢è·èˆ‡è³‡é£çµç®—ä½œæ¥­</h4>
                    <p class="text-xs text-slate-500 mb-5 bg-slate-50 p-3 rounded-xl leading-relaxed border border-slate-100">åŸ·è¡Œçµç®—å¾Œï¼Œç³»çµ±å°‡çµæ¸…æ‰€æœ‰æ™‚æ•¸èˆ‡è³‡é£è²»ï¼Œä¸¦<strong class="text-red-600">æ°¸ä¹…åœæ¬Šè©²å“¡å·¥ç™»å…¥è³‡æ ¼</strong>ã€‚</p>
                    <div class="grid grid-cols-2 gap-4 mb-5"><div><label class="text-[10px] font-bold text-slate-500 ml-1 block mb-1">é›¢è·é¡åˆ¥</label><select id="modal-off-type" class="admin-input font-bold bg-slate-50 select-arrow"><option value="è‡ªé¡˜é›¢è·">è‡ªé¡˜é›¢è· (ç„¡è³‡é£è²»)</option><option value="éè‡ªé¡˜é›¢è·(è³‡é£)">éè‡ªé¡˜è³‡é£ (å«è³‡é£è²»)</option></select></div><div><label class="text-[10px] font-bold text-slate-500 ml-1 block mb-1">æœ€å¾Œå·¥ä½œæ—¥</label><input type="date" id="modal-off-date" class="admin-input bg-slate-50 font-bold"></div></div>
                    <button onclick="calculateSettlement()" class="w-full border-2 border-slate-800 text-slate-800 font-black py-3.5 rounded-xl hover:bg-slate-800 hover:text-white transition-colors tracking-widest shadow-sm">âš™ï¸ ç”¢ç”Ÿçµç®—å ±è¡¨</button>
                    <div id="modal-off-result" class="hidden mt-6 border-t border-slate-200 pt-5 space-y-2"><h5 class="font-black text-slate-800 mb-4 text-center bg-slate-100 py-2 rounded-lg text-sm tracking-widest shadow-inner">çµç®—æ˜ç´°é è¦½</h5><div class="flex justify-between text-sm px-2"><span class="font-bold text-slate-500">æ ¸ç®—åŸºæº–åº•è–ª</span><span id="res-base" class="font-black text-slate-700">NT$ 0</span></div><div class="flex justify-between text-sm px-2"><span class="font-bold text-slate-500">1. ç•¶æœˆç ´æœˆè–ªè³‡</span><span id="res-pro" class="font-black text-emerald-600">+ NT$ 0</span></div><div class="flex justify-between text-sm px-2"><span class="font-bold text-slate-500">2. æœªä¼‘ç‰¹ä¼‘æ›ç¾ (<span id="res-lvh">0</span> Hrs)</span><span id="res-lvp" class="font-black text-emerald-600">+ NT$ 0</span></div><div class="flex justify-between text-sm px-2 border-b border-slate-100 pb-4"><span class="font-bold text-slate-500">3. å‹åŸºæ³•è³‡é£è²»</span><span id="res-sev" class="font-black text-amber-600">+ NT$ 0</span></div><div class="flex justify-between text-base items-end pt-2 px-2"><span class="font-black text-slate-800">ç¸½è¨ˆæ‡‰ç™¼æ”¾</span><span id="res-total" class="text-3xl font-black text-red-600 tracking-tight">NT$ 0</span></div><button onclick="confirmOffboarding()" class="w-full bg-red-600 hover:bg-red-700 text-white font-black py-4.5 rounded-xl shadow-lg mt-6 active:scale-95 transition-all tracking-widest text-lg">âš ï¸ ç¢ºèªçµç®—ä¸¦ç«‹å³åœæ¬Š</button></div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared.js"></script>
    <script>
        let globalOffboardData = null; window.empData = {}; window.allEmps = []; window.branches = []; window.bulletins = []; window.adminInvData = []; window.currentPayrollRecords = [];
        
        function login() { if(document.getElementById('pin').value === '888888'){ document.getElementById('login-box').style.display='none'; document.getElementById('dashboard-ui').classList.remove('hidden'); document.getElementById('dashboard-ui').classList.add('flex'); document.getElementById('att-date').value = new Date().toLocaleDateString('en-CA'); const now = new Date(); document.getElementById('p-mon').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; document.getElementById('export-mon').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; loadAll(); } else { alert('å¯†ç¢¼éŒ¯èª¤ï¼è«‹è¼¸å…¥ 888888'); } }
        function st(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.m-btn').forEach(e=>{ e.classList.remove('bg-slate-900','text-white','shadow-md','border-transparent'); e.classList.add('bg-white','text-slate-500','border-slate-200','shadow-sm'); e.querySelector('.m-text').classList.remove('font-black'); e.querySelector('.m-text').classList.add('font-bold'); }); const activeMBtn = document.getElementById('m-'+id); if(activeMBtn) { activeMBtn.classList.remove('bg-white','text-slate-500','border-slate-200','shadow-sm'); activeMBtn.classList.add('bg-slate-900','text-white','shadow-md','border-transparent'); activeMBtn.querySelector('.m-text').classList.remove('font-bold'); activeMBtn.querySelector('.m-text').classList.add('font-black'); } document.querySelectorAll('.dt-btn').forEach(e=>{ e.classList.remove('active','bg-sky-600','text-white'); e.classList.add('text-slate-400'); }); const activeDtBtn = document.getElementById('dt-'+id); if(activeDtBtn) { activeDtBtn.classList.add('active','bg-sky-600','text-white'); activeDtBtn.classList.remove('text-slate-400'); } document.getElementById(id).classList.add('active'); if(id === 'att') loadAttendance(); if(id === 'inv') loadAdminInventory(); }
        function openModal(id) { document.getElementById(id).classList.add('active'); } function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function loadAll() {
            const { data: emps } = await window._sb.from('employees').select('*, branch_locations(branch_name)');
            const { data: brs } = await window._sb.from('branch_locations').select('*');
            window.allEmps = emps || []; window.branches = brs || [];

            const p = window.allEmps.filter(e => !e.is_approved && e.employment_status === 'åœ¨è·');
            document.getElementById('list-pend').innerHTML = p.length ? p.map(e => `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><span class="text-2xl mr-3">ğŸ‘¤</span><div><h4 class="font-black text-sm text-slate-800"><span class="text-[10px] text-sky-600 mr-1">[${e.job_title||'æœªæŒ‡å®š'}]</span>${e.full_name}</h4><p class="text-[10px] text-slate-500">${e.onboarding_date} ç”³è«‹</p></div></div><button onclick="appr('${e.id}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-black px-4 py-2 rounded-lg shadow-sm transition">é–‹é€š</button></div>`).join('') : '<div class="text-center py-6 bg-slate-100/50 rounded-xl border border-dashed border-slate-300"><p class="text-xs text-slate-400 font-bold">ç›®å‰ç„¡å¾…è¾¦å¯©æ ¸äººå“¡</p></div>';
            
            const aEmps = window.allEmps.filter(e => e.is_approved && e.employment_status === 'åœ¨è·');
            aEmps.sort((a, b) => { let valA = a.employee_no && a.employee_no !== 'æœªè¨­å®š' ? a.employee_no : 'Z999'; let valB = b.employee_no && b.employee_no !== 'æœªè¨­å®š' ? b.employee_no : 'Z999'; return valA.localeCompare(valB, 'zh-TW', { numeric: true }); });
            aEmps.forEach(e => { window.empData[e.id] = { base: e.base_salary, deps: e.dependents_count || 0, start: e.work_start_time || '09:00:00' }; }); 
            
            const empOpts = '<option value="">è«‹é¸æ“‡ç™¼æ”¾è–ªè³‡çš„å“¡å·¥...</option>' + aEmps.map(e => `<option value="${e.id}">[${e.employee_no||'æœªè¨­å®š'}] ${e.full_name}</option>`).join('');
            document.getElementById('p-emp').innerHTML = empOpts;
            document.getElementById('hist-emp').innerHTML = '<option value="">è«‹é¸æ“‡å“¡å·¥æŸ¥è©¢...</option>' + aEmps.map(e => `<option value="${e.id}">[${e.employee_no||'æœªè¨­å®š'}] ${e.full_name}</option>`).join('');

            if (aEmps.length) {
                document.getElementById('list-emps-mobile').innerHTML = aEmps.map(e => {
                    let mgrTag = e.is_inventory_manager ? '<span class="text-[9px] bg-emerald-100 text-emerald-700 px-1 rounded ml-1">ç›¤é»å“¡</span>' : '';
                    let pntTag = e.penalty_points > 0 ? `<span class="text-[9px] bg-red-100 text-red-700 px-1 rounded ml-1">è¨ˆé»:${e.penalty_points}</span>` : '';
                    return `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><div class="w-10 h-10 bg-slate-100 border border-slate-200 rounded-full flex items-center justify-center text-slate-500 font-black mr-3">${e.full_name.charAt(0)}</div><div><h4 class="font-black text-sm text-slate-800">${e.full_name} <span class="text-[9px] bg-emerald-50 border border-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded ml-1">${(e.base_salary/1000).toFixed(0)}k</span>${mgrTag}${pntTag}</h4><p class="text-[10px] text-slate-500 mt-1"><span class="text-sky-600 font-bold mr-1">${e.employee_no||'æœªç·¨è™Ÿ'}</span> | ${e.branch_locations?.branch_name||'æœªç¶å®š'}</p></div></div><button onclick="openEmpDetail('${e.id}')" class="bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded-xl">ç®¡ç†</button></div>`;
                }).join('');
                document.getElementById('list-emps-desktop').innerHTML = aEmps.map(e => {
                    let mgrTag = e.is_inventory_manager ? '<span class="text-[9px] bg-emerald-100 text-emerald-700 px-1 rounded block mt-1 w-max">ç›¤é»è² è²¬äºº</span>' : '';
                    let pntTag = e.penalty_points > 0 ? `<span class="text-[9px] bg-red-100 text-red-700 px-1 rounded block mt-1 w-max">è¨ˆé»:${e.penalty_points}</span>` : '';
                    return `<tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-black text-sky-700 text-xs">${e.employee_no||'--'}</td><td class="px-6 py-4 font-black text-slate-800">${e.full_name}${mgrTag}${pntTag}</td><td class="px-6 py-4 text-slate-600 font-mono text-xs">${e.phone}</td><td class="px-6 py-4 text-emerald-600 font-black">NT$ ${e.base_salary.toLocaleString()}</td><td class="px-6 py-4 text-center"><button onclick="openEmpDetail('${e.id}')" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold px-4 py-2 rounded-xl transition shadow-sm">ç®¡ç†èˆ‡çµç®—</button></td></tr>`;
                }).join('');
            } else {
                document.getElementById('list-emps-mobile').innerHTML = '<p class="text-center text-xs text-slate-400 py-4">ç„¡åœ¨è·å“¡å·¥</p>';
                document.getElementById('list-emps-desktop').innerHTML = '<tr><td colspan="5" class="text-center py-6 text-slate-400">ç„¡åœ¨è·å“¡å·¥</td></tr>';
            }

            const { data: lv } = await window._sb.from('leave_requests').select('*, employees(full_name)').eq('status', 'å¯©æ ¸ä¸­');
            document.getElementById('list-leaves').innerHTML = (lv && lv.length) ? lv.map(l => {
                let isRet = l.leave_type === 'å¿˜è¨˜æ‰“å¡(è£œç™»)'; let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = isRet?'':new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                let spB = isRet ? `<span class="text-[9px] text-amber-700 bg-amber-100 px-1.5 py-0.5 rounded ml-2 font-bold">è£œç™»${l.target_punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span>` : (l.leave_type === 'é¢±é¢¨å‡' ? '<span class="text-[9px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded ml-2">ä¸æ”¯è–ª</span>' : (l.salary_protection?'<span class="text-[9px] text-sky-600 bg-sky-50 px-1.5 py-0.5 rounded ml-2">ç‰¹ä¼‘ä¿è–ª</span>':'<span class="text-[9px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded ml-2">ä¸ä¿è–ª</span>'));
                return `<div class="glass-panel p-4 shadow-sm"><div class="flex justify-between items-start mb-2"><div><span class="font-black text-sm text-slate-800">${l.employees?.full_name}</span><span class="text-xs font-bold text-slate-600 ml-2 border-l-2 border-slate-300 pl-2">${l.leave_type.replace('(è£œç™»)','')}</span>${spB}</div></div><div class="bg-slate-50 p-2 rounded-lg mb-3 inline-block"><p class="text-[10px] font-mono text-slate-600 tracking-tight">${t1} ${t2?'~ '+t2:''}</p></div><div class="flex space-x-2"><button onclick="updLeave('${l.id}', 'æ ¸å‡†')" class="flex-1 bg-emerald-50 border border-emerald-200 text-emerald-700 hover:bg-emerald-500 hover:text-white py-2.5 rounded-lg text-sm font-black transition-colors">æ ¸å‡†</button><button onclick="updLeave('${l.id}', 'æ ¸é§')" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2.5 rounded-lg text-sm font-black transition-colors">é§å›</button></div></div>`
            }).join('') : '<div class="text-center py-6 bg-slate-100/50 rounded-xl border border-dashed border-slate-300 md:col-span-2"><p class="text-xs text-slate-400 font-bold">å¤ªæ£’äº†ï¼Œç„¡å¾…å¯©æ ¸å–®æ“šï¼</p></div>';

            document.getElementById('list-brs').innerHTML = window.branches.map(b => `<div class="glass-panel p-4 flex justify-between items-center shadow-sm"><div class="flex items-center"><span class="text-2xl mr-3 opacity-80">ğŸ“</span><div><p class="font-black text-sm text-slate-800">${b.branch_name} <span class="text-[9px] text-emerald-600 ml-1 font-bold bg-emerald-50 px-1 rounded border border-emerald-100">${b.radius_m}m</span></p><p class="text-[10px] text-slate-500 mt-0.5">${b.address}</p></div></div><button onclick="editBr('${b.id}')" class="text-xs bg-sky-100 text-sky-700 font-bold px-3 py-2 rounded-lg active:scale-95 shadow-sm">âœï¸ ä¿®æ”¹</button></div>`).join('');
            
            loadAdminBlt();
            if(document.getElementById('att').classList.contains('active')) loadAttendance();
        }

        async function loadAttendance() {
            const d = document.getElementById('att-date').value; if(!d) return; 
            document.getElementById('list-attendance-mobile').innerHTML = 'è¼‰å…¥ä¸­...';
            document.getElementById('list-attendance-desktop').innerHTML = '<tr><td colspan="4" class="text-center py-6 text-slate-400 font-bold">è¼‰å…¥ä¸­...</td></tr>';
            const sT = new Date(d); sT.setHours(0,0,0,0); const eT = new Date(d); eT.setHours(23,59,59,999);
            const { data: logs } = await window._sb.from('attendance_logs').select('*, employees(id, full_name, work_start_time, work_end_time, employee_no), branch_locations(branch_name)').gte('punch_time', sT.toISOString()).lte('punch_time', eT.toISOString()).order('punch_time', {ascending: true});
            const empLogs = {}; 
            const activeEmps = window.allEmps.filter(e => e.employment_status === 'åœ¨è·');
            activeEmps.sort((a, b) => { let valA = a.employee_no || 'Z999'; let valB = b.employee_no || 'Z999'; return valA.localeCompare(valB, 'zh-TW', { numeric: true }); });
            activeEmps.forEach(e => { empLogs[e.id] = { name: e.full_name, eno: e.employee_no, start: e.work_start_time || '09:00:00', end: e.work_end_time || '18:00:00', in: null, out: null }; });
            if(logs) { logs.forEach(l => { const eid = l.employees?.id; if(!eid || !empLogs[eid]) return; const tStr = new Date(l.punch_time).toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'}); const isRet = l.note && l.note.includes('[è£œç™»æ ¸å‡†]'); const bName = isRet ? 'è£œç™»(å…å®šä½)' : (l.branch_locations?.branch_name || 'å¤–å‹¤å®šä½'); if(l.punch_type === 'IN' && !empLogs[eid].in) empLogs[eid].in = { time: tStr, branch: bName, retro: isRet }; if(l.punch_type === 'OUT') empLogs[eid].out = { time: tStr, branch: bName, retro: isRet }; }); }
            let htmlM = '', htmlD = '';
            Object.values(empLogs).forEach(e => {
                let inStatus = '<span class="text-[9px] bg-slate-100 text-slate-400 px-1.5 py-0.5 rounded font-bold ml-2">æœªæ‰“å¡</span>';
                if(e.in) { if(e.in.retro) inStatus = '<span class="text-[9px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold ml-2">ä¸»ç®¡è£œç™»</span>'; else if(e.in.time > e.start.slice(0,5)) inStatus = '<span class="text-[9px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold ml-2">é²åˆ°</span>'; else inStatus = '<span class="text-[9px] bg-emerald-100 text-emerald-600 px-1.5 py-0.5 rounded font-bold ml-2">æ­£å¸¸</span>'; }
                let outStatus = '<span class="text-[9px] bg-slate-100 text-slate-400 px-1.5 py-0.5 rounded font-bold ml-2">æœªæ‰“å¡</span>';
                if(e.out) { if(e.out.retro) outStatus = '<span class="text-[9px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold ml-2">ä¸»ç®¡è£œç™»</span>'; else if(e.out.time < e.end.slice(0,5)) outStatus = '<span class="text-[9px] bg-amber-100 text-amber-600 px-1.5 py-0.5 rounded font-bold ml-2">æ—©é€€</span>'; else outStatus = '<span class="text-[9px] bg-emerald-100 text-emerald-600 px-1.5 py-0.5 rounded font-bold ml-2">æ­£å¸¸</span>'; }
                htmlM += `<div class="glass-panel p-4 shadow-sm border-l-4 ${e.in&&e.out?'border-emerald-400':'border-slate-200'}"><div class="flex justify-between items-center border-b border-slate-100 pb-2 mb-3"><span class="font-black text-slate-800 text-sm flex items-center">${e.name} <span class="text-[10px] text-sky-600 ml-1 font-bold">(${e.eno||'--'})</span><span class="text-[9px] font-bold text-slate-400 ml-2 bg-slate-100 border border-slate-200 px-1.5 py-0.5 rounded">ç­åˆ¥ ${e.start.slice(0,5)}~${e.end.slice(0,5)}</span></span></div><div class="grid grid-cols-2 gap-3 text-xs"><div class="bg-white p-2.5 rounded-xl border border-slate-100"><div class="font-bold text-slate-500 mb-1 flex justify-between">ä¸Šç­ ${inStatus}</div><div class="font-black ${e.in?'text-slate-800':'text-slate-300'} text-lg">${e.in?e.in.time:'--:--'}</div><div class="text-[9px] text-slate-400 truncate ${e.in?.retro ? 'text-amber-600' : ''}">${e.in?'ğŸ“'+e.in.branch:''}</div></div><div class="bg-white p-2.5 rounded-xl border border-slate-100"><div class="font-bold text-slate-500 mb-1 flex justify-between">ä¸‹ç­ ${outStatus}</div><div class="font-black ${e.out?'text-slate-800':'text-slate-300'} text-lg">${e.out?e.out.time:'--:--'}</div><div class="text-[9px] text-slate-400 truncate ${e.out?.retro ? 'text-amber-600' : ''}">${e.out?'ğŸ“'+e.out.branch:''}</div></div></div></div>`;
                htmlD += `<tr class="hover:bg-slate-50"><td class="px-6 py-4 font-black text-slate-800">${e.name} <span class="text-[10px] text-sky-600 font-bold ml-1">${e.eno||''}</span></td><td class="px-6 py-4 text-xs font-mono text-slate-500">${e.start.slice(0,5)} ~ ${e.end.slice(0,5)}</td><td class="px-6 py-4"><span class="font-black ${e.in?'text-slate-800':'text-slate-300'} text-base mr-2">${e.in?e.in.time:'--:--'}</span>${inStatus}<br><span class="text-[10px] ${e.in?.retro ? 'text-amber-600 font-bold' : 'text-slate-400'}">${e.in?e.in.branch:''}</span></td><td class="px-6 py-4"><span class="font-black ${e.out?'text-slate-800':'text-slate-300'} text-base mr-2">${e.out?e.out.time:'--:--'}</span>${outStatus}<br><span class="text-[10px] ${e.out?.retro ? 'text-amber-600 font-bold' : 'text-slate-400'}">${e.out?e.out.branch:''}</span></td></tr>`;
            });
            document.getElementById('list-attendance-mobile').innerHTML = htmlM; document.getElementById('list-attendance-desktop').innerHTML = htmlD;
        }

        async function loadAdminInventory() {
            document.getElementById('list-inv-mobile').innerHTML = 'è¼‰å…¥ä¸­...'; document.getElementById('list-inv-desktop').innerHTML = '<tr><td colspan="5" class="text-center py-6 text-slate-400 font-bold">è¼‰å…¥ä¸­...</td></tr>';
            const { data: items } = await window._sb.from('items').select('*').order('created_at', {ascending: false});
            const { data: ledgers } = await window._sb.from('inventory_ledgers').select('item_id, change_qty');
            let stockMap = {}; if(ledgers) { ledgers.forEach(l => { if(!stockMap[l.item_id]) stockMap[l.item_id] = 0; stockMap[l.item_id] += l.change_qty; }); }
            window.adminInvData = (items || []).map(i => ({ ...i, current_stock: stockMap[i.id] || 0 }));
            renderAdminInventory();
        }

        function renderAdminInventory() {
            let htmlM = '', htmlD = '';
            
            const cats = [...new Set(window.adminInvData.map(i => i.category || 'æœªåˆ†é¡'))];
            document.getElementById('admin-inv-cat-filter').innerHTML = '<option value="">å…¨éƒ¨åˆ†é¡</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');

            if(!window.adminInvData.length) { htmlM = '<p class="text-slate-400 py-4 text-center">ç„¡åº«å­˜è³‡æ–™</p>'; htmlD = '<tr><td colspan="5" class="text-center py-6 text-slate-400">ç„¡åº«å­˜è³‡æ–™</td></tr>'; }
            else {
                window.adminInvData.forEach(i => {
                    let isLow = i.current_stock <= (i.safe_stock_level || 0);
                    let badge = isLow ? `<span class="text-[9px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-bold border border-red-200">ä½æ°´ä½</span>` : '';
                    let catTag = `<span class="text-[9px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded ml-1">${i.category || 'æœªåˆ†é¡'}</span>`;
                    htmlM += `<div class="glass-panel p-4 flex justify-between items-center inv-admin-item" data-search="${i.item_code} ${i.item_name} ${i.specification||''}" data-cat="${i.category||'æœªåˆ†é¡'}"><div class="flex-1"><span class="text-[10px] text-indigo-600 bg-indigo-50 px-1.5 rounded font-mono">${i.item_code}</span>${catTag}<h4 class="font-black text-sm text-slate-800 mt-1">${i.item_name} ${badge}</h4><p class="text-[10px] text-slate-500 mt-0.5">è¦æ ¼: ${i.specification||'ç„¡'} | é€±æœŸ: ${i.lead_time_days}å¤©</p></div><div class="text-right pl-3 border-l border-slate-100"><div class="text-xl font-black ${isLow?'text-red-600':'text-slate-800'}">${i.current_stock}</div><button onclick="openEditItem('${i.id}')" class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded mt-1 font-bold hover:bg-slate-200">ä¿®æ”¹</button></div></div>`;
                    htmlD += `<tr class="hover:bg-slate-50 inv-admin-item" data-search="${i.item_code} ${i.item_name} ${i.specification||''}" data-cat="${i.category||'æœªåˆ†é¡'}"><td class="px-6 py-4"><div class="mb-1"><span class="text-[10px] text-indigo-600 font-mono bg-indigo-50 px-1.5 rounded mr-1">${i.item_code}</span>${catTag}</div><span class="font-black text-slate-800">${i.item_name}</span> ${badge}<br><span class="text-[10px] text-slate-400 font-bold">${i.specification||'ç„¡è¦æ ¼'}</span></td><td class="px-6 py-4 text-right font-black ${isLow?'text-red-600':'text-slate-800'} text-lg">${i.current_stock}</td><td class="px-6 py-4 text-right text-slate-500 font-bold">${i.safe_stock_level}</td><td class="px-6 py-4 text-center text-slate-500 font-bold">${i.lead_time_days}</td><td class="px-6 py-4 text-center"><button onclick="openEditItem('${i.id}')" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold px-4 py-2 rounded-xl transition shadow-sm">ä¿®æ”¹åƒæ•¸</button></td></tr>`;
                });
            }
            document.getElementById('list-inv-mobile').innerHTML = htmlM; document.getElementById('list-inv-desktop').innerHTML = htmlD;
        }

        function filterAdminInventory() {
            const kw = document.getElementById('admin-inv-search').value.toLowerCase();
            const cat = document.getElementById('admin-inv-cat-filter').value;
            document.querySelectorAll('.inv-admin-item').forEach(el => { 
                const text = el.getAttribute('data-search').toLowerCase();
                const elCat = el.getAttribute('data-cat');
                const matchKw = text.includes(kw);
                const matchCat = cat === '' || elCat === cat;
                el.style.display = (matchKw && matchCat) ? '' : 'none'; 
            });
        }

        function openEditItem(id) {
            const i = window.adminInvData.find(x => x.id === id); if(!i) return;
            document.getElementById('edit-item-id').value = i.id; 
            document.getElementById('edit-item-name').value = i.item_name; 
            document.getElementById('edit-item-safe').value = i.safe_stock_level || 0; 
            document.getElementById('edit-item-lead').value = i.lead_time_days || 15;
            const catSelect = document.getElementById('edit-item-cat');
            if (Array.from(catSelect.options).some(opt => opt.value === i.category)) { catSelect.value = i.category; } else { catSelect.value = 'æœªåˆ†é¡'; }
            openModal('item-edit-modal');
        }

        async function saveAdminItem() {
            const id = document.getElementById('edit-item-id').value;
            const p = { item_name: document.getElementById('edit-item-name').value, category: document.getElementById('edit-item-cat').value, safe_stock_level: parseInt(document.getElementById('edit-item-safe').value) || 0, lead_time_days: parseInt(document.getElementById('edit-item-lead').value) || 15 };
            const { error } = await window._sb.from('items').update(p).eq('id', id);
            if(error) alert('ä¿®æ”¹å¤±æ•—'); else { alert('âœ… åƒæ•¸æ›´æ–°æˆåŠŸï¼'); closeModal('item-edit-modal'); loadAdminInventory(); }
        }

        // ğŸŒŸ æ¢ä»¶å¼åˆ‡æ›å¹´çµ‚ç‰¹ä¼‘è¨ˆç®—
        async function handleYebToggle() {
            const isChecked = document.getElementById('toggle-yeb').checked;
            const yebSec = document.getElementById('yeb-section');
            if(isChecked) {
                yebSec.classList.remove('hidden');
                // è‹¥å·²é¸å“¡å·¥ï¼Œç›´æ¥å¹«ä»–ç®—å¥½ç‰¹ä¼‘éŒ¢
                await autoCalcUlp();
            } else {
                yebSec.classList.add('hidden');
                document.getElementById('p-yeb').value = 0;
                document.getElementById('p-ulp').value = 0;
                calcPayroll();
            }
        }

        async function autoCalcUlp() {
            const empId = document.getElementById('p-emp').value;
            if(!empId) return;
            const { data: lv } = await window._sb.rpc('fn_get_annual_leave_v2', { p_emp_id: empId });
            if(lv) {
                const base = window.empData[empId]?.base || 0;
                const hrRate = base / 240;
                document.getElementById('p-ulp').value = Math.round((lv.remain_hours || 0) * hrRate);
            }
            calcPayroll();
        }

        async function loadPayrollHistory() {
            const empId = document.getElementById('hist-emp').value;
            if(!empId) { document.getElementById('ui-payroll-hist').innerHTML = '<div class="text-center text-xs text-slate-400 py-6 bg-slate-50 rounded-xl border border-dashed border-slate-300">è«‹å…ˆé¸æ“‡å“¡å·¥ä»¥è¼‰å…¥æ­·å²è–ªè³‡å–®</div>'; return; }
            document.getElementById('ui-payroll-hist').innerHTML = '<div class="text-center text-xs text-slate-400 py-4">è¼‰å…¥ä¸­...</div>';
            const { data } = await window._sb.from('payroll_records').select('*').eq('employee_id', empId).order('created_at', {ascending: false});
            window.currentPayrollRecords = data || [];
            if(!data || data.length === 0) {
                document.getElementById('ui-payroll-hist').innerHTML = '<div class="text-center text-xs text-slate-400 py-6 bg-slate-50 rounded-xl border border-dashed border-slate-300">è©²å“¡å·¥ç›®å‰ç„¡æ­·å²è–ªè³‡ç´€éŒ„</div>';
                return;
            }
            document.getElementById('ui-payroll-hist').innerHTML = data.map(r => `
                <div class="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                    <div>
                        <span class="text-[10px] font-black text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded border border-indigo-200 mr-2 tracking-widest">${r.pay_month}</span>
                        <span class="font-black text-slate-800 text-sm tracking-tight">å¯¦é ˜: NT$ ${r.total_net_pay.toLocaleString()}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="openEditPayroll('${r.id}')" class="text-[10px] bg-sky-50 hover:bg-sky-100 text-sky-700 border border-sky-200 font-bold px-3 py-2 rounded-lg active:scale-95 shadow-sm transition">âœï¸ ç·¨è¼¯</button>
                        <button onclick="deletePayroll('${r.id}')" class="text-[10px] bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 font-bold px-3 py-2 rounded-lg active:scale-95 shadow-sm transition">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function openEditPayroll(id) {
            const r = window.currentPayrollRecords.find(x => x.id === id); if(!r) return;
            document.getElementById('edit-pr-id').value = r.id;
            document.getElementById('edit-pr-month').value = r.pay_month;
            document.getElementById('edit-pr-base').value = r.base_pay;
            document.getElementById('edit-pr-bonus').value = r.bonus;
            document.getElementById('edit-pr-yeb').value = r.year_end_bonus;
            document.getElementById('edit-pr-ulp').value = r.unused_leave_pay || 0;
            document.getElementById('edit-pr-ins').value = r.insurance_deduction;
            document.getElementById('edit-pr-2nd').value = r.second_gen_health;
            document.getElementById('edit-pr-lvd').value = r.leave_deduction;
            calcEditPayrollNet();
            openModal('payroll-edit-modal');
        }

        function calcEditPayrollNet() {
            const base = parseFloat(document.getElementById('edit-pr-base').value)||0;
            const bonus = parseFloat(document.getElementById('edit-pr-bonus').value)||0;
            const yeb = parseFloat(document.getElementById('edit-pr-yeb').value)||0;
            const ulp = parseFloat(document.getElementById('edit-pr-ulp').value)||0;
            const ins = parseFloat(document.getElementById('edit-pr-ins').value)||0;
            const sec = parseFloat(document.getElementById('edit-pr-2nd').value)||0;
            const lvd = parseFloat(document.getElementById('edit-pr-lvd').value)||0;
            const net = base + bonus + yeb + ulp - ins - sec - lvd;
            document.getElementById('edit-pr-net').innerText = `NT$ ${net > 0 ? net : 0}`;
        }

        async function saveEditPayroll() {
            const id = document.getElementById('edit-pr-id').value;
            const base = parseFloat(document.getElementById('edit-pr-base').value)||0;
            const bonus = parseFloat(document.getElementById('edit-pr-bonus').value)||0;
            const yeb = parseFloat(document.getElementById('edit-pr-yeb').value)||0;
            const ulp = parseFloat(document.getElementById('edit-pr-ulp').value)||0;
            const ins = parseFloat(document.getElementById('edit-pr-ins').value)||0;
            const sec = parseFloat(document.getElementById('edit-pr-2nd').value)||0;
            const lvd = parseFloat(document.getElementById('edit-pr-lvd').value)||0;
            const net = base + bonus + yeb + ulp - ins - sec - lvd;
            
            const p = {
                base_pay: base, bonus: bonus, year_end_bonus: yeb, unused_leave_pay: ulp,
                insurance_deduction: ins, second_gen_health: sec, leave_deduction: lvd,
                total_net_pay: net > 0 ? net : 0
            };
            const { error } = await window._sb.from('payroll_records').update(p).eq('id', id);
            if(error) alert('ä¿®æ”¹å¤±æ•—:' + error.message);
            else { alert('âœ… è–ªè³‡å–®ä¿®æ”¹æˆåŠŸï¼å‰å°å·²åŒæ­¥ã€‚'); closeModal('payroll-edit-modal'); loadPayrollHistory(); }
        }

        async function deletePayroll(id) {
            if(!confirm('âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ç­†è–ªè³‡å–®å—ï¼Ÿåˆªé™¤å¾Œå‰å°å°‡ç„¡æ³•æŸ¥è©¢ã€‚')) return;
            const { error } = await window._sb.from('payroll_records').delete().eq('id', id);
            if(error) alert('åˆªé™¤å¤±æ•—:' + error.message);
            else { alert('âœ… è–ªè³‡å–®å·²æˆåŠŸåˆªé™¤'); loadPayrollHistory(); }
        }

        // ğŸŒŸ å“¡å·¥æª”æ¡ˆ Modal æ’ç‰ˆå¤§ç¿»æ–°
        function openEmpDetail(empId) {
            const e = window.allEmps.find(x => x.id === empId); if(!e) return;
            window.currentOffboardEmpId = empId; document.getElementById('modal-off-result').classList.add('hidden'); document.getElementById('modal-off-date').value = '';
            document.getElementById('ui-emp-offboard-section').style.display = 'block'; const editBtn = document.getElementById('btn-edit-emp'); editBtn.onclick = () => renderEditEmpForm(empId); editBtn.style.display = 'block';
            let mgrTag = e.is_inventory_manager ? '<span class="text-[10px] font-bold text-emerald-700 bg-emerald-100 px-2 py-0.5 rounded-md ml-1 align-middle border border-emerald-200">åº«å­˜ç›¤é»å“¡</span>' : '';
            let pntTag = e.penalty_points > 0 ? `<span class="text-[10px] font-bold text-red-700 bg-red-100 px-2 py-0.5 rounded-md ml-1 align-middle border border-red-200">è¨ˆé»: ${e.penalty_points}</span>` : '';
            const html = `
                <div class="space-y-4">
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center space-x-4">
                        <div class="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center text-white text-2xl font-black shadow-inner shrink-0">${e.full_name.charAt(0)}</div>
                        <div class="flex-1">
                            <h4 class="text-2xl font-black text-slate-800 tracking-tight flex items-center flex-wrap gap-2">
                                ${e.full_name} 
                                <span class="text-[10px] font-bold text-sky-700 bg-sky-100 px-2 py-1 rounded-md border border-sky-200 tracking-widest">${e.employment_status}</span>
                                ${mgrTag}${pntTag}
                            </h4>
                            <p class="text-sm text-slate-500 font-bold mt-1.5 tracking-wider">${e.job_title||'æœªæŒ‡æ´¾è·ä½'}</p>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <h5 class="text-sm font-black text-blue-800 mb-4 border-l-4 border-blue-500 pl-2">ğŸ¢ åŸºæœ¬èˆ‡è€ƒå‹¤è³‡è¨Š</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">å“¡å·¥ç·¨è™Ÿ</p><p class="font-black text-sky-700 text-lg leading-none">${e.employee_no||'æœªè¨­å®š'}</p></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">å…¥è·æ—¥æœŸ</p><p class="font-black text-slate-700 text-base leading-none mt-0.5">${e.onboarding_date}</p></div>
                            <div class="col-span-2 bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">å·¥ä½œæ‰“å¡æ“šé»</p><p class="font-black text-slate-800 text-base leading-none mt-0.5">${e.branch_locations?.branch_name || 'æœªç¶å®š'}</p></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">ä¸Šç­æ™‚é–“</p><p class="font-black text-slate-700 text-base leading-none mt-0.5">${(e.work_start_time||'09:00').slice(0,5)}</p></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">ä¸‹ç­æ™‚é–“</p><p class="font-black text-slate-700 text-base leading-none mt-0.5">${(e.work_end_time||'18:00').slice(0,5)}</p></div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <h5 class="text-sm font-black text-slate-700 mb-4 border-l-4 border-slate-500 pl-2">ğŸ“ è¯çµ¡èˆ‡é€šè¨Šè³‡æ–™</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">è¯çµ¡é›»è©±</p><p class="font-black text-slate-800 text-sm mt-0.5">${e.phone}</p></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">èº«åˆ†è­‰å­—è™Ÿ</p><p class="font-black text-slate-800 text-sm mt-0.5">${e.id_number}</p></div>
                            <div class="col-span-2 bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">é›»å­ä¿¡ç®±</p><p class="font-black text-slate-800 text-sm mt-0.5">${e.email}</p></div>
                            <div class="col-span-2 bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1">é€šè¨Šé€é”åœ°å€</p><p class="font-black text-slate-800 text-sm leading-relaxed mt-0.5">${e.address}</p></div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <h5 class="text-sm font-black text-emerald-700 mb-4 border-l-4 border-emerald-500 pl-2">ğŸ’° è²¡å‹™èˆ‡ä¿éšªè¨­å®š</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100"><p class="text-[10px] font-bold text-emerald-600/70 mb-1.5">æ ¸å®šæœ¬è–ª</p><p class="font-black text-emerald-700 text-xl tracking-tight leading-none">NT$ ${e.base_salary.toLocaleString()}</p></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 mb-1.5">çœ·å±¬åŠ ä¿äººæ•¸</p><p class="font-black text-slate-800 text-xl tracking-tight leading-none">${e.dependents_count} <span class="text-sm font-bold text-slate-500">äºº</span></p></div>
                            <div class="col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-inner">
                                <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">æ’¥è–ªéŠ€è¡Œå¸³æˆ¶</p>
                                <p class="font-black text-slate-800 text-lg tracking-wider leading-none mb-2">${e.bank_name} (${e.bank_code})</p>
                                <p class="font-black text-slate-800 text-2xl tracking-wider leading-none mb-3">${e.bank_account}</p>
                                <p class="text-xs font-bold text-slate-500">æˆ¶åï¼š${e.bank_user_name}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <h5 class="text-sm font-black text-amber-700 mb-4 border-l-4 border-amber-500 pl-2">ğŸš¨ ç·Šæ€¥è¯çµ¡èˆ‡æ•¸ä½åˆç´„</h5>
                        <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 mb-4">
                            <p class="text-[10px] font-bold text-amber-600/70 mb-1.5">ç·Šæ€¥è¯çµ¡äºº</p>
                            <p class="font-black text-amber-900 text-lg tracking-wide">${e.emergency_name} <span class="mx-2 text-amber-200">|</span> ${e.emergency_phone}</p>
                        </div>
                        <div class="flex justify-between items-center bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 mb-1">è˜åƒ±åˆç´„èˆ‡ NDA ä¿å¯†å”å®š</p>
                                <p class="text-xs font-black text-emerald-600 flex items-center mt-1"><span class="mr-1">âœ”ï¸</span>å·²ç°½ç½²ç”Ÿæ•ˆ (${new Date(e.nda_signed_at).toLocaleDateString('zh-TW')})</p>
                            </div>
                            <button onclick="exportContract('${e.id}')" class="bg-white text-sky-700 hover:bg-sky-50 border border-sky-200 text-xs font-black px-4 py-3 rounded-xl transition shadow-sm active:scale-95">ğŸ“¥ ä¸‹è¼‰ PDF</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('ui-emp-full-info').innerHTML = html; document.getElementById('emp-detail-modal').classList.add('active');
        }

        function renderEditEmpForm(empId) {
            const e = window.allEmps.find(x => x.id === empId); if(!e) return;
            document.getElementById('btn-edit-emp').style.display = 'none'; document.getElementById('ui-emp-offboard-section').style.display = 'none';
            const brOptions = window.branches.map(b => `<option value="${b.id}" ${e.default_branch_id === b.id ? 'selected' : ''}>${b.branch_name}</option>`).join('');
            const html = `
                <div class="bg-sky-50 p-6 rounded-2xl border border-sky-100 shadow-inner">
                    <h4 class="font-black text-sky-800 mb-5 flex items-center border-b border-sky-200 pb-3 text-lg"><span class="text-2xl mr-2">âœï¸</span>ç·¨è¼¯å“¡å·¥å…¨è³‡æ–™</h4>
                    <form onsubmit="saveEmpDetail(event, '${e.id}')" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2 flex space-x-3"><div class="flex-1"><label class="text-[10px] font-bold text-slate-500 ml-1">çœŸå¯¦å§“å</label><input type="text" id="edit-name" value="${e.full_name}" class="admin-input bg-white font-bold" required></div><div class="w-1/3"><label class="text-[10px] font-bold text-slate-500 ml-1">åœ¨è·ç‹€æ…‹</label><select id="edit-status" class="admin-input bg-white font-bold select-arrow"><option value="åœ¨è·" ${e.employment_status==='åœ¨è·'?'selected':''}>åœ¨è·</option><option value="ç•™è·åœè–ª" ${e.employment_status==='ç•™è·åœè–ª'?'selected':''}>ç•™è·åœè–ª</option></select></div></div>
                            <div><label class="text-[10px] font-bold text-slate-500 ml-1">å“¡å·¥ç·¨è™Ÿ</label><input type="text" id="edit-emp-no" value="${e.employee_no==='æœªè¨­å®š'?'':e.employee_no}" class="admin-input bg-white font-black text-sky-700" placeholder="å¯æ‰‹å‹•ä¿®æ”¹"></div>
                            <div><label class="text-[10px] font-bold text-slate-500 ml-1">èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="edit-idnum" value="${e.id_number}" class="admin-input bg-white uppercase" required></div>
                            <div class="col-span-2"><label class="text-[10px] font-bold text-slate-500 ml-1">å“¡å·¥è·ä½</label><select id="edit-job-title" class="admin-input bg-white font-bold select-arrow"><option value="ä¸»ç®¡" ${e.job_title==='ä¸»ç®¡'?'selected':''}>ä¸»ç®¡</option><option value="æ¥­å‹™" ${e.job_title==='æ¥­å‹™'?'selected':''}>æ¥­å‹™</option><option value="åŠ©ç†" ${e.job_title==='åŠ©ç†'?'selected':''}>åŠ©ç†</option></select></div>
                            
                            <div class="col-span-2 border-t border-sky-200 pt-3 mt-1"><h5 class="text-[10px] font-black text-red-700 mb-2">âš™ï¸ æ¬Šé™èˆ‡ç´€å¾‹è¨­å®š</h5><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">ç›¤é»è² è²¬äºº</label><select id="edit-inv-mgr" class="admin-input bg-white font-bold select-arrow"><option value="false" ${!e.is_inventory_manager?'selected':''}>å¦</option><option value="true" ${e.is_inventory_manager?'selected':''}>æ˜¯ (éœ€åŸ·è¡Œç›¤é»)</option></select></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">çµ•å°è¨ˆé»ç¸½æ•¸</label><input type="number" id="edit-penalty" value="${e.penalty_points||0}" class="admin-input bg-white font-black text-red-600" required></div></div></div>

                            <div class="col-span-2 border-t border-sky-200 pt-3 mt-1"><h5 class="text-[10px] font-black text-blue-700 mb-2">â° è€ƒå‹¤ç­åˆ¥è¨­å®š</h5><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">ä¸Šç­æ™‚é–“</label><input type="time" id="edit-start-time" value="${(e.work_start_time||'09:00').slice(0,5)}" class="admin-input bg-white font-black text-blue-700" required></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">ä¸‹ç­æ™‚é–“</label><input type="time" id="edit-end-time" value="${(e.work_end_time||'18:00').slice(0,5)}" class="admin-input bg-white font-black text-blue-700" required></div></div></div>
                            <div><label class="text-[10px] font-bold text-slate-500 ml-1">å…¥è·æ—¥æœŸ</label><input type="date" id="edit-onboard" value="${e.onboarding_date}" class="admin-input bg-white" required></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">å·¥ä½œæ‰“å¡æ“šé»</label><select id="edit-branch" class="admin-input bg-white font-bold select-arrow">${brOptions}</select></div>
                            <div class="col-span-2 border-t border-sky-200 pt-3 mt-1"><label class="text-[10px] font-bold text-slate-500 ml-1">é›»å­ä¿¡ç®±</label><input type="email" id="edit-email" value="${e.email}" class="admin-input bg-white" required></div>
                            <div><label class="text-[10px] font-bold text-emerald-600 ml-1">æ ¸å®šåº•è–ª</label><input type="number" id="edit-base" value="${e.base_salary}" class="admin-input bg-white font-black text-emerald-600" required></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">çœ·å±¬äººæ•¸</label><input type="number" id="edit-deps" value="${e.dependents_count}" class="admin-input bg-white" required></div>
                            <div><label class="text-[10px] font-bold text-slate-500 ml-1">è¯çµ¡é›»è©±</label><input type="text" id="edit-phone" value="${e.phone}" class="admin-input bg-white" required></div>
                            <div class="col-span-2"><label class="text-[10px] font-bold text-slate-500 ml-1">é€šè¨Šåœ°å€</label><input type="text" id="edit-address" value="${e.address}" class="admin-input bg-white" required></div>
                            <div class="col-span-2 border-t border-sky-200 pt-3 mt-1"><h5 class="text-[10px] font-black text-amber-700 mb-2">ğŸš¨ ç·Šæ€¥è¯çµ¡äºº</h5><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">å§“å</label><input type="text" id="edit-emg-name" value="${e.emergency_name}" class="admin-input bg-white" required></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">é›»è©±</label><input type="tel" id="edit-emg-phone" value="${e.emergency_phone}" class="admin-input bg-white" required></div></div></div>
                            <div class="col-span-2 border-t border-sky-200 pt-3 mt-1"><h5 class="text-[10px] font-black text-slate-700 mb-2">ğŸ¦ æ’¥è–ªéŠ€è¡Œå¸³æˆ¶</h5><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">éŠ€è¡Œåç¨±</label><input type="text" id="edit-bank-name" value="${e.bank_name}" class="admin-input bg-white" required></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">ä»£ç¢¼</label><input type="text" id="edit-bank-code" value="${e.bank_code}" class="admin-input bg-white" required></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">æˆ¶å</label><input type="text" id="edit-bank-user" value="${e.bank_user_name}" class="admin-input bg-white" required></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">å¸³è™Ÿ</label><input type="text" id="edit-bank-account" value="${e.bank_account}" class="admin-input bg-white" required></div></div></div>
                        </div>
                        <div class="flex space-x-3 pt-5"><button type="button" onclick="openEmpDetail('${e.id}')" class="flex-1 bg-white border-2 border-slate-200 text-slate-600 py-4 rounded-xl font-bold transition hover:bg-slate-50 tracking-widest">å–æ¶ˆ</button><button type="submit" id="btn-save-emp" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white py-4 rounded-xl font-black transition shadow-md tracking-widest text-lg">ğŸ’¾ å„²å­˜è®Šæ›´</button></div>
                    </form>
                </div>
            `;
            document.getElementById('ui-emp-full-info').innerHTML = html;
        }

        async function saveEmpDetail(e, empId) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-emp'); const originText = btn.innerHTML; btn.innerHTML = 'â³ å„²å­˜ä¸­...'; btn.disabled = true;
            let st = document.getElementById('edit-start-time').value; if(st && st.length === 5) st += ':00'; let et = document.getElementById('edit-end-time').value; if(et && et.length === 5) et += ':00';
            
            const p = { 
                full_name: document.getElementById('edit-name').value, employment_status: document.getElementById('edit-status').value, 
                employee_no: document.getElementById('edit-emp-no').value || 'æœªè¨­å®š',
                id_number: document.getElementById('edit-idnum').value, onboarding_date: document.getElementById('edit-onboard').value, 
                job_title: document.getElementById('edit-job-title').value, work_start_time: st, work_end_time: et,
                email: document.getElementById('edit-email').value, base_salary: parseFloat(document.getElementById('edit-base').value) || 0, 
                phone: document.getElementById('edit-phone').value, dependents_count: parseInt(document.getElementById('edit-deps').value) || 0, 
                default_branch_id: document.getElementById('edit-branch').value, address: document.getElementById('edit-address').value, 
                emergency_name: document.getElementById('edit-emg-name').value, emergency_phone: document.getElementById('edit-emg-phone').value, 
                bank_name: document.getElementById('edit-bank-name').value, bank_code: document.getElementById('edit-bank-code').value, 
                bank_user_name: document.getElementById('edit-bank-user').value, bank_account: document.getElementById('edit-bank-account').value,
                is_inventory_manager: document.getElementById('edit-inv-mgr').value === 'true', 
                penalty_points: parseInt(document.getElementById('edit-penalty').value) || 0
            };
            
            const { error } = await window._sb.from('employees').update(p).eq('id', empId);
            if (error) { alert('æ›´æ–°å¤±æ•—: ' + error.message); btn.innerHTML = originText; btn.disabled = false; } 
            else { 
                btn.innerHTML = 'âœ… å„²å­˜å®Œç•¢'; await loadAll(); setTimeout(() => openEmpDetail(empId), 1000); 
            }
        }

        async function updateAttendanceRate() { 
            const empId = document.getElementById('p-emp').value; 
            const month = document.getElementById('p-mon').value; 
            if(!empId || !month) return; 
            
            const { data } = await window._sb.rpc('fn_get_payroll_calc', { p_emp_id: empId, p_month: month }); 
            if(data) { 
                document.getElementById('sd-sick').innerText = data.sick_hrs; 
                document.getElementById('sd-per').innerText = data.personal_hrs; 
                document.getElementById('sd-typ').innerText = data.typhoon_hrs; 
                document.getElementById('sd-lat').innerText = data.late_count; 
                document.getElementById('sd-ovt').innerText = data.overtime_hrs; 
                document.getElementById('sd-pnt').innerText = data.total_penalty; 
                document.getElementById('p-lvd').value = data.leave_deduct; 
            } 
            
            const y = month.split('-')[0];
            const { data: yData } = await window._sb.rpc('fn_get_year_end_stats', { p_emp_id: empId, p_year: y });
            const { data: lv } = await window._sb.rpc('fn_get_annual_leave_v2', { p_emp_id: empId });
            if(yData) {
                document.getElementById('sy-ann').innerText = lv?.remain_hours || 0; 
                document.getElementById('sy-per').innerText = yData.personal || 0; 
                document.getElementById('sy-sic').innerText = yData.sick || 0; 
                document.getElementById('sy-lat').innerText = yData.late || 0; 
                document.getElementById('sy-ovt').innerText = yData.overtime || 0; 
                document.getElementById('sy-pnt').innerText = yData.total_penalty || 0;
            }
            
            // åªæœ‰é–‹å•Ÿå¹´çµ‚æ¨¡å¼æ™‚ï¼Œæ‰è‡ªå‹•æ›ç®—ç‰¹ä¼‘
            if(document.getElementById('toggle-yeb').checked) {
                await autoCalcUlp();
            } else {
                calcNet(); 
            }
        }

        function onEmpChange() { const empId = document.getElementById('p-emp').value; if(!empId) return; const emp = window.empData[empId]; if(!emp) return; document.getElementById('p-base').value = emp.base; calcPayroll(); updateAttendanceRate(); }
        
        function calcPayroll() { 
            const empId = document.getElementById('p-emp').value; 
            const emp = window.empData[empId]; 
            if(!emp) return; 
            const base = parseFloat(document.getElementById('p-base').value) || 0; 
            const bonus = parseFloat(document.getElementById('p-bonus').value) || 0; 
            const yeb = parseFloat(document.getElementById('p-yeb').value) || 0; 
            
            document.getElementById('p-pen').value = Math.round(base * 0.06); 
            document.getElementById('p-2nd').value = Math.round((bonus + yeb) * 0.0211); 
            document.getElementById('p-ins').value = Math.round(base * 0.022) + Math.round(base * 0.0155 * (1 + emp.deps)); 
            
            calcNet(); 
        }

        function calcNet() { 
            const base = parseFloat(document.getElementById('p-base').value) || 0;
            const bonus = parseFloat(document.getElementById('p-bonus').value) || 0;
            const yeb = parseFloat(document.getElementById('p-yeb').value) || 0;
            const ulp = parseFloat(document.getElementById('p-ulp').value) || 0;
            const ins = parseFloat(document.getElementById('p-ins').value) || 0;
            const sec = parseFloat(document.getElementById('p-2nd').value) || 0;
            const lvd = parseFloat(document.getElementById('p-lvd').value) || 0;
            
            const net = base + bonus + yeb + ulp - ins - sec - lvd; 
            document.getElementById('p-net').value = net > 0 ? net : 0; 
            document.getElementById('p-net-display').innerText = `NT$ ${net > 0 ? net : 0}`; 
        }

        async function issuePayroll() { 
            const empId = document.getElementById('p-emp').value;
            const base = parseFloat(document.getElementById('p-base').value) || 0;
            const bonus = parseFloat(document.getElementById('p-bonus').value) || 0;
            const yeb = parseFloat(document.getElementById('p-yeb').value) || 0;
            const ulp = parseFloat(document.getElementById('p-ulp').value) || 0;
            
            if(!empId) { alert('è«‹é¸æ“‡å“¡å·¥ï¼'); return; }
            if(base === 0 && bonus === 0 && yeb === 0 && ulp === 0) { alert('ç™¼æ”¾é‡‘é¡ä¸èƒ½å…¨éƒ¨ç‚º 0ï¼'); return; }
            
            const isYeb = document.getElementById('toggle-yeb').checked;
            const pm = document.getElementById('p-mon').value;
            const finalMonth = isYeb ? `${pm.split('-')[0]}-13 (å¹´çµ‚çµç®—)` : pm;

            const p = { 
                employee_id: empId, 
                pay_month: finalMonth, 
                base_pay: base, 
                bonus: bonus, 
                year_end_bonus: yeb,
                unused_leave_pay: ulp,
                labor_pension: parseFloat(document.getElementById('p-pen').value) || 0, 
                insurance_deduction: parseFloat(document.getElementById('p-ins').value) || 0, 
                second_gen_health: parseFloat(document.getElementById('p-2nd').value) || 0, 
                leave_deduction: parseFloat(document.getElementById('p-lvd').value) || 0, 
                total_net_pay: parseFloat(document.getElementById('p-net').value) || 0 
            }; 
            
            await window._sb.from('payroll_records').insert([p]); 
            alert('âœ… ç¶œåˆè–ªè³‡ç™¼é€æˆåŠŸï¼'); 
            
            // åŒæ­¥åˆ·æ–°æ­·å²è–ªè³‡å–®å€å¡Š
            document.getElementById('hist-emp').value = empId;
            loadPayrollHistory();
        }

        function exportContract(empId) {
            const e = window.allEmps.find(x => x.id === empId); if(!e) return;
            const printWindow = window.open('', '_blank', 'width=900,height=900');
            const startScript = "<scr" + "ipt>"; const endScript = "</scr" + "ipt>";
            const html = `
                <html>
                <head><title>${e.full_name} - æ•¸ä½è˜åƒ±åˆç´„</title><style>body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; padding: 40px 60px; line-height: 1.8; color: #111; max-width: 800px; margin: 0 auto; } h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; letter-spacing: 2px;} .info-box { border: 1px solid #ddd; padding: 20px; background: #f9fafb; margin-bottom: 30px; border-radius: 8px; } .info-box p { margin: 8px 0; font-size: 15px; } .section-title { font-weight: bold; margin-top: 30px; margin-bottom: 10px; font-size: 1.1em; background: #eee; padding: 5px 10px; border-left: 4px solid #333;} ul { padding-left: 25px; margin-top: 0; } li { margin-bottom: 8px; text-align: justify; } .signature-box { margin-top: 50px; border-top: 2px dashed #999; padding-top: 30px; text-align: right; } .signature-box p { margin: 5px 0; font-size: 14px; } .stamp { display: inline-block; border: 3px solid #b91c1c; color: #b91c1c; padding: 10px 20px; font-weight: bold; font-size: 18px; transform: rotate(-5deg); margin-bottom: 15px; border-radius: 5px;}</style></head>
                <body>
                    <h2>HYPASS ä¼æ¥­è˜åƒ±åˆç´„èˆ‡å“¡å·¥æœå‹™å®ˆå‰‡</h2>
                    <div class="info-box"><p><strong>ç”²æ–¹ï¼ˆé›‡ä¸»ï¼‰ï¼š</strong>æµ·å¸•æ–¯ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸</p><p><strong>ä¹™æ–¹ï¼ˆå—åƒ±äººï¼‰ï¼š</strong>${e.full_name} <span style="color:#666; font-size:12px;">(å“¡å·¥ç·¨è™Ÿ: ${e.employee_no||'æœªè¨­å®š'})</span></p><p><strong>èº«åˆ†è­‰å­—è™Ÿï¼š</strong>${e.id_number}</p><p><strong>é€šè¨Šåœ°å€ï¼š</strong>${e.address}</p></div>
                    <div class="section-title">ç¬¬ä¸€ç« ï¼šè·ä½èˆ‡å·¥ä½œå…§å®¹</div><ul><li>è·å‹™èªªæ˜ï¼šä¹™æ–¹åŒæ„æ“”ä»»ç”²æ–¹æ‰€æŒ‡æ´¾ä¹‹è·å‹™ï¼Œä¸¦å”åŠ©ç”²æ–¹å„é …æ¥­å‹™æ¨å‹•ã€‚</li><li>å·¥ä½œå€åŸŸï¼šç”²æ–¹å¾—è¦–ç‡Ÿé‹éœ€æ±‚ï¼ŒæŒ‡æ´¾ä¹™æ–¹æ–¼å¯¦é«”æ“šé»æˆ–æŒ‡å®šåˆ†å€åŸ·è¡Œè·å‹™ã€‚</li></ul>
                    <div class="section-title">ç¬¬äºŒç« ï¼šè€ƒå‹¤ç®¡ç†èˆ‡æ‰“å¡è¦ç¯„</div><ul><li>è€ƒå‹¤ä¾æ“šï¼šä¹™æ–¹åŒæ„ä»¥ App ä¹‹ GPS å®šä½æ‰“å¡ï¼Œä½œç‚ºå‡ºå‹¤ç´€éŒ„ä¹‹å”¯ä¸€åˆæ³•ä¾æ“šã€‚</li><li>æ‰“å¡ç¯„åœï¼šç³»çµ±è‡ªå‹•åµæ¸¬ä¸¦è¨˜éŒ„å“¡å·¥æ‰€åœ¨åº§æ¨™èˆ‡æ“šé»ï¼Œç„¡è·é›¢é™åˆ¶ã€‚</li><li>é²åˆ°è™•ç†ï¼šæ¯æœˆçµ¦äºˆ 3 æ¬¡é²åˆ°å¯¬é™ï¼Œæ¯æ¬¡æœ€é«˜ 10 åˆ†é˜ã€‚è‹¥è¶…éå¯¬é™ï¼Œè©²ç¼ºå¤±æ™‚æ•¸å°‡ä¾æ¯”ä¾‹ä¸è¨ˆè–ªã€‚è‹¥ä¹™æ–¹æ¬²ç¶­æŒå…¨è–ªï¼Œæ‡‰ä¸»å‹•ç”³è«‹ä»¥å‰©é¤˜ç‰¹ä¼‘æŠµæ‰£ã€‚</li><li>å¿˜è¨˜æ‰“å¡èˆ‡è£œç™»ï¼šè‹¥å¿˜è¨˜æ‰“å¡ï¼Œæ‡‰æ–¼ç³»çµ±æå‡ºã€Œè£œç™»ç”³è«‹ã€ã€‚æ¯äººæ¯æœˆè£œç™»ä¸Šé™ç‚º 3 æ¬¡ï¼Œè¶…éæ¬¡æ•¸å°‡ç„¡æ³•ç”³è«‹ï¼Œè©²ç•°å¸¸æ™‚æ®µä»¥æ› è·æˆ–äº‹å‡è«–è™•ã€‚è‹¥å‰ä¸€æ—¥æ¼æ‰“ä¸‹ç­å¡ï¼Œé ˆå…ˆå®Œæˆè£œç™»ç”³è«‹æ–¹å¯é€²è¡Œæ¬¡æ—¥æ‰“å¡ã€‚</li></ul>
                    <div class="section-title">ç¬¬ä¸‰ç« ï¼šè«‹å‡èˆ‡ä¼‘å‡è¦ç¯„</div><ul><li>è«‹å‡ç¨‹åºï¼šä¸€èˆ¬è«‹å‡æ‡‰è‡³å°‘æå‰ä¸‰æ—¥æ–¼ç·šä¸Šç”³è«‹ï¼›çªç™¼ç‹€æ³æ‡‰ç¬¬ä¸€æ™‚é–“å‘ŠçŸ¥ä¸¦è£œå–®ã€‚</li><li>é¢±é¢¨å‡åŸå‰‡ï¼šä¾æ”¿åºœç™¼å¸ƒï¼Œéµå¾ªã€Œæ”¾å‡ä½†è©²æ—¥ä¸æ”¯è–ªã€åŸå‰‡ï¼Œä¸æ‰£ç‰¹ä¼‘äº¦ä¸å½±éŸ¿å…¨å‹¤ã€‚</li><li>åŠ ç­ç”³è«‹ï¼šä¾‹å‡æ—¥å‡ºå‹¤é ˆæ–¼ç³»çµ±å¡«å¯«ã€Œèµ·è¨–æ™‚é–“ã€é€å‡ºåŠ ç­å–®ã€‚</li></ul>
                    <div class="section-title">ç¬¬å››ç« ï¼šä¿å¯†å”å®š (NDA) èˆ‡æ™ºæ…§è²¡ç”¢æ¬Š</div><ul><li>ä¿å¯†ç¾©å‹™ï¼šä¹™æ–¹å°ç”²æ–¹ä¹‹å®¢æˆ¶æœªå…¬é–‹ç‡Ÿæ¥­ç§˜å¯†ï¼Œè² çµ•å°ä¿å¯†ç¾©å‹™ã€‚æœªç¶“åŒæ„çµ•ä¸æ´©æ¼ã€‚</li><li>æ­¸é‚„ç¾©å‹™ï¼šé›¢è·æ™‚ï¼Œæ‡‰å°‡æ‰€æœ‰éš¸å±¬å…¬å¸ä¹‹è²¡ç”¢ã€æ©Ÿå¯†è³‡è¨Šã€è¨­å‚™ã€å¯¦é«”èˆ‡æ•¸ä½æª”æ¡ˆå…¨æ•¸æ­¸é‚„ï¼Œçµ•å°ä¸å¾—ç§è‡ªæ‹·è²æˆ–ä¿ç•™ã€‚</li><li>é•ç´„ç½°å‰‡ï¼šä¹™æ–¹è‹¥é•åä¿å¯†ç¾©å‹™ï¼ŒåŒæ„ç„¡æ¢ä»¶è² æ“”æ–°å°å¹£å£¹ä½°è¬å…ƒæ•´ä¹‹æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</li></ul>
                    <div class="section-title">ç¬¬äº”ç« ï¼šè–ªè³‡èˆ‡çµ¦å‡è¨ˆç®—åŸºæº– (ä¾æ“šå‹å‹•åŸºæº–æ³•)</div><ul><li>è–ªè³‡æ›ç®—ï¼šç´„å®šä¹‹æœ¬è–ªå³ç‚ºã€Œæœˆè–ªã€ã€‚æ—¥è–ªä»¥ã€Œæœˆè–ª / 30æ—¥ã€è¨ˆï¼›æ™‚è–ªä»¥ã€Œæœˆè–ª / 240å°æ™‚ã€è¨ˆã€‚</li><li>è«‹å‡æ‰£è–ªï¼šäº‹å‡ä¾æ³•æ‰£é™¤ 100% è©²æ™‚æ®µä¹‹è–ªè³‡ï¼›ç—…å‡ä¾æ³•æ‰£é™¤ 50% è©²æ™‚æ®µä¹‹è–ªè³‡ã€‚é²åˆ°æœªæŠµæ‰£ç‰¹ä¼‘è€…ï¼Œä¾å¯¦éš›ç¼ºå‹¤æ™‚æ•¸æ¯”ä¾‹æ‰£é™¤ã€‚</li><li>åŠ ç­è²»ç‡ï¼šå¹³æ—¥å»¶é•·å·¥æ™‚å‰å…©å°æ™‚æŒ‰æ™‚è–ªåŠ çµ¦ 1.34 å€ï¼Œå¾Œå…©å°æ™‚æŒ‰ 1.67 å€ã€‚å‡æ—¥å‡ºå‹¤ä¾æ³•å®šå€ç‡æ ¸ç™¼ã€‚</li><li>ç´€å¾‹èˆ‡è€ƒæ ¸ï¼šå“¡å·¥ä¹‹è€ƒå‹¤ç•°å¸¸èˆ‡ã€Œé•è¦è¨ˆé»ã€ï¼Œå°‡ç›´æ¥å½±éŸ¿ä¸¦ç´å…¥ã€Œå¹´çµ‚çé‡‘ã€èˆ‡ã€Œç¸¾æ•ˆçé‡‘ã€ä¹‹ç™¼æ”¾è©•ä¼°åŸºæº–ã€‚</li></ul>
                    <div class="signature-box"><div class="stamp">åˆæ³•æ•¸ä½ç°½ç« èªè­‰</div><p><strong>âœ”ï¸ ä¹™æ–¹å·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°å…¨æ¢æ–‡</strong></p><p><strong>âœ”ï¸ ä¹™æ–¹åŒæ„ç³»çµ±ä»¥ GPS å®šä½ç‚ºè€ƒå‹¤å”¯ä¸€ä¾æ“š</strong></p><p><strong>âœ”ï¸ ä¹™æ–¹åŒæ„åš´å®ˆä¿å¯†å”å®š(NDA)ï¼Œå¦‚æœ‰é•é¡˜è² æ“”æ‡²ç½°æ€§é•ç´„é‡‘</strong></p><br><p><strong>æ•¸ä½ç°½ç½²äººï¼ˆä¹™æ–¹ï¼‰ï¼š</strong>${e.full_name}</p><p><strong>ç°½ç½²è£ç½®æˆæ¬Šï¼š</strong>LINE LIFF ç¶å®šé©—è­‰ (${e.line_id})</p><p><strong>ç”Ÿæ•ˆæ™‚é–“ï¼š</strong>${new Date(e.nda_signed_at).toLocaleString('zh-TW')}</p></div>
                    ${startScript} window.onload = function() { setTimeout(() => { window.print(); }, 500); } ${endScript}
                </body></html>
            `;
            printWindow.document.write(html); printWindow.document.close();
        }

        async function calculateSettlement() { const empId = window.currentOffboardEmpId; const lastDay = document.getElementById('modal-off-date').value; const type = document.getElementById('modal-off-type').value; if(!empId || !lastDay) { alert('è«‹å¡«å¯«æœ€å¾Œå·¥ä½œæ—¥'); return; } const e = window.allEmps.find(x => x.id === empId); const { data: lv } = await window._sb.rpc('fn_get_annual_leave_v2', { p_emp_id: e.id }); const proRat = new Date(lastDay).getDate() / 30.0; const proSal = Math.round((proRat > 1 ? 1 : proRat) * e.base_salary); const uHrs = lv?.remain_hours || 0; const lPay = Math.round(uHrs * (e.base_salary / 240)); let sev = 0; if(type === 'éè‡ªé¡˜é›¢è·(è³‡é£)') { const ty = (new Date(lastDay).getTime() - new Date(e.onboarding_date).getTime()) / 31557600000; sev = Math.round(Math.max(0, ty) * 0.5 * e.base_salary); } const tot = proSal + lPay + sev; document.getElementById('res-base').innerText = `NT$ ${e.base_salary.toLocaleString()}`; document.getElementById('res-pro').innerText = `+ NT$ ${proSal.toLocaleString()}`; document.getElementById('res-lvh').innerText = uHrs; document.getElementById('res-lvp').innerText = `+ NT$ ${lPay.toLocaleString()}`; document.getElementById('res-sev').innerText = `+ NT$ ${sev.toLocaleString()}`; document.getElementById('res-total').innerText = `NT$ ${tot.toLocaleString()}`; document.getElementById('modal-off-result').classList.remove('hidden'); globalOffboardData = { employee_id: empId, settlement_type: type, last_working_day: lastDay, base_salary_ref: e.base_salary, prorated_salary: proSal, unused_leave_hours: uHrs, unused_leave_pay: lPay, severance_pay: sev, total_settlement: tot }; }
        async function confirmOffboarding() { if(!globalOffboardData || !confirm('âš ï¸ ç¢ºå®šçµç®—ä¸¦åœæ¬Šï¼Ÿ')) return; await window._sb.from('settlement_records').insert([globalOffboardData]); await window._sb.from('employees').update({ employment_status: 'é›¢è·', is_approved: false, resignation_date: globalOffboardData.last_working_day }).eq('id', globalOffboardData.employee_id); alert('âœ… å¸³è™Ÿå·²æ°¸ä¹…åœæ¬Šã€‚'); closeEmpDetail(); loadAll(); }
        async function exportBankCSV() { const month = document.getElementById('export-mon').value; if(!month) return; const { data } = await window._sb.from('payroll_records').select('total_net_pay, employees(full_name, bank_code, bank_name, bank_user_name, bank_account)').eq('pay_month', month); if(!data || data.length === 0) return; let csv = "\uFEFFéŠ€è¡Œä»£ç¢¼,éŠ€è¡Œåç¨±,æ”¶æ¬¾å¸³è™Ÿ,æˆ¶å,åŒ¯æ¬¾é‡‘é¡,å‚™è¨»\n"; data.forEach(r => { csv += `="${r.employees.bank_code}",${r.employees.bank_name},="${r.employees.bank_account}",${r.employees.bank_user_name},${r.total_net_pay},${month}è–ªè³‡\n`; }); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `HYPASS_${month}_è½‰å¸³æª”.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        async function loadAdminBlt() { const { data: blt } = await window._sb.from('bulletin_board').select('*').order('created_at', {ascending: false}); window.bulletins = blt || []; document.getElementById('list-admin-blt').innerHTML = window.bulletins.map(b => `<div class="p-3 bg-slate-50 rounded-xl border border-slate-100 flex justify-between items-center hover:bg-white transition shadow-sm"><div><div class="text-[10px] text-amber-600 font-black mb-1">${new Date(b.created_at).toISOString().split('T')[0]}</div><div class="font-black text-sm text-slate-800 truncate w-48">${b.title}</div></div><div class="flex space-x-2"><button onclick="editBlt('${b.id}')" class="text-xs bg-sky-100 text-sky-700 font-bold px-3 py-1.5 rounded-lg active:scale-95">âœï¸</button><button onclick="delBlt('${b.id}')" class="text-xs bg-red-100 text-red-700 font-bold px-3 py-1.5 rounded-lg active:scale-95">åˆªé™¤</button></div></div>`).join('') || '<div class="text-center text-xs text-slate-400 py-3">ç„¡æ­·å²å…¬å‘Š</div>'; }
        function editBlt(id) { const b = window.bulletins.find(x => x.id === id); if(!b) return; document.getElementById('blt-edit-id').value = b.id; document.getElementById('blt-title').value = b.title; document.getElementById('blt-content').value = b.content; document.getElementById('blt-form-title').innerText = 'âœï¸ ç·¨è¼¯ä¼æ¥­å…¬å‘Š'; document.getElementById('btn-post-blt').innerText = 'å„²å­˜å…¬å‘Šè®Šæ›´'; document.getElementById('btn-cancel-blt').classList.remove('hidden'); window.scrollTo({top: 0, behavior: 'smooth'}); }
        function cancelEditBlt() { document.getElementById('blt-edit-id').value = ''; document.getElementById('blt-title').value = ''; document.getElementById('blt-content').value = ''; document.getElementById('blt-form-title').innerText = 'ç™¼å¸ƒä¼æ¥­å…¬å‘Š'; document.getElementById('btn-post-blt').innerText = 'ç«‹å³æ¨æ’­è‡³å…¨å“¡é¦–é '; document.getElementById('btn-cancel-blt').classList.add('hidden'); }
        async function postBlt() { const id = document.getElementById('blt-edit-id').value; const title = document.getElementById('blt-title').value; const content = document.getElementById('blt-content').value; if(!title || !content) return; try { if(id) { await window._sb.from('bulletin_board').update({ title, content }).eq('id', id); alert('âœ… å…¬å‘Šå·²æ›´æ–°'); } else { await window._sb.from('bulletin_board').insert([{ title, content }]); alert('âœ… å…¬å‘Šå·²æˆåŠŸæ¨æ’­'); } cancelEditBlt(); loadAdminBlt(); } catch(e) { alert('ç™¼ä½ˆå¤±æ•—'); } }
        async function delBlt(id) { if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡å…¬å‘Šå—ï¼Ÿ')) return; await window._sb.from('bulletin_board').delete().eq('id', id); alert('âœ… å…¬å‘Šå·²åˆªé™¤'); loadAdminBlt(); }
        let cId = null; function editBr(id) { const b = window.branches.find(x=>x.id===id); cId=b.id; document.getElementById('b-n').value=b.branch_name; document.getElementById('b-a').value=b.address; document.getElementById('b-la').value=b.lat; document.getElementById('b-ln').value=b.lng; document.getElementById('btn-cancel-br').classList.remove('hidden'); window.scrollTo({top: 0, behavior: 'smooth'});}
        function cancelEditBr() { cId=null; document.getElementById('b-n').value=''; document.getElementById('b-a').value=''; document.getElementById('b-la').value=''; document.getElementById('b-ln').value=''; document.getElementById('btn-cancel-br').classList.add('hidden'); }
        async function saveBr() { const p={branch_name:document.getElementById('b-n').value, address:document.getElementById('b-a').value, lat:parseFloat(document.getElementById('b-la').value), lng:parseFloat(document.getElementById('b-ln').value)}; if(cId) await window._sb.from('branch_locations').update(p).eq('id', cId); else await window._sb.from('branch_locations').insert([p]); alert('âœ… å®Œæˆ'); cancelEditBr(); loadAll(); }
        async function updLeave(id, st) { try { const { error } = await window._sb.rpc('fn_approve_leave', { p_leave_id: id, p_status: st }); if(error) throw error; alert(`âœ… å·²${st}`); loadAll(); } catch(e) { alert('éŒ¯èª¤: ' + e.message); } }
        async function appr(id) { 
            try { 
                const { data, error } = await window._sb.rpc('fn_approve_employee', { p_emp_id: id }); 
                if(error) throw error; 
                
                const e = window.allEmps.find(x => x.id === id);
                await window._sb.functions.invoke('line-webhook', { body: { action: 'notify_approved', name: e.full_name, employee_no: data.employee_no } }).catch(err=>console.log(err));
                
                alert(`âœ… å“¡å·¥æ¬Šé™å·²é–‹é€šï¼\nç³»çµ±è‡ªå‹•ç™¼æ”¾å°ˆå±¬ç·¨è™Ÿï¼š${data.employee_no}`); 
                loadAll(); 
            } catch(e) { alert('é–‹é€šå¤±æ•—: ' + e.message); } 
        }
    </script>
</body>
</html>
