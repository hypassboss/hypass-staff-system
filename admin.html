<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYPASS | ç®¡ç†å“¡å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        .view-section { display: none; }
        .view-active { display: block; }
        .tab-btn-active { border-bottom: 4px solid #0f172a; color: #0f172a; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-slate-900 text-white shadow-2xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-black italic tracking-tighter text-blue-400">HYPASS</span>
                <span class="text-sm font-bold border-l pl-2 border-slate-700">ç®¡ç†ä¸­å¿ƒ</span>
            </div>
            <div id="admin-info" class="text-xs bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700">
                ç®¡ç†å“¡é©—è­‰ä¸­...
            </div>
        </div>
        <div class="bg-white text-slate-500 border-b flex justify-around overflow-x-auto">
            <button onclick="switchView('view-approvals')" class="tab-btn py-3 px-6 font-bold text-sm">å¾…å¯©æ ¸</button>
            <button onclick="switchView('view-employees')" class="tab-btn py-3 px-6 font-bold text-sm">å“¡å·¥ç®¡ç†</button>
            <button onclick="switchView('view-payroll')" class="tab-btn py-3 px-6 font-bold text-sm">è–ªè³‡çµç®—</button>
            <button onclick="switchView('view-attendance')" class="tab-btn py-3 px-6 font-bold text-sm">æ‰“å¡ç´€éŒ„</button>
        </div>
    </nav>

    <main id="main-content" class="max-w-7xl mx-auto p-4 md:p-8">
        
        <div id="status-unauthorized" class="view-section py-20 text-center">
            <div class="text-6xl mb-4">ğŸš«</div>
            <h2 class="text-2xl font-black text-slate-800">ç„¡å­˜å–æ¬Šé™</h2>
            <p class="text-slate-500 mt-2">åªæœ‰åœ¨ system_admins è¡¨ä¸­çš„ç®¡ç†å“¡å¯é€²å…¥æ­¤å€ã€‚</p>
        </div>

        <section id="view-approvals" class="view-section space-y-4">
            <h3 class="text-xl font-black text-slate-800 mb-6">å¾…æ ¸å‡†å…¥è·äººå“¡</h3>
            <div id="approval-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="animate-pulse bg-white p-6 rounded-2xl h-40"></div>
            </div>
        </section>

        <section id="view-employees" class="view-section">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">å“¡å·¥å§“å</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">èº«åˆ†è­‰/åœ°å€/é›»è©±</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">è–ªè³‡/è‡ªæ</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">ç‰¹ä¼‘é¤˜é¡</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="employee-table-body" class="bg-white divide-y divide-gray-200 text-sm">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="view-payroll" class="view-section space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-black">2026 å¹´ 02 æœˆ è–ªè³‡é ä¼°å ±è¡¨</h3>
                    <p class="text-xs text-gray-400">ä¾æ“š 240 å°æ™‚åˆ¶èˆ‡ 30 æ—¥ç´¯åŠ æ³•è¨ˆè–ª</p>
                </div>
                <button onclick="exportPayrollCSV()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold text-sm">åŒ¯å‡ºè–ªè³‡è½‰å¸³æª” (CSV)</button>
            </div>
            <div id="payroll-container" class="space-y-4">
                </div>
        </section>

        <section id="view-attendance" class="view-section">
            <div class="bg-white p-6 rounded-2xl shadow-sm">
                <h3 class="text-xl font-black mb-4">å…¨é«”å‡ºå‹¤èˆ‡ç‰¹ä¼‘æŠµæ‰£æ—¥èªŒ</h3>
                <div id="attendance-logs" class="space-y-2 max-h-[600px] overflow-y-auto">
                    </div>
            </div>
        </section>

    </main>

    

    <script>
        // --- é…ç½® ---
        const SB_URL = 'YOUR_SUPABASE_URL';
        const SB_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const LIFF_ID = 'YOUR_LIFF_ID';
        const _sb = supabase.createClient(SB_URL, SB_KEY);
        let adminUser = null;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const p = await liff.getProfile();
            
            // æ¬Šé™æª¢æ ¸ï¼šæŸ¥ system_admins è¡¨
            const { data: adminData } = await _sb.from('system_admins').select('*').eq('line_id', p.userId).single();
            
            if (!adminData) {
                show('status-unauthorized');
                document.getElementById('admin-info').innerText = "éç®¡ç†å“¡èº«åˆ†";
                return;
            }

            adminUser = adminData;
            document.getElementById('admin-info').innerText = `ç®¡ç†å“¡: ${p.displayName}`;
            switchView('view-approvals'); // é è¨­é¡¯ç¤ºå¾…å¯©æ ¸
        }

        function show(id) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('view-active'));
            document.getElementById(id).classList.add('view-active');
        }

        async function switchView(viewId) {
            show(viewId);
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-btn-active'));
            document.querySelector(`[onclick="switchView('${viewId}')"]`).classList.add('tab-btn-active');

            if (viewId === 'view-approvals') loadApprovals();
            if (viewId === 'view-employees') loadEmployees();
            if (viewId === 'view-payroll') loadPayroll();
            if (viewId === 'view-attendance') loadAttendance();
        }

        // --- æ ¸å¿ƒé‚è¼¯ 1: å¯©æ ¸æµç¨‹ ---
        async function loadApprovals() {
            const list = document.getElementById('approval-list');
            const { data } = await _sb.from('employees').select('*').eq('is_approved', false);
            
            if (!data || data.length === 0) {
                list.innerHTML = '<div class="p-8 text-center col-span-2 text-gray-400">ç›®å‰ç„¡å¾…æ ¸å‡†äººå“¡</div>';
                return;
            }

            list.innerHTML = data.map(emp => `
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-yellow-400">
                    <h4 class="font-black text-lg">${emp.full_name}</h4>
                    <div class="text-xs text-gray-500 mt-2 space-y-1">
                        <p>ID: ${emp.id_number}</p>
                        <p>åœ°å€: ${emp.address}</p>
                        <p>éŠ€è¡Œ: ${emp.bank_account}</p>
                    </div>
                    <button onclick="approveUser('${emp.id}')" class="mt-4 w-full bg-slate-900 text-white py-2 rounded-lg font-bold">æ ¸å‡†å…¥è·</button>
                </div>
            `).join('');
        }

        async function approveUser(empId) {
            if (!confirm('ç¢ºèªæ ¸å‡†è©²å“¡å·¥å…¥è·ï¼Ÿæ ¸å‡†å¾Œå°‡é–‹å•Ÿæ‰“å¡èˆ‡è–ªè³‡è¨ˆç®—ã€‚')) return;
            const { error } = await _sb.from('employees').update({ is_approved: true }).eq('id', empId);
            if (!error) {
                // åˆå§‹åŒ–ç‰¹ä¼‘å¸³æˆ¶
                await _sb.from('leave_balances').insert({ employee_id: empId, annual_leave_hours: 0 });
                loadApprovals();
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ 2: å“¡å·¥ç®¡ç†èˆ‡ PII ---
        async function loadEmployees() {
            const { data } = await _sb.from('employees').select('*, leave_balances(annual_leave_hours)');
            const tbody = document.getElementById('employee-table-body');
            
            tbody.innerHTML = data.map(emp => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-bold text-slate-800">${emp.full_name}<br><span class="text-[10px] text-gray-400">${emp.email}</span></td>
                    <td class="px-6 py-4 text-[11px] leading-tight text-gray-600">èº«åˆ†è­‰: ${emp.id_number}<br>åœ°å€: ${emp.address}<br>é›»è©±: ${emp.phone}</td>
                    <td class="px-6 py-4 font-mono font-bold text-blue-700">$${emp.base_salary}<br><span class="text-[10px] text-gray-400">è‡ªæ: ${emp.labor_percent}%</span></td>
                    <td class="px-6 py-4 font-black">${emp.leave_balances?.[0]?.annual_leave_hours || 0} h</td>
                    <td class="px-6 py-4">
                        <button onclick="adjustLeave('${emp.id}')" class="text-blue-600 font-bold">èª¿æ•´ç‰¹ä¼‘</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- æ ¸å¿ƒé‚è¼¯ 3: è–ªè³‡çµç®—ç²¾ç®— (240h + çœ·å±¬) ---
        async function loadPayroll() {
            const { data: employees } = await _sb.from('employees').select('*').eq('is_approved', true);
            const container = document.getElementById('payroll-container');

            container.innerHTML = employees.map(emp => {
                const hourlyRate = (emp.base_salary / 240).toFixed(2);
                const dailyRate = (emp.base_salary / 30).toFixed(2);
                // ç°¡æ˜“å‰ç«¯æ¨¡æ“¬å¥ä¿å°é ‚è¨ˆç®—
                const healthCount = Math.min(emp.family_insured_count + 1, 4);
                
                return `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <span class="text-xs bg-slate-100 px-2 py-0.5 rounded font-bold">${emp.full_name}</span>
                            <div class="mt-2 text-sm text-gray-600 space-x-4">
                                <span>æ™‚è–ª: <b class="text-slate-900">$${hourlyRate}</b></span>
                                <span>å¥ä¿è¨ˆç®—äººæ•¸: <b class="text-slate-900">${healthCount}</b></span>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0 text-right">
                            <p class="text-xs text-gray-400">æœ¬æœˆé è¨ˆå¯¦ç™¼ (æœªæ‰£é™¤è€ƒå‹¤)</p>
                            <h4 class="text-2xl font-black text-blue-900 italic">$${emp.base_salary}</h4>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- æ ¸å¿ƒé‚è¼¯ 4: æ‰“å¡æ—¥èªŒ (å«è‡ªå‹•æŠµæ‰£è¨»è¨˜) ---
        async function loadAttendance() {
            const { data } = await _sb.from('attendance_logs').select('*, employees(full_name)').order('punch_time', { ascending: false });
            const logContainer = document.getElementById('attendance-logs');

            logContainer.innerHTML = data.map(log => `
                <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center text-xs">
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-slate-700">${log.employees.full_name}</span>
                        <span class="${log.punch_type === 'IN' ? 'text-green-600' : 'text-orange-600'} font-black">${log.punch_type}</span>
                        <span class="text-gray-400">${new Date(log.punch_time).toLocaleString()}</span>
                    </div>
                    <div class="text-right">
                        ${log.is_offset_applied ? '<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold">ç‰¹ä¼‘å·²æŠµæ‰£</span>' : ''}
                        <p class="text-[10px] text-gray-400 mt-1">${log.note || ''}</p>
                    </div>
                </div>
            `).join('');
        }

        init();
    </script>
</body>
</html>
