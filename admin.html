<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPASS | 老闆指揮中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>.tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.2s ease-in-out; } @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }</style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
    <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-50">
        <h1 class="text-lg font-black italic text-amber-400">HYPASS ADMIN</h1>
        <button onclick="location.reload()" id="logout" class="hidden text-xs bg-red-600 px-3 py-1.5 rounded font-bold">登出</button>
    </header>

    <div id="login-box" class="flex flex-col items-center justify-center py-20 px-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-black mb-6">最高權限解鎖</h2>
            <input type="password" id="pin" placeholder="管理密碼" class="w-full border p-4 text-center text-2xl tracking-[0.5em] rounded-xl outline-none mb-6 bg-slate-50">
            <button onclick="login()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl active:scale-95">解鎖進入</button>
        </div>
    </div>

    <main id="main-dash" class="container mx-auto p-4 max-w-lg hidden">
        <div class="grid grid-cols-2 gap-2 mb-6 bg-white p-2 rounded-2xl shadow-sm border">
            <button onclick="st('pend')" id="t-pend" class="t-btn active px-3 py-3 text-sm font-black bg-slate-900 text-white rounded-xl">審核與請假</button>
            <button onclick="st('brs')" id="t-brs" class="t-btn px-3 py-3 text-sm font-black text-slate-500 rounded-xl">分店據點</button>
            <button onclick="st('pay')" id="t-pay" class="t-btn px-3 py-3 text-sm font-black text-slate-500 rounded-xl">發放薪資</button>
            <button onclick="st('bull')" id="t-bull" class="t-btn px-3 py-3 text-sm font-black text-slate-500 rounded-xl">發布公告</button>
        </div>

        <section id="pend" class="tab-content active space-y-4">
            <h3 class="font-black border-l-4 border-blue-500 pl-2 text-lg">新進員工審核</h3>
            <div id="list-pend" class="space-y-3"></div>
            <h3 class="font-black border-l-4 border-amber-500 pl-2 text-lg mt-6">假單簽核</h3>
            <div id="list-leaves" class="space-y-3"></div>
        </section>

        <section id="brs" class="tab-content space-y-4">
            <h3 class="font-black border-l-4 border-emerald-500 pl-2 text-lg">新增分店據點</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border mb-4">
                <input type="text" id="b-n" placeholder="分店名稱" class="w-full p-3 border rounded-xl mb-3 text-sm">
                <input type="text" id="b-a" onblur="autoGeoCode()" placeholder="輸入地址 (輸入完點擊旁邊自動定位)" class="w-full p-3 border rounded-xl mb-3 text-sm bg-sky-50">
                <div class="grid grid-cols-2 gap-3 mb-3"><input type="number" id="b-la" placeholder="緯度" class="p-3 border rounded-xl bg-slate-100 text-sm" readonly><input type="number" id="b-ln" placeholder="經度" class="p-3 border rounded-xl bg-slate-100 text-sm" readonly></div>
                <button onclick="addBr()" class="w-full bg-emerald-600 text-white font-black py-3 rounded-xl">儲存據點</button>
            </div>
            <div id="list-brs" class="space-y-3"></div>
        </section>

        <section id="pay" class="tab-content space-y-4">
            <h3 class="font-black border-l-4 border-indigo-500 pl-2 text-lg">發派當月薪資單</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border space-y-3">
                <select id="p-emp" class="w-full p-3 border rounded-xl text-sm font-bold bg-slate-50"></select>
                <input type="month" id="p-mon" class="w-full p-3 border rounded-xl text-sm font-bold bg-slate-50">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">底薪</label><input type="number" id="p-base" class="w-full p-3 border rounded-xl text-sm"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">獎金</label><input type="number" id="p-bonus" class="w-full p-3 border rounded-xl text-sm"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">年終獎金</label><input type="number" id="p-yeb" class="w-full p-3 border rounded-xl text-sm"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">勞退公司提撥 (資訊)</label><input type="number" id="p-pen" class="w-full p-3 border rounded-xl text-sm"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">勞健保扣除額 (-)</label><input type="number" id="p-ins" class="w-full p-3 border rounded-xl text-sm border-red-200 bg-red-50 text-red-600 font-bold"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">總計實領</label><input type="number" id="p-net" class="w-full p-3 border rounded-xl text-lg bg-sky-50 font-black text-sky-600"></div>
                </div>
                <button onclick="issuePayroll()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl shadow-md mt-2">發送薪資單至員工 App</button>
            </div>
        </section>

        <section id="bull" class="tab-content space-y-4">
            <h3 class="font-black border-l-4 border-amber-500 pl-2 text-lg">發布電子公告</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border">
                <input type="text" id="blt-title" placeholder="公告標題" class="w-full p-3 border rounded-xl mb-3 text-sm font-bold">
                <textarea id="blt-content" placeholder="公告內容..." class="w-full p-3 border rounded-xl mb-3 text-sm h-32"></textarea>
                <button onclick="postBlt()" class="w-full bg-amber-500 text-white font-black py-4 rounded-xl shadow-md">立即推播公告</button>
            </div>
        </section>
    </main>

    <script>
        const _sb = supabase.createClient('https://obbcgmgkbazwpfvgbupg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'); // ⚠️
        function login() { if(document.getElementById('pin').value==='888888'){ document.getElementById('login-box').style.display='none'; document.getElementById('main-dash').style.display='block'; loadAll(); } }
        function st(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.t-btn').forEach(e=>{e.classList.remove('bg-slate-900','text-white'); e.classList.add('text-slate-500');}); document.getElementById(id).classList.add('active'); document.getElementById('t-'+id).classList.add('bg-slate-900','text-white'); }
        
        async function loadAll() {
            const { data: p } = await _sb.from('employees').select('*').eq('is_approved', false);
            document.getElementById('list-pend').innerHTML = p.length ? p.map(e => `<div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm"><h4 class="font-black text-base">${e.full_name}</h4><button onclick="appr('${e.id}')" class="bg-blue-600 text-white text-sm font-black px-4 py-2 rounded-lg">核准開通</button></div>`).join('') : '<p class="text-sm text-slate-400 text-center py-4 bg-slate-50 rounded-xl">無待審核名單</p>';
            
            const { data: em } = await _sb.from('employees').select('id, full_name').eq('is_approved', true);
            document.getElementById('p-emp').innerHTML = em.map(e => `<option value="${e.id}">${e.full_name}</option>`).join('');

            const { data: lv } = await _sb.from('leave_requests').select('*, employees(full_name)').eq('status', '審核中');
            document.getElementById('list-leaves').innerHTML = lv.length ? lv.map(l => `<div class="bg-white p-4 rounded-xl border shadow-sm"><div class="flex justify-between mb-2"><span class="font-black text-sm">${l.employees.full_name} - ${l.leave_type}</span><span class="text-xs text-sky-600 font-bold bg-sky-50 px-2 py-1 rounded">${l.salary_protection?'保薪':''}</span></div><div class="flex space-x-2"><button onclick="updLeave('${l.id}', '核准')" class="flex-1 bg-emerald-100 text-emerald-700 py-3 rounded-xl text-sm font-black">核准</button><button onclick="updLeave('${l.id}', '核駁')" class="flex-1 bg-red-100 text-red-700 py-3 rounded-xl text-sm font-black">核駁</button></div></div>`).join('') : '<p class="text-sm text-slate-400 text-center py-4 bg-slate-50 rounded-xl">目前無假單</p>';

            const { data: br } = await _sb.from('branch_locations').select('*');
            document.getElementById('list-brs').innerHTML = br.map(b => `<div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm"><div><p class="font-black text-base">${b.branch_name}</p><p class="text-xs text-slate-500 mt-1">${b.address}</p></div></div>`).join('');
        }

        async function autoGeoCode() {
            const addr = document.getElementById('b-a').value; if(!addr) return;
            document.getElementById('b-la').value = '定位中...'; document.getElementById('b-ln').value = '定位中...';
            try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`); const data = await res.json(); if(data && data.length > 0) { document.getElementById('b-la').value = data[0].lat; document.getElementById('b-ln').value = data[0].lon; } else { alert('找不到地址'); document.getElementById('b-la').value = ''; document.getElementById('b-ln').value = ''; } } catch (e) { alert('定位失敗'); }
        }

        async function appr(id) { await _sb.from('employees').update({is_approved:true}).eq('id',id); loadAll(); alert('✅ 員工已開通'); }
        async function updLeave(id, st) { await _sb.from('leave_requests').update({status:st}).eq('id',id); loadAll(); alert('✅ 假單已' + st); }
        async function addBr() { await _sb.from('branch_locations').insert([{ branch_name: document.getElementById('b-n').value, address: document.getElementById('b-a').value, lat: document.getElementById('b-la').value, lng: document.getElementById('b-ln').value }]); loadAll(); alert('✅ 據點新增成功'); }
        async function postBlt() { await _sb.from('bulletin_board').insert([{ title: document.getElementById('blt-title').value, content: document.getElementById('blt-content').value }]); alert('✅ 公告已推播'); document.getElementById('blt-title').value=''; document.getElementById('blt-content').value=''; }
        async function issuePayroll() { await _sb.from('payroll_records').insert([{ employee_id: document.getElementById('p-emp').value, pay_month: document.getElementById('p-mon').value, base_pay: document.getElementById('p-base').value || 0, bonus: document.getElementById('p-bonus').value || 0, year_end_bonus: document.getElementById('p-yeb').value || 0, labor_pension: document.getElementById('p-pen').value || 0, insurance_deduction: document.getElementById('p-ins').value || 0, total_net_pay: document.getElementById('p-net').value || 0 }]); alert('✅ 薪資單派發成功'); }
    </script>
</body>
</html>
