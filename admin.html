<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPASS | ä¼æ¥­æŒ‡æ®ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; } 
        @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} } 
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-panel { background: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); border: 1px solid #e2e8f0; }
        .admin-input { width: 100%; padding: 0.875rem; border: 1px solid #cbd5e1; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.2s; }
        .admin-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .modal { display: none; } .modal.active { display: flex; z-index: 100; }
    </style>
</head>
<body class="text-slate-800 font-sans min-h-screen pb-24">
    <header class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-5 flex justify-between items-center shadow-lg sticky top-0 z-50">
        <div><h1 class="text-xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-300">HYPASS</h1><span class="text-[9px] text-slate-400 tracking-[0.2em] uppercase font-bold">Admin Portal</span></div>
        <button onclick="location.reload()" id="logout" class="hidden text-[10px] bg-white/10 border border-white/20 hover:bg-red-500 hover:border-red-500 px-3 py-1.5 rounded-full font-bold transition-all">å®‰å…¨ç™»å‡º</button>
    </header>

    <div id="login-box" class="flex flex-col items-center justify-center pt-32 px-5">
        <div class="glass-panel p-8 w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">ğŸ‘‘</div>
            <h2 class="text-2xl font-black mb-2 text-slate-800">æœ€é«˜æ¬Šé™é©—è­‰</h2>
            <p class="text-xs text-slate-500 mb-6">è«‹è¼¸å…¥ç®¡ç†é‡‘é‘°è§£é–æŒ‡æ®ä¸­å¿ƒ</p>
            <input type="password" id="pin" placeholder="PIN CODE" class="admin-input text-center text-2xl tracking-[0.5em] mb-6 bg-slate-50 font-black text-slate-700">
            <button onclick="login()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform">é©—è­‰ä¸¦ç™»å…¥</button>
        </div>
    </div>

    <main id="main-dash" class="container mx-auto p-4 max-w-2xl hidden mt-2">
        <div class="grid grid-cols-3 gap-2 mb-6">
            <button onclick="st('pend')" id="t-pend" class="t-btn active flex flex-col items-center justify-center py-3.5 bg-slate-900 text-white rounded-2xl shadow-md border border-transparent transition-all"><span class="text-2xl mb-1">ğŸ”´</span><span class="t-text text-[11px] font-black tracking-widest">å¾…è¾¦å¯©æ ¸</span></button>
            <button onclick="st('pay')" id="t-pay" class="t-btn flex flex-col items-center justify-center py-3.5 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all"><span class="text-2xl mb-1">ğŸ’°</span><span class="t-text text-[11px] font-bold tracking-widest">è–ªè³‡åŒ¯æ¬¾</span></button>
            <button onclick="st('emps')" id="t-emps" class="t-btn flex flex-col items-center justify-center py-3.5 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all"><span class="text-2xl mb-1">ğŸ‘¥</span><span class="t-text text-[11px] font-bold tracking-widest">å“¡å·¥/è³‡é£</span></button>
            <button onclick="st('att')" id="t-att" class="t-btn flex flex-col items-center justify-center py-3.5 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all"><span class="text-2xl mb-1">ğŸ“‹</span><span class="t-text text-[11px] font-bold tracking-widest">å‡ºå‹¤ç´€éŒ„</span></button>
            <button onclick="st('brs')" id="t-brs" class="t-btn flex flex-col items-center justify-center py-3.5 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all"><span class="text-2xl mb-1">ğŸ“</span><span class="t-text text-[11px] font-bold tracking-widest">æ“šé»ç®¡ç†</span></button>
            <button onclick="st('bull')" id="t-bull" class="t-btn flex flex-col items-center justify-center py-3.5 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all"><span class="text-2xl mb-1">ğŸ“¢</span><span class="t-text text-[11px] font-bold tracking-widest">ä¼æ¥­å…¬å‘Š</span></button>
        </div>

        <section id="pend" class="tab-content active space-y-6">
            <div><h3 class="font-black text-slate-800 border-l-4 border-blue-500 pl-3 text-lg mb-3">æ–°é€²å“¡å·¥å¯©æ ¸</h3><div id="list-pend" class="space-y-3"></div></div>
            <div><h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-3">å‡å–®ç°½æ ¸ä¸­å¿ƒ</h3><div id="list-leaves" class="space-y-3"></div></div>
        </section>

        <section id="pay" class="tab-content space-y-6">
            <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-[1.5rem] shadow-lg text-white relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 text-7xl opacity-20">ğŸ¦</div>
                <h3 class="font-black text-lg mb-1 relative z-10">éŠ€è¡Œè–ªè³‡è½‰å¸³æª” (CSV)</h3>
                <p class="text-xs text-emerald-100 mb-4 relative z-10 font-medium">æ”¯æ´ç„¡æ³•ç›´æ¥ä¸‹è¼‰çš„æ‰‹æ©Ÿï¼Œæä¾›ä¸€éµè¤‡è£½å‚™æ¡ˆ</p>
                <div class="flex space-x-2 relative z-10"><input type="month" id="export-mon" class="admin-input bg-white/20 border-white/30 text-white placeholder-white/50 flex-1" style="color-scheme: dark;"><button onclick="exportBankCSV()" class="bg-white text-emerald-700 font-black px-5 py-3 rounded-xl shadow-md active:scale-95 transition">ç”¢ç”Ÿæª”æ¡ˆ</button></div>
            </div>

            <div class="glass-panel p-6 space-y-4">
                <h3 class="font-black text-slate-800 border-l-4 border-indigo-500 pl-3 text-lg mb-2">ç™¼æ´¾æœˆè–ªèˆ‡å¹´çµ‚</h3>
                <p class="text-[10px] text-slate-500 mb-4 bg-slate-50 p-2 rounded-lg border">ğŸ’¡ æç¤ºï¼šç™¼è–ªå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜æ†¶è©²å“¡å·¥çš„æœ¬è–ªæ•¸å€¼ï¼Œä¸‹æ¬¡ç„¡éœ€é‡å¡«ã€‚</p>
                <div class="grid grid-cols-2 gap-3 mb-2"><select id="p-emp" class="admin-input bg-slate-50 font-bold" onchange="autoFillLaw()"></select><input type="month" id="p-mon" class="admin-input bg-slate-50 font-bold"></div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200 grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">æœ¬è–ª</label><input type="number" id="p-base" oninput="autoFillLaw()" class="admin-input font-black text-slate-800"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">çé‡‘æ´¥è²¼</label><input type="number" id="p-bonus" oninput="autoFillLaw()" class="admin-input font-black text-emerald-600"></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-amber-600 ml-1">å¹´çµ‚çé‡‘ (ç„¡å‰‡å…å¡«)</label><input type="number" id="p-yeb" oninput="autoFillLaw()" class="admin-input font-black text-amber-600 border-amber-200 bg-amber-50"></div>
                </div>
                <div class="p-4 bg-red-50 rounded-xl border border-red-100 grid grid-cols-2 gap-3 relative">
                    <button onclick="autoFillLaw()" class="absolute -top-3 right-3 text-[9px] bg-slate-800 text-white font-bold px-2 py-1 rounded shadow-sm">ğŸ¤– ä¾çœ·å±¬è‡ªå‹•ç²¾ç®—</button>
                    <div><label class="text-[10px] font-bold text-red-800 ml-1">å‹å¥ä¿æ‰£é™¤</label><input type="number" id="p-ins" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200"></div>
                    <div><label class="text-[10px] font-bold text-red-800 ml-1">äºŒä»£å¥ä¿</label><input type="number" id="p-2nd" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200"></div>
                </div>
                <div class="flex justify-between items-end pt-2 px-1"><span class="text-xs font-black text-slate-400">ç³»çµ±å¯¦é ˜æ ¸ç®—</span><input type="number" id="p-net" class="w-40 border-none text-3xl font-black text-sky-600 text-right bg-transparent outline-none" readonly></div>
                <input type="hidden" id="p-pen">
                <button onclick="issuePayroll()" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform mt-2">æ­£å¼ç™¼é€è–ªè³‡å–®</button>
            </div>
        </section>

        <section id="emps" class="tab-content space-y-5">
            <h3 class="font-black text-slate-800 border-l-4 border-sky-500 pl-3 text-lg mb-3">å“¡å·¥è³‡æ–™ç¸½è¡¨èˆ‡ç®¡ç†</h3>
            <div id="list-all-emps" class="space-y-3"></div>
        </section>

        <section id="att" class="tab-content space-y-5">
            <div class="flex justify-between items-end mb-3">
                <h3 class="font-black text-slate-800 border-l-4 border-purple-500 pl-3 text-lg">å…¨é«”å‡ºå‹¤çœ‹æ¿</h3>
                <input type="date" id="att-date-filter" class="p-2 text-xs border rounded-lg font-bold outline-none" onchange="loadAttendance()">
            </div>
            <div id="list-attendance" class="space-y-3"></div>
        </section>

        <section id="brs" class="tab-content space-y-5">
            <div class="glass-panel p-6 shadow-sm mb-4">
                <h3 class="font-black text-slate-800 border-l-4 border-emerald-500 pl-3 text-lg mb-4">æ–°å¢æ‰“å¡æ“šé»</h3>
                <input type="text" id="b-n" placeholder="åˆ†åº—åç¨±" class="admin-input mb-3 font-bold">
                <input type="text" id="b-a" onblur="autoGeoCode()" placeholder="è²¼ä¸Š Google Maps ç¶²å€è‡ªå‹•è§£æ" class="admin-input mb-1 bg-sky-50">
                <p class="text-[9px] text-slate-400 font-bold px-1 mb-3">è¼¸å…¥å®Œé»æ“Šç©ºç™½è™•ï¼Œç³»çµ±å°‡è‡ªå‹•æ“·å–ç¶“ç·¯åº¦</p>
                <div class="grid grid-cols-2 gap-3 mb-5"><input type="number" step="any" id="b-la" placeholder="ç·¯åº¦" class="admin-input bg-slate-50 font-mono text-sm"><input type="number" step="any" id="b-ln" placeholder="ç¶“åº¦" class="admin-input bg-slate-50 font-mono text-sm"></div>
                <button onclick="addBr()" class="w-full bg-emerald-600 text-white font-black py-3.5 rounded-xl shadow-md">å„²å­˜æ–°æ“šé»</button>
            </div>
            <h4 class="font-black text-sm text-slate-600 px-2">ç¾æœ‰æ“šé»æ¸…å–®</h4><div id="list-brs" class="space-y-3"></div>
        </section>

        <section id="bull" class="tab-content space-y-5">
            <div class="glass-panel p-6 shadow-sm">
                <h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-4">ç™¼å¸ƒæ–°å…¬å‘Š</h3>
                <input type="text" id="blt-title" placeholder="ä¸»æ—¨æ¨™é¡Œ" class="admin-input mb-3 font-bold text-lg">
                <textarea id="blt-content" placeholder="è«‹è¼¸å…¥è©³ç´°å…¬å‘Šå…§å®¹..." class="admin-input mb-5 h-32 resize-none leading-relaxed"></textarea>
                <button onclick="postBlt()" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-black py-4 rounded-xl shadow-lg">æ¨æ’­ç™¼å¸ƒ</button>
            </div>
            <h4 class="font-black text-sm text-slate-600 px-2 mt-6">ç¾æœ‰å…¬å‘Šç®¡ç†</h4>
            <div id="list-bulls" class="space-y-3"></div>
        </section>
    </main>

    <div id="csv-modal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-sm items-center justify-center p-5 z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 relative flex flex-col shadow-2xl">
            <h3 class="font-black text-lg text-slate-800 mb-2">ğŸ“„ è½‰å¸³è³‡æ–™å·²ç”¢ç”Ÿ</h3>
            <p class="text-xs text-slate-500 mb-4">è‹¥æ‰‹æ©Ÿç€è¦½å™¨é˜»æ“‹ä¸‹è¼‰ï¼Œè«‹ç›´æ¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½å…§å®¹ï¼Œä¸¦è²¼åˆ°é›»è…¦ Excel ä¸­å„²å­˜ç‚º CSV æª”ã€‚</p>
            <textarea id="csv-raw-text" readonly class="w-full h-48 p-3 bg-slate-50 border rounded-xl text-[10px] font-mono whitespace-pre text-slate-700 outline-none"></textarea>
            <div class="flex space-x-3 mt-4">
                <button onclick="closeModal('csv-modal')" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl transition">é—œé–‰</button>
                <button onclick="copyCSV()" class="flex-1 bg-emerald-600 text-white font-black py-3 rounded-xl shadow-md">ğŸ“‹ é»æˆ‘è¤‡è£½å…§å®¹</button>
            </div>
        </div>
    </div>

    <div id="emp-modal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-sm items-end justify-center z-[100]">
        <div class="bg-white w-full max-w-md rounded-t-[2rem] p-6 h-[85vh] flex flex-col shadow-2xl overflow-y-auto no-scrollbar relative">
            <button onclick="closeModal('emp-modal')" class="absolute top-4 right-4 bg-slate-100 px-3 py-1.5 rounded-full text-xs font-bold text-slate-600">âœ• é—œé–‰</button>
            <h3 id="em-name" class="font-black text-2xl text-slate-800 mb-1 mt-2">--</h3>
            <p id="em-id" class="text-xs text-slate-400 font-mono mb-4 border-b pb-4">--</p>
            
            <div class="space-y-4 flex-1">
                <div><label class="text-[10px] font-bold text-slate-500 ml-1">è¯çµ¡é›»è©±</label><input type="text" id="em-phone" class="admin-input text-sm"></div>
                <div><label class="text-[10px] font-bold text-slate-500 ml-1">é€šè¨Šåœ°å€</label><input type="text" id="em-addr" class="admin-input text-sm"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">é è¨­åº•è–ª</label><input type="number" id="em-base" class="admin-input font-black text-slate-800"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">çœ·å±¬äººæ•¸</label><input type="number" id="em-deps" class="admin-input font-black text-sky-600"></div>
                </div>
                <button onclick="saveEmpData()" class="w-full bg-slate-900 text-white font-black py-3.5 rounded-xl shadow-md mt-2">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
                
                <div class="mt-8 border-t pt-6">
                    <h4 class="text-sm font-black text-red-600 mb-2 flex items-center"><span class="mr-1">âš”ï¸</span>é›¢è·èˆ‡è³‡é£çµç®—</h4>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100 space-y-3">
                        <select id="off-type" class="admin-input text-xs font-bold"><option value="è‡ªé¡˜é›¢è·">ä¸€èˆ¬é›¢è· (ç„¡è³‡é£è²»)</option><option value="éè‡ªé¡˜é›¢è·(è³‡é£)">éè‡ªé¡˜é›¢è· (å«è³‡é£è²»)</option></select>
                        <div><label class="text-[10px] font-bold text-slate-500 ml-1">æœ€å¾Œå·¥ä½œæ—¥</label><input type="date" id="off-date" class="admin-input text-xs"></div>
                        <button onclick="calculateSettlement()" class="w-full bg-red-600 text-white font-black py-3 rounded-lg shadow-sm">é–‹å§‹ç²¾ç®—</button>
                        
                        <div id="off-result" class="hidden mt-3 border-t border-red-200 pt-3 space-y-1.5">
                            <div class="flex justify-between text-xs"><span class="font-bold text-slate-600">ç ´æœˆè–ªè³‡</span><span id="off-res-pro" class="font-black text-slate-800">+ NT$ 0</span></div>
                            <div class="flex justify-between text-xs"><span class="font-bold text-slate-600">æœªä¼‘ç‰¹ä¼‘æ›ç¾</span><span id="off-res-lvp" class="font-black text-slate-800">+ NT$ 0</span></div>
                            <div class="flex justify-between text-xs border-b border-red-200 pb-2"><span class="font-bold text-slate-600">è³‡é£è²»</span><span id="off-res-sev" class="font-black text-amber-600">+ NT$ 0</span></div>
                            <div class="flex justify-between text-sm items-end pt-1"><span class="font-black text-red-800">ç¸½è¨ˆç™¼æ”¾</span><span id="off-res-total" class="text-xl font-black text-red-600">NT$ 0</span></div>
                            <button onclick="confirmOffboarding()" class="w-full bg-slate-900 text-white font-black py-3 rounded-lg mt-3">ç¢ºèªçµç®—ä¸¦åœæ¬Š</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const _sb = supabase.createClient('https://obbcgmgkbazwpfvgbupg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'); // âš ï¸
        let globalOffboardData = null; window.empData = {}; window.currentEditEmpId = null;

        function login() { if(document.getElementById('pin').value==='888888'){ document.getElementById('login-box').style.display='none'; document.getElementById('main-dash').style.display='block'; document.getElementById('logout').style.display='block'; loadAll(); } else alert('å¯†ç¢¼éŒ¯èª¤'); }
        function st(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.t-btn').forEach(e=>{e.classList.remove('bg-slate-900','text-white','shadow-md','border-transparent'); e.classList.add('bg-white','text-slate-500','border-slate-200'); e.querySelector('.t-text').classList.remove('font-black'); e.querySelector('.t-text').classList.add('font-bold');}); document.getElementById(id).classList.add('active'); const activeBtn = document.getElementById('t-'+id); activeBtn.classList.remove('bg-white','text-slate-500','border-slate-200'); activeBtn.classList.add('bg-slate-900','text-white','shadow-md','border-transparent'); activeBtn.querySelector('.t-text').classList.remove('font-bold'); activeBtn.querySelector('.t-text').classList.add('font-black'); if(id === 'bull') loadBulls(); if(id === 'att') loadAttendance(); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function loadAll() {
            const { data: emps } = await _sb.from('employees').select('*');
            const p = emps.filter(e => !e.is_approved && e.employment_status === 'åœ¨è·');
            document.getElementById('list-pend').innerHTML = p.length ? p.map(e => `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><span class="text-2xl mr-3">ğŸ‘¤</span><div><h4 class="font-black text-sm text-slate-800"><span class="text-[10px] text-sky-600 mr-1">[${e.work_region}]</span>${e.full_name}</h4><p class="text-[10px] text-slate-500">${e.onboarding_date} å…¥è·</p></div></div><button onclick="appr('${e.id}')" class="bg-blue-600 text-white text-xs font-black px-4 py-2 rounded-lg shadow-sm">æ ¸å‡†</button></div>`).join('') : '<div class="text-center py-6 bg-slate-100/50 rounded-xl border border-dashed border-slate-300"><p class="text-xs text-slate-400 font-bold">ç„¡å¾…å¯©æ ¸</p></div>';
            
            const activeEmps = emps.filter(e => e.is_approved && e.employment_status === 'åœ¨è·');
            activeEmps.forEach(e => { window.empData[e.id] = { base: e.base_salary, deps: e.dependents_count || 0, name: e.full_name, phone: e.phone, addr: e.address }; }); 
            const empOptions = activeEmps.map(e => `<option value="${e.id}">[${e.work_region}] ${e.full_name}</option>`).join('');
            document.getElementById('p-emp').innerHTML = empOptions;
            
            // ğŸŒŸ å“¡å·¥ç¸½è¡¨æ¸…å–®
            document.getElementById('list-all-emps').innerHTML = activeEmps.map(e => `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><div class="bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center font-black text-slate-500 mr-3">${e.full_name.charAt(0)}</div><div><h4 class="font-black text-sm text-slate-800">${e.full_name} <span class="text-[9px] bg-emerald-50 text-emerald-600 px-1.5 rounded ml-1">åº•è–ª ${e.base_salary/1000}k</span></h4><p class="text-[10px] text-slate-500 mt-0.5">ğŸ“ ${e.work_region} | ğŸ“ ${e.phone}</p></div></div><button onclick="openEmpEdit('${e.id}')" class="bg-slate-800 text-white text-xs font-black px-4 py-2 rounded-lg shadow-sm">ç®¡ç†</button></div>`).join('');

            const { data: lv } = await _sb.from('leave_requests').select('*, employees(full_name)').eq('status', 'å¯©æ ¸ä¸­');
            document.getElementById('list-leaves').innerHTML = lv.length ? lv.map(l => {
                let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                let spBadge = l.leave_type === 'é¢±é¢¨å‡' ? '<span class="text-[9px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded ml-2">ä¸æ‰£è–ª</span>' : (l.salary_protection?'<span class="text-[9px] text-sky-600 bg-sky-50 px-1.5 py-0.5 rounded ml-2">ä¿è–ª</span>':'<span class="text-[9px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded ml-2">ä¸ä¿è–ª</span>');
                return `<div class="glass-panel p-4"><div class="flex justify-between items-start mb-2"><div><span class="font-black text-sm text-slate-800">${l.employees?.full_name}</span><span class="text-xs font-bold text-slate-600 ml-2 border-l-2 border-slate-300 pl-2">${l.leave_type}</span>${spBadge}</div></div><div class="bg-slate-50 p-2 rounded-lg mb-3 inline-block"><p class="text-[10px] font-mono text-slate-600 tracking-tight">${t1} ~ ${t2}</p></div><div class="flex space-x-2"><button onclick="updLeave('${l.id}', 'æ ¸å‡†')" class="flex-1 bg-emerald-50 border border-emerald-200 text-emerald-700 hover:bg-emerald-500 hover:text-white py-2.5 rounded-lg text-sm font-black transition-colors">æ ¸å‡†</button><button onclick="updLeave('${l.id}', 'æ ¸é§')" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2.5 rounded-lg text-sm font-black transition-colors">é§å›</button></div></div>`
            }).join('') : '<div class="text-center py-6 bg-slate-100/50 rounded-xl border border-dashed border-slate-300"><p class="text-xs text-slate-400 font-bold">ç„¡å¾…å¯©æ ¸å‡å–®</p></div>';

            const { data: br } = await _sb.from('branch_locations').select('*');
            document.getElementById('list-brs').innerHTML = br.map(b => `<div class="glass-panel p-4 flex items-center shadow-sm"><span class="text-2xl mr-3 opacity-80">ğŸ“</span><div><p class="font-black text-sm text-slate-800">${b.branch_name}</p><p class="text-[10px] text-slate-500 mt-0.5">${b.address}</p></div></div>`).join('');
            autoFillLaw(); loadAttendance();
        }

        // ğŸŒŸ å“¡å·¥ç®¡ç†é¢æ¿é‚è¼¯
        function openEmpEdit(id) {
            const e = window.empData[id]; window.currentEditEmpId = id;
            document.getElementById('em-name').innerText = e.name; document.getElementById('em-id').innerText = `ID: ${id}`;
            document.getElementById('em-phone').value = e.phone; document.getElementById('em-addr').value = e.addr;
            document.getElementById('em-base').value = e.base; document.getElementById('em-deps').value = e.deps;
            document.getElementById('off-result').classList.add('hidden');
            openModal('emp-modal');
        }
        async function saveEmpData() {
            const p = document.getElementById('em-phone').value; const a = document.getElementById('em-addr').value;
            const b = parseInt(document.getElementById('em-base').value)||0; const d = parseInt(document.getElementById('em-deps').value)||0;
            await _sb.from('employees').update({phone: p, address: a, base_salary: b, dependents_count: d}).eq('id', window.currentEditEmpId);
            alert('âœ… å„²å­˜æˆåŠŸ'); closeModal('emp-modal'); loadAll();
        }

        // ğŸŒŸ å‡ºå‹¤çœ‹æ¿é‚è¼¯
        async function loadAttendance() {
            let filterDate = document.getElementById('att-date-filter').value;
            if(!filterDate) { const d = new Date(); filterDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; document.getElementById('att-date-filter').value = filterDate; }
            const start = `${filterDate}T00:00:00+08:00`; const end = `${filterDate}T23:59:59+08:00`;
            const { data } = await _sb.from('attendance_logs').select('punch_type, punch_time, note, employees(full_name), branch_locations(branch_name)').gte('punch_time', start).lte('punch_time', end).order('punch_time', {ascending: false});
            document.getElementById('list-attendance').innerHTML = data && data.length ? data.map(log => {
                const time = new Date(log.punch_time).toLocaleString('zh-TW').slice(10,-3);
                return `<div class="glass-panel p-3 flex justify-between items-center"><div class="flex items-center"><span class="text-xs font-black px-2 py-1 rounded border ${log.punch_type==='IN'?'bg-sky-50 text-sky-700 border-sky-200':'bg-slate-100 text-slate-600 border-slate-200'} mr-3">${log.punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span><div><p class="font-black text-sm">${log.employees?.full_name}</p><p class="text-[9px] text-slate-400">ğŸ“ ${log.branch_locations?.branch_name||'æœªçŸ¥'} | â° ${time}</p></div></div></div>`
            }).join('') : `<div class="text-center py-10 bg-slate-100/50 rounded-xl border border-dashed border-slate-300"><p class="text-sm text-slate-400 font-bold">è©²æ—¥ç„¡æ‰“å¡ç´€éŒ„</p></div>`;
        }

        // ğŸŒŸ å…¬å‘Šç·¨è¼¯èˆ‡åˆªé™¤é‚è¼¯
        async function postBlt() {
            await _sb.from('bulletin_board').insert([{ title: document.getElementById('blt-title').value, content: document.getElementById('blt-content').value }]);
            alert('âœ… å…¬å‘Šç™¼å¸ƒæˆåŠŸ'); document.getElementById('blt-title').value=''; document.getElementById('blt-content').value=''; loadBulls();
        }
        async function loadBulls() {
            const { data } = await _sb.from('bulletin_board').select('*').order('created_at', {ascending: false}).limit(20);
            document.getElementById('list-bulls').innerHTML = data && data.length ? data.map(b => `<div class="glass-panel p-4 mb-2"><div class="flex justify-between items-start mb-1"><h4 class="font-black text-sm text-slate-800">${b.title}</h4><span class="text-[9px] text-slate-400">${new Date(b.created_at).toISOString().split('T')[0]}</span></div><p class="text-[10px] text-slate-600 mb-3 whitespace-pre-wrap">${b.content}</p><div class="flex space-x-2 border-t pt-2"><button onclick="editBlt('${b.id}', '${b.title}')" class="text-xs text-sky-600 font-bold px-2 py-1 bg-sky-50 rounded flex-1 hover:bg-sky-100">ç·¨è¼¯å…§å®¹</button><button onclick="delBlt('${b.id}')" class="text-xs text-red-600 font-bold px-2 py-1 bg-red-50 rounded flex-1 hover:bg-red-100">åˆªé™¤</button></div></div>`).join('') : '<p class="text-xs text-slate-400 text-center">ç„¡å…¬å‘Š</p>';
        }
        async function delBlt(id) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤å…¬å‘Šï¼Ÿ')) { await _sb.from('bulletin_board').delete().eq('id', id); loadBulls(); } }
        async function editBlt(id, oldTitle) { const newContent = prompt(`è«‹è¼¸å…¥ã€${oldTitle}ã€‘çš„æ›´æ–°å…§å®¹ï¼š`); if(newContent) { await _sb.from('bulletin_board').update({content: newContent}).eq('id', id); loadBulls(); } }

        async function autoGeoCode() {
            const input = document.getElementById('b-a').value; if(!input) return;
            const mapRegex = /@(-?\d+\.\d+),(-?\d+\.\d+)/; const match = input.match(mapRegex);
            if(match) { document.getElementById('b-la').value = match[1]; document.getElementById('b-ln').value = match[2]; alert('âœ… è‡ªå‹•è§£ææˆåŠŸï¼'); return; }
            try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent("å°ç£" + input)}`, { headers: {'Accept-Language': 'zh-TW'} }); const data = await res.json(); if(data && data.length > 0) { document.getElementById('b-la').value = data[0].lat; document.getElementById('b-ln').value = data[0].lon; } else { alert('å®šä½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥'); } } catch (e) {}
        }

        // ğŸŒŸ æ™ºæ…§ CSV ä¸‹è¼‰ (è§£æ±ºæ‰‹æ©Ÿé˜²æ“‹)
        async function exportBankCSV() {
            const month = document.getElementById('export-mon').value; if(!month) { alert('è«‹é¸æ“‡è¦åŒ¯å‡ºçš„æœˆä»½'); return; }
            const { data } = await _sb.from('payroll_records').select('total_net_pay, employees(full_name, bank_code, bank_name, bank_user_name, bank_account)').eq('pay_month', month);
            if(!data || data.length === 0) { alert('è©²æœˆä»½ç„¡è–ªè³‡ç´€éŒ„'); return; }
            let csv = "\uFEFFéŠ€è¡Œä»£ç¢¼,éŠ€è¡Œåç¨±,æ”¶æ¬¾å¸³è™Ÿ,æˆ¶å,åŒ¯æ¬¾é‡‘é¡,å‚™è¨»\n";
            data.forEach(r => { csv += `="${r.employees.bank_code}",${r.employees.bank_name},="${r.employees.bank_account}",${r.employees.bank_user_name},${r.total_net_pay},${month}è–ªè³‡\n`; });
            
            try {
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `HYPASS_${month}_è½‰å¸³æª”.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch(e) {}
            // ç„¡è«–ä¸‹è¼‰æ˜¯å¦æˆåŠŸï¼ŒåŒæ™‚æ‰“é–‹æ™ºæ…§é¢æ¿è®“ä½¿ç”¨è€…å¯ä»¥ç›´æ¥è¤‡è£½
            document.getElementById('csv-raw-text').value = csv; openModal('csv-modal');
        }
        function copyCSV() {
            const txt = document.getElementById('csv-raw-text'); txt.select(); txt.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(txt.value).then(() => alert("âœ… å…§å®¹å·²è¤‡è£½ï¼è«‹è‡³é›»è…¦ç‰ˆ Excel è²¼ä¸Šå³å¯ã€‚"));
        }

        function autoFillLaw() {
            const empId = document.getElementById('p-emp').value; const emp = window.empData[empId]; if(!emp) return;
            if(!document.getElementById('p-base').value) { document.getElementById('p-base').value = emp.base; }
            const base = parseFloat(document.getElementById('p-base').value) || 0; const bonus = parseFloat(document.getElementById('p-bonus').value) || 0; const yeb = parseFloat(document.getElementById('p-yeb').value) || 0;
            document.getElementById('p-pen').value = Math.round(base * 0.06); document.getElementById('p-2nd').value = Math.round((bonus + yeb) * 0.0211);
            const labor_est = Math.round(base * 0.022); const health_est = Math.round(base * 0.0155 * (1 + emp.deps));
            document.getElementById('p-ins').value = labor_est + health_est; calcNet();
        }

        function calcNet() { const net = (parseFloat(document.getElementById('p-base').value)||0) + (parseFloat(document.getElementById('p-bonus').value)||0) + (parseFloat(document.getElementById('p-yeb').value)||0) - (parseFloat(document.getElementById('p-ins').value)||0) - (parseFloat(document.getElementById('p-2nd').value)||0); document.getElementById('p-net').value = net > 0 ? net : 0; }

        async function issuePayroll() { 
            const eId = document.getElementById('p-emp').value;
            const base_pay_val = parseFloat(document.getElementById('p-base').value)||0;
            const p = { employee_id: eId, pay_month: document.getElementById('p-mon').value, base_pay: base_pay_val, bonus: parseFloat(document.getElementById('p-bonus').value)||0, year_end_bonus: parseFloat(document.getElementById('p-yeb').value)||0, labor_pension: parseFloat(document.getElementById('p-pen').value)||0, insurance_deduction: parseFloat(document.getElementById('p-ins').value)||0, second_gen_health: parseFloat(document.getElementById('p-2nd').value)||0, total_net_pay: parseFloat(document.getElementById('p-net').value)||0 }; 
            if(!p.pay_month) { alert('è«‹é¸æ“‡ç™¼æ”¾æœˆä»½'); return; } 
            await _sb.from('payroll_records').insert([p]); 
            // ğŸŒŸ è‡ªå‹•è¨˜æ†¶åº•è–ª
            await _sb.from('employees').update({base_salary: base_pay_val}).eq('id', eId);
            alert('âœ… è–ªè³‡å–®ç™¼é€æˆåŠŸï¼åº•è–ªå·²è‡ªå‹•è¨˜æ†¶ã€‚'); document.querySelectorAll('#pay input[type="number"]').forEach(e => e.value = ''); loadAll();
        }

        async function calculateSettlement() {
            const empId = window.currentEditEmpId; const lastDay = document.getElementById('off-date').value; const type = document.getElementById('off-type').value;
            if(!empId || !lastDay) { alert('è«‹å¡«å¯«æœ€å¾Œå·¥ä½œæ—¥'); return; }
            const { data: emp } = await _sb.from('employees').select('full_name, base_salary, onboarding_date').eq('id', empId).single();
            const { data: lv } = await _sb.rpc('fn_get_annual_leave', { p_onboard_date: emp.onboarding_date });
            const proRat = new Date(lastDay).getDate() / 30.0; const proSal = Math.round((proRat > 1 ? 1 : proRat) * emp.base_salary);
            const uHrs = lv?.hours || 0; const lPay = Math.round(uHrs * (emp.base_salary / 240));
            let sev = 0; if(type === 'éè‡ªé¡˜é›¢è·(è³‡é£)') { const ty = (new Date(lastDay).getTime() - new Date(emp.onboarding_date).getTime()) / 31557600000; sev = Math.round(Math.max(0, ty) * 0.5 * emp.base_salary); }
            const tot = proSal + lPay + sev;
            document.getElementById('off-res-base').innerText = `NT$ ${emp.base_salary.toLocaleString()}`; document.getElementById('off-res-pro').innerText = `+ NT$ ${proSal.toLocaleString()}`; document.getElementById('off-res-lvh').innerText = uHrs; document.getElementById('off-res-lvp').innerText = `+ NT$ ${lPay.toLocaleString()}`; document.getElementById('off-res-sev').innerText = `+ NT$ ${sev.toLocaleString()}`; document.getElementById('off-res-total').innerText = `NT$ ${tot.toLocaleString()}`; document.getElementById('off-result').classList.remove('hidden');
            globalOffboardData = { employee_id: empId, settlement_type: type, last_working_day: lastDay, base_salary_ref: emp.base_salary, prorated_salary: proSal, unused_leave_hours: uHrs, unused_leave_pay: lPay, severance_pay: sev, total_settlement: tot };
        }

        async function confirmOffboarding() {
            if(!globalOffboardData || !confirm('âš ï¸ è­¦å‘Šï¼šç¢ºå®šçµç®—ä¸¦åœæ¬Šï¼Ÿ')) return;
            await _sb.from('settlement_records').insert([globalOffboardData]); await _sb.from('employees').update({ employment_status: 'é›¢è·', is_approved: false, resignation_date: globalOffboardData.last_working_day }).eq('id', globalOffboardData.employee_id);
            alert('âœ… çµç®—å®Œæˆï¼Œå¸³è™Ÿå·²åœæ¬Šã€‚'); closeModal('emp-modal'); loadAll();
        }

        async function appr(id) { await _sb.from('employees').update({is_approved:true}).eq('id',id); loadAll(); alert('âœ… å·²é–‹é€š'); }
        async function updLeave(id, st) { await _sb.from('leave_requests').update({status:st}).eq('id',id); loadAll(); alert(`âœ… å‡å–®å·²${st}`); }
        async function addBr() { const n = document.getElementById('b-n').value; const a = document.getElementById('b-a').value; const la = document.getElementById('b-la').value; const ln = document.getElementById('b-ln').value; if(!n||!a||!la||!ln){ alert('è«‹å¡«å¦¥è³‡è¨Š'); return;} await _sb.from('branch_locations').insert([{ branch_name: n, address: a, lat: parseFloat(la), lng: parseFloat(ln) }]); loadAll(); alert('âœ… æ“šé»æ–°å¢æˆåŠŸ'); }
    </script>
</body>
</html>
