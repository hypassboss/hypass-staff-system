<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPASS | ä¼æ¥­æŒ‡æ®ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body { background: #f8fafc; -webkit-tap-highlight-color: transparent; } .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; } @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} } .no-scrollbar::-webkit-scrollbar { display: none; } .glass-panel { background: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); border: 1px solid #e2e8f0; } .admin-input { width: 100%; padding: 0.875rem; border: 1px solid #cbd5e1; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.2s; } .modal { display: none; } .modal.active { display: flex; z-index: 100; } .dt-btn.active { background-color: #0284c7; color: white; }</style>
</head>
<body class="text-slate-800 font-sans min-h-screen md:h-screen md:overflow-hidden md:flex bg-slate-50">

    <div id="login-box" class="flex flex-col items-center justify-center min-h-screen px-5 md:w-full z-50"><div class="glass-panel p-8 w-full max-w-sm text-center relative overflow-hidden"><div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">ğŸ‘‘</div><h2 class="text-2xl font-black mb-2 text-slate-800">æœ€é«˜æ¬Šé™é©—è­‰</h2><p class="text-xs text-slate-500 mb-6">è«‹è¼¸å…¥ç®¡ç†é‡‘é‘°è§£é–æŒ‡æ®ä¸­å¿ƒ</p><input type="password" id="pin" placeholder="PIN CODE" class="admin-input text-center text-2xl tracking-[0.5em] mb-6 bg-slate-50 font-black text-slate-700" onkeypress="if(event.key==='Enter') login()"><button onclick="login()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform">é©—è­‰ä¸¦ç™»å…¥</button></div></div>

    <div id="dashboard-ui" class="hidden flex-col md:flex-row h-screen w-full md:overflow-hidden">
        <header class="md:hidden bg-gradient-to-r from-slate-900 to-slate-800 text-white p-5 flex justify-between items-center shadow-lg sticky top-0 z-50 shrink-0"><div><h1 class="text-xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-300">HYPASS</h1><span class="text-[9px] text-slate-400 tracking-[0.2em] uppercase font-bold">Admin ERP</span></div><button onclick="location.reload()" class="text-[10px] bg-white/10 border border-white/20 hover:bg-red-500 hover:border-red-500 px-3 py-1.5 rounded-full font-bold transition-all">å®‰å…¨ç™»å‡º</button></header>
        <aside class="hidden md:flex w-64 bg-slate-900 text-white flex-col h-full shadow-2xl shrink-0 z-20">
            <div class="p-6 pb-2 border-b border-slate-800 mb-4"><h1 class="text-2xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-300">HYPASS</h1><span class="text-[10px] text-slate-400 tracking-[0.2em] uppercase font-bold">Admin ERP</span></div>
            <nav class="flex-1 px-4 space-y-2"><button onclick="st('pend')" id="dt-pend" class="dt-btn active w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ”´</span> å¾…è¾¦å¯©æ ¸</button><button onclick="st('pay')" id="dt-pay" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ’°</span> è–ªè³‡ç™¼æ”¾</button><button onclick="st('emps')" id="dt-emps" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ‘¥</span> å“¡å·¥ç¸½è¡¨/é›¢è·</button><button onclick="st('att')" id="dt-att" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“‹</span> å‡ºå‹¤ç´€éŒ„å¤§ç›¤</button><button onclick="st('brs')" id="dt-brs" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“</span> ä¼æ¥­æ“šé»ç®¡ç†</button></nav>
            <div class="p-4 border-t border-slate-800"><button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-red-500 text-slate-300 hover:text-white py-3 rounded-xl font-bold transition">å®‰å…¨ç™»å‡º</button></div>
        </aside>

        <main class="flex-1 overflow-y-auto w-full p-4 md:p-8 bg-slate-50">
            <div class="grid grid-cols-3 gap-3 mb-8 md:hidden">
                <button onclick="st('pend')" id="m-pend" class="m-btn active flex flex-col items-center justify-center py-4 bg-slate-900 text-white rounded-2xl shadow-md border border-transparent transition-all"><span class="text-3xl mb-1.5 drop-shadow-md">ğŸ”´</span><span class="m-text text-xs font-black tracking-widest">å¾…è¾¦å¯©æ ¸</span></button>
                <button onclick="st('pay')" id="m-pay" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm">ğŸ’°</span><span class="m-text text-xs font-bold tracking-widest">è–ªè³‡åŒ¯æ¬¾</span></button>
                <button onclick="st('emps')" id="m-emps" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ‘¥</span><span class="m-text text-xs font-bold tracking-widest">å“¡å·¥ç¸½è¡¨</span></button>
                <button onclick="st('att')" id="m-att" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“‹</span><span class="m-text text-xs font-bold tracking-widest">å‡ºå‹¤å¤§ç›¤</span></button>
                <button onclick="st('brs')" id="m-brs" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“</span><span class="m-text text-xs font-bold tracking-widest">æ“šé»ç®¡ç†</span></button>
            </div>

            <section id="pend" class="tab-content active space-y-6 max-w-4xl">
                <div><h3 class="font-black text-slate-800 border-l-4 border-blue-500 pl-3 text-lg mb-3">æ–°é€²å“¡å·¥å¯©æ ¸</h3><div id="list-pend" class="space-y-3"></div></div>
                <div><h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-3">ç°½æ ¸ä¸­å¿ƒ (å«å¿˜è¨˜æ‰“å¡è£œç™»)</h3><div id="list-leaves" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
            </section>

            <section id="pay" class="tab-content space-y-6 max-w-3xl">
                <div class="glass-panel p-6 space-y-4">
                    <h3 class="font-black text-slate-800 border-l-4 border-indigo-500 pl-3 text-lg mb-4">ç™¼æ´¾æœˆè–ªèˆ‡å¹´çµ‚</h3>
                    <div class="grid grid-cols-2 gap-3 mb-2"><select id="p-emp" class="admin-input bg-slate-50 font-bold" onchange="onEmpChange()"></select><input type="month" id="p-mon" class="admin-input bg-slate-50 font-bold" onchange="updateAttendanceRate()"></div>
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200 grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">æœ¬è–ª</label><input type="number" id="p-base" oninput="calcPayroll()" class="admin-input font-black text-slate-800 bg-white"></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">çé‡‘æ´¥è²¼</label><input type="number" id="p-bonus" oninput="calcPayroll()" class="admin-input font-black text-emerald-600"></div><div class="col-span-2"><label class="text-[10px] font-bold text-amber-600 ml-1">å¹´çµ‚çé‡‘</label><input type="number" id="p-yeb" oninput="calcPayroll()" class="admin-input font-black text-amber-600 bg-amber-50 border-amber-200"></div></div>
                    <div class="p-4 bg-orange-50 rounded-xl border border-orange-200"><div class="flex justify-between items-center mb-2"><h4 class="text-[10px] font-black text-orange-800 tracking-widest">ğŸ¤– ç³»çµ±å‡ºå‹¤æ‰£æ¬¾åˆ†æ</h4><button onclick="updateAttendanceRate()" class="text-[9px] bg-orange-200 text-orange-800 px-2 py-1 rounded font-bold hover:bg-orange-300">é‡æ–°è®€å–</button></div><div class="grid grid-cols-4 gap-2 text-center text-[10px] font-bold text-slate-600 bg-white p-2 rounded-lg border border-orange-100 shadow-sm mb-3"><div>ç—…å‡<br><span id="sd-sick" class="text-orange-600 text-sm font-black">0</span>h</div><div>äº‹å‡<br><span id="sd-per" class="text-orange-600 text-sm font-black">0</span>h</div><div>é¢±é¢¨å‡<br><span id="sd-typ" class="text-orange-600 text-sm font-black">0</span>h</div><div>é²åˆ°<br><span id="sd-lat" class="text-orange-600 text-sm font-black">0</span>æ¬¡</div></div><div class="flex space-x-3"><div class="flex-1"><label class="text-[10px] font-bold text-orange-800 ml-1">è«‹å‡æ‰£è–ªç¸½é¡</label><input type="number" id="p-lvd" oninput="calcNet()" class="admin-input font-black text-orange-600 border-orange-200" value="0"></div></div></div>
                    <div class="p-4 bg-red-50 rounded-xl border border-red-100 grid grid-cols-2 gap-3 relative"><button onclick="calcPayroll()" class="absolute -top-3 right-3 text-[9px] bg-slate-800 text-white font-bold px-2 py-1 rounded shadow-sm">ğŸ¤– ä¾çœ·å±¬é‡æ–°è¨ˆç®—</button><div><label class="text-[10px] font-bold text-red-800 ml-1">å‹å¥ä¿æ‰£é™¤</label><input type="number" id="p-ins" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200"></div><div><label class="text-[10px] font-bold text-red-800 ml-1">äºŒä»£å¥ä¿</label><input type="number" id="p-2nd" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200"></div></div>
                    <div class="flex justify-between items-center p-4 mt-2 bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl border border-sky-100"><span class="text-sm font-black text-slate-700">çµç®—å¯¦é ˜è–ªè³‡</span><span class="text-4xl font-black text-sky-600 tracking-tighter" id="p-net-display">NT$ 0</span><input type="hidden" id="p-net"><input type="hidden" id="p-pen"></div>
                    <button onclick="issuePayroll()" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform mt-2">æ­£å¼ç™¼é€è–ªè³‡å–®</button>
                </div>
            </section>

            <section id="emps" class="tab-content space-y-5 max-w-6xl"><div><h3 class="font-black text-slate-800 border-l-4 border-sky-500 pl-3 text-lg mb-4">å“¡å·¥è³‡æ–™ç¸½è¡¨</h3><div id="list-emps-mobile" class="space-y-3">è¼‰å…¥ä¸­...</div></div></section>
            <section id="att" class="tab-content space-y-5 max-w-6xl"><h3 class="font-black text-slate-800 border-l-4 border-slate-500 pl-3 text-lg mb-4">å‡ºå‹¤ç‹€æ…‹ç¸½è¦½</h3><input type="date" id="att-date" onchange="loadAttendance()" class="admin-input bg-white font-black text-lg mb-4 max-w-sm"><div id="list-attendance-mobile" class="space-y-3 pb-8">è«‹é¸æ“‡æ—¥æœŸ...</div></section>
            <section id="brs" class="tab-content space-y-5 max-w-4xl"><div class="glass-panel p-6 shadow-sm mb-4"><h3 class="font-black text-slate-800 border-l-4 border-emerald-500 pl-3 text-lg mb-4" id="br-form-title">æ–°å¢æ‰“å¡æ“šé»</h3><input type="hidden" id="b-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3"><input type="text" id="b-n" placeholder="åˆ†åº—åç¨±" class="admin-input font-bold"><input type="text" id="b-a" placeholder="åœ°å€" class="admin-input bg-white"></div><div class="grid grid-cols-2 gap-3 mb-5"><input type="number" step="any" id="b-la" placeholder="ç·¯åº¦" class="admin-input bg-slate-50 font-mono text-sm" required><input type="number" step="any" id="b-ln" placeholder="ç¶“åº¦" class="admin-input bg-slate-50 font-mono text-sm" required></div><div class="flex space-x-2"><button type="button" onclick="cancelEditBr()" id="btn-cancel-br" class="hidden w-1/3 bg-slate-200 text-slate-700 py-3.5 rounded-xl">å–æ¶ˆ</button><button onclick="saveBr()" id="btn-save-br" class="flex-1 bg-emerald-600 text-white font-black py-3.5 rounded-xl">å„²å­˜</button></div></div><h4 class="font-black text-sm text-slate-600 px-2">ç¾æœ‰æ“šé»æ¸…å–®</h4><div id="list-brs" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div></section>
        </main>
    </div>

    <div id="emp-detail-modal" class="modal fixed inset-0 bg-slate-900/70 backdrop-blur-sm items-center justify-center p-5"><div class="bg-white w-full max-w-4xl rounded-2xl h-[90vh] flex flex-col shadow-2xl relative"><div class="flex justify-between items-center p-6 border-b border-slate-100 shrink-0"><h3 class="font-black text-lg text-slate-800 flex items-center">ğŸªª å“¡å·¥æª”æ¡ˆç®¡ç†</h3><div class="flex space-x-2"><button id="btn-edit-emp" class="bg-sky-100 text-sky-700 px-4 py-2 rounded-full font-bold text-xs">âœï¸ ä¿®æ”¹</button><button onclick="document.getElementById('emp-detail-modal').classList.remove('active')" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full font-bold text-xs">âœ• é—œé–‰</button></div></div><div class="overflow-y-auto p-6 space-y-6 flex-1 bg-slate-50/50"><div id="ui-emp-full-info"></div></div></div></div>

    <script src="shared.js"></script>
    <script>
        window.empData = {}; window.allEmps = []; window.branches = [];
        function login() { if(document.getElementById('pin').value === '888888'){ document.getElementById('login-box').style.display='none'; document.getElementById('dashboard-ui').classList.remove('hidden'); document.getElementById('dashboard-ui').classList.add('flex'); document.getElementById('att-date').value = new Date().toLocaleDateString('en-CA'); const now = new Date(); document.getElementById('p-mon').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; loadAll(); } else { alert('å¯†ç¢¼éŒ¯èª¤ï¼'); } }
        function st(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.m-btn').forEach(e=>{ e.classList.remove('bg-slate-900','text-white'); e.classList.add('bg-white','text-slate-500'); }); document.getElementById('m-'+id).classList.add('bg-slate-900','text-white'); document.querySelectorAll('.dt-btn').forEach(e=>e.classList.remove('active','bg-sky-600','text-white')); document.getElementById('dt-'+id).classList.add('active','bg-sky-600','text-white'); document.getElementById(id).classList.add('active'); if(id === 'att') loadAttendance(); }
        
        async function loadAll() {
            const { data: emps } = await window._sb.from('employees').select('*, branch_locations(branch_name)'); const { data: brs } = await window._sb.from('branch_locations').select('*'); window.allEmps = emps || []; window.branches = brs || [];
            
            const p = window.allEmps.filter(e => !e.is_approved && e.employment_status === 'åœ¨è·');
            document.getElementById('list-pend').innerHTML = p.length ? p.map(e => `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><span class="text-2xl mr-3">ğŸ‘¤</span><div><h4 class="font-black text-sm text-slate-800">${e.full_name}</h4><p class="text-[10px] text-slate-500">${e.job_title}</p></div></div><button onclick="appr('${e.id}')" class="bg-blue-600 text-white text-xs font-black px-4 py-2 rounded-lg">é–‹é€š</button></div>`).join('') : '<p class="text-xs text-slate-400 font-bold py-4">ç„¡å¾…è¾¦</p>';
            
            const aEmps = window.allEmps.filter(e => e.is_approved && e.employment_status === 'åœ¨è·');
            aEmps.forEach(e => { window.empData[e.id] = { base: e.base_salary, deps: e.dependents_count || 0, start: e.work_start_time || '09:00:00' }; }); 
            document.getElementById('p-emp').innerHTML = aEmps.map(e => `<option value="${e.id}">[${e.employee_no||'--'}] ${e.full_name}</option>`).join('');
            document.getElementById('list-emps-mobile').innerHTML = aEmps.map(e => `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-black mr-3">${e.full_name.charAt(0)}</div><div><h4 class="font-black text-sm text-slate-800">${e.full_name}</h4><p class="text-[10px] text-slate-500 mt-1">${e.employee_no||'--'} | ${e.branch_locations?.branch_name||'æœªç¶å®š'}</p></div></div><button onclick="openEmpDetail('${e.id}')" class="bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded-xl">ç®¡ç†</button></div>`).join('');

            const { data: lv } = await window._sb.from('leave_requests').select('*, employees(full_name)').eq('status', 'å¯©æ ¸ä¸­');
            document.getElementById('list-leaves').innerHTML = (lv && lv.length) ? lv.map(l => {
                let isRet = l.leave_type === 'å¿˜è¨˜æ‰“å¡(è£œç™»)'; let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = isRet?'':new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                let spB = isRet?`<span class="text-[9px] text-amber-700 bg-amber-100 px-1.5 py-0.5 rounded ml-2">è£œç™»${l.target_punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span>`:'';
                return `<div class="glass-panel p-4"><div class="flex justify-between items-start mb-2"><div><span class="font-black text-sm text-slate-800">${l.employees?.full_name}</span><span class="text-xs font-bold text-slate-600 ml-2 border-l-2 border-slate-300 pl-2">${l.leave_type.replace('(è£œç™»)','')}</span>${spB}</div></div><div class="bg-slate-50 p-2 rounded-lg mb-3 inline-block"><p class="text-[10px] font-mono text-slate-600 tracking-tight">${t1} ${t2?'~ '+t2:''}</p></div><div class="flex space-x-2"><button onclick="updLeave('${l.id}', 'æ ¸å‡†')" class="flex-1 bg-emerald-50 text-emerald-700 hover:bg-emerald-500 hover:text-white py-2.5 rounded-lg text-sm font-black transition">æ ¸å‡†</button><button onclick="updLeave('${l.id}', 'æ ¸é§')" class="flex-1 bg-white border border-red-200 text-red-600 py-2.5 rounded-lg text-sm font-black">é§å›</button></div></div>`
            }).join('') : '<p class="text-xs text-slate-400 font-bold py-4">ç„¡å¾…è¾¦å–®æ“š</p>';

            document.getElementById('list-brs').innerHTML = window.branches.map(b => `<div class="glass-panel p-4 flex justify-between items-center shadow-sm"><div class="flex items-center"><span class="text-2xl mr-3 opacity-80">ğŸ“</span><div><p class="font-black text-sm text-slate-800">${b.branch_name}</p><p class="text-[10px] text-slate-500">${b.address}</p></div></div><button onclick="editBr('${b.id}')" class="text-xs bg-sky-100 text-sky-700 font-bold px-3 py-2 rounded-lg">ä¿®æ”¹</button></div>`).join('');
            onEmpChange(); if(document.getElementById('att').classList.contains('active')) loadAttendance();
        }

        async function loadAttendance() {
            const d = document.getElementById('att-date').value; if(!d) return; document.getElementById('list-attendance-mobile').innerHTML = 'è¼‰å…¥ä¸­...';
            const sT = new Date(d); sT.setHours(0,0,0,0); const eT = new Date(d); eT.setHours(23,59,59,999);
            const { data: logs } = await window._sb.from('attendance_logs').select('*, employees(id, full_name, work_start_time, work_end_time, employee_no), branch_locations(branch_name)').gte('punch_time', sT.toISOString()).lte('punch_time', eT.toISOString()).order('punch_time', {ascending: true});
            const empLogs = {}; window.allEmps.filter(e => e.employment_status === 'åœ¨è·').forEach(e => { empLogs[e.id] = { name: e.full_name, start: e.work_start_time || '09:00:00', end: e.work_end_time || '18:00:00', in: null, out: null }; });
            if(logs) { logs.forEach(l => { const eid = l.employees?.id; if(!eid || !empLogs[eid]) return; const tStr = new Date(l.punch_time).toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'}); const isRet = l.note && l.note.includes('[è£œç™»'); const bName = isRet ? 'è£œç™»(å…å®šä½)' : (l.branch_locations?.branch_name || 'å¤–å‹¤å®šä½'); if(l.punch_type === 'IN' && !empLogs[eid].in) empLogs[eid].in = { time: tStr, branch: bName, retro: isRet }; if(l.punch_type === 'OUT') empLogs[eid].out = { time: tStr, branch: bName, retro: isRet }; }); }
            
            let htmlM = '';
            Object.values(empLogs).forEach(e => {
                let iSt = e.in?(e.in.retro?'è£œç™»':(e.in.time>e.start.slice(0,5)?'é²åˆ°':'æ­£å¸¸')):'æœªæ‰“å¡'; let oSt = e.out?(e.out.retro?'è£œç™»':(e.out.time<e.end.slice(0,5)?'æ—©é€€':'æ­£å¸¸')):'æœªæ‰“å¡';
                htmlM += `<div class="glass-panel p-4 shadow-sm border-l-4 ${e.in&&e.out?'border-emerald-400':'border-slate-200'}"><div class="flex justify-between items-center border-b border-slate-100 pb-2 mb-3"><span class="font-black text-slate-800 text-sm">${e.name}</span></div><div class="grid grid-cols-2 gap-3 text-xs"><div class="bg-white p-2.5 rounded-xl border border-slate-100"><div class="font-bold text-slate-500 mb-1">ä¸Šç­ [${iSt}]</div><div class="font-black text-lg">${e.in?e.in.time:'--:--'}</div><div class="text-[9px] text-slate-400">${e.in?e.in.branch:''}</div></div><div class="bg-white p-2.5 rounded-xl border border-slate-100"><div class="font-bold text-slate-500 mb-1">ä¸‹ç­ [${oSt}]</div><div class="font-black text-lg">${e.out?e.out.time:'--:--'}</div><div class="text-[9px] text-slate-400">${e.out?e.out.branch:''}</div></div></div></div>`;
            });
            document.getElementById('list-attendance-mobile').innerHTML = htmlM;
        }

        async function updateAttendanceRate() { const empId = document.getElementById('p-emp').value; const month = document.getElementById('p-mon').value; if(!empId || !month) return; const { data } = await window._sb.rpc('fn_get_payroll_calc', { p_emp_id: empId, p_month: month }); if(data) { document.getElementById('sd-sick').innerText = data.sick_hrs; document.getElementById('sd-per').innerText = data.personal_hrs; document.getElementById('sd-typ').innerText = data.typhoon_hrs; document.getElementById('sd-lat').innerText = data.late_count; document.getElementById('p-lvd').value = data.leave_deduct; } calcNet(); }
        function onEmpChange() { const empId = document.getElementById('p-emp').value; if(!empId) return; const emp = window.empData[empId]; if(!emp) return; document.getElementById('p-base').value = emp.base; calcPayroll(); updateAttendanceRate(); }
        function calcPayroll() { const empId = document.getElementById('p-emp').value; const emp = window.empData[empId]; if(!emp) return; const base = parseFloat(document.getElementById('p-base').value) || 0; const bonus = parseFloat(document.getElementById('p-bonus').value) || 0; const yeb = parseFloat(document.getElementById('p-yeb').value) || 0; document.getElementById('p-pen').value = Math.round(base * 0.06); document.getElementById('p-2nd').value = Math.round((bonus + yeb) * 0.0211); document.getElementById('p-ins').value = Math.round(base * 0.022) + Math.round(base * 0.0155 * (1 + emp.deps)); calcNet(); }
        function calcNet() { const net = (parseFloat(document.getElementById('p-base').value)||0) + (parseFloat(document.getElementById('p-bonus').value)||0) + (parseFloat(document.getElementById('p-yeb').value)||0) - (parseFloat(document.getElementById('p-ins').value)||0) - (parseFloat(document.getElementById('p-2nd').value)||0) - (parseFloat(document.getElementById('p-lvd').value)||0); document.getElementById('p-net').value = net>0?net:0; document.getElementById('p-net-display').innerText = `NT$ ${net>0?net:0}`; }
        async function issuePayroll() { const p = { employee_id: document.getElementById('p-emp').value, pay_month: document.getElementById('p-mon').value, base_pay: parseFloat(document.getElementById('p-base').value)||0, bonus: parseFloat(document.getElementById('p-bonus').value)||0, year_end_bonus: parseFloat(document.getElementById('p-yeb').value)||0, labor_pension: parseFloat(document.getElementById('p-pen').value)||0, insurance_deduction: parseFloat(document.getElementById('p-ins').value)||0, second_gen_health: parseFloat(document.getElementById('p-2nd').value)||0, leave_deduction: parseFloat(document.getElementById('p-lvd').value)||0, total_net_pay: parseFloat(document.getElementById('p-net').value)||0 }; await window._sb.from('payroll_records').insert([p]); alert('âœ… ç™¼é€æˆåŠŸï¼'); }

        async function updLeave(id, st) { try { const { error } = await window._sb.rpc('fn_approve_leave', { p_leave_id: id, p_status: st }); if(error) throw error; alert(`âœ… å·²${st}`); loadAll(); } catch(e) { alert('éŒ¯èª¤: ' + e.message); } }
        async function appr(id) { try { const { error } = await window._sb.from('employees').update({ is_approved: true }).eq('id', id); if(error) throw error; alert('âœ… å·²é–‹é€š'); loadAll(); } catch(e) { alert('éŒ¯èª¤'); } }

        function openEmpDetail(empId) {
            const e = window.allEmps.find(x => x.id === empId); if(!e) return;
            const html = `<div class="bg-white p-5 rounded-2xl shadow-sm"><h4 class="text-xl font-black text-slate-800">${e.full_name} <span class="text-[10px] text-sky-600 bg-sky-50 px-2 py-0.5 rounded">${e.employment_status}</span></h4><p class="text-sm font-bold text-slate-500 mt-2">è¯çµ¡é›»è©±: ${e.phone}</p><p class="text-sm font-bold text-slate-500">æ ¸å®šåº•è–ª: NT$ ${e.base_salary}</p></div>`;
            document.getElementById('ui-emp-full-info').innerHTML = html; document.getElementById('emp-detail-modal').classList.add('active');
        }
        let cId = null; function editBr(id) { const b = window.branches.find(x=>x.id===id); cId=b.id; document.getElementById('b-n').value=b.branch_name; document.getElementById('b-a').value=b.address; document.getElementById('b-la').value=b.lat; document.getElementById('b-ln').value=b.lng; document.getElementById('btn-cancel-br').classList.remove('hidden'); }
        function cancelEditBr() { cId=null; document.getElementById('b-n').value=''; document.getElementById('b-a').value=''; document.getElementById('b-la').value=''; document.getElementById('b-ln').value=''; document.getElementById('btn-cancel-br').classList.add('hidden'); }
        async function saveBr() { const p={branch_name:document.getElementById('b-n').value, address:document.getElementById('b-a').value, lat:parseFloat(document.getElementById('b-la').value), lng:parseFloat(document.getElementById('b-ln').value)}; if(cId) await window._sb.from('branch_locations').update(p).eq('id', cId); else await window._sb.from('branch_locations').insert([p]); alert('âœ… å®Œæˆ'); cancelEditBr(); loadAll(); }
    </script>
</body>
</html>
