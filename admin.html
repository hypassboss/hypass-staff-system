<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPASS | ä¼æ¥­æŒ‡æ®ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #f8fafc; -webkit-tap-highlight-color: transparent; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;} 
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; } 
        @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} } 
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .glass-panel { background: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); border: 1px solid #e2e8f0; } 
        .admin-input { width: 100%; padding: 0.875rem; border: 1px solid #cbd5e1; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.2s; } 
        .admin-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); } 
        .modal { display: none; } .modal.active { display: flex; z-index: 100; } 
        .dt-btn.active { background-color: #0284c7; color: white; }
        .select-arrow { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-size: 1.5em 1.5em; background-position: right 0.5rem center; background-repeat: no-repeat; padding-right: 2rem; }
        
        @media print {
            body * { visibility: hidden; }
            #admin-print-zone, #admin-print-zone * { visibility: visible; }
            #admin-print-zone { display: block !important; position: absolute; left: 0; top: 0; width: 100vw; background: white; z-index: 9999; padding: 20px;}
            #dashboard-ui, aside, header { display: none !important; }
            .print-break { page-break-after: always; }
        }
    </style>
</head>
<body class="text-slate-800 font-sans min-h-screen md:h-screen md:overflow-hidden md:flex bg-slate-50">

    <div id="admin-print-zone" style="display:none; font-family: 'Microsoft JhengHei', sans-serif;"></div>

    <div id="login-box" class="flex flex-col items-center justify-center min-h-screen px-5 md:w-full z-50">
        <div class="glass-panel p-8 w-full max-w-sm text-center relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-sky-600 text-white text-[9px] font-bold px-2 py-1 rounded-bl-lg">ERP Admin</div>
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-inner">ğŸ‘‘</div>
            <h2 class="text-2xl font-black mb-2 text-slate-800">æœ€é«˜æ¬Šé™é©—è­‰</h2>
            <p class="text-xs text-slate-500 mb-6">è«‹è¼¸å…¥ç®¡ç†é‡‘é‘°è§£é–æŒ‡æ®ä¸­å¿ƒ</p>
            <input type="password" id="pin" placeholder="PIN CODE" class="admin-input text-center text-2xl tracking-[0.5em] mb-6 bg-slate-50 font-black text-slate-700" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform">é©—è­‰ä¸¦ç™»å…¥</button>
        </div>
    </div>

    <div id="dashboard-ui" class="hidden flex-col md:flex-row h-screen w-full md:overflow-hidden">
        <header class="md:hidden bg-gradient-to-r from-slate-900 to-slate-800 text-white p-5 flex justify-between items-center shadow-lg sticky top-0 z-50 shrink-0">
            <div><h1 class="text-xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-300">HYPASS</h1><span class="text-[9px] text-slate-400 tracking-[0.2em] uppercase font-bold">Admin ERP</span></div>
            <button onclick="location.reload()" class="text-[10px] bg-white/10 border border-white/20 hover:bg-red-500 hover:border-red-500 px-3 py-1.5 rounded-full font-bold transition-all">å®‰å…¨ç™»å‡º</button>
        </header>

        <aside class="hidden md:flex w-64 bg-slate-900 text-white flex-col h-full shadow-2xl shrink-0 z-20 overflow-y-auto no-scrollbar">
            <div class="p-6 pb-2 border-b border-slate-800 mb-4"><h1 class="text-2xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-300">HYPASS</h1><span class="text-[10px] text-slate-400 tracking-[0.2em] uppercase font-bold">Admin Dashboard</span></div>
            <nav class="flex-1 px-4 space-y-2 pb-6">
                <button onclick="st('pend')" id="dt-pend" class="dt-btn active w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ”´</span> å¾…è¾¦å¯©æ ¸</button>
                <button onclick="st('pay')" id="dt-pay" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ’°</span> ç¶œåˆè–ªè³‡ç™¼æ”¾</button>
                <button onclick="st('emps')" id="dt-emps" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ‘¥</span> å“¡å·¥ç¸½è¡¨/é›¢è·</button>
                <button onclick="st('att')" id="dt-att" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“‹</span> å‡ºå‹¤ç´€éŒ„å¤§ç›¤</button>
                <button onclick="st('inv')" id="dt-inv" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“¦</span> åº«å­˜æ¸…å–®ç®¡ç†</button>
                
                <button onclick="st('pur')" id="dt-pur" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ›’</span> æ¡è³¼èˆ‡è«‹è³¼ä¸­å¿ƒ</button>
                <button onclick="st('fin')" id="dt-fin" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ’µ</span> è²¡å‹™å°å¸³å¤§ç›¤</button>
                <button onclick="st('sal')" id="dt-sal" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ’¼</span> æ¥­å‹™ç®¡ç†ä¸­å¿ƒ</button>
                
                <button onclick="st('brs')" id="dt-brs" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“</span> ä¼æ¥­æ“šé»ç®¡ç†</button>
                <button onclick="st('bull')" id="dt-bull" class="dt-btn w-full text-left px-4 py-3.5 rounded-xl font-bold flex items-center transition text-slate-400 hover:text-white hover:bg-slate-800"><span class="mr-3 text-xl">ğŸ“¢</span> ç³»çµ±å…¬å‘Šæ¨æ’­</button>
            </nav>
            <div class="p-4 border-t border-slate-800"><button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-red-500 text-slate-300 hover:text-white py-3 rounded-xl font-bold transition">å®‰å…¨ç™»å‡º</button></div>
        </aside>

        <main class="flex-1 overflow-y-auto w-full p-4 md:p-8 bg-slate-50 relative pb-20 md:pb-8">
            <div class="grid grid-cols-3 gap-3 mb-8 md:hidden">
                <button onclick="st('pend')" id="m-pend" class="m-btn active flex flex-col items-center justify-center py-4 bg-slate-900 text-white rounded-2xl shadow-md border border-transparent transition-all"><span class="text-3xl mb-1.5 drop-shadow-md">ğŸ”´</span><span class="m-text text-[11px] font-black tracking-widest">å¾…è¾¦å¯©æ ¸</span></button>
                <button onclick="st('pay')" id="m-pay" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm">ğŸ’°</span><span class="m-text text-[11px] font-bold tracking-widest">è–ªè³‡ç™¼æ”¾</span></button>
                <button onclick="st('emps')" id="m-emps" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ‘¥</span><span class="m-text text-[11px] font-bold tracking-widest">å“¡å·¥/é›¢è·</span></button>
                <button onclick="st('att')" id="m-att" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“‹</span><span class="m-text text-[11px] font-bold tracking-widest">å‡ºå‹¤å¤§ç›¤</span></button>
                <button onclick="st('inv')" id="m-inv" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“¦</span><span class="m-text text-[11px] font-bold tracking-widest">åº«å­˜æ¸…å–®</span></button>
                
                <button onclick="st('pur')" id="m-pur" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ›’</span><span class="m-text text-[11px] font-bold tracking-widest">æ¡è³¼ç®¡ç†</span></button>
                <button onclick="st('fin')" id="m-fin" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ’µ</span><span class="m-text text-[11px] font-bold tracking-widest">è²¡å‹™å°å¸³</span></button>
                <button onclick="st('sal')" id="m-sal" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ’¼</span><span class="m-text text-[11px] font-bold tracking-widest">æ¥­å‹™ç¸½è¡¨</span></button>
                
                <button onclick="st('brs')" id="m-brs" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“</span><span class="m-text text-[11px] font-bold tracking-widest">æ“šé»ç®¡ç†</span></button>
                <button onclick="st('bull')" id="m-bull" class="m-btn flex flex-col items-center justify-center py-4 bg-white text-slate-500 rounded-2xl border border-slate-200 transition-all shadow-sm col-span-3"><span class="text-3xl mb-1.5 drop-shadow-sm opacity-80">ğŸ“¢</span><span class="m-text text-[11px] font-bold tracking-widest">ç³»çµ±å…¬å‘Šæ¨æ’­</span></button>
            </div>

            <section id="pend" class="tab-content active space-y-6 max-w-4xl">
                <div><h3 class="font-black text-slate-800 border-l-4 border-blue-500 pl-3 text-lg mb-3">æ–°é€²å“¡å·¥å¯©æ ¸</h3><div id="list-pend" class="space-y-3"></div></div>
                <div><h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-3">ç°½æ ¸ä¸­å¿ƒ (å«è£œç™»ç”³è«‹)</h3><div id="list-leaves" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
            </section>

            <section id="pay" class="tab-content space-y-6 max-w-4xl">
                <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-[1.5rem] shadow-lg text-white relative overflow-hidden"><div class="absolute -right-4 -bottom-4 text-7xl opacity-20">ğŸ¦</div><h3 class="font-black text-lg mb-1 relative z-10">éŠ€è¡Œè–ªè³‡è½‰å¸³æª” (CSV)</h3><p class="text-xs text-emerald-100 mb-4 relative z-10 font-medium">æ”¯æ´éŠ€è¡Œä»£ç¢¼ï¼ŒåŒ¯å…¥ç¶²éŠ€æ‰¹æ¬¡è½‰å¸³</p><div class="flex space-x-2 relative z-10"><input type="month" id="export-mon" class="admin-input bg-white/20 border-white/30 text-white placeholder-white/50 flex-1" style="color-scheme: dark;"><button onclick="exportBankCSV()" class="bg-white text-emerald-700 font-black px-5 py-3 rounded-xl shadow-md active:scale-95 transition">ä¸‹è¼‰</button></div></div>
                
                <div class="glass-panel p-6 space-y-4 border-t-4 border-indigo-500">
                    <h3 class="font-black text-slate-800 pl-1 text-lg mb-4 flex items-center"><span class="mr-2">ğŸ’°</span>ç¶œåˆè–ªè³‡èˆ‡å¹´çµ‚ç™¼æ”¾ä¸­å¿ƒ</h3>
                    <div class="grid grid-cols-2 gap-3 mb-2"><select id="p-emp" class="admin-input bg-slate-50 font-bold select-arrow" onchange="onEmpChange()"></select><input type="month" id="p-mon" class="admin-input bg-slate-50 font-bold" onchange="updateAttendanceRate()"></div>
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200 space-y-4">
                        <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">ç•¶æœˆæœ¬è–ª</label><input type="number" id="p-base" oninput="calcPayroll()" class="admin-input font-black text-slate-800 bg-white"></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">çé‡‘æ´¥è²¼</label><select id="p-bonus" onchange="calcPayroll()" class="admin-input font-black text-emerald-600 bg-white select-arrow"><option value="0">0</option><option value="1000">1,000</option><option value="3000">3,000</option><option value="5000">5,000</option><option value="7000">7,000</option><option value="10000">10,000</option></select></div></div>
                        <div class="border-t border-slate-200 pt-4"><label class="flex items-center space-x-2 cursor-pointer text-sm font-black text-amber-700 mb-2 p-2 hover:bg-amber-50 rounded-lg transition select-none"><input type="checkbox" id="toggle-yeb" class="w-5 h-5 accent-amber-500" onchange="handleYebToggle()"><span>ğŸ å•Ÿç”¨å¹´çµ‚èˆ‡ç‰¹ä¼‘çµç®—</span></label><div id="yeb-section" class="hidden grid grid-cols-2 gap-3 bg-amber-50 p-4 rounded-xl border border-amber-200 shadow-inner"><div><label id="lbl-yeb" class="text-[11px] font-black text-amber-800 ml-1">é è¨­å¹´çµ‚</label><input type="number" id="p-yeb" oninput="calcPayroll()" class="admin-input font-black text-amber-600 bg-white border-amber-300 text-lg mt-1" placeholder="é‡‘é¡"></div><div><label id="lbl-ulp-text" class="text-[11px] font-black text-emerald-700 ml-1">ç‰¹ä¼‘çµç®—</label><input type="number" id="p-ulp" oninput="calcPayroll()" class="admin-input font-black text-emerald-600 bg-white border-emerald-300 text-lg mt-1" placeholder="è‡ªå‹•æ›ç®—"></div></div></div>
                    </div>
                    
                    <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                        <div class="flex justify-between items-center mb-2"><h4 class="text-[10px] font-black text-indigo-800 tracking-widest">ğŸ¤– ç•¶æœˆå‡ºå‹¤åˆ†æ</h4><button onclick="updateAttendanceRate()" class="text-[9px] bg-indigo-200 text-indigo-800 px-2 py-1 rounded font-bold">åˆ·æ–°</button></div>
                        <div class="grid grid-cols-6 gap-1 text-center text-[10px] font-bold text-slate-600 bg-white p-2 rounded-lg border border-indigo-100 shadow-sm mb-3"><div>ç—…å‡<br><span id="sd-sick" class="text-indigo-600 text-sm font-black">0</span>h</div><div>äº‹å‡<br><span id="sd-per" class="text-indigo-600 text-sm font-black">0</span>h</div><div>é¢±é¢¨<br><span id="sd-typ" class="text-indigo-600 text-sm font-black">0</span>h</div><div>é²åˆ°<br><span id="sd-lat" class="text-indigo-600 text-sm font-black">0</span>æ¬¡</div><div>åŠ ç­<br><span id="sd-ovt" class="text-emerald-600 text-sm font-black">0</span>h</div><div>è¨ˆé»<br><span id="sd-pnt" class="text-red-600 text-sm font-black">0</span>æ¬¡</div></div>
                        <div class="flex space-x-3"><div class="flex-1"><label class="text-[10px] font-bold text-indigo-800 ml-1">è«‹å‡æ‰£è–ªç¸½é¡</label><input type="number" id="p-lvd" oninput="calcNet()" class="admin-input font-black text-indigo-600 border-indigo-200 bg-white" value="0"></div></div>
                    </div>

                    <div class="p-4 bg-amber-50 rounded-xl border border-amber-200 shadow-sm space-y-4">
                        <div><h4 id="lbl-eval-prev" class="text-[10px] font-black text-amber-800 tracking-widest mb-2 border-b border-amber-200 pb-1">ä¸Šå¹´åº¦</h4><div class="grid grid-cols-6 gap-1 text-center text-[10px] font-bold text-slate-500 bg-white p-2 rounded-lg border border-amber-100 shadow-inner"><div>ç‰¹ä¼‘<br><span id="sy-prev-ann" class="text-amber-600 text-sm font-black">0</span>h</div><div>äº‹å‡<br><span id="sy-prev-per" class="text-amber-600 text-sm font-black">0</span>h</div><div>ç—…å‡<br><span id="sy-prev-sic" class="text-amber-600 text-sm font-black">0</span>h</div><div>é²åˆ°<br><span id="sy-prev-lat" class="text-amber-600 text-sm font-black">0</span>æ¬¡</div><div>åŠ ç­<br><span id="sy-prev-ovt" class="text-emerald-600 text-sm font-black">0</span>h</div><div>è¨ˆé»<br><span id="sy-prev-pnt" class="text-red-600 text-sm font-black">0</span>æ¬¡</div></div></div>
                        <div><h4 id="lbl-eval-curr" class="text-[10px] font-black text-amber-800 tracking-widest mb-2 border-b border-amber-200 pb-1">ç•¶å¹´åº¦</h4><div class="grid grid-cols-6 gap-1 text-center text-[10px] font-bold text-slate-500 bg-white p-2 rounded-lg border border-amber-100 shadow-inner opacity-80"><div>ç‰¹ä¼‘<br><span id="sy-curr-ann" class="text-amber-600 text-sm font-black">0</span>h</div><div>äº‹å‡<br><span id="sy-curr-per" class="text-amber-600 text-sm font-black">0</span>h</div><div>ç—…å‡<br><span id="sy-curr-sic" class="text-amber-600 text-sm font-black">0</span>h</div><div>é²åˆ°<br><span id="sy-curr-lat" class="text-amber-600 text-sm font-black">0</span>æ¬¡</div><div>åŠ ç­<br><span id="sy-curr-ovt" class="text-emerald-600 text-sm font-black">0</span>h</div><div>è¨ˆé»<br><span id="sy-curr-pnt" class="text-red-600 text-sm font-black">0</span>æ¬¡</div></div></div>
                    </div>
                    
                    <div class="p-4 bg-red-50 rounded-xl border border-red-100 grid grid-cols-2 gap-3 relative"><button onclick="calcPayroll()" class="absolute -top-3 right-3 text-[9px] bg-slate-800 text-white font-bold px-2 py-1 rounded shadow-sm">ğŸ¤– é‡ç®—</button><div><label class="text-[10px] font-bold text-red-800 ml-1">å‹å¥ä¿</label><input type="number" id="p-ins" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200 bg-white"></div><div><label class="text-[10px] font-bold text-red-800 ml-1">äºŒä»£å¥ä¿</label><input type="number" id="p-2nd" oninput="calcNet()" class="admin-input font-black text-red-600 border-red-200 bg-white"></div></div>
                    <div class="flex justify-between items-center p-5 mt-2 bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl border border-sky-200 shadow-inner"><span class="text-sm font-black text-slate-700">ç¶œåˆçµç®—å¯¦é ˜</span><span class="text-4xl font-black text-sky-600 tracking-tighter" id="p-net-display">NT$ 0</span><input type="hidden" id="p-net"><input type="hidden" id="p-pen"></div>
                    <button onclick="issuePayroll()" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform mt-2 tracking-widest text-lg">ğŸš€ æ­£å¼ç™¼é€</button>
                </div>
                <div class="glass-panel p-6 space-y-4 border-t-4 border-slate-600">
                    <h3 class="font-black text-slate-800 pl-1 text-lg mb-4 flex items-center"><span class="mr-2">ğŸ“œ</span>æ­·å²è–ªè³‡å–®ç®¡ç†</h3>
                    <select id="hist-emp" class="admin-input bg-slate-50 font-bold mb-4 select-arrow" onchange="loadPayrollHistory()"></select>
                    <div id="ui-payroll-hist" class="space-y-3 max-h-[400px] overflow-y-auto pr-1 no-scrollbar"><div class="text-center text-xs text-slate-400 py-6 bg-slate-50 rounded-xl border border-dashed border-slate-300">è«‹å…ˆé¸æ“‡å“¡å·¥</div></div>
                </div>
            </section>

            <section id="emps" class="tab-content space-y-5 max-w-6xl">
                <div><h3 class="font-black text-slate-800 border-l-4 border-sky-500 pl-3 text-lg mb-4">å“¡å·¥è³‡æ–™ç¸½è¡¨èˆ‡ç®¡ç†</h3><div id="list-emps-mobile" class="space-y-3 md:hidden">è¼‰å…¥ä¸­...</div><div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold"><tr><th class="px-6 py-4">ç·¨è™Ÿ</th><th class="px-6 py-4">å§“å / æ“šé»</th><th class="px-6 py-4">è¯çµ¡é›»è©±</th><th class="px-6 py-4">æ ¸å®šåº•è–ª</th><th class="px-6 py-4 text-center">æ“ä½œ</th></tr></thead><tbody id="list-emps-desktop" class="divide-y divide-slate-100"></tbody></table></div></div>
            </section>

            <section id="inv" class="tab-content space-y-5 max-w-6xl">
                <div><h3 class="font-black text-slate-800 border-l-4 border-emerald-500 pl-3 text-lg mb-4">åº«å­˜æ¸…å–®èˆ‡æ–™è™Ÿç®¡ç†</h3><div class="glass-panel p-5 shadow-sm mb-4 flex space-x-2"><select id="admin-inv-cat-filter" class="w-1/3 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold outline-none select-arrow shadow-inner" onchange="filterAdminInventory()"><option value="">å…¨éƒ¨åˆ†é¡</option></select><input type="text" id="admin-inv-search" placeholder="ğŸ” æœå°‹æ–™è™Ÿ/å“å..." class="w-2/3 admin-input bg-slate-50 font-bold shadow-inner" onkeyup="filterAdminInventory()"></div><div id="list-inv-mobile" class="space-y-3 md:hidden">è¼‰å…¥ä¸­...</div><div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold"><tr><th class="px-6 py-4">æ–™è™Ÿ / å“å / è¦æ ¼</th><th class="px-6 py-4 text-right">ç•¶å‰åº«å­˜</th><th class="px-6 py-4 text-right">å®‰å…¨ä½æ°´ä½</th><th class="px-6 py-4 text-center">ç”Ÿç”¢é€±æœŸ</th><th class="px-6 py-4 text-center">æ“ä½œ</th></tr></thead><tbody id="list-inv-desktop" class="divide-y divide-slate-100"></tbody></table></div></div>
            </section>

            <section id="att" class="tab-content space-y-5 max-w-6xl">
                <h3 class="font-black text-slate-800 border-l-4 border-slate-500 pl-3 text-lg mb-4">å…¨é«”å‡ºå‹¤ç‹€æ…‹ç¸½è¦½</h3><div class="glass-panel p-5 shadow-sm mb-4 max-w-sm"><input type="date" id="att-date" onchange="loadAttendance()" class="admin-input bg-slate-50 font-black text-lg shadow-inner"></div><div id="list-attendance-mobile" class="space-y-3 pb-8 md:hidden">è«‹é¸æ“‡æ—¥æœŸ...</div><div class="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold"><tr><th class="px-6 py-4">å“¡å·¥å§“å</th><th class="px-6 py-4">æ’å®šç­åˆ¥</th><th class="px-6 py-4">ä¸Šç­æ‰“å¡</th><th class="px-6 py-4">ä¸‹ç­æ‰“å¡</th></tr></thead><tbody id="list-attendance-desktop"><tr><td colspan="4" class="text-center py-6 text-slate-400">è«‹é¸æ“‡æ—¥æœŸ</td></tr></tbody></table></div>
            </section>

            <section id="pur" class="tab-content space-y-6 max-w-6xl">
                <div>
                    <h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-4 flex items-center justify-between">
                        <span>ğŸ“„ æ­£å¼æ¡è³¼å–® (PDF) ç®¡ç†</span>
                    </h3>
                    <div class="glass-panel p-5 shadow-sm"><div id="list-admin-po-docs" class="space-y-4">è¼‰å…¥ä¸­...</div></div>
                </div>
                
                <div>
                    <h3 class="font-black text-slate-800 border-l-4 border-sky-500 pl-3 text-lg mb-4 flex items-center justify-between">
                        <span>ğŸ“ å…§éƒ¨è«‹è³¼å–®ç´€éŒ„</span>
                    </h3>
                    <div class="glass-panel p-5 shadow-sm bg-slate-50/50 border border-dashed border-slate-300"><div id="list-admin-po-drafts" class="space-y-3">è¼‰å…¥ä¸­...</div></div>
                </div>
            </section>

            <section id="fin" class="tab-content space-y-5 max-w-6xl">
                <h3 class="font-black text-slate-800 border-l-4 border-blue-500 pl-3 text-lg mb-4">è²¡å‹™å°å¸³å¤§ç›¤</h3>
                <div class="glass-panel p-5 md:p-8 shadow-sm"><div id="list-admin-fin" class="space-y-4">è¼‰å…¥ä¸­...</div></div>
            </section>

            <section id="sal" class="tab-content space-y-5 max-w-6xl">
                <h3 class="font-black text-slate-800 border-l-4 border-indigo-500 pl-3 text-lg mb-4">æ¥­å‹™ç®¡ç†ç¸½è¡¨</h3>
                <div class="glass-panel p-10 text-center shadow-sm rounded-3xl mt-10"><span class="text-6xl mb-4 block">ğŸ’¼</span><h4 class="text-xl font-black text-slate-700">æ¥­å‹™æ¨¡çµ„å³å°‡ä¸Šç·š</h4><p class="text-sm text-slate-500 mt-2 font-bold">ç›®å‰å‰å°æ¥­å‹™åŠŸèƒ½æ­£åœ¨ç±Œå‚™é–‹ç™¼ä¸­ï¼Œæ­¤å¤§ç›¤å°‡æ–¼å¾ŒçºŒé–‹æ”¾ï¼Œæ•¬è«‹æœŸå¾…ï¼</p></div>
            </section>

            <section id="brs" class="tab-content space-y-5 max-w-4xl">
                <div class="glass-panel p-6 shadow-sm mb-4"><h3 class="font-black text-slate-800 border-l-4 border-emerald-500 pl-3 text-lg mb-4" id="br-form-title">æ–°å¢æ‰“å¡æ“šé»</h3><input type="hidden" id="b-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3"><input type="text" id="b-n" placeholder="åˆ†åº—åç¨±" class="admin-input font-bold"><input type="text" id="b-a" placeholder="åœ°å€" class="admin-input bg-white"></div><div class="grid grid-cols-2 gap-3 mb-5"><input type="number" step="any" id="b-la" placeholder="ç·¯åº¦" class="admin-input bg-slate-50 font-mono text-sm shadow-inner" required><input type="number" step="any" id="b-ln" placeholder="ç¶“åº¦" class="admin-input bg-slate-50 font-mono text-sm shadow-inner" required></div><div class="flex space-x-2"><button type="button" onclick="cancelEditBr()" id="btn-cancel-br" class="hidden w-1/3 bg-slate-200 text-slate-700 font-bold py-3.5 rounded-xl transition">å–æ¶ˆ</button><button onclick="saveBr()" id="btn-save-br" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-black py-3.5 rounded-xl shadow-md transition">å„²å­˜æ“šé»</button></div></div>
                <div id="list-brs" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </section>
            
            <section id="bull" class="tab-content space-y-5 max-w-4xl">
                <div class="glass-panel p-6 shadow-sm"><h3 class="font-black text-slate-800 border-l-4 border-amber-500 pl-3 text-lg mb-4" id="blt-form-title">ç™¼å¸ƒä¼æ¥­é›»å­å…¬å‘Š</h3><input type="hidden" id="blt-edit-id"><input type="text" id="blt-title" placeholder="ä¸»æ—¨æ¨™é¡Œ" class="admin-input mb-3 font-bold text-lg"><textarea id="blt-content" placeholder="è«‹è¼¸å…¥è©³ç´°å…¬å‘Šå…§å®¹..." class="admin-input mb-5 h-40 resize-none leading-relaxed shadow-inner"></textarea><div class="flex space-x-2"><button type="button" onclick="cancelEditBlt()" id="btn-cancel-blt" class="hidden w-1/3 bg-slate-200 text-slate-700 font-bold py-4 rounded-xl shadow-sm transition">å–æ¶ˆ</button><button onclick="postBlt()" id="btn-post-blt" class="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-black py-4 rounded-xl shadow-lg transition">ç«‹å³æ¨æ’­</button></div></div>
                <div class="glass-panel p-6 shadow-sm"><h3 class="font-black text-slate-600 text-sm mb-3">å·²å…¬å‘Šæ­·å²ç´€éŒ„</h3><div id="list-admin-blt" class="space-y-3"></div></div>
            </section>
        </main>
    </div>

    <div id="payroll-edit-modal" class="modal fixed inset-0 bg-slate-900/70 backdrop-blur-sm items-center justify-center p-5 z-[100]"><div class="bg-white w-full max-w-md rounded-3xl p-6 relative flex flex-col shadow-2xl max-h-[90vh] overflow-y-auto"><h3 class="font-black text-lg border-b pb-3 mb-4 text-slate-800">âœï¸ ç·¨è¼¯æ­·å²è–ªè³‡å–®</h3><input type="hidden" id="edit-pr-id"><div class="space-y-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">æœˆä»½</label><input type="text" id="edit-pr-month" class="admin-input font-bold bg-slate-100" disabled></div><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-slate-500 ml-1">æœ¬è–ª</label><input type="number" id="edit-pr-base" class="admin-input font-black bg-slate-50" oninput="calcEditPayrollNet()"></div><div><label class="text-[10px] font-bold text-emerald-600 ml-1">çé‡‘æ´¥è²¼</label><input type="number" id="edit-pr-bonus" class="admin-input font-black text-emerald-600 bg-emerald-50 border-emerald-200" oninput="calcEditPayrollNet()"></div><div class="col-span-2"><label class="text-[10px] font-bold text-amber-600 ml-1">å¹´çµ‚</label><input type="number" id="edit-pr-yeb" class="admin-input font-black text-amber-600 bg-amber-50" oninput="calcEditPayrollNet()"></div><div class="col-span-2"><label class="text-[10px] font-bold text-sky-600 ml-1">ç‰¹ä¼‘çµç®—</label><input type="number" id="edit-pr-ulp" class="admin-input font-black text-sky-600 bg-sky-50" oninput="calcEditPayrollNet()"></div><div><label class="text-[10px] font-bold text-red-600 ml-1">å‹å¥ä¿</label><input type="number" id="edit-pr-ins" class="admin-input font-black text-red-600 bg-red-50" oninput="calcEditPayrollNet()"></div><div><label class="text-[10px] font-bold text-red-600 ml-1">äºŒä»£å¥ä¿</label><input type="number" id="edit-pr-2nd" class="admin-input font-black text-red-600 bg-red-50" oninput="calcEditPayrollNet()"></div><div class="col-span-2"><label class="text-[10px] font-bold text-red-600 ml-1">è«‹å‡æ‰£è–ª</label><input type="number" id="edit-pr-lvd" class="admin-input font-black text-red-600 bg-red-50" oninput="calcEditPayrollNet()"></div></div><div class="flex justify-between items-center bg-slate-100 p-4 rounded-xl mt-3 shadow-inner"><span class="font-bold text-slate-600">é‡ç®—å¯¦é ˜</span><span id="edit-pr-net" class="text-2xl font-black text-sky-600">NT$ 0</span></div></div><div class="flex space-x-3 mt-6"><button onclick="closeModal('payroll-edit-modal')" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3.5 rounded-xl">å–æ¶ˆ</button><button onclick="saveEditPayroll()" class="flex-1 bg-indigo-600 text-white font-black py-3.5 rounded-xl">å„²å­˜</button></div></div></div>

    <div id="item-edit-modal" class="modal fixed inset-0 bg-slate-900/70 backdrop-blur-sm items-center justify-center p-4 z-[100]"><div class="bg-white w-full max-w-md m-auto rounded-[2rem] p-5 relative flex flex-col shadow-2xl max-h-[90vh] overflow-y-auto no-scrollbar"><h3 class="font-black text-lg border-b pb-3 mb-4 text-slate-800 flex justify-between"><span>âœï¸ ä¿®æ”¹æ–™è™Ÿ</span><button onclick="deleteAdminItem()" class="text-xs bg-red-50 text-red-600 px-3 py-1 rounded-lg">ğŸ—‘ï¸ åˆªé™¤</button></h3><input type="hidden" id="edit-item-id"><div class="space-y-3"><div class="grid grid-cols-2 gap-3"><div class="col-span-2"><label class="text-[10px] font-bold text-slate-500 ml-1">å“å</label><input type="text" id="edit-item-name" class="admin-input font-bold bg-slate-50"></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">æ–™è™Ÿ</label><input type="text" id="edit-item-code" class="admin-input font-mono uppercase bg-slate-50"></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">å±¬æ€§</label><select id="edit-item-type" class="admin-input bg-white select-arrow"><option value="åŸæ–™">åŸæ–™</option><option value="æˆå“">æˆå“</option></select></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">é¡åˆ¥</label><select id="edit-item-cat" class="admin-input bg-white select-arrow"><option value="æ±½è»Šå†·æ°£æ¿¾ç¶²">æ±½è»Šå†·æ°£æ¿¾ç¶²</option><option value="VESTAç³»åˆ—ç”¢å“">VESTAç³»åˆ—ç”¢å“</option><option value="æœªåˆ†é¡">æœªåˆ†é¡</option></select></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">åŒ…è£é‡</label><input type="number" id="edit-item-qty" class="admin-input bg-slate-50 text-center"></div><div class="col-span-2"><label class="text-[10px] font-bold text-slate-500 ml-1">è¦æ ¼</label><input type="text" id="edit-item-spec" class="admin-input bg-slate-50"></div><div><label class="text-[10px] font-bold text-red-600 ml-1">ä½æ°´ä½</label><input type="number" id="edit-item-safe" class="admin-input text-red-600 bg-red-50 border-red-200"></div><div><label class="text-[10px] font-bold text-slate-500 ml-1">ç”Ÿç”¢é€±æœŸ</label><select id="edit-item-lead" class="admin-input bg-white select-arrow"><option value="15">15å¤©</option><option value="30">30å¤©</option><option value="60">60å¤©</option><option value="90">90å¤©</option></select></div><div class="col-span-2"><label class="text-[10px] font-bold text-slate-500 ml-1">ç›¤é»é€±æœŸ</label><select id="edit-item-cycle" class="admin-input bg-sky-50 text-sky-900 select-arrow font-black"><option value="7">7å¤© (æ¯é€±)</option><option value="30">30å¤© (æ¯æœˆ)</option><option value="60">60å¤© (é›™æœˆ)</option><option value="90">90å¤© (ä¸€å­£)</option></select></div></div><div class="border-t border-slate-200 pt-3 mt-2">
        <h5 class="text-[10px] font-black text-sky-700 mb-2">âš™ï¸ BOM ä¿®æ­£ (æœ€å¤š 6 é …)</h5><div class="overflow-x-auto no-scrollbar border border-slate-200 rounded-xl bg-slate-50 p-1">
            <table class="w-full text-left text-[10px] whitespace-nowrap min-w-[400px]">
                <thead class="text-slate-500 border-b border-slate-200"><tr><th class="p-1 font-bold w-32">åŸæ–™åç¨±</th><th class="p-1 font-bold w-16">ç”¨é‡</th><th class="p-1 font-bold w-16">å–®ä½</th><th class="p-1 font-bold text-sky-700">ç¸½ç”¨é‡(+10%æè€—)</th></tr></thead>
                <tbody id="admin-bom-table-body" class="divide-y divide-slate-100"></tbody>
            </table>
        </div></div></div><div class="flex space-x-3 mt-6"><button onclick="closeModal('item-edit-modal')" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3.5 rounded-xl">å–æ¶ˆ</button><button onclick="saveAdminItem()" class="flex-1 bg-emerald-600 text-white font-black py-3.5 rounded-xl shadow-md">å„²å­˜</button></div></div></div>

    <div id="emp-detail-modal" class="modal fixed inset-0 bg-slate-900/70 backdrop-blur-sm items-end justify-center pb-0 z-[100] md:items-center"><div class="bg-slate-50 w-full max-w-3xl md:max-w-4xl rounded-t-[2rem] md:rounded-3xl h-[92vh] flex flex-col shadow-2xl relative overflow-hidden"><div class="bg-white flex justify-between items-center p-5 md:p-6 border-b border-slate-200 shrink-0 shadow-sm z-10"><h3 class="font-black text-xl text-slate-800 flex items-center"><span class="text-2xl mr-2">ğŸªª</span>æª”æ¡ˆç®¡ç†ä¸­å¿ƒ</h3><div class="flex space-x-2"><button id="btn-edit-emp" class="bg-sky-50 text-sky-700 px-4 py-2 rounded-full font-black text-xs shadow-sm">âœï¸ ç·¨è¼¯</button><button onclick="closeModal('emp-detail-modal')" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full font-black text-xs">âœ• é—œé–‰</button></div></div><div class="overflow-y-auto p-5 md:p-8 space-y-6 flex-1 no-scrollbar"><div id="ui-emp-full-info"></div><div class="bg-white p-6 rounded-2xl border border-red-200 shadow-sm" id="ui-emp-offboard-section"><h4 class="font-black text-red-700 mb-3 border-l-4 border-red-500 pl-2 text-lg">âš–ï¸ é›¢è·èˆ‡çµç®—</h4><div class="grid grid-cols-2 gap-4 mb-5"><div><label class="text-[10px] font-bold text-slate-500 ml-1 block">é›¢è·é¡åˆ¥</label><select id="modal-off-type" class="admin-input bg-slate-50"><option value="è‡ªé¡˜é›¢è·">è‡ªé¡˜é›¢è·</option><option value="éè‡ªé¡˜é›¢è·(è³‡é£)">éè‡ªé¡˜è³‡é£</option></select></div><div><label class="text-[10px] font-bold text-slate-500 ml-1 block">æœ€å¾Œå·¥ä½œæ—¥</label><input type="date" id="modal-off-date" class="admin-input bg-slate-50"></div></div><button onclick="calculateSettlement()" class="w-full border-2 border-slate-800 text-slate-800 font-black py-3 rounded-xl hover:bg-slate-800 hover:text-white transition">âš™ï¸ ç”¢ç”Ÿçµç®—å ±è¡¨</button><div id="modal-off-result" class="hidden mt-6 border-t border-slate-200 pt-5 space-y-2"><div class="flex justify-between text-sm px-2"><span class="font-bold text-slate-500">æ ¸ç®—åº•è–ª</span><span id="res-base" class="font-black text-slate-700">0</span></div><div class="flex justify-between text-sm px-2"><span class="font-bold text-slate-500">ç ´æœˆè–ªè³‡</span><span id="res-pro" class="font-black text-emerald-600">0</span></div><div class="flex justify-between text-sm px-2"><span class="font-bold text-slate-500">ç‰¹ä¼‘æ›ç¾</span><span id="res-lvp" class="font-black text-emerald-600">0</span></div><div class="flex justify-between text-sm px-2"><span class="font-bold text-slate-500">è³‡é£è²»</span><span id="res-sev" class="font-black text-amber-600">0</span></div><div class="flex justify-between text-base items-end pt-2 px-2"><span class="font-black text-slate-800">ç¸½è¨ˆç™¼æ”¾</span><span id="res-total" class="text-2xl font-black text-red-600">0</span></div><button onclick="confirmOffboarding()" class="w-full bg-red-600 text-white font-black py-4 rounded-xl mt-4">âš ï¸ ç¢ºèªçµç®—ä¸¦åœæ¬Š</button></div></div></div></div></div>

    <script src="shared.js"></script>
    <script>
        let globalOffboardData = null; window.empData = {}; window.allEmps = []; window.branches = []; window.bulletins = []; window.adminInvData = []; window.currentPayrollRecords = []; window.supplierData = [];
        window.adminPoData = []; window.adminReqData = [];

        // ğŸŒŸ å¼·åˆ¶è§£æç‚ºå®‰å…¨é™£åˆ—çš„å¼•æ“
        function getSafeArray(data) { if (!data) return []; if (Array.isArray(data)) return data; try { return JSON.parse(data); } catch(e) { return []; } }

        function login() { if(document.getElementById('pin').value === '888888'){ document.getElementById('login-box').style.display='none'; document.getElementById('dashboard-ui').classList.remove('hidden'); document.getElementById('dashboard-ui').classList.add('flex'); document.getElementById('att-date').value = new Date().toLocaleDateString('en-CA'); const now = new Date(); document.getElementById('p-mon').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; document.getElementById('export-mon').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; loadAll(); } else { alert('å¯†ç¢¼éŒ¯èª¤ï¼'); } }
        
        function st(id) { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.m-btn').forEach(e=>{ e.classList.remove('bg-slate-900','text-white','shadow-md','border-transparent'); e.classList.add('bg-white','text-slate-500','border-slate-200','shadow-sm'); e.querySelector('.m-text').classList.remove('font-black'); e.querySelector('.m-text').classList.add('font-bold'); }); const activeMBtn = document.getElementById('m-'+id); if(activeMBtn) { activeMBtn.classList.remove('bg-white','text-slate-500','border-slate-200','shadow-sm'); activeMBtn.classList.add('bg-slate-900','text-white','shadow-md','border-transparent'); activeMBtn.querySelector('.m-text').classList.remove('font-bold'); activeMBtn.querySelector('.m-text').classList.add('font-black'); } document.querySelectorAll('.dt-btn').forEach(e=>{ e.classList.remove('active','bg-sky-600','text-white'); e.classList.add('text-slate-400'); }); const activeDtBtn = document.getElementById('dt-'+id); if(activeDtBtn) { activeDtBtn.classList.add('active','bg-sky-600','text-white'); activeDtBtn.classList.remove('text-slate-400'); } document.getElementById(id).classList.add('active'); 
            
            if(id === 'att') loadAttendance(); 
            if(id === 'inv') loadAdminInventory();
            if(id === 'pur') loadAdminPurchase();
            if(id === 'fin') loadAdminFinance();
        }
        
        function openModal(id) { document.getElementById(id).classList.add('active'); } 
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function loadAll() {
            const { data: emps } = await window._sb.from('employees').select('*, branch_locations(branch_name)');
            const { data: brs } = await window._sb.from('branch_locations').select('*');
            window.allEmps = emps || []; window.branches = brs || [];

            const p = window.allEmps.filter(e => !e.is_approved && e.employment_status === 'åœ¨è·');
            document.getElementById('list-pend').innerHTML = p.length ? p.map(e => `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><span class="text-2xl mr-3">ğŸ‘¤</span><div><h4 class="font-black text-sm text-slate-800">${e.full_name}</h4><p class="text-[10px] text-slate-500">${e.onboarding_date}</p></div></div><button onclick="appr('${e.id}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-black px-4 py-2 rounded-lg transition">é–‹é€š</button></div>`).join('') : '<p class="text-xs text-slate-400 font-bold text-center py-4">ç„¡å¾…è¾¦äººå“¡</p>';
            
            const aEmps = window.allEmps.filter(e => e.is_approved && e.employment_status === 'åœ¨è·');
            aEmps.sort((a, b) => { let valA = a.employee_no && a.employee_no !== 'æœªè¨­å®š' ? a.employee_no : 'Z999'; let valB = b.employee_no && b.employee_no !== 'æœªè¨­å®š' ? b.employee_no : 'Z999'; return valA.localeCompare(valB, 'zh-TW', { numeric: true }); });
            
            aEmps.forEach(e => { window.empData[e.id] = { base: e.base_salary, deps: e.dependents_count || 0, start: e.work_start_time || '09:00:00', penalty_points: e.penalty_points || 0 }; }); 
            const empOpts = '<option value="">é¸æ“‡ç™¼æ”¾å“¡å·¥...</option>' + aEmps.map(e => `<option value="${e.id}">[${e.employee_no||'æœªè¨­'}] ${e.full_name}</option>`).join('');
            document.getElementById('p-emp').innerHTML = empOpts; document.getElementById('hist-emp').innerHTML = empOpts;

            if (aEmps.length) {
                document.getElementById('list-emps-mobile').innerHTML = aEmps.map(e => {
                    let mgrTag = e.is_inventory_manager ? '<span class="text-[9px] bg-emerald-100 text-emerald-700 px-1 rounded ml-1">ç›¤é»å“¡</span>' : '';
                    let pntTag = e.penalty_points > 0 ? `<span class="text-[9px] bg-red-100 text-red-700 px-1 rounded ml-1">è¨ˆé»:${e.penalty_points}</span>` : '';
                    return `<div class="glass-panel p-4 flex justify-between items-center"><div class="flex items-center"><div class="w-10 h-10 bg-slate-100 border border-slate-200 rounded-full flex items-center justify-center text-slate-500 font-black mr-3">${e.full_name.charAt(0)}</div><div><h4 class="font-black text-sm text-slate-800">${e.full_name} <span class="text-[9px] text-emerald-700 border border-emerald-200 bg-emerald-50 px-1 rounded">${(e.base_salary/1000).toFixed(0)}k</span>${mgrTag}${pntTag}</h4><p class="text-[10px] text-slate-500 mt-1">${e.employee_no||'æœªç·¨è™Ÿ'} | ${e.branch_locations?.branch_name||'æœªç¶å®š'}</p></div></div><button onclick="openEmpDetail('${e.id}')" class="bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded-xl">ç®¡ç†</button></div>`;
                }).join('');
                document.getElementById('list-emps-desktop').innerHTML = aEmps.map(e => {
                    let mgrTag = e.is_inventory_manager ? '<span class="text-[9px] bg-emerald-100 text-emerald-700 px-1 rounded block mt-1 w-max">ç›¤é»è² è²¬äºº</span>' : '';
                    let pntTag = e.penalty_points > 0 ? `<span class="text-[9px] bg-red-100 text-red-700 px-1 rounded block mt-1 w-max">è¨ˆé»:${e.penalty_points}</span>` : '';
                    return `<tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-black text-sky-700 text-xs">${e.employee_no||'--'}</td><td class="px-6 py-4 font-black text-slate-800">${e.full_name}${mgrTag}${pntTag}</td><td class="px-6 py-4 text-slate-600 font-mono text-xs">${e.phone}</td><td class="px-6 py-4 text-emerald-600 font-black">NT$ ${e.base_salary.toLocaleString()}</td><td class="px-6 py-4 text-center"><button onclick="openEmpDetail('${e.id}')" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold px-4 py-2 rounded-xl transition shadow-sm">ç®¡ç†</button></td></tr>`;
                }).join('');
            } else {
                document.getElementById('list-emps-mobile').innerHTML = '<p class="text-center text-xs text-slate-400 py-4">ç„¡åœ¨è·å“¡å·¥</p>';
                document.getElementById('list-emps-desktop').innerHTML = '<tr><td colspan="5" class="text-center py-6 text-slate-400">ç„¡åœ¨è·å“¡å·¥</td></tr>';
            }

            const { data: lv } = await window._sb.from('leave_requests').select('*, employees(full_name)').eq('status', 'å¯©æ ¸ä¸­');
            document.getElementById('list-leaves').innerHTML = (lv && lv.length) ? lv.map(l => {
                let isRet = l.leave_type === 'å¿˜è¨˜æ‰“å¡(è£œç™»)'; let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = isRet?'':new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                let spB = isRet ? `<span class="text-[9px] text-amber-700 bg-amber-100 px-1.5 py-0.5 rounded ml-2 font-bold">è£œç™»${l.target_punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span>` : (l.leave_type === 'é¢±é¢¨å‡' ? '<span class="text-[9px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded ml-2">ä¸æ”¯è–ª</span>' : (l.salary_protection?'<span class="text-[9px] text-sky-600 bg-sky-50 px-1.5 py-0.5 rounded ml-2">ç‰¹ä¼‘ä¿è–ª</span>':'<span class="text-[9px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded ml-2">ä¸ä¿è–ª</span>'));
                return `<div class="glass-panel p-4 shadow-sm"><div class="flex justify-between items-start mb-2"><div><span class="font-black text-sm text-slate-800">${l.employees?.full_name}</span><span class="text-xs font-bold text-slate-600 ml-2 border-l-2 border-slate-300 pl-2">${l.leave_type.replace('(è£œç™»)','')}</span>${spB}</div></div><div class="bg-slate-50 p-2 rounded-lg mb-3 inline-block"><p class="text-[10px] font-mono text-slate-600 tracking-tight">${t1} ${t2?'~ '+t2:''}</p></div><div class="flex space-x-2"><button onclick="updLeave('${l.id}', 'æ ¸å‡†')" class="flex-1 bg-emerald-50 border border-emerald-200 text-emerald-700 hover:bg-emerald-500 hover:text-white py-2.5 rounded-lg text-sm font-black transition-colors">æ ¸å‡†</button><button onclick="updLeave('${l.id}', 'æ ¸é§')" class="flex-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2.5 rounded-lg text-sm font-black transition-colors">é§å›</button></div></div>`
            }).join('') : '<div class="text-center py-6 bg-slate-100/50 rounded-xl border border-dashed border-slate-300 md:col-span-2"><p class="text-xs text-slate-400 font-bold">ç„¡å¾…å¯©æ ¸å–®æ“šï¼</p></div>';

            document.getElementById('list-brs').innerHTML = window.branches.map(b => `<div class="glass-panel p-4 flex justify-between items-center shadow-sm"><div class="flex items-center"><span class="text-2xl mr-3 opacity-80">ğŸ“</span><div><p class="font-black text-sm text-slate-800">${b.branch_name}</p><p class="text-[10px] text-slate-500 mt-0.5">${b.address}</p></div></div><button onclick="editBr('${b.id}')" class="text-xs bg-sky-100 text-sky-700 font-bold px-3 py-2 rounded-lg active:scale-95 shadow-sm">âœï¸ ä¿®æ”¹</button></div>`).join('');
            
            const { data: sups } = await window._sb.from('suppliers').select('*');
            window.supplierData = sups || [];

            loadAdminBlt();
        }

        // ğŸŒŸ çµ•å°é˜²å½ˆå¼•æ“ï¼šé›™è»Œè‡ªå‹•å‚™æ´æƒæï¼Œä¿è­‰è³‡æ–™ä¸éºæ¼
        async function fetchSafeReqs() {
            let reqData = [];
            try {
                const { data: r1, error: e1 } = await window._sb.from('requisitions').select('*, employees(full_name)').order('created_at', {ascending: false});
                if (!e1 && r1) reqData = r1;
            } catch(e) {}

            try {
                const { data: r2 } = await window._sb.from('purchase_orders').select('*, employees(full_name)').in('status', ['å¾…è™•ç†', 'å·²å»ºæª”', 'æ¡è³¼ä¸­']).order('created_at', {ascending: false});
                if (r2 && r2.length > 0) {
                    let oldReqs = r2.map(x => ({
                        id: x.id,
                        req_no: 'REQ-FB-' + x.id.slice(0,4),
                        employee_id: x.employee_id,
                        employees: x.employees,
                        items_json: x.raw_materials, 
                        status: x.status === 'å·²å»ºæª”' ? 'å¾…è™•ç†' : x.status,
                        created_at: x.created_at
                    }));
                    reqData = [...reqData, ...oldReqs];
                }
            } catch(e) {}
            return reqData;
        }

        async function loadAdminPurchase() {
            const elDocs = document.getElementById('list-admin-po-docs');
            const elDrafts = document.getElementById('list-admin-po-drafts');
            elDocs.innerHTML = 'è¼‰å…¥ä¸­...'; elDrafts.innerHTML = 'è¼‰å…¥ä¸­...';
            
            try {
                const { data: docs } = await window._sb.from('po_documents').select('*').order('created_at', {ascending: false});
                if(!docs || docs.length === 0) {
                    elDocs.innerHTML = '<p class="text-center text-slate-400 font-bold py-6">ç›®å‰ç„¡æ­£å¼æ¡è³¼å–® (PDF)</p>';
                } else {
                    window.adminPoData = docs;
                    elDocs.innerHTML = docs.map(d => {
                        let statusCol = d.status === 'å®Œæˆ' ? 'text-emerald-700 bg-emerald-100 border-emerald-200' : (d.status.includes('ç•°å¸¸') ? 'text-red-700 bg-red-100 border-red-200' : 'text-slate-700 bg-slate-100 border-slate-200');
                        let safeItems = getSafeArray(d.items_json);
                        let expText = d.exception_reason ? `<div class="text-[10px] bg-red-50 text-red-600 p-1.5 rounded-lg border border-red-100 mt-1 font-bold"><span class="mr-1">ğŸš¨</span>ç•°å¸¸åŸå› : ${d.exception_reason}</div>` : '';
                        
                        return `
                        <div class="bg-white p-4 rounded-xl border border-slate-200 mb-3 shadow-sm flex flex-col md:flex-row justify-between md:items-center">
                            <div class="mb-3 md:mb-0">
                                <div class="flex items-center mb-1">
                                    <span class="font-mono font-black text-slate-700 bg-slate-100 px-2 py-0.5 rounded border border-slate-200 mr-2">${d.po_no}</span>
                                    <span class="text-[10px] font-black px-2 py-0.5 rounded border ${statusCol}">${d.status}</span>
                                </div>
                                <h4 class="font-black text-base text-slate-800">${d.supplier_name} <span class="text-xs text-slate-500 font-bold ml-1">(${safeItems.length}é …åŸæ–™)</span></h4>
                                <div class="text-[10px] text-slate-500 mt-1 flex items-center">
                                    <span class="mr-1">ğŸ“…</span>å»ºæª”: ${new Date(d.created_at).toLocaleDateString()} <span class="mx-2">|</span> <span class="text-red-600 font-bold">ğŸšš é è¨ˆåˆ°è²¨: ${d.expected_date||'æœªå®š'}</span>
                                </div>
                                ${expText}
                            </div>
                            <div class="flex items-center space-x-2 md:flex-col md:space-x-0 md:space-y-2 md:items-end">
                                <button onclick="downloadAdminPO_PDF('${d.id}')" class="flex-1 md:w-32 bg-slate-800 hover:bg-slate-700 text-white text-xs px-4 py-2 rounded-lg font-black shadow-sm transition active:scale-95 flex justify-center items-center"><span class="mr-1">ğŸ“¥</span> è£œå° PDF</button>
                                <button onclick="openAdminEditPO('${d.id}')" class="text-xs bg-amber-50 hover:bg-amber-100 text-amber-700 border border-amber-200 px-4 py-2 rounded-lg font-bold shadow-sm active:scale-95 transition">âœï¸ ç‹€æ…‹ç·¨è¼¯</button>
                                <button onclick="delAdminPODoc('${d.id}')" class="text-xs bg-white border border-red-200 text-red-600 px-3 py-2 rounded-lg font-bold shadow-sm active:scale-95 transition hover:bg-red-50">ğŸ—‘ï¸</button>
                            </div>
                        </div>`;
                    }).join('');
                }
            } catch(e) { elDocs.innerHTML = '<p class="text-center text-red-400 font-bold py-6">è³‡æ–™è®€å–ç•°å¸¸</p>'; }

            try {
                const reqs = await fetchSafeReqs();
                if(!reqs || reqs.length === 0) {
                    elDrafts.innerHTML = '<p class="text-center text-slate-400 font-bold py-4">ç„¡è«‹è³¼å–®ç´€éŒ„</p>';
                } else {
                    window.adminReqData = reqs;
                    elDrafts.innerHTML = reqs.map(r => {
                        let stBadge = r.status === 'å·²å®Œæˆ' ? '<span class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded border border-emerald-200 ml-2">å·²å®Œæˆ</span>' : (r.status === 'æ¡è³¼ä¸­' ? '<span class="text-[9px] bg-sky-100 text-sky-700 px-1.5 py-0.5 rounded border border-sky-200 ml-2">æ¡è³¼ä¸­</span>' : '<span class="text-[9px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded border border-amber-200 ml-2">å¾…è™•ç†</span>');
                        let safeReqItems = getSafeArray(r.items_json);
                        return `
                        <div class="bg-white p-3 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                            <div>
                                <span class="text-[10px] font-mono font-bold text-slate-400">${r.req_no}</span> ${stBadge}
                                <div class="text-xs font-black text-slate-700 mt-0.5">${r.employees?.full_name||'æœªçŸ¥'} è«‹è³¼äº† ${safeReqItems.length} é …åŸæ–™</div>
                            </div>
                            <div class="flex space-x-1.5">
                                <button onclick="downloadReqCSV('${r.id}')" class="text-[9px] bg-slate-800 hover:bg-slate-700 text-white px-2 py-1.5 rounded-lg shadow-sm font-bold transition">ğŸ“¥ CSV</button>
                                <button onclick="openAdminEditReq('${r.id}')" class="text-[9px] bg-sky-50 text-sky-700 px-2 py-1.5 rounded-lg font-bold border border-sky-200">âœï¸</button>
                                <button onclick="delAdminReq('${r.id}')" class="text-[9px] bg-red-50 text-red-600 px-2 py-1.5 rounded-lg font-bold border border-red-200">ğŸ—‘ï¸</button>
                            </div>
                        </div>`;
                    }).join('');
                }
            } catch(e) { elDrafts.innerHTML = '<p class="text-center text-red-400 font-bold py-4">è³‡æ–™è®€å–ç•°å¸¸</p>'; }
        }

        // ğŸŒŸ é˜²å½ˆç‰ˆåº«å­˜åˆ—è¡¨è¼‰å…¥
        async function loadAdminInventory() {
            try {
                document.getElementById('list-inv-mobile').innerHTML = 'è¼‰å…¥ä¸­...'; 
                document.getElementById('list-inv-desktop').innerHTML = '<tr><td colspan="5" class="text-center py-6 text-slate-400 font-bold">è¼‰å…¥ä¸­...</td></tr>';
                const { data: items } = await window._sb.from('items').select('*').order('created_at', {ascending: false});
                const { data: ledgers } = await window._sb.from('inventory_ledgers').select('item_id, change_qty');
                let stockMap = {}; if(ledgers) { ledgers.forEach(l => { if(!stockMap[l.item_id]) stockMap[l.item_id] = 0; stockMap[l.item_id] += l.change_qty; }); }
                window.adminInvData = (items || []).map(i => ({ ...i, current_stock: stockMap[i.id] || 0 }));
                renderAdminInventory();
            } catch (err) {
                console.error(err);
                document.getElementById('list-inv-mobile').innerHTML = '<p class="text-center text-red-500 py-4">è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«ç‹€æ…‹</p>';
            }
        }

        function renderAdminInventory() {
            let htmlM = '', htmlD = '';
            const cats = [...new Set(window.adminInvData.map(i => i.category || 'æœªåˆ†é¡'))];
            document.getElementById('admin-inv-cat-filter').innerHTML = '<option value="">å…¨éƒ¨åˆ†é¡</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');

            if(!window.adminInvData.length) { htmlM = '<p class="text-slate-400 py-4 text-center">ç„¡åº«å­˜è³‡æ–™</p>'; htmlD = '<tr><td colspan="5" class="text-center py-6 text-slate-400">ç„¡åº«å­˜è³‡æ–™</td></tr>'; }
            else {
                window.adminInvData.forEach(i => {
                    let safe = i.safe_stock_level || 0; let isLow = i.current_stock <= safe; let isWarn = !isLow && i.current_stock <= (safe * 1.5);
                    let badge = '<span class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold border border-emerald-200">æ¨™æº–</span>';
                    let borderClass = 'border-emerald-400 bg-emerald-50/10'; let textCol = 'text-slate-700';
                    if(isLow) { badge = '<span class="text-[9px] bg-red-500 text-white px-1.5 py-0.5 rounded font-black shadow-sm animate-pulse">âš ï¸ ä½æ°´ä½</span>'; borderClass = 'border-red-500 bg-red-50/30'; textCol = 'text-red-600'; } 
                    else if(isWarn) { badge = '<span class="text-[9px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-black border border-amber-300 shadow-sm">è­¦ç¤º</span>'; borderClass = 'border-amber-400 bg-amber-50/30'; textCol = 'text-amber-600'; }

                    htmlM += `<div class="glass-panel p-4 flex justify-between items-center inv-admin-item mb-3 border-2 ${borderClass}" data-search="${i.item_code} ${i.item_name}" data-cat="${i.category||'æœªåˆ†é¡'}"><div class="flex-1 pr-2"><div class="mb-1.5"><span class="text-[10px] text-indigo-600 bg-white border border-indigo-100 px-1.5 rounded font-mono shadow-sm tracking-wider">${i.item_code}</span><span class="text-[9px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded ml-1">${i.category || 'æœªåˆ†é¡'}</span></div><h4 class="font-black text-sm text-slate-800 mt-1">${i.item_name} ${badge}</h4><p class="text-[10px] text-slate-500 mt-0.5">è¦æ ¼: ${i.specification||'ç„¡'} <span class="mx-1 text-slate-300">|</span> ç”Ÿç”¢é€±æœŸ: ${i.lead_time_days}å¤©</p></div><div class="text-right pl-3 border-l border-slate-200"><div class="text-2xl font-black ${textCol} tracking-tight">${i.current_stock}</div><button onclick="openEditItem('${i.id}')" class="text-[10px] bg-slate-800 text-white shadow-sm active:scale-95 transition px-3 py-1.5 rounded-lg mt-1 font-bold">ä¿®æ”¹</button></div></div>`;
                    htmlD += `<tr class="hover:bg-slate-50 inv-admin-item border-l-4 ${borderClass.split(' ')[0]}" data-search="${i.item_code} ${i.item_name}" data-cat="${i.category||'æœªåˆ†é¡'}"><td class="px-6 py-4"><div class="mb-1"><span class="text-[10px] text-indigo-600 font-mono bg-white shadow-sm border border-indigo-100 px-1.5 py-0.5 rounded mr-1">${i.item_code}</span></div><span class="font-black text-slate-800">${i.item_name}</span></td><td class="px-6 py-4 text-right"><div class="flex flex-col items-end">${badge}<span class="font-black ${textCol} text-xl mt-1 tracking-tight">${i.current_stock}</span></div></td><td class="px-6 py-4 text-right text-slate-500 font-bold">${safe}</td><td class="px-6 py-4 text-center text-slate-500 font-bold">${i.lead_time_days}</td><td class="px-6 py-4 text-center"><button onclick="openEditItem('${i.id}')" class="bg-slate-800 text-white text-xs font-bold px-4 py-2 rounded-xl transition shadow-sm active:scale-95">ä¿®æ”¹</button></td></tr>`;
                });
            }
            document.getElementById('list-inv-mobile').innerHTML = htmlM; document.getElementById('list-inv-desktop').innerHTML = htmlD;
        }

        function filterAdminInventory() {
            const kw = document.getElementById('admin-inv-search').value.toLowerCase();
            const cat = document.getElementById('admin-inv-cat-filter').value;
            document.querySelectorAll('.inv-admin-item').forEach(el => { 
                const text = el.getAttribute('data-search').toLowerCase(); const elCat = el.getAttribute('data-cat');
                el.style.display = (text.includes(kw) && (cat === '' || elCat === cat)) ? '' : 'none'; 
            });
        }

        function openEditItem(id) {
            const i = window.adminInvData.find(x => x.id === id); if(!i) return;
            document.getElementById('edit-item-id').value = i.id; 
            document.getElementById('edit-item-name').value = i.item_name; 
            document.getElementById('edit-item-code').value = i.item_code; 
            document.getElementById('edit-item-type').value = i.item_type || 'æˆå“'; 
            document.getElementById('edit-item-spec').value = i.specification || ''; 
            document.getElementById('edit-item-qty').value = i.qty_per_pack || 1; 
            document.getElementById('edit-item-safe').value = i.safe_stock_level || 0; 
            document.getElementById('edit-item-lead').value = i.lead_time_days || 15;
            document.getElementById('edit-item-cycle').value = i.stocktake_cycle || 30;
            const catSelect = document.getElementById('edit-item-cat');
            if (Array.from(catSelect.options).some(opt => opt.value === i.category)) { catSelect.value = i.category; } else { catSelect.value = 'æœªåˆ†é¡'; }
            
            let rawItems = window.adminInvData.filter(x => x.item_type === 'åŸæ–™');
            let bomHtml = '';
            // å¼·åˆ¶å®‰å…¨è§£æ
            let safeBom = getSafeArray(i.bom_data);
            
            for(let j=0; j<6; j++) {
                let r = safeBom[j] || { material: '', usage: '', unit: 'ç±³å¹³æ–¹', total_qty: '' };
                let opts = '<option value="">(ç„¡)</option>' + rawItems.map(rm => `<option value="${rm.item_name}" ${r.material===rm.item_name?'selected':''}>[${rm.item_code}] ${rm.item_name}</option>`).join('');
                if(r.material && !rawItems.some(rm => rm.item_name === r.material)) opts += `<option value="${r.material}" selected>${r.material} (èˆŠè³‡æ–™)</option>`;
                
                bomHtml += `<tr><td class="p-1"><select class="w-32 p-2 bg-slate-50 border border-slate-200 rounded-lg text-[10px] bom-mat select-arrow font-bold text-slate-700 outline-none focus:border-sky-500">${opts}</select></td><td class="p-1"><input type="number" step="any" class="w-16 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs text-center font-black text-sky-700 bom-qty outline-none focus:border-sky-500" value="${r.usage}" oninput="const u=parseFloat(this.value)||0;this.closest('tr').querySelector('.bom-total').value=u>0?(u*1.1).toFixed(2):'';"></td><td class="p-1"><select class="w-16 p-2 bg-white border border-slate-200 rounded-lg text-xs select-arrow bom-unit outline-none focus:border-sky-500"><option value="ç±³å¹³æ–¹" ${r.unit==='ç±³å¹³æ–¹'?'selected':''}>ç±³å¹³æ–¹</option><option value="ç±³" ${r.unit==='ç±³'?'selected':''}>ç±³</option><option value="å€‹" ${r.unit==='å€‹'?'selected':''}>å€‹</option><option value="è¢‹" ${r.unit==='è¢‹'?'selected':''}>è¢‹</option><option value="æ¢" ${r.unit==='æ¢'?'selected':''}>æ¢</option></select></td><td class="p-1"><input type="number" class="w-16 p-2 bg-slate-100 border border-transparent rounded-lg text-xs text-center font-black text-sky-900 bom-total shadow-inner" value="${r.total_qty}" readonly></td></tr>`;
            }
            document.getElementById('admin-bom-table-body').innerHTML = bomHtml;
            openModal('item-edit-modal');
        }

        async function saveAdminItem() {
            const id = document.getElementById('edit-item-id').value;
            let bomData = [];
            document.querySelectorAll('#admin-bom-table-body tr').forEach(tr => {
                const mat = tr.querySelector('.bom-mat').value;
                if(mat) bomData.push({ material: mat, usage: parseFloat(tr.querySelector('.bom-qty').value)||0, unit: tr.querySelector('.bom-unit').value, total_qty: parseFloat(tr.querySelector('.bom-total').value)||0 });
            });
            const p = { item_name: document.getElementById('edit-item-name').value, item_code: document.getElementById('edit-item-code').value.toUpperCase(), item_type: document.getElementById('edit-item-type').value, specification: document.getElementById('edit-item-spec').value, qty_per_pack: parseInt(document.getElementById('edit-item-qty').value) || 1, category: document.getElementById('edit-item-cat').value, safe_stock_level: parseInt(document.getElementById('edit-item-safe').value) || 0, lead_time_days: parseInt(document.getElementById('edit-item-lead').value) || 15, stocktake_cycle: parseInt(document.getElementById('edit-item-cycle').value) || 30, bom_data: bomData };
            const { error } = await window._sb.from('items').update(p).eq('id', id);
            if(error) alert('ä¿®æ”¹å¤±æ•—'); else { alert('âœ… æ›´æ–°æˆåŠŸï¼'); closeModal('item-edit-modal'); loadAdminInventory(); }
        }

        async function deleteAdminItem() {
            const id = document.getElementById('edit-item-id').value;
            if(!confirm('âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤é€™å€‹æ–™è™Ÿå—ï¼Ÿ')) return;
            const { error } = await window._sb.from('items').delete().eq('id', id);
            if(error) alert('åˆªé™¤å¤±æ•—: ' + error.message); else { alert('âœ… æˆåŠŸåˆªé™¤ï¼'); closeModal('item-edit-modal'); loadAdminInventory(); }
        }

        function openAdminEditPO(id) {
            const p = window.adminPoData.find(x => x.id === id); if(!p) return;
            document.getElementById('admin-po-edit-id').value = p.id;
            document.getElementById('admin-po-edit-status').value = p.status;
            document.getElementById('admin-po-edit-reason').value = p.exception_reason || '';
            togglePoException();
            openModal('admin-edit-po-modal');
        }

        function togglePoException() {
            const st = document.getElementById('admin-po-edit-status').value;
            const box = document.getElementById('admin-po-exception-box');
            if(st.includes('ç•°å¸¸')) box.classList.remove('hidden');
            else { box.classList.add('hidden'); document.getElementById('admin-po-edit-reason').value = ''; }
        }

        async function saveAdminPOEdit() {
            const id = document.getElementById('admin-po-edit-id').value;
            const st = document.getElementById('admin-po-edit-status').value;
            const res = document.getElementById('admin-po-edit-reason').value;
            if(st.includes('ç•°å¸¸') && !res) { alert('è«‹å¡«å¯«ç•°å¸¸èªªæ˜ï¼'); return; }
            const { error } = await window._sb.from('po_documents').update({ status: st, exception_reason: res }).eq('id', id);
            if(!error) { alert('âœ… æ›´æ–°æˆåŠŸ'); closeModal('admin-edit-po-modal'); loadAdminPurchase(); }
        }
        
        async function delAdminPODoc(id) { if(confirm('âš ï¸ ç¢ºå®šåˆªé™¤é€™ç­†æ­£å¼æ¡è³¼å–®å—ï¼Ÿ')){ await window._sb.from('po_documents').delete().eq('id',id); loadAdminPurchase(); } }

        function openAdminEditReq(id) {
            const r = window.adminReqData.find(x => x.id === id); if(!r) return;
            document.getElementById('admin-req-edit-id').value = r.id;
            document.getElementById('admin-req-edit-status').value = r.status;
            openModal('admin-edit-req-modal');
        }

        async function saveAdminReqEdit() {
            const id = document.getElementById('admin-req-edit-id').value;
            const st = document.getElementById('admin-req-edit-status').value;
            
            // é›™è»Œæ›´æ–°ï¼Œå› ç‚ºä¸çŸ¥é“é€™ç­†æ˜¯æ–°çš„é‚„æ˜¯èˆŠçš„
            try { await window._sb.from('requisitions').update({ status: st }).eq('id', id); } catch(e){}
            try { await window._sb.from('purchase_orders').update({ status: st }).eq('id', id); } catch(e){}

            alert('âœ… æ›´æ–°æˆåŠŸ'); closeModal('admin-edit-req-modal'); loadAdminPurchase(); 
        }

        async function delAdminReq(id) { 
            if(confirm('åˆªé™¤é€™ç­†è«‹è³¼å–®å—ï¼Ÿ')){ 
                try { await window._sb.from('requisitions').delete().eq('id',id); } catch(e){}
                try { await window._sb.from('purchase_orders').delete().eq('id',id); } catch(e){}
                loadAdminPurchase(); 
            } 
        }

        async function downloadReqCSV(id) {
            let reqData = null;
            try { const res = await window._sb.from('requisitions').select('*, employees(full_name)').eq('id', id).single(); reqData = res.data; } catch(e){}
            if(!reqData) {
                try { const res = await window._sb.from('purchase_orders').select('*, employees(full_name)').eq('id', id).single(); reqData = res.data; } catch(e){}
            }

            if(!reqData) { alert('ä¸‹è¼‰å¤±æ•—ï¼Œæ‰¾ä¸åˆ°è³‡æ–™'); return; }

            let reqNo = reqData.req_no || ('REQ-OLD-' + reqData.id.slice(0,4));
            let csv = "\uFEFFè«‹è³¼å–®è™Ÿ,ç”³è«‹æ—¥æœŸ,ç”³è«‹äºº,è«‹è³¼æˆå“/åŠæˆå“,ç”Ÿç”¢æ•¸é‡,å±•é–‹åŸæ–™åç¨±,éœ€æ±‚ç¸½é‡,å–®ä½\n";
            const dateStr = new Date(reqData.created_at).toLocaleDateString('zh-TW');
            
            let safeTarget = getSafeArray(reqData.target_items);
            let safeItems = getSafeArray(reqData.items_json || reqData.raw_materials);

            safeTarget.forEach(t => { csv += `="${reqNo}",${dateStr},${reqData.employees?.full_name||'æœªçŸ¥'},${t.name},${t.qty},,,, \n`; });
            safeItems.forEach(r => { csv += `="${reqNo}",${dateStr},${reqData.employees?.full_name||'æœªçŸ¥'},,,${r.name},${r.qty.toFixed(2)},${r.unit}\n`; });

            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); 
            link.download = `HYPASS_è«‹è³¼å–®_è£œå°_${reqNo}.csv`; 
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        async function downloadAdminPO_PDF(id) {
            const { data } = await window._sb.from('po_documents').select('*').eq('id', id).single();
            if(!data) return;

            const supInfo = window.supplierData.find(x => x.supplier_name === data.supplier_name) || {};
            const dateStr = new Date(data.created_at).toLocaleDateString('zh-TW');
            
            let safeItems = getSafeArray(data.items_json);

            let tableRows = safeItems.map((s, i) => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px; text-align: center;">${i+1}</td>
                    <td style="padding: 12px; font-weight: bold;">${s.name}</td>
                    <td style="padding: 12px; text-align: right; color: #d97706; font-weight: bold; font-size: 16px;">${parseFloat(s.qty).toFixed(2)}</td>
                    <td style="padding: 12px; text-align: center; font-size: 12px; color: #64748b;">${s.unit}</td>
                    <td style="padding: 12px; text-align: center; color: #ef4444; font-weight: bold;">${data.expected_date}</td>
                </tr>
            `).join('');

            const printHtml = `
                <div style="max-width: 800px; margin: 0 auto; padding: 40px; color: #1e293b; font-family: sans-serif;">
                    <div style="text-align: center; border-bottom: 4px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="font-size: 36px; font-weight: 900; margin: 0; letter-spacing: 2px;">HYPASS æ¡è³¼å–® (è£œå°)</h1>
                        <p style="font-size: 14px; color: #64748b; margin-top: 10px; font-weight: bold; letter-spacing: 1px;">PURCHASE ORDER</p>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; width: 45%;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #334155; border-bottom: 2px solid #cbd5e1; padding-bottom: 5px;">ä¾›æ‡‰å•†è³‡è¨Š</h3>
                            <p style="margin: 5px 0;"><strong>åç¨±ï¼š</strong>${data.supplier_name}</p>
                            <p style="margin: 5px 0;"><strong>çµ±ç·¨ï¼š</strong>${supInfo.tax_id||'--'}</p>
                            <p style="margin: 5px 0;"><strong>è¯çµ¡äººï¼š</strong>${supInfo.contact_name||'--'} / ${supInfo.contact_phone||'--'}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; width: 45%;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #334155; border-bottom: 2px solid #cbd5e1; padding-bottom: 5px;">å–®æ“šè³‡è¨Š</h3>
                            <p style="margin: 5px 0;"><strong>å–®è™Ÿï¼š</strong><span style="font-family: monospace; font-weight: bold;">${data.po_no}</span></p>
                            <p style="margin: 5px 0;"><strong>å»ºæª”æ—¥ï¼š</strong>${dateStr}</p>
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 30px;">
                        <thead style="background: #1e293b; color: white;"><tr><th style="padding: 12px; text-align: center; width: 50px;">é …æ¬¡</th><th style="padding: 12px; text-align: left;">æ¡è³¼å“å/è¦æ ¼</th><th style="padding: 12px; text-align: right;">æ•¸é‡</th><th style="padding: 12px; text-align: center;">å–®ä½</th><th style="padding: 12px; text-align: center;">æŒ‡å®šåˆ°è²¨æ—¥</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    <div style="background: #fffbeb; border: 1px solid #fde68a; padding: 15px; border-radius: 8px; font-size: 12px; color: #92400e; margin-bottom: 40px;"><strong>å‚™è¨»èªªæ˜ï¼š</strong><br>1. ç…©è«‹æ–¼æŒ‡å®šåˆ°è²¨æ—¥å‰å®Œæˆäº¤è²¨ï¼Œè‹¥æœ‰å»¶é²è«‹æå‰å‘ŠçŸ¥ã€‚<br>2. è«‹æ–¼å‡ºè²¨å–®/ç™¼ç¥¨ä¸Šè¨»æ˜æœ¬æ¡è³¼å–®è™Ÿï¼š${data.po_no}ã€‚<br>3. ç´„å®šä»˜æ¬¾æ–¹å¼ï¼š${supInfo.payment_method||'ä¾åŸåˆç´„'}ã€‚</div>
                    <div style="display: flex; justify-content: space-between; border-top: 2px solid #1e293b; padding-top: 20px;"><div style="text-align: center; width: 200px;"><p style="margin-bottom: 40px; color: #64748b;">æ¡è³¼ä¸»ç®¡ç°½æ ¸</p><div style="border-bottom: 1px solid #94a3b8;"></div></div><div style="text-align: center; width: 200px;"><p style="margin-bottom: 40px; color: #64748b;">ä¾›æ‡‰å•†ç¢ºèªç°½å›</p><div style="border-bottom: 1px solid #94a3b8;"></div></div></div>
                </div>
            `;
            document.getElementById('admin-print-zone').innerHTML = printHtml;
            setTimeout(() => { window.print(); }, 150);
        }

        async function handleYebToggle() { const isChecked = document.getElementById('toggle-yeb').checked; const yebSec = document.getElementById('yeb-section'); if(isChecked) { yebSec.classList.remove('hidden'); await updateAttendanceRate(); } else { yebSec.classList.add('hidden'); document.getElementById('p-yeb').value = ''; document.getElementById('p-ulp').value = ''; calcPayroll(); } }
        async function updateAttendanceRate() { const empId = document.getElementById('p-emp').value; const month = document.getElementById('p-mon').value; if(!empId || !month) return; const currentYear = parseInt(month.split('-')[0]); const prevYear = currentYear - 1; const absolutePenalty = window.empData[empId]?.penalty_points || 0; try { const { data: mData } = await window._sb.rpc('fn_get_payroll_calc', { p_emp_id: empId, p_month: month }); if(mData) { document.getElementById('sd-sick').innerText = mData.sick_hrs || 0; document.getElementById('sd-per').innerText = mData.personal_hrs || 0; document.getElementById('sd-typ').innerText = mData.typhoon_hrs || 0; document.getElementById('sd-lat').innerText = mData.late_count || 0; document.getElementById('sd-ovt').innerText = mData.overtime_hrs || 0; document.getElementById('sd-pnt').innerText = absolutePenalty; document.getElementById('p-lvd').value = mData.leave_deduct || 0; } const { data: currYData } = await window._sb.rpc('fn_get_year_end_stats', { p_emp_id: empId, p_year: currentYear.toString() }); const { data: prevYData } = await window._sb.rpc('fn_get_year_end_stats', { p_emp_id: empId, p_year: prevYear.toString() }); const { data: lvCurr } = await window._sb.rpc('fn_get_annual_leave_by_year', { p_emp_id: empId, p_year: currentYear }); const { data: lvPrev } = await window._sb.rpc('fn_get_annual_leave_by_year', { p_emp_id: empId, p_year: prevYear }); let remainHrsCurr = lvCurr ? (lvCurr.remain_hours || 0) : 0; let remainHrsPrev = lvPrev ? (lvPrev.remain_hours || 0) : 0; if(currYData) { document.getElementById('sy-curr-ann').innerText = remainHrsCurr; document.getElementById('sy-curr-per').innerText = currYData.personal || 0; document.getElementById('sy-curr-sic').innerText = currYData.sick || 0; document.getElementById('sy-curr-lat').innerText = currYData.late || 0; document.getElementById('sy-curr-ovt').innerText = currYData.overtime || 0; document.getElementById('sy-curr-pnt').innerText = absolutePenalty; } if(prevYData) { document.getElementById('sy-prev-ann').innerText = remainHrsPrev; document.getElementById('sy-prev-per').innerText = prevYData.personal || 0; document.getElementById('sy-prev-sic').innerText = prevYData.sick || 0; document.getElementById('sy-prev-lat').innerText = prevYData.late || 0; document.getElementById('sy-prev-ovt').innerText = prevYData.overtime || 0; document.getElementById('sy-prev-pnt').innerText = 0; } document.getElementById('lbl-yeb').innerText = `é è¨­å¹´çµ‚ (${prevYear})`; document.getElementById('lbl-ulp-text').innerText = `ç‰¹ä¼‘çµç®— (é¤˜${remainHrsPrev}h)`; if(document.getElementById('toggle-yeb').checked) { const base = window.empData[empId]?.base || 0; const hrRate = base / 240; document.getElementById('p-ulp').value = Math.round(remainHrsPrev * hrRate); } calcNet(); } catch (err) {} }
        async function onEmpChange() { const empId = document.getElementById('p-emp').value; if(!empId) return; document.getElementById('p-base').value = window.empData[empId].base; await updateAttendanceRate(); }
        function calcPayroll() { const empId = document.getElementById('p-emp').value; const emp = window.empData[empId]; if(!emp) return; const base = parseFloat(document.getElementById('p-base').value) || 0; const bonus = parseFloat(document.getElementById('p-bonus').value) || 0; const yeb = parseFloat(document.getElementById('p-yeb').value) || 0; document.getElementById('p-pen').value = Math.round(base * 0.06); document.getElementById('p-2nd').value = Math.round((bonus + yeb) * 0.0211); document.getElementById('p-ins').value = Math.round(base * 0.022) + Math.round(base * 0.0155 * (1 + emp.deps)); calcNet(); }
        function calcNet() { const base = parseFloat(document.getElementById('p-base').value) || 0; const bonus = parseFloat(document.getElementById('p-bonus').value) || 0; const yeb = parseFloat(document.getElementById('p-yeb').value) || 0; const ulp = parseFloat(document.getElementById('p-ulp').value) || 0; const ins = parseFloat(document.getElementById('p-ins').value) || 0; const sec = parseFloat(document.getElementById('p-2nd').value) || 0; const lvd = parseFloat(document.getElementById('p-lvd').value) || 0; const net = base + bonus + yeb + ulp - ins - sec -
