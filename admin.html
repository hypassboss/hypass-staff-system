<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPASS | ä¼æ¥­æŒ‡æ®ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>.tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s ease; } @keyframes fadeIn { from{opacity:0;} to{opacity:1;} } .no-scrollbar::-webkit-scrollbar { display: none; }</style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-20">
    <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg sticky top-0 z-50">
        <h1 class="text-xl font-black italic text-amber-400">HYPASS ADMIN</h1>
        <button onclick="location.reload()" id="logout" class="hidden text-xs bg-red-600 hover:bg-red-500 px-4 py-2 rounded font-bold transition">å®‰å…¨ç™»å‡º</button>
    </header>

    <div id="login-box" class="flex flex-col items-center justify-center py-24 px-4">
        <div class="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-black mb-6">ç³»çµ±è§£é–</h2>
            <input type="password" id="pin" placeholder="è€é—†å¯†ç¢¼" class="w-full border p-4 text-center text-2xl tracking-[0.5em] rounded-xl outline-none mb-6 bg-slate-50 focus:border-amber-400">
            <button onclick="login()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl active:scale-95 transition">é€²å…¥æ§åˆ¶å°</button>
        </div>
    </div>

    <main id="main-dash" class="container mx-auto p-4 max-w-2xl hidden">
        <div class="flex space-x-2 mb-6 bg-white p-2 rounded-2xl shadow-sm border overflow-x-auto no-scrollbar">
            <button onclick="st('pend')" id="t-pend" class="t-btn active px-4 py-3 text-sm font-black bg-slate-900 text-white rounded-xl whitespace-nowrap">å¯©æ ¸/è«‹å‡</button>
            <button onclick="st('pay')" id="t-pay" class="t-btn px-4 py-3 text-sm font-black text-slate-500 rounded-xl whitespace-nowrap">è–ªè³‡èˆ‡åŒ¯æ¬¾</button>
            <button onclick="st('offboard')" id="t-offboard" class="t-btn px-4 py-3 text-sm font-black text-slate-500 rounded-xl whitespace-nowrap">é›¢è·/è³‡é£</button>
            <button onclick="st('brs')" id="t-brs" class="t-btn px-4 py-3 text-sm font-black text-slate-500 rounded-xl whitespace-nowrap">åˆ†åº—æ“šé»</button>
            <button onclick="st('bull')" id="t-bull" class="t-btn px-4 py-3 text-sm font-black text-slate-500 rounded-xl whitespace-nowrap">å…¬å‘Š</button>
        </div>

        <section id="pend" class="tab-content active space-y-5">
            <h3 class="font-black border-l-4 border-blue-500 pl-3 text-lg">æ–°é€²å“¡å·¥å¯©æ ¸</h3>
            <div id="list-pend" class="space-y-3"></div>
            <h3 class="font-black border-l-4 border-amber-500 pl-3 text-lg">å“¡å·¥å‡å–®ç°½æ ¸</h3>
            <div id="list-leaves" class="space-y-3"></div>
        </section>

        <section id="pay" class="tab-content space-y-5">
            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 p-5 rounded-2xl shadow-sm border border-emerald-100">
                <h3 class="font-black text-emerald-900 mb-3 flex items-center"><span class="text-xl mr-2">ğŸ¦</span> ä¸€éµåŒ¯å‡ºéŠ€è¡Œè–ªè³‡è½‰å¸³æª” (CSV)</h3>
                <div class="flex space-x-2"><input type="month" id="export-mon" class="p-3 border rounded-xl font-bold flex-1 text-sm bg-white"><button onclick="exportBankCSV()" class="bg-emerald-600 text-white font-black px-4 py-3 rounded-xl shadow-md">ä¸‹è¼‰ CSV</button></div>
            </div>

            <h3 class="font-black border-l-4 border-indigo-500 pl-3 text-lg">ç™¼æ”¾ç•¶æœˆè–ªè³‡ (å«å¹´çµ‚æ•´åˆ)</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border space-y-3">
                <div class="grid grid-cols-2 gap-3 mb-2"><select id="p-emp" class="p-3 border rounded-xl text-sm font-bold bg-slate-50" onchange="autoFillLaw()"></select><input type="month" id="p-mon" class="p-3 border rounded-xl text-sm font-bold bg-slate-50"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">åº•è–ª (+)</label><input type="number" id="p-base" oninput="autoFillLaw()" class="w-full p-3 border rounded-xl text-sm font-bold"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">çé‡‘/æ´¥è²¼ (+)</label><input type="number" id="p-bonus" oninput="autoFillLaw()" class="w-full p-3 border rounded-xl text-sm font-bold text-emerald-600"></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-amber-600 ml-1">å¹´çµ‚çé‡‘ (+)</label><input type="number" id="p-yeb" oninput="autoFillLaw()" placeholder="ç„¡å‰‡å…å¡«" class="w-full p-3 border border-amber-200 rounded-xl text-sm font-bold text-amber-600 bg-amber-50"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">å‹å¥ä¿æ‰£é™¤é¡ (-)</label><input type="number" id="p-ins" oninput="calcNet()" class="w-full p-3 border rounded-xl text-sm font-bold text-red-600 bg-red-50"></div>
                    <div><label class="text-[10px] font-bold text-slate-500 ml-1">äºŒä»£å¥ä¿ (-)</label><input type="number" id="p-2nd" oninput="calcNet()" class="w-full p-3 border rounded-xl text-sm font-bold text-red-600 bg-red-50"></div>
                </div>
                <div class="flex justify-between items-center border-t pt-3 mt-2">
                    <div><button onclick="autoFillLaw()" class="text-xs bg-slate-800 text-white font-bold px-3 py-2 rounded-lg mb-1">é‡æ–°ç²¾ç®—</button><p class="text-[9px] text-slate-400">ç³»çµ±è‡ªå‹•ä¾çœ·å±¬äººæ•¸è¨ˆç®—</p></div>
                    <div class="text-right"><label class="text-[10px] font-black text-slate-500 block">ç¸½è¨ˆå¯¦é ˜</label><input type="number" id="p-net" class="w-32 border-none text-2xl font-black text-sky-600 text-right bg-transparent outline-none" readonly></div>
                </div>
                <input type="hidden" id="p-pen">
                <button onclick="issuePayroll()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl shadow-md mt-2">æ­£å¼ç™¼é€è–ªè³‡å–®</button>
            </div>
        </section>

        <section id="offboard" class="tab-content space-y-5">
            <h3 class="font-black border-l-4 border-red-500 pl-3 text-lg">å“¡å·¥é›¢è· / è³‡é£ç²¾å¯†çµç®—</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                <div class="bg-slate-100 p-3 rounded-xl text-[10px] text-slate-600 font-bold mb-4">ğŸ’¡ è‡ªå‹•è¨ˆç®—ï¼šç ´æœˆè–ªè³‡ã€å‰©é¤˜ç‰¹ä¼‘æ›ç¾ã€è³‡é£è²»ã€‚çµç®—å¾Œå¸³è™Ÿå°‡è‡ªå‹•åœæ¬Šã€‚</div>
                <div class="space-y-3">
                    <div><label class="text-[10px] font-bold text-slate-500">é¸æ“‡çµç®—å“¡å·¥</label><select id="off-emp" class="w-full p-3 border rounded-xl text-sm font-bold bg-slate-50"></select></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-500">çµç®—é¡åˆ¥</label><select id="off-type" class="w-full p-3 border rounded-xl text-sm font-bold"><option value="è‡ªé¡˜é›¢è·">è‡ªé¡˜é›¢è· (ç„¡è³‡é£è²»)</option><option value="éè‡ªé¡˜é›¢è·(è³‡é£)">éè‡ªé¡˜é›¢è· (å«è³‡é£è²»)</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-500">æœ€å¾Œå·¥ä½œæ—¥</label><input type="date" id="off-date" class="w-full p-3 border rounded-xl text-sm"></div>
                    </div>
                </div>
                <button onclick="calculateSettlement()" class="w-full bg-slate-800 text-white font-black py-3 rounded-xl active:scale-95 transition">âš™ï¸ ç³»çµ±è‡ªå‹•ç²¾ç®—æ˜ç´°</button>

                <div id="off-result" class="hidden mt-4 border-t pt-4 space-y-2 bg-red-50 p-4 rounded-xl border border-red-100">
                    <h4 class="font-black text-red-800 mb-3 text-center">çµç®—æ˜ç´° (é è¦½)</h4>
                    <div class="flex justify-between text-xs"><span class="font-bold text-slate-600">çµç®—åŸºæº–åº•è–ª</span><span id="off-res-base" class="font-black">NT$ 0</span></div>
                    <div class="flex justify-between text-xs"><span class="font-bold text-slate-600">1. ç ´æœˆè–ªè³‡ (ä¾æ¯”ä¾‹)</span><span id="off-res-pro" class="font-black text-emerald-600">+ NT$ 0</span></div>
                    <div class="flex justify-between text-xs"><span class="font-bold text-slate-600">2. æœªä¼‘ç‰¹ä¼‘æ›ç¾ (<span id="off-res-lvh">0</span> Hrs)</span><span id="off-res-lvp" class="font-black text-emerald-600">+ NT$ 0</span></div>
                    <div class="flex justify-between text-xs border-b border-red-200 pb-2"><span class="font-bold text-slate-600">3. å‹åŸºæ³•è³‡é£è²»</span><span id="off-res-sev" class="font-black text-amber-600">+ NT$ 0</span></div>
                    <div class="flex justify-between text-sm items-end pt-2"><span class="font-black text-red-900">ç™¼æ”¾ç¸½é¡ (Total)</span><span id="off-res-total" class="text-2xl font-black text-red-600">NT$ 0</span></div>
                    <button onclick="confirmOffboarding()" class="w-full bg-red-600 text-white font-black py-4 rounded-xl shadow-md mt-4">ç¢ºèªçµç®—ä¸¦åœæ¬Šå¸³è™Ÿ</button>
                </div>
            </div>
        </section>

        <section id="brs" class="tab-content space-y-4">
            <h3 class="font-black border-l-4 border-emerald-500 pl-3 text-lg">æ–°å¢åˆ†åº—æ“šé»</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border mb-4">
                <input type="text" id="b-n" placeholder="åˆ†åº—åç¨± (ä¾‹:å°å—ä¸­å±±åº—)" class="w-full p-3 border rounded-xl mb-3 text-sm font-bold">
                <input type="text" id="b-a" onblur="autoGeoCode()" placeholder="è²¼ä¸Š Google Maps ç¶²å€ï¼Œæˆ–è¼¸å…¥åœ°å€" class="w-full p-3 border rounded-xl mb-2 text-sm bg-sky-50 focus:bg-white transition">
                <div class="flex justify-between items-center mb-2 px-1"><p class="text-[9px] text-slate-400 font-bold">è¼¸å…¥å®Œé»æ“Šç©ºç™½è™•è‡ªå‹•è§£æ</p></div>
                <div class="grid grid-cols-2 gap-3 mb-4"><input type="number" step="any" id="b-la" placeholder="ç·¯åº¦ (Lat)" class="p-3 border rounded-xl bg-slate-50 text-sm font-bold text-slate-600"><input type="number" step="any" id="b-ln" placeholder="ç¶“åº¦ (Lng)" class="p-3 border rounded-xl bg-slate-50 text-sm font-bold text-slate-600"></div>
                <button onclick="addBr()" class="w-full bg-emerald-600 text-white font-black py-4 rounded-xl shadow-md">å„²å­˜æ“šé»</button>
            </div>
            <div id="list-brs" class="space-y-3"></div>
        </section>

        <section id="bull" class="tab-content space-y-4">
            <h3 class="font-black border-l-4 border-amber-500 pl-3 text-lg">ç™¼å¸ƒä¼æ¥­é›»å­å…¬å‘Š</h3>
            <div class="bg-white p-5 rounded-2xl shadow-sm border">
                <input type="text" id="blt-title" placeholder="å…¬å‘Šæ¨™é¡Œ" class="w-full p-3 border rounded-xl mb-3 text-sm font-bold">
                <textarea id="blt-content" placeholder="å…¬å‘Šè©³ç´°å…§å®¹..." class="w-full p-3 border rounded-xl mb-4 text-sm h-32 outline-none"></textarea>
                <button onclick="postBlt()" class="w-full bg-amber-500 text-white font-black py-4 rounded-xl shadow-md active:scale-95 transition">æ¨æ’­è‡³å“¡å·¥ App é¦–é </button>
            </div>
        </section>
    </main>

    <script>
        const _sb = supabase.createClient('https://obbcgmgkbazwpfvgbupg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'); // âš ï¸
        let globalOffboardData = null;
        window.empData = {}; 

        function login() { if(document.getElementById('pin').value==='888888'){ document.getElementById('login-box').style.display='none'; document.getElementById('main-dash').style.display='block'; loadAll(); } else alert('å¯†ç¢¼éŒ¯èª¤'); }
        function st(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.t-btn').forEach(e=>{e.classList.remove('bg-slate-900','text-white'); e.classList.add('text-slate-500');}); document.getElementById(id).classList.add('active'); document.getElementById('t-'+id).classList.add('bg-slate-900','text-white'); }
        
        async function loadAll() {
            const { data: emps } = await _sb.from('employees').select('*');
            const p = emps.filter(e => !e.is_approved && e.employment_status === 'åœ¨è·');
            document.getElementById('list-pend').innerHTML = p.length ? p.map(e => `<div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm"><h4 class="font-black text-sm">${e.full_name}</h4><button onclick="appr('${e.id}')" class="bg-blue-600 text-white text-xs font-black px-4 py-2 rounded-lg">æ ¸å‡†é–‹é€š</button></div>`).join('') : '<p class="text-xs text-slate-400 text-center py-3 bg-slate-50 rounded-xl">ç›®å‰ç„¡å¾…å¯©æ ¸åå–®</p>';
            
            const activeEmps = emps.filter(e => e.is_approved && e.employment_status === 'åœ¨è·');
            activeEmps.forEach(e => { window.empData[e.id] = { base: e.base_salary, deps: e.dependents_count || 0 }; }); 
            const empOptions = activeEmps.map(e => `<option value="${e.id}">${e.full_name}</option>`).join('');
            document.getElementById('p-emp').innerHTML = empOptions; document.getElementById('off-emp').innerHTML = empOptions;

            const { data: lv } = await _sb.from('leave_requests').select('*, employees(full_name)').eq('status', 'å¯©æ ¸ä¸­');
            document.getElementById('list-leaves').innerHTML = lv.length ? lv.map(l => {
                let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                return `<div class="bg-white p-4 rounded-xl border shadow-sm"><div class="flex justify-between mb-1"><span class="font-black text-sm">${l.employees?.full_name} - ${l.leave_type}</span><span class="text-[9px] text-sky-600 font-bold bg-sky-50 px-2 py-1 rounded">${l.salary_protection?'ä¿è–ªæŠµæ‰£':'ä¸ä¿è–ª'}</span></div><p class="text-[10px] text-slate-500 mb-3">${t1} ~ ${t2}</p><div class="flex space-x-2"><button onclick="updLeave('${l.id}', 'æ ¸å‡†')" class="flex-1 bg-emerald-100 hover:bg-emerald-200 text-emerald-800 py-3 rounded-xl text-sm font-black transition">æ ¸å‡†</button><button onclick="updLeave('${l.id}', 'æ ¸é§')" class="flex-1 bg-red-100 hover:bg-red-200 text-red-800 py-3 rounded-xl text-sm font-black transition">æ ¸é§</button></div></div>`
            }).join('') : '<p class="text-xs text-slate-400 text-center py-3 bg-slate-50 rounded-xl">æ‰€æœ‰å‡å–®å·²å¯©æ ¸å®Œç•¢</p>';

            const { data: br } = await _sb.from('branch_locations').select('*');
            document.getElementById('list-brs').innerHTML = br.map(b => `<div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm"><div><p class="font-black text-sm">${b.branch_name}</p><p class="text-[10px] text-slate-500 mt-1">${b.address}</p></div></div>`).join('');
            
            autoFillLaw();
        }

        async function autoGeoCode() {
            const input = document.getElementById('b-a').value; if(!input) return;
            document.getElementById('b-la').placeholder = 'è§£æä¸­...'; document.getElementById('b-ln').placeholder = 'è§£æä¸­...';
            
            const mapRegex = /@(-?\d+\.\d+),(-?\d+\.\d+)/; const match = input.match(mapRegex);
            if(match) { document.getElementById('b-la').value = match[1]; document.getElementById('b-ln').value = match[2]; alert('âœ… å·²å¾ç¶²å€æå–ç¶“ç·¯åº¦ï¼'); return; }

            try { 
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent("å°ç£" + input)}`, { headers: {'Accept-Language': 'zh-TW'} }); 
                const data = await res.json(); 
                if(data && data.length > 0) { document.getElementById('b-la').value = data[0].lat; document.getElementById('b-ln').value = data[0].lon; } 
                else { alert('âš ï¸ è‡ªå‹•å®šä½å¤±æ•—ï¼Œè«‹ç›´æ¥è²¼ä¸Š Google Maps ç¶²å€æˆ–æ‰‹å‹•è¼¸å…¥æ•¸å­—ï¼'); document.getElementById('b-la').placeholder = 'æ‰‹å‹•å¡«å¯«'; document.getElementById('b-ln').placeholder = 'æ‰‹å‹•å¡«å¯«'; } 
            } catch (e) { alert('å®šä½ç•°å¸¸'); }
        }

        async function exportBankCSV() {
            const month = document.getElementById('export-mon').value; if(!month) { alert('è«‹é¸æ“‡æœˆä»½'); return; }
            const { data } = await _sb.from('payroll_records').select('total_net_pay, employees(full_name, bank_name, bank_account)').eq('pay_month', month);
            if(!data || data.length === 0) { alert('ç„¡è–ªè³‡ç´€éŒ„'); return; }
            let csv = "\uFEFFéŠ€è¡Œåç¨±,æ”¶æ¬¾å¸³è™Ÿ,æˆ¶å,åŒ¯æ¬¾é‡‘é¡,å‚™è¨»\n";
            data.forEach(r => { csv += `${r.employees.bank_name},="${r.employees.bank_account}",${r.employees.full_name},${r.total_net_pay},${month}è–ªè³‡\n`; });
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `HYPASS_${month}_åŒ¯æ¬¾æª”.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function autoFillLaw() {
            const empId = document.getElementById('p-emp').value;
            const emp = window.empData[empId];
            if(!emp) return;

            if(!document.getElementById('p-base').value) { document.getElementById('p-base').value = emp.base; }

            const base = parseFloat(document.getElementById('p-base').value) || 0;
            const bonus = parseFloat(document.getElementById('p-bonus').value) || 0;
            const yeb = parseFloat(document.getElementById('p-yeb').value) || 0;
            
            document.getElementById('p-pen').value = Math.round(base * 0.06);
            document.getElementById('p-2nd').value = Math.round((bonus + yeb) * 0.0211);
            
            // å‹å¥ä¿è‡ªå‹•ä¼°ç®— (ç¯„ä¾‹å…¬å¼ï¼šå‹ä¿ç´„ 2.2% + å¥ä¿ç´„ 1.55% * (1+çœ·å±¬))
            const labor_est = Math.round(base * 0.022);
            const health_est = Math.round(base * 0.0155 * (1 + emp.deps));
            document.getElementById('p-ins').value = labor_est + health_est;

            calcNet();
        }

        function calcNet() { 
            const net = (parseFloat(document.getElementById('p-base').value)||0) + (parseFloat(document.getElementById('p-bonus').value)||0) + (parseFloat(document.getElementById('p-yeb').value)||0) - (parseFloat(document.getElementById('p-ins').value)||0) - (parseFloat(document.getElementById('p-2nd').value)||0); 
            document.getElementById('p-net').value = net > 0 ? net : 0; 
        }

        async function issuePayroll() { 
            const p = { employee_id: document.getElementById('p-emp').value, pay_month: document.getElementById('p-mon').value, base_pay: parseFloat(document.getElementById('p-base').value)||0, bonus: parseFloat(document.getElementById('p-bonus').value)||0, year_end_bonus: parseFloat(document.getElementById('p-yeb').value)||0, labor_pension: parseFloat(document.getElementById('p-pen').value)||0, insurance_deduction: parseFloat(document.getElementById('p-ins').value)||0, second_gen_health: parseFloat(document.getElementById('p-2nd').value)||0, total_net_pay: parseFloat(document.getElementById('p-net').value)||0 }; 
            if(!p.pay_month) { alert('è«‹é¸æ“‡æœˆä»½'); return; } 
            await _sb.from('payroll_records').insert([p]); alert('âœ… è–ªè³‡èˆ‡å¹´çµ‚å–®å·²åˆä½µç™¼é€ï¼'); document.querySelectorAll('#pay input[type="number"]').forEach(e => e.value = ''); 
        }

        async function calculateSettlement() {
            const empId = document.getElementById('off-emp').value; const lastDay = document.getElementById('off-date').value; const type = document.getElementById('off-type').value;
            if(!empId || !lastDay) { alert('è«‹å¡«å¯«å®Œæ•´'); return; }
            const { data: emp } = await _sb.from('employees').select('full_name, base_salary, onboarding_date').eq('id', empId).single();
            const { data: lv } = await _sb.rpc('fn_get_annual_leave', { p_onboard_date: emp.onboarding_date });
            const proRat = new Date(lastDay).getDate() / 30.0; const proSal = Math.round((proRat > 1 ? 1 : proRat) * emp.base_salary);
            const uHrs = lv?.hours || 0; const lPay = Math.round(uHrs * (emp.base_salary / 240));
            let sev = 0; if(type === 'éè‡ªé¡˜é›¢è·(è³‡é£)') { const ty = (new Date(lastDay).getTime() - new Date(emp.onboarding_date).getTime()) / 31557600000; sev = Math.round(Math.max(0, ty) * 0.5 * emp.base_salary); }
            const tot = proSal + lPay + sev;
            document.getElementById('off-res-base').innerText = `NT$ ${emp.base_salary.toLocaleString()}`; document.getElementById('off-res-pro').innerText = `+ NT$ ${proSal.toLocaleString()}`; document.getElementById('off-res-lvh').innerText = uHrs; document.getElementById('off-res-lvp').innerText = `+ NT$ ${lPay.toLocaleString()}`; document.getElementById('off-res-sev').innerText = `+ NT$ ${sev.toLocaleString()}`; document.getElementById('off-res-total').innerText = `NT$ ${tot.toLocaleString()}`; document.getElementById('off-result').classList.remove('hidden');
            globalOffboardData = { employee_id: empId, settlement_type: type, last_working_day: lastDay, base_salary_ref: emp.base_salary, prorated_salary: proSal, unused_leave_hours: uHrs, unused_leave_pay: lPay, severance_pay: sev, total_settlement: tot };
        }

        async function confirmOffboarding() {
            if(!globalOffboardData || !confirm('ç¢ºå®šçµç®—ä¸¦åœç”¨å¸³è™Ÿï¼Ÿ')) return;
            await _sb.from('settlement_records').insert([globalOffboardData]);
            await _sb.from('employees').update({ employment_status: 'é›¢è·', is_approved: false, resignation_date: globalOffboardData.last_working_day }).eq('id', globalOffboardData.employee_id);
            alert('âœ… çµç®—å®Œæˆï¼Œå¸³è™Ÿå·²åœæ¬Šã€‚'); document.getElementById('off-result').classList.add('hidden'); loadAll();
        }

        async function appr(id) { await _sb.from('employees').update({is_approved:true}).eq('id',id); loadAll(); alert('âœ… å·²é–‹é€š'); }
        async function updLeave(id, st) { await _sb.from('leave_requests').update({status:st}).eq('id',id); loadAll(); alert('âœ… å‡å–®å·²' + st); }
        async function addBr() { const n = document.getElementById('b-n').value; const a = document.getElementById('b-a').value; const la = document.getElementById('b-la').value; const ln = document.getElementById('b-ln').value; if(!n||!a||!la||!ln){ alert('è«‹å¡«å¦¥'); return;} await _sb.from('branch_locations').insert([{ branch_name: n, address: a, lat: parseFloat(la), lng: parseFloat(ln) }]); loadAll(); alert('âœ… æ–°å¢æˆåŠŸ'); }
        async function postBlt() { await _sb.from('bulletin_board').insert([{ title: document.getElementById('blt-title').value, content: document.getElementById('blt-content').value }]); alert('âœ… å…¬å‘Šç™¼å¸ƒæˆåŠŸ'); document.getElementById('blt-title').value=''; document.getElementById('blt-content').value=''; }
    </script>
</body>
</html>
