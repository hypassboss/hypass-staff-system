<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | ä¼æ¥­å“¡å·¥å°ˆå€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>body{background:linear-gradient(135deg,#f8fafc 0%,#e0f2fe 100%);-webkit-tap-highlight-color:transparent}.app-view{display:none}.app-view.active{display:block;animation:fadeIn .2s ease-in-out}.glass-card{background:rgba(255,255,255,.95);box-shadow:0 4px 20px rgba(0,0,0,.05);border:1px solid rgba(255,255,255,.6)}.nav-item.active{color:#0284c7;transform:translateY(-2px);font-weight:900}@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}.modal{display:none}.modal.active{display:flex;z-index:100}.no-scrollbar::-webkit-scrollbar{display:none}</style>
</head>
<body class="text-slate-800 font-sans min-h-screen pb-20">
    <header class="bg-slate-900 text-white px-5 py-3 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div><h1 class="text-xl font-black italic uppercase tracking-wider">Hypass</h1><span class="text-[9px] text-sky-400 tracking-widest">ENTERPRISE</span></div><div id="user-status" class="text-[10px] font-bold bg-white/10 px-3 py-1.5 rounded-full border border-white/20">é€£ç·šä¸­...</div>
    </header>
    <main class="container mx-auto p-4 max-w-md">
        <div id="sys-loading" class="text-center py-32 active-view"><div class="animate-spin h-8 w-8 border-4 border-sky-600 border-t-transparent rounded-full mx-auto mb-3"></div><p class="text-xs text-slate-500 font-bold">è³‡æ–™åŒæ­¥ä¸­...</p></div>
        <div id="sys-pending" class="text-center py-24 hidden"><div class="text-5xl mb-4 grayscale">â³</div><h2 class="text-xl font-black">å¸³è™Ÿå¯©æ ¸ä¸­</h2><p class="text-xs text-slate-500 mt-2">è€é—†æ­£åœ¨LINEä¸Šé€²è¡Œæ ¸å‡†ï¼Œè«‹ç¨å€™</p></div>

        <div id="view-onboarding" class="hidden glass-card p-5 rounded-2xl shadow-xl">
            <h2 class="text-lg font-black mb-4 text-center">æ–°é€²å“¡å·¥å»ºæª”</h2>
            <form id="onboarding-form" class="space-y-3">
                <input type="text" name="full_name" placeholder="çœŸå¯¦å§“å" required class="w-full p-2.5 bg-slate-50 rounded-xl text-sm border outline-none">
                <input type="text" name="id_number" placeholder="èº«åˆ†è­‰å­—è™Ÿ" required class="w-full p-2.5 bg-slate-50 rounded-xl text-sm border outline-none">
                <div class="grid grid-cols-2 gap-2"><input type="email" name="email" placeholder="é›»éƒµ" required class="p-2.5 bg-slate-50 rounded-xl text-xs border"><input type="tel" name="phone" placeholder="æ‰‹æ©Ÿ" required class="p-2.5 bg-slate-50 rounded-xl text-xs border"></div>
                <input type="text" name="address" placeholder="é€šè¨Šåœ°å€ (æ³•å¾‹é€é”åœ°)" required class="w-full p-2.5 bg-slate-50 rounded-xl text-sm border outline-none">
                <div class="grid grid-cols-2 gap-2"><div><label class="text-[9px] font-bold text-slate-500 ml-1">å…¥è·æ—¥æœŸ</label><input type="date" name="onboarding_date" required class="w-full p-2.5 bg-slate-50 rounded-xl text-xs border"></div><div><label class="text-[9px] font-bold text-slate-500 ml-1">é è¨­æ“šé»</label><select id="reg-branch" class="w-full p-2.5 bg-slate-50 rounded-xl text-xs border"></select></div></div>
                <div class="p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                    <h3 class="text-[10px] font-black text-emerald-800 mb-2">è²¡å‹™èˆ‡çœ·å±¬è³‡æ–™</h3>
                    <div class="grid grid-cols-2 gap-2 mb-3"><input type="text" name="bank_name" placeholder="éŠ€è¡Œåç¨±" required class="p-2 text-xs border rounded-lg bg-white"><input type="text" name="bank_code" placeholder="ä»£ç¢¼(ä¾‹:808)" required class="p-2 text-xs border rounded-lg bg-white"><input type="text" name="bank_user_name" placeholder="æˆ¶å" required class="p-2 text-xs border rounded-lg bg-white"><input type="text" name="bank_account" placeholder="éŠ€è¡Œå¸³è™Ÿ" required class="p-2 text-xs border rounded-lg bg-white"></div>
                    <div class="flex justify-between items-center border-t border-emerald-100 pt-2"><span class="text-[9px] font-bold text-emerald-900">å¥ä¿çœ·å±¬åŠ ä¿äººæ•¸</span><input type="number" name="dependents_count" value="0" min="0" required class="w-16 p-1 text-center text-xs border rounded bg-white"></div>
                </div>
                <div class="grid grid-cols-2 gap-2"><input type="text" name="emergency_name" placeholder="ç·Šæ€¥è¯çµ¡äºº" required class="p-2.5 bg-slate-50 border rounded-xl text-xs"><input type="tel" name="emergency_phone" placeholder="é›»è©±" required class="p-2.5 bg-slate-50 border rounded-xl text-xs"></div>
                <div class="bg-slate-900 text-white p-4 rounded-xl mt-3"><h3 class="text-[10px] font-black text-amber-400 mb-2 border-b border-white/20 pb-1">âš–ï¸ è˜åƒ±åˆç´„ç°½ç½²</h3><label class="flex items-start space-x-2 text-[9px] mb-2"><input type="checkbox" id="chk1" onchange="checkForm()"><span>ã€GPSã€‘åŒæ„å®šä½ç‚ºå‡ºå‹¤å”¯ä¸€ä¾æ“šã€‚</span></label><label class="flex items-start space-x-2 text-[9px] mb-2"><input type="checkbox" id="chk2" onchange="checkForm()"><span>ã€å®ˆå‰‡ã€‘åŒæ„ç‰¹ä¼‘å„ªå…ˆæŠµæ‰£é²åˆ°ä»¥ç¶­æŒå…¨è–ªã€‚</span></label><label class="flex items-start space-x-2 text-[9px]"><input type="checkbox" id="chk3" onchange="checkForm()"><span>ã€ä¿å¯†ã€‘åŒæ„åš´å®ˆæ©Ÿå¯†ï¼Œé•é¡˜è³ å„Ÿã€‚</span></label></div>
                <button type="submit" id="btn-submit" disabled class="w-full bg-sky-600 disabled:bg-slate-300 text-white font-black py-3 rounded-xl mt-2 transition">æ•¸ä½ç°½ç½²ä¸¦é€å‡º</button>
            </form>
        </div>

        <div id="view-dashboard" class="hidden space-y-4">
            <div id="tab-home" class="app-view active space-y-3">
                <div class="bg-amber-50 border border-amber-200 p-3 rounded-xl flex flex-col shadow-sm"><div class="flex items-center space-x-1.5 mb-2 border-b border-amber-200/50 pb-1"><span class="text-sm">ğŸ“¢</span><h4 class="text-[10px] font-black text-amber-900 tracking-widest">å…¬å¸å…¬å‘Š (1å¹´å…§)</h4></div><div id="ui-bulletin" class="pl-2 pr-1 max-h-32 overflow-y-auto no-scrollbar space-y-2">è¼‰å…¥ä¸­...</div></div>
                <div class="bg-slate-900 p-6 rounded-2xl text-white shadow-xl relative overflow-hidden"><h3 id="ui-name" class="text-2xl font-black mb-1">--</h3><p id="ui-tenure" class="text-[10px] text-sky-300 font-bold mb-3 tracking-wider">ğŸ•’ å…¥è·æ—¥è¼‰å…¥ä¸­</p><div class="flex justify-between items-center bg-white/10 p-3 rounded-xl border border-white/10"><span class="text-[10px] font-black text-slate-300">æ³•å®šç‰¹ä¼‘é¤˜é¡</span><span id="ui-leave" class="text-xl font-black">-- å¤© -- å°æ™‚</span></div></div>
                
                <div class="glass-card p-4 rounded-2xl shadow-sm">
                    <button onclick="loadPunchHistory()" class="w-full mb-3 text-xs font-bold text-sky-700 bg-sky-50 py-2.5 rounded-xl border border-sky-100 flex justify-center items-center space-x-1 active:scale-95 transition"><span>ğŸ”</span><span>æŸ¥è©¢æ‰“å¡ç´€éŒ„</span></button>
                    <select id="punch-branch" class="w-full mb-3 text-sm font-bold bg-white text-slate-700 border border-slate-200 rounded-xl p-2.5 outline-none text-center"></select>
                    <div class="grid grid-cols-2 gap-3"><button onclick="punch('IN')" class="bg-sky-600 text-white py-8 rounded-xl font-black text-lg shadow-md active:scale-95 flex flex-col items-center transition"><span class="text-2xl mb-1">ğŸ¢</span>ä¸Šç­</button><button onclick="punch('OUT')" class="bg-white text-slate-700 border border-slate-200 py-8 rounded-xl font-black text-lg shadow-sm active:scale-95 flex flex-col items-center transition"><span class="text-2xl mb-1 grayscale">ğŸ </span>ä¸‹ç­</button></div>
                </div>
            </div>

            <div id="tab-leave" class="app-view space-y-3">
                <h3 class="font-black text-lg text-slate-900 border-l-4 border-amber-500 pl-2">ç·šä¸Šè«‹å‡å–®</h3>
                <div class="glass-card p-5 rounded-2xl shadow-sm">
                    <form id="leave-form" onsubmit="submitLeave(event)" class="space-y-3 border-b border-slate-100 pb-5 mb-4">
                        <select name="leave_type" id="leave-type-select" onchange="checkLeaveType()" class="w-full bg-white border border-slate-200 p-2.5 rounded-xl text-sm font-bold">
                            <option value="ç‰¹ä¼‘">ğŸ–ï¸ ç‰¹ä¼‘</option><option value="äº‹å‡">ğŸ“„ äº‹å‡</option><option value="ç—…å‡">ğŸ’Š ç—…å‡</option><option value="å…¬å‡">ğŸ’¼ å…¬å‡</option>
                            <option value="é¢±é¢¨å‡">ğŸŒªï¸ é¢±é¢¨å‡</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2"><div><label class="text-[9px] font-bold text-slate-500 ml-1">èµ·å§‹</label><input type="datetime-local" name="start_time" required class="w-full bg-white border border-slate-200 p-2.5 rounded-xl text-xs"></div><div><label class="text-[9px] font-bold text-slate-500 ml-1">çµæŸ</label><input type="datetime-local" name="end_time" required class="w-full bg-white border border-slate-200 p-2.5 rounded-xl text-xs"></div></div>
                        
                        <div id="salary-protection-ui" class="flex items-center justify-between p-2.5 bg-sky-50 rounded-xl border border-sky-100 transition-all">
                            <div id="sp-text"><p class="text-[10px] font-black text-sky-900">è–ªè³‡ä¿å…¨</p><p class="text-[9px] text-sky-600">åŒæ„å„ªå…ˆæ‰£ç‰¹ä¼‘ä»¥ç¶­æŒå…¨è–ª</p></div>
                            <label class="relative inline-flex items-center cursor-pointer" id="sp-toggle"><input type="checkbox" name="salary_protection" checked class="sr-only peer"><div class="w-9 h-5 bg-slate-300 rounded-full peer peer-checked:bg-sky-600 peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"></div></label>
                        </div>
                        
                        <button type="submit" id="btn-leave" class="w-full bg-amber-500 text-white font-black py-3 rounded-xl shadow-md active:scale-95 transition">é€å‡ºå‡å–®</button>
                    </form>
                    <h4 class="text-[11px] font-black text-slate-700 mb-2">ğŸ“… ç”³è«‹ç´€éŒ„</h4><div id="ui-leave-list" class="space-y-2 max-h-40 overflow-y-auto no-scrollbar">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div id="tab-payroll" class="app-view space-y-3">
                <h3 class="font-black text-lg text-slate-900 border-l-4 border-emerald-500 pl-2">è–ªè³‡æ˜ç´°</h3>
                <div class="glass-card p-5 rounded-2xl space-y-3 shadow-sm">
                    <select id="payroll-month" onchange="loadPayrollDetail()" class="w-full bg-slate-50 text-slate-800 font-bold border border-slate-200 p-2.5 rounded-xl text-sm outline-none"></select>
                    <div class="bg-white border border-slate-100 rounded-xl p-4 space-y-3 mt-2 shadow-sm">
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-xs font-bold text-slate-500">åº•è–ª</span><span id="p-base" class="text-sm font-black text-slate-800">NT$ 0</span></div>
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-xs font-bold text-slate-500">çé‡‘</span><span id="p-bonus" class="text-sm font-black text-emerald-600">NT$ 0</span></div>
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-xs font-bold text-slate-500">å¹´çµ‚çé‡‘</span><span id="p-yeb" class="text-sm font-black text-emerald-600">NT$ 0</span></div>
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-xs font-bold text-slate-500">å‹å¥ä¿æ‰£é™¤</span><span id="p-ins" class="text-sm font-black text-red-500">- NT$ 0</span></div>
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-xs font-bold text-slate-500">äºŒä»£å¥ä¿</span><span id="p-2nd" class="text-sm font-black text-red-500">- NT$ 0</span></div>
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-[10px] font-bold text-slate-400">å‹é€€ææ’¥ (6%)</span><span id="p-pen" class="text-[10px] font-black text-slate-400">NT$ 0</span></div>
                        <div class="flex justify-between items-end pt-2"><span class="text-sm font-black text-slate-800">ç¸½è¨ˆå¯¦é ˜</span><span id="p-net" class="text-2xl font-black text-sky-600">NT$ 0</span></div>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="app-view space-y-3">
                <h3 class="font-black text-lg text-slate-900 border-l-4 border-slate-400 pl-2">åŸºæœ¬è³‡æ–™</h3>
                <div class="glass-card p-5 rounded-2xl shadow-sm space-y-4">
                    <div class="flex flex-col space-y-3 text-xs border-b border-slate-100 pb-4" id="ui-profile-info">è¼‰å…¥ä¸­...</div>
                    <div class="pt-1">
                        <h4 class="text-[9px] font-black tracking-widest text-slate-400 uppercase mb-2">æ•¸ä½åˆç´„å­˜è­‰ä¸­å¿ƒ</h4>
                        <button onclick="openDoc('contract')" class="w-full text-left bg-white p-3 rounded-xl border border-slate-200 font-bold text-xs mb-2 flex justify-between items-center shadow-sm active:scale-95"><span class="flex items-center"><span class="mr-2 text-base">ğŸ“„</span>è˜åƒ±åˆç´„èˆ‡å®ˆå‰‡</span><span class="text-slate-400">â”</span></button>
                        <button onclick="openDoc('nda')" class="w-full text-left bg-white p-3 rounded-xl border border-slate-200 font-bold text-xs flex justify-between items-center shadow-sm active:scale-95"><span class="flex items-center"><span class="mr-2 text-base">ğŸ”’</span>ä¿å¯†å”å®š (NDA)</span><span class="text-slate-400">â”</span></button>
                    </div>
                </div>
            </div>

            <nav class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-slate-100 flex justify-around items-center py-2 pb-6 z-50">
                <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center w-14 text-slate-400 transition"><span class="text-xl mb-0.5">ğŸ </span><span class="text-[9px] font-bold">æ‰“å¡</span></button>
                <button onclick="switchTab('leave')" class="nav-item flex flex-col items-center w-14 text-slate-400 transition"><span class="text-xl mb-0.5">ğŸ“…</span><span class="text-[9px] font-bold">è«‹å‡</span></button>
                <button onclick="switchTab('payroll')" class="nav-item flex flex-col items-center w-14 text-slate-400 transition"><span class="text-xl mb-0.5">ğŸ’°</span><span class="text-[9px] font-bold">è–ªè³‡</span></button>
                <button onclick="switchTab('profile')" class="nav-item flex flex-col items-center w-14 text-slate-400 transition"><span class="text-xl mb-0.5">ğŸ‘¤</span><span class="text-[9px] font-bold">è³‡æ–™</span></button>
            </nav>
        </div>
    </main>

    <div id="record-modal" class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm items-end justify-center"><div class="bg-white w-full max-w-md rounded-t-3xl p-5 h-[70vh] flex flex-col"><div class="flex justify-between items-center mb-3"><h3 class="font-black text-lg">è¿‘æœŸæ‰“å¡ç´€éŒ„</h3><button onclick="closeModal('record-modal')" class="bg-slate-100 px-3 py-1.5 rounded-full text-xs font-bold text-slate-600">âœ• é—œé–‰</button></div><div id="ui-records-list" class="overflow-y-auto space-y-2 flex-1 no-scrollbar pb-6">è¼‰å…¥ä¸­...</div></div></div>
    <div id="doc-modal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-md items-center justify-center p-4"><div class="bg-white w-full max-w-md rounded-2xl p-6 relative flex flex-col shadow-2xl"><h3 id="doc-title" class="font-black text-base border-b pb-2 mb-3">æ–‡ä»¶</h3><div class="text-xs text-slate-600 leading-relaxed space-y-2 mb-4"><p>1. å“¡å·¥çµ•å°æœå¾è€ƒå‹¤è¦å®šï¼Œå®šä½ç‚ºå”¯ä¸€ä¾æ“šã€‚</p><p>2. å“¡å·¥åŒæ„é²åˆ°æ™‚æ•¸ç”±ç³»çµ±è‡ªå‹•ä»¥ç‰¹ä¼‘æŠµæ‰£ã€‚</p><p>3. å“¡å·¥å°å…¬å¸æ©Ÿå¯†å…·çµ•å°ä¿å¯†ç¾©å‹™ï¼Œé•é¡˜è² æ“”æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</p></div><div class="bg-amber-50 border border-amber-100 p-3 rounded-xl text-center"><p class="text-[9px] text-amber-700 font-bold mb-1">âœ”ï¸ ç¶“æ•¸ä½ç°½ç« èªè­‰ï¼Œå…·å‚™æ³•å¾‹æ•ˆåŠ›</p><p id="doc-sig" class="font-black text-amber-900 text-[10px]">ç°½ç½²äººï¼š--</p></div><button onclick="closeModal('doc-modal')" class="w-full mt-4 bg-slate-900 text-white font-bold py-3 rounded-xl text-sm transition">å·²è©³é–±ä¸¦é—œé–‰</button></div></div>

    <script>
        const SUPABASE_URL = 'https://obbcgmgkbazwpfvgbupg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'; // âš ï¸
        const LIFF_ID = '2009148826-RoogHmxk'; 
        const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            document.getElementById('user-status').innerHTML = 'ğŸ‘¤ ' + profile.displayName;
            loadBranches('reg-branch'); checkUser(profile.userId);
        }

        async function checkUser(lineId) {
            const { data } = await _sb.from('employees').select('*').eq('line_id', lineId).single();
            document.getElementById('sys-loading').style.display = 'none';
            if (!data) document.getElementById('view-onboarding').style.display = 'block';
            else if (!data.is_approved || data.employment_status === 'é›¢è·') { 
                document.getElementById('sys-pending').style.display = 'block'; 
                if(data.employment_status === 'é›¢è·') document.querySelector('#sys-pending h2').innerText = 'å¸³è™Ÿå·²åœæ¬Š';
            }
            else { 
                currentUser = data; 
                await loadBranches('punch-branch'); 
                // ğŸŒŸ å¼·åˆ¶ç¶å®šè©²å“¡å·¥çš„é è¨­æ‰“å¡æ“šé»
                if(currentUser.default_branch_id) {
                    document.getElementById('punch-branch').value = currentUser.default_branch_id;
                }
                renderUI(); document.getElementById('view-dashboard').style.display = 'block'; 
            }
        }

        async function loadBranches(targetId) {
            const { data } = await _sb.from('branch_locations').select('id, branch_name').eq('is_active', true);
            const sel = document.getElementById(targetId);
            sel.innerHTML = data.map(b => `<option value="${b.id}">${b.branch_name}</option>`).join('');
        }

        function switchTab(id) {
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active');
            if(id === 'leave') loadLeaveHistory();
            if(id === 'payroll') loadPayrollMonths(); 
        }

        // ğŸŒŸ é¢±é¢¨å‡ UI å‹•æ…‹åˆ‡æ›é‚è¼¯
        function checkLeaveType() {
            const type = document.getElementById('leave-type-select').value;
            const ui = document.getElementById('salary-protection-ui');
            if(type === 'é¢±é¢¨å‡') {
                document.getElementById('sp-text').innerHTML = '<p class="text-[10px] font-black text-emerald-900">ğŸŒªï¸ æ³•å®šé¢±é¢¨å‡</p><p class="text-[9px] text-emerald-600">ä¾å‹åŸºæ³•è¦å®šï¼Œä¸æ‰£è–ªã€ä¸æ‰£ç‰¹ä¼‘</p>';
                ui.className = 'flex items-center justify-between p-2.5 bg-emerald-50 rounded-xl border border-emerald-200 transition-all';
                document.getElementById('sp-toggle').style.display = 'none'; // éš±è—é–‹é—œ
            } else {
                document.getElementById('sp-text').innerHTML = '<p class="text-[10px] font-black text-sky-900">è–ªè³‡ä¿å…¨</p><p class="text-[9px] text-sky-600">åŒæ„å„ªå…ˆæ‰£ç‰¹ä¼‘ä»¥ç¶­æŒå…¨è–ª</p>';
                ui.className = 'flex items-center justify-between p-2.5 bg-sky-50 rounded-xl border border-sky-100 transition-all';
                document.getElementById('sp-toggle').style.display = 'block'; // é¡¯ç¤ºé–‹é—œ
            }
        }

        function checkForm() { document.getElementById('btn-submit').disabled = !(document.getElementById('chk1').checked && document.getElementById('chk2').checked && document.getElementById('chk3').checked); }

        async function renderUI() {
            document.getElementById('ui-name').innerText = currentUser.full_name;
            document.getElementById('ui-tenure').innerText = `å…¥è·æ—¥ï¼š${currentUser.onboarding_date}`;
            const { data: lv } = await _sb.rpc('fn_get_annual_leave', { p_onboard_date: currentUser.onboarding_date });
            if(lv) document.getElementById('ui-leave').innerText = `${lv.days} å¤© ${lv.hours%8} å°æ™‚`;

            const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const { data: blt } = await _sb.from('bulletin_board').select('*').gte('created_at', oneYearAgo.toISOString()).order('created_at', {ascending: false});
            if (blt && blt.length > 0) {
                document.getElementById('ui-bulletin').innerHTML = blt.map(b => {
                    const d = new Date(b.created_at).toISOString().split('T')[0];
                    return `<div class="mb-2 border-b border-amber-100/50 pb-1.5 last:border-0 last:mb-0 last:pb-0 flex items-start"><span class="text-[10px] text-amber-600 font-black mr-1.5 mt-0.5">[${d}]</span><div><span class="font-black text-slate-800 text-xs">${b.title}</span><span class="text-[10px] text-slate-600 font-medium leading-relaxed block mt-0.5">${b.content}</span></div></div>`;
                }).join('');
            } else { document.getElementById('ui-bulletin').innerHTML = '<p class="text-xs text-slate-400">ç›®å‰ç„¡æ­·å²å…¬å‘Š</p>'; }

            document.getElementById('ui-profile-info').innerHTML = `
                <div class="flex items-center space-x-2"><span class="w-5 text-center text-sm">ğŸ†”</span><span class="text-slate-600 font-bold">${currentUser.id_number}</span></div>
                <div class="flex items-center space-x-2"><span class="w-5 text-center text-sm">ğŸ“</span><span class="text-slate-600">${currentUser.phone}</span></div>
                <div class="flex items-center space-x-2"><span class="w-5 text-center text-sm">ğŸ‘¥</span><span class="text-slate-600">çœ·å±¬ï¼š${currentUser.dependents_count || 0} äºº</span></div>
                <div class="flex items-start space-x-2"><span class="w-5 text-center text-sm mt-0.5">ğŸ </span><span class="text-slate-600 leading-relaxed">${currentUser.address}</span></div>
                <div class="flex items-start space-x-2 mt-2 pt-2 border-t border-slate-50"><span class="w-5 text-center text-sm mt-0.5">ğŸ¦</span><div class="text-slate-700 font-black leading-tight">${currentUser.bank_name} (${currentUser.bank_code})<br><span class="text-xs font-bold text-slate-500">${currentUser.bank_user_name} / ${currentUser.bank_account}</span></div></div>
            `;
        }

        function punch(type) {
            const bid = document.getElementById('punch-branch').value;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { data, error } = await _sb.rpc('fn_process_punch', { p_emp_id: currentUser.id, p_type: type, p_lat: pos.coords.latitude, p_lng: pos.coords.longitude, p_branch_id: bid });
                if (error || data.status === 'error') alert('âš ï¸ ' + (error?.message || data.message)); else alert('âœ… æ‰“å¡æˆåŠŸï¼');
            }, () => alert('è«‹é–‹å•Ÿ GPS å®šä½æ¬Šé™ï¼'));
        }

        async function loadPunchHistory() {
            document.getElementById('ui-records-list').innerHTML = 'è¼‰å…¥ä¸­...'; openModal('record-modal');
            const { data } = await _sb.from('attendance_logs').select('punch_type, punch_time, note, branch_locations(branch_name)').eq('employee_id', currentUser.id).order('punch_time', {ascending: false}).limit(30);
            document.getElementById('ui-records-list').innerHTML = data.length ? data.map(log => `<div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm"><div><span class="text-xs font-black bg-white px-2 py-1 rounded border">${log.punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span> <span class="text-xs font-bold text-slate-700 ml-1">${new Date(log.punch_time).toLocaleString('zh-TW').slice(5,-3)}</span><p class="text-[10px] text-slate-400 mt-1">ğŸ“ ${log.branch_locations?.branch_name||'æœªçŸ¥'}</p></div><span class="text-[9px] font-bold ${log.note.includes('æ­£å¸¸')?'text-emerald-500':'text-amber-500'}">${log.note}</span></div>`).join('') : '<div class="text-center text-xs text-slate-400">ç„¡ç´€éŒ„</div>';
        }

        async function submitLeave(e) {
            e.preventDefault(); const fd = new FormData(e.target);
            // é¢±é¢¨å‡è‡ªå‹•è¦†è“‹ä¿è–ªè¨­å®šç‚º false (ä¸æ‰£è–ªä¸æ‰£å‡)
            const isTyphoon = fd.get('leave_type') === 'é¢±é¢¨å‡';
            const payload = { employee_id: currentUser.id, leave_type: fd.get('leave_type'), start_time: fd.get('start_time'), end_time: fd.get('end_time'), salary_protection: isTyphoon ? false : (fd.get('salary_protection') === 'on') };
            await _sb.from('leave_requests').insert([payload]); alert('âœ… å‡å–®å·²é€å‡ºï¼Œè€é—†å·²æ”¶åˆ° LINE é€šçŸ¥ï¼'); e.target.reset(); checkLeaveType(); loadLeaveHistory();
        }

        async function loadLeaveHistory() {
            const { data } = await _sb.from('leave_requests').select('*').eq('employee_id', currentUser.id).order('created_at', {ascending: false}).limit(10);
            document.getElementById('ui-leave-list').innerHTML = data.length ? data.map(l => {
                let badge = l.status === 'æ ¸å‡†' ? 'bg-emerald-100 text-emerald-700' : (l.status === 'æ ¸é§' ? 'bg-red-100 text-red-700' : 'bg-slate-200 text-slate-600');
                let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                let spTag = l.leave_type === 'é¢±é¢¨å‡' ? '<span class="text-[9px] text-emerald-600 ml-1">(ä¸æ‰£è–ª)</span>' : (l.salary_protection ? '<span class="text-[9px] text-sky-500 ml-1">(ä¿è–ª)</span>' : '');
                return `<div class="bg-slate-50 p-3 rounded-xl border border-slate-100 shadow-sm"><div class="flex justify-between items-center mb-1"><span class="font-black text-xs">${l.leave_type} ${spTag}</span><span class="text-[9px] font-bold px-2 py-0.5 rounded ${badge}">${l.status}</span></div><p class="text-[10px] text-slate-500">${t1} ~ ${t2}</p></div>`;
            }).join('') : '<div class="text-center text-xs text-slate-400">ç„¡è«‹å‡ç´€éŒ„</div>';
        }

        async function loadPayrollMonths() {
            const sel = document.getElementById('payroll-month');
            const { data } = await _sb.from('payroll_records').select('pay_month').eq('employee_id', currentUser.id).order('pay_month', {ascending: false});
            if(!data || !data.length) { sel.innerHTML = '<option>å°šç„¡è–ªè³‡ç´€éŒ„</option>'; sel.disabled = true; resetPayrollUI(); return; }
            sel.disabled = false; sel.innerHTML = data.map(m => `<option value="${m.pay_month}">${m.pay_month} è–ªè³‡å–®</option>`).join('');
            sel.selectedIndex = 0; loadPayrollDetail(); 
        }

        function resetPayrollUI() { document.getElementById('p-base').innerText = 'NT$ 0'; document.getElementById('p-bonus').innerText = 'NT$ 0'; document.getElementById('p-yeb').innerText = 'NT$ 0'; document.getElementById('p-ins').innerText = '- NT$ 0'; document.getElementById('p-2nd').innerText = '- NT$ 0'; document.getElementById('p-pen').innerText = 'NT$ 0'; document.getElementById('p-net').innerText = 'NT$ 0'; }

        async function loadPayrollDetail() {
            const month = document.getElementById('payroll-month').value;
            const { data } = await _sb.from('payroll_records').select('*').eq('employee_id', currentUser.id).eq('pay_month', month).single();
            if(!data) { resetPayrollUI(); return; }
            document.getElementById('p-base').innerText = `NT$ ${data.base_pay.toLocaleString()}`; document.getElementById('p-bonus').innerText = `NT$ ${data.bonus.toLocaleString()}`; document.getElementById('p-yeb').innerText = `NT$ ${data.year_end_bonus.toLocaleString()}`; document.getElementById('p-ins').innerText = `- NT$ ${data.insurance_deduction.toLocaleString()}`; document.getElementById('p-2nd').innerText = `- NT$ ${data.second_gen_health.toLocaleString()}`; document.getElementById('p-pen').innerText = `NT$ ${data.labor_pension.toLocaleString()}`; document.getElementById('p-net').innerText = `NT$ ${data.total_net_pay.toLocaleString()}`;
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openDoc(type) { document.getElementById('doc-title').innerText = type === 'nda' ? 'å…¬å¸ä¿å¯†å”å®š (NDA)' : 'è˜åƒ±åˆç´„èˆ‡å“¡å·¥å®ˆå‰‡'; document.getElementById('doc-sig').innerText = `ç°½ç½²äººï¼š${currentUser.full_name}\næ™‚é–“ï¼š${new Date(currentUser.nda_signed_at).toLocaleString('zh-TW')}`; openModal('doc-modal'); }

        document.getElementById('onboarding-form').onsubmit = async (e) => {
            e.preventDefault(); document.getElementById('btn-submit').innerText = 'è³‡æ–™ä¸Šå‚³ä¸­...'; const fd = new FormData(e.target); 
            const payload = Object.fromEntries(fd.entries());
            payload.line_id = (await liff.getProfile()).userId; payload.default_branch_id = document.getElementById('reg-branch').value;
            payload.dependents_count = parseInt(payload.dependents_count) || 0;
            const { error } = await _sb.from('employees').insert([payload]); if(error) alert(error.message); else location.reload();
        };
        window.onload = init;
    </script>
</body>
</html>
