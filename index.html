<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* =========================================
       ğŸ’ V5.1 Tesla x Gogoro (æ¡Œé¢ç‰ˆæ‰‹æ©Ÿæ¯”ä¾‹é™åˆ¶)
       ========================================= */
       
    :root {
      --bg-image: none; --bg-color: #000000; --surface-color: #161618; --border-color: #2c2c2e;
      --text-primary: #ffffff; --text-secondary: #8e8e93;
      --accent-color: #00e676; --accent-gradient: linear-gradient(135deg, #00e676 0%, #00b85c 100%);
      --accent-glow: rgba(0, 230, 118, 0.2);
      --chart-bar: #333333; --chart-active: #00e676;
      --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(10, 10, 10, 0.85); --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      --input-bg: #1c1c1e;
    }

    body.light-mode {
      --bg-color: #f2f2f7; --surface-color: #ffffff; --border-color: #e5e5ea;
      --text-primary: #1c1c1e; --text-secondary: #8e8e93;
      --accent-color: #10b981; --accent-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --accent-glow: rgba(16, 185, 129, 0.15);
      --chart-bar: #e5e5ea; --chart-active: #34c759;
      --gold-color: #d4af37; --gold-glow: rgba(212, 175, 55, 0.15);
      --glass-bg: rgba(255, 255, 255, 0.9); --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      --input-bg: #f9f9f9;
    }

    body.metal-mode {
      --bg-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.015) 0px, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 4px);
      --bg-color: #151515; --surface-color: linear-gradient(145deg, #262628 0%, #1c1c1e 100%);
      --border-color: #3a3a3c; --text-primary: #e5e5ea; --text-secondary: #98989d;
      --accent-color: #06b6d4; --accent-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      --accent-glow: rgba(6, 182, 212, 0.25);
      --chart-bar: #333; --chart-active: #06b6d4;
      --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(28, 28, 30, 0.9); --card-shadow: inset 0 1px 1px rgba(255,255,255,0.05), 0 8px 25px rgba(0,0,0,0.5);
      --input-bg: #111112;
    }

    /* ğŸŒŸ ä¿®å¾©ï¼šé›»è…¦ç‰ˆèƒŒæ™¯è¨­å®š */
    html { background-color: #0a0a0c; }
    
    /* ğŸŒŸ ä¿®å¾©ï¼šå¼·åˆ¶é™ç¸® App æœ€å¤§å¯¬åº¦ï¼Œä¸¦ç½®ä¸­é¡¯ç¤ºç«‹é«”é™°å½± */
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      margin: 0 auto; /* æ°´å¹³ç½®ä¸­ */
      width: 100%; 
      max-width: 450px; /* é–å®šåœ¨æœ€å¤§ iPhone Pro Max å¯¬åº¦ */
      background-color: var(--bg-color); 
      background-image: var(--bg-image); 
      color: var(--text-primary); 
      padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); 
      transition: background 0.4s ease, color 0.4s ease; 
      min-height: 100vh; 
      letter-spacing: 0.5px; 
      -webkit-font-smoothing: antialiased;
      box-shadow: 0 0 50px rgba(0,0,0,0.8); /* è®“ App åœ¨é›»è…¦ä¸Šæµ®èµ· */
      position: relative;
      overflow-x: hidden;
    }
    
    .page { display: none; padding: 16px; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .g-card { background: var(--surface-color); border-radius: 20px; padding: 18px; box-shadow: var(--card-shadow); margin-bottom: 16px; border: 1px solid var(--border-color); }
    
    .btn-main { background: var(--accent-gradient); color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 4px 15px var(--accent-glow); letter-spacing: 1px;}
    .btn-main:active { transform: scale(0.96); box-shadow: 0 2px 8px var(--accent-glow); }
    
    input, select { width: 100%; padding: 16px; margin-bottom: 16px; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 14px; font-size: 15px; transition: all 0.3s; outline: none; -webkit-appearance: none; box-sizing: border-box;}
    input:focus, select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--accent-glow); }
    
    /* ğŸŒŸ ä¿®å¾©ï¼šåº•éƒ¨å°è¦½åˆ—è·Ÿéš¨ max-width ç½®ä¸­ */
    .bottom-nav { 
      position: fixed; bottom: 0; 
      left: 50%; transform: translateX(-50%); /* ç½®ä¸­å°é½Š */
      width: 100%; max-width: 450px; /* åŒæ­¥é™åˆ¶å¯¬åº¦ */
      background: var(--glass-bg); display: flex; justify-content: space-between; align-items: flex-end; 
      padding: 6px 5px calc(4px + env(safe-area-inset-bottom, 0px)) 5px; border-top: 1px solid var(--border-color); 
      z-index: 999; backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); box-shadow: 0 -4px 20px rgba(0,0,0,0.2); 
    }
    .nav-item { color: var(--text-secondary); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: space-between; flex: 1; height: 42px; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
    .nav-item:active { transform: scale(0.9); }
    .nav-item.active { color: var(--accent-color); font-weight: 700; transform: none; }
    .nav-icon { font-size: 22px; display: flex; align-items: center; justify-content: center; height: 24px; margin: 0; line-height: 1; }
    .nav-text { font-size: 11px; line-height: 1; display: block; margin-top: 2px;}

    .header-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 25px; }
    .header-title-box { flex: 1; min-width: 0; } 
    #ui-owner { font-size: 20px; font-weight: 800; margin: 0; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .plate-tag { background: var(--input-bg); color: var(--text-secondary); padding: 6px 12px; border-radius: 16px; font-family: monospace; font-size: 13px; font-weight: 700; border: 1px solid var(--border-color); letter-spacing: 1px;}
    
    .shield-badge { display:inline-flex; background: var(--accent-glow); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 6px 12px; border-radius: 30px; font-size: 11px; font-weight: 700; align-items: center; gap: 6px; animation: badgePulse 2.5s infinite alternate ease-in-out; transition: all 0.5s ease; margin-top:6px;}
    @keyframes badgePulse { 0% { box-shadow: 0 0 5px var(--accent-glow); border-color: transparent; } 100% { box-shadow: 0 0 20px var(--accent-color); border-color: var(--accent-color); } }
    .pulse-dot { display: inline-block; width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; animation: heartBeat 1.8s infinite cubic-bezier(0.215, 0.61, 0.355, 1); transition: background 0.5s ease;}
    @keyframes heartBeat { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 var(--accent-color); } 50% { transform: scale(1.6); box-shadow: 0 0 0 8px rgba(0,0,0,0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
    
    .main-visual-container { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 10px 0 20px 0; }
    .ring { width: 220px; height: 220px; border-radius: 50%; border: 6px solid var(--accent-color); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 50px var(--accent-glow); position: relative; background: var(--surface-color); z-index: 2;}
    .ring::after { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: 50%; border: 1px dashed var(--text-secondary); animation: rotate 25s linear infinite; opacity: 0.2; z-index: 1;}
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .chart-title { font-size: 13px; font-weight: 700; color: var(--text-secondary); }
    .chart-content { display: flex; justify-content: space-between; align-items: flex-end; }
    .chart-number-box { display:flex; align-items:baseline; gap:4px; }
    .chart-number { font-size: 42px; font-weight: 900; letter-spacing: -2px; color: var(--text-primary); line-height: 1;}
    .chart-unit { font-size: 12px; font-weight: 600; color: var(--text-secondary); padding-bottom: 6px;}
    
    .bars-container { display: flex; align-items: flex-end; gap: 6px; height: 45px; }
    .bar { width: 10px; border-radius: 5px; background: var(--chart-bar); transition: height 1s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .bar.active { background: var(--accent-gradient); }

    .level-row { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid var(--border-color); margin-top: 15px; }
    .level-badge { background: var(--input-bg); color: var(--accent-color); font-weight: 700; font-size: 12px; padding: 6px 12px; border-radius: 16px; border: 1px solid var(--border-color); display:flex; align-items:center; gap:6px;}
    
    .tech-tag-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 16px; }
    .tech-tag { background: var(--input-bg); color: var(--text-primary); padding: 8px 2px; border-radius: 10px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; gap: 2px; font-weight: 600; text-align: center; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .t-icon { font-size: 13px; opacity: 0.9; flex-shrink: 0;}
    
    .dynamic-msg-bar { background: var(--surface-color); color: var(--accent-color); padding: 0 16px; height: 48px; border-radius: 16px; font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; border: 1px solid var(--border-color); overflow: hidden; font-weight: 600; transition: all 0.4s ease; box-shadow: var(--card-shadow); }
    .dynamic-msg-icon { margin-right: 12px; font-size: 18px; flex-shrink: 0; display:flex; align-items:center; }
    .marquee-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; height: 100%; }
    .marquee-content { display: flex; align-items: center; min-width: 100%; animation: scrollText 14s linear infinite; line-height: 1; padding-top: 2px;} 
    @keyframes scrollText { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .env-box { background: var(--input-bg); border-radius: 14px; padding: 16px 10px; text-align: center; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 90px; }
    .env-title { font-size: 12px; color: var(--text-secondary); font-weight: 600; margin-bottom: 6px; line-height: 1.4;}
    .aqi-container { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }
    .aqi-label { font-size: 10px; font-weight: 800; color: var(--text-secondary); letter-spacing: 1px; margin-bottom: 2px; }
    .env-val { font-size: 32px; font-weight: 800; color: var(--text-primary); margin: 0; font-family: -apple-system, sans-serif; letter-spacing: -1px; line-height: 1; }

    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 16px;}
    .esg-box { text-align: center; padding: 12px 6px; background: var(--input-bg); border-radius: 14px; border: 1px solid var(--border-color); position: relative; }
    .esg-badge { position: absolute; top: -8px; right: 50%; transform: translateX(50%); background: var(--accent-gradient); color: #fff; font-size: 9px; padding: 3px 6px; border-radius: 10px; font-weight: 700; white-space: nowrap;}
    
    .tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
    .tab-btn { padding: 14px 10px; margin: 0; font-size: 13px; text-align: center; border-radius: 14px; cursor: pointer; font-weight: 600; border: 1px solid var(--border-color); white-space: nowrap; transition: all 0.3s; background: var(--input-bg); color: var(--text-secondary);}
    .tab-btn.active { background: var(--accent-gradient); color: #fff; border-color: var(--accent-color); box-shadow: 0 6px 15px var(--accent-glow);}
    
    .log-item { border-bottom: 1px solid var(--border-color); padding: 16px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .log-item:last-child { border-bottom: none; }
    .version-tag { text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: 40px; font-family: monospace; letter-spacing: 1px; opacity: 0.6;}
    label { font-size: 12px; color: var(--text-secondary); font-weight: 600; margin-bottom: 8px; display: block; padding-left: 4px;}

    .vip-card { border: 1px solid var(--gold-color); background: linear-gradient(135deg, #1a1500 0%, #050400 100%); box-shadow: 0 15px 40px var(--gold-glow); position: relative; overflow: hidden; }
    .vip-card::before { content: ''; position: absolute; top: -60px; right: -60px; width: 180px; height: 180px; background: var(--gold-glow); filter: blur(50px); border-radius: 50%; }
    .shine-btn { position: relative; overflow: hidden; background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); color: #000; box-shadow: 0 8px 25px var(--gold-glow); border-radius: 16px;}
    .shine-btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.7) 50%, rgba(255,255,255,0) 100%); transform: skewX(-25deg); animation: shine 3s infinite; }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:var(--text-primary); text-align:center; margin-bottom:30px;">HYPASS <span style="color:var(--accent-color);">Air+</span></h2>
    <div class="card"><p style="font-size:13px; color:var(--text-secondary); margin:0; text-align:center; line-height:1.5;">ç‚ºä¿éšœæ‚¨çš„æ•¸ä½å±¥æ­·èˆ‡å°ˆå±¬ä¿å›º<br>è«‹å®Œæˆé¦–æ¬¡åº§è‰™æˆæ¬Š</p></div>
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:30px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      <select id="c-city" onchange="updateDistricts('c-city', 'c-district')">
        <option value="">* å±…ä½ç¸£å¸‚</option>
        <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
        <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
        <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
        <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
        <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
        <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
      </select>
      <select id="c-district"><option value="">* é„‰é®å¸‚å€</option></select>
      <input type="text" id="c-address" placeholder="* è©³ç´°é€šè¨Šåœ°å€ (è¡—é“/å··å¼„/æ¨“å±¤)">
      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡è»Šè¼›å“ç‰Œ</option>
        <option value="Toyota">Toyota (è±ç”°)</option><option value="Honda">Honda (æœ¬ç”°)</option>
        <option value="Nissan">Nissan (æ—¥ç”¢)</option><option value="Ford">Ford (ç¦ç‰¹)</option>
        <option value="Mazda">Mazda (é¦¬è‡ªé”)</option><option value="Mitsubishi">Mitsubishi (ä¸‰è±)</option>
        <option value="Hyundai">Hyundai (ç¾ä»£)</option><option value="Kia">Kia (èµ·äº)</option>
        <option value="Volkswagen">Volkswagen (ç¦æ–¯)</option><option value="Skoda">Skoda (å¸ç§‘é”)</option>
        <option value="Lexus">Lexus (å‡Œå¿—)</option><option value="Benz">Mercedes-Benz (è³“å£«)</option>
        <option value="BMW">BMW (å¯¶é¦¬)</option><option value="Audi">Audi (å¥§è¿ª)</option>
        <option value="Volvo">Volvo (å¯Œè±ª)</option><option value="Porsche">Porsche (ä¿æ™‚æ·)</option>
        <option value="Tesla">Tesla (ç‰¹æ–¯æ‹‰)</option><option value="Subaru">Subaru (é€Ÿéœ¸é™¸)</option>
        <option value="Suzuki">Suzuki (éˆ´æœ¨)</option><option value="Luxgen">Luxgen (ç´æ™ºæ·)</option>
        <option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      <select id="c-model"><option value="">* è«‹å…ˆé¸æ“‡å“ç‰Œ</option></select>
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼ (ä¾‹ï¼šABC-1234)">
      <select id="c-mileage"><option value="">* å¹´å¹³å‡é‡Œç¨‹</option><option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option></select>
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆæˆæ¬Šä¸¦å•Ÿç”¨åº§è‰™</button>
    </div>
  </div>

  <div id="page-home" class="page">
    
    <div class="header-flex">
      <div class="header-title-box">
        <p id="ui-owner">è®€å–ä¸­...</p>
        <div class="shield-badge" id="ui-shield-badge"><span class="pulse-dot" id="ui-pulse-dot"></span> <span id="ui-shield-text">ç³»çµ±é€£ç·šä¸­</span></div>
      </div>
      <div class="plate-tag" id="ui-plate-tag">è®€å–ä¸­</div>
    </div>

    <div class="main-visual-container">
      <div class="ring">
        <div style="font-size:64px; font-weight:900; color:var(--accent-color); letter-spacing:-2px; line-height:1;" id="ui-health">100%</div>
        <div style="font-size:14px; color:var(--text-secondary); font-weight:700; margin-top:8px;">å‹•æ…‹å£½å‘½æ¨ä¼°</div>
      </div>
      <div style="font-size:11px; color:var(--text-secondary); margin-top:20px; z-index:3; letter-spacing:0.5px;">ä¿å›ºå•Ÿç”¨: <span id="ui-filter-date" style="font-weight:bold; color:var(--text-primary);">è®€å–ä¸­...</span></div>
    </div>
    
    <div class="dynamic-msg-bar" id="dynamic-msg-box">
      <span style="margin-right: 12px; font-size: 18px;">ğŸ’¬</span>
      <div class="marquee-container"><span class="marquee-content" id="ui-dynamic-msg">ç³»çµ±é€£ç·šä¸­ï¼ŒåŒæ­¥ç¸½éƒ¨å¤§æ•¸æ“š...</span></div>
    </div>

    <div class="g-card">
      <div class="chart-header">
        <span class="chart-title">ç´¯è¨ˆæ·¨åŒ–é‡ (PM2.5)</span>
        <span class="plate-tag" style="font-size:10px; padding:2px 8px;">è¿‘ 7 æ—¥è¶¨å‹¢</span>
      </div>
      <div class="chart-content">
        <div class="chart-number-box">
          <div class="chart-number" id="ui-pm25-w">0</div>
          <div class="chart-unit">è¬ Âµg</div>
        </div>
        <div class="bars-container">
          <div class="bar" style="height: 30%;"></div>
          <div class="bar" style="height: 50%;"></div>
          <div class="bar" style="height: 40%;"></div>
          <div class="bar" style="height: 70%;"></div>
          <div class="bar" style="height: 60%;"></div>
          <div class="bar" style="height: 90%;"></div>
          <div class="bar active" style="height: 100%; position:relative;">
             <div style="position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); width:3px; height:3px; background:var(--accent-color); border-radius:50%;"></div>
          </div>
        </div>
      </div>
      <div class="level-row">
        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">
          å·²æ¸›å°‘ç¢³æ’æ”¾ <span id="ui-esg-co2" style="color:var(--text-primary); font-weight:800; font-size:14px;">0</span> kg
        </div>
        <div class="level-badge" id="ui-level-badge"><span>ğŸ‘¤</span> <span id="ui-level-title">è®€å–ä¸­</span></div>
      </div>
    </div>

    <div class="g-card">
      <div class="chart-title" style="margin-bottom: 12px;">ç©ºæ±™é›·é”èˆ‡ææ–™è¦æ ¼</div>
      <div class="grid-2">
        <div class="env-box">
          <div class="env-title">ğŸ“ å³æ™‚æ‰€åœ¨åœ°<br><span id="ui-loc-name" class="env-subtitle" style="color:var(--text-primary);">å®šä½ä¸­...</span></div>
          <div class="aqi-container">
            <div class="aqi-label">AQI</div>
            <div class="env-val" id="env-aqi" style="color:var(--accent-color);">--</div>
          </div>
        </div>
        <div class="env-box">
          <div class="env-title">ğŸ  è¿‘7æ—¥å±…ä½åœ°<br><span id="ui-home-city" class="env-subtitle" style="color:var(--text-primary);">è®€å–ä¸­...</span></div>
          <div class="aqi-container">
            <div class="aqi-label">AQI</div>
            <div class="env-val" id="env-home-aqi" style="color:var(--gold-color);">--</div>
          </div>
        </div>
      </div>

      <div class="grid-3">
        <div class="esg-box">
          <div class="esg-badge">å†·æ°£è¼•è² è¼‰</div><div style="font-size:18px; margin-top:8px;">âš¡ï¸</div><div style="font-size:18px; font-weight:700; color:var(--text-primary); margin:4px 0;"><span id="ui-esg-kwh">0</span><span style="font-size:9px; color:var(--text-secondary);">kWh</span></div><div style="font-size:10px; color:var(--text-secondary); font-weight:600;">çœé›»æ•ˆèƒ½</div>
        </div>
        <div class="esg-box">
          <div class="esg-badge">å¼·æ•ˆå¤§é¢¨é‡</div><div style="font-size:18px; margin-top:8px;">â›½ï¸</div><div style="font-size:18px; font-weight:700; color:var(--text-primary); margin:4px 0;"><span id="ui-esg-ac">0</span><span style="font-size:9px; color:var(--text-secondary);">%</span></div><div style="font-size:10px; color:var(--text-secondary); font-weight:600;">ç©ºèª¿ç¯€èƒ½</div>
        </div>
        <div class="esg-box" style="display:flex; flex-direction:column; justify-content:center; gap:4px; padding:8px 4px;">
           <div style="font-size:9px; background:var(--border-color); border-radius:4px; padding:2px; font-weight:bold;">ğŸ‡¹ğŸ‡¼ å°ç£è£½é€ </div>
           <div style="font-size:9px; background:var(--border-color); border-radius:4px; padding:2px; font-weight:bold;">æ¤°æ®¼é™¤è‡­</div>
           <div style="font-size:9px; background:var(--border-color); border-radius:4px; padding:2px; font-weight:bold;">éœé›»éæ¿¾</div>
        </div>
      </div>
    </div>
    
    <button class="btn-main" onclick="scanFilter()" style="margin-top:5px; background:var(--surface-color); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:var(--card-shadow);">ğŸ“· DIY æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="g-card" style="text-align:center; padding: 40px 20px;">
      <p style="color:var(--text-secondary); font-size:15px; margin-bottom:15px;">æ‚¨çš„å°ˆå±¬éš±è—å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:var(--accent-color); letter-spacing: 4px; border: 2px dashed var(--accent-color); padding: 18px; border-radius: 16px; margin-bottom:30px; font-size:28px;">AIRPLUS2026</h2>
      <button class="btn-main" onclick="window.location.href='https://www.hypass.com.tw/categories/replace-filters-all'">å‰å¾€å•†åŸé¸è³¼å°ˆå±¬æ¿¾ç¶²</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ“ é ç´„å®‰è£</h3>
    <div id="booking-section">
      <div style="display: flex; gap: 12px; margin-bottom: 24px;">
        <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div>
        <div class="tab-btn inactive" id="tab-btn-manual" onclick="switchBookingTab('manual')">ğŸ“‹ é™„è¿‘ä¿ä¿®å» </div>
      </div>
      <div id="booking-smart"><div id="smart-match-result" class="g-card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
      <div id="booking-manual" style="display: none;"><div id="garage-list">è®€å–æ¸…å–®ä¸­...</div></div>
    </div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ ä»»å‹™èˆ‡çå‹µ</h3>
    <div class="g-card vip-card" style="text-align: center; padding: 40px 20px; border-radius:24px;">
      <h4 style="margin:0; color:var(--gold-color); font-size: 18px; letter-spacing: 2px;">VIP å°ˆå±¬çå‹µé‡‘</h4>
      <h1 style="margin:20px 0; font-size: 64px; color: #FFF; text-shadow: 0 4px 25px rgba(255, 215, 0, 0.6);"><span id="reward-balance">$0</span></h1>
      <p style="font-size:14px; color:#d4d4d4; margin-bottom: 30px; line-height:1.6;">ç´¯ç©æ»¿ $100 å³å¯å…Œæ› LINE Points<br>æ¨è–¦ç„¡ä¸Šé™ï¼Œçé‡‘ç„¡ä¸Šé™ï¼</p>
      <button class="btn-main shine-btn" style="padding:18px; font-size:18px; font-weight:800;" onclick="redeemPoints()">ç”³è«‹æé ˜é»æ•¸</button>
    </div>
    
    <div class="g-card" style="text-align: center; border: 2px solid var(--accent-color);">
       <h3 style="margin-top: 10px; color: var(--text-primary); font-size:20px;">ğŸš€ é‚€è«‹è»Šå‹åŠ å…¥åº§è‰™</h3>
       <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6;">åˆ†äº«æ‚¨çš„å°ˆå±¬é€£çµï¼Œå¥½å‹æˆåŠŸå•Ÿç”¨æ¿¾ç¶²å¾Œ<br>æ‚¨å°‡ç«‹å³ç²å¾—é«˜é¡æ¨è–¦çé‡‘ï¼</p>
       <button class="btn-main" style="box-shadow: 0 8px 25px var(--accent-glow); font-size: 18px; padding:18px;" onclick="generateMGM()">ğŸ”— é»æ“Šè¤‡è£½å°ˆå±¬é€£çµ</button>
    </div>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    
    <div class="tab-grid">
      <div class="tab-btn active" id="tab-set-a" onclick="switchSetTab('a')">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
      <div class="tab-btn inactive" id="tab-set-theme" onclick="switchSetTab('theme')">ğŸ¨ ç•«é¢è¨­å®š</div>
      <div class="tab-btn inactive" id="tab-set-b" onclick="switchSetTab('b')">ğŸ“œ æ­·å²ç´€éŒ„</div>
      <div class="tab-btn inactive" id="tab-set-c" onclick="switchSetTab('c')">ğŸ“„ æ•¸ä½åˆç´„</div>
    </div>

    <div id="set-content-a" style="display:block;">
      <div class="g-card">
        <label>è»Šä¸»å§“å</label><input type="text" id="edit-name">
        <label>è¯çµ¡é›»è©±</label><input type="tel" id="edit-phone">
        <label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="edit-plate">
        <label>è»Šè¼›å“ç‰Œ</label>
        <select id="edit-brand" onchange="updateCarModels('edit-brand', 'edit-model')"><option value="Toyota">Toyota</option><option value="Honda">Honda</option><option value="Tesla">Tesla</option><option value="Other">å…¶ä»–å“ç‰Œ</option></select>
        <label>è»Šè¼›å‹è™Ÿ</label><select id="edit-model"></select>
        <label>å¹´å¹³å‡è¡Œé§›é‡Œç¨‹</label><select id="edit-mileage"><option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option></select>
        <button class="btn-main" onclick="updateProfile()" style="margin-top:10px;">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
    
    <div id="set-content-theme" style="display:none;">
      <div class="g-card" style="text-align: center; padding: 40px 20px;">
        <h3 style="margin-top:0; color:var(--text-primary); margin-bottom: 30px; font-size:20px;">é¸æ“‡åº§è‰™é¡¯ç¤ºæ¨¡å¼</h3>
        <div style="display:flex; flex-direction: column; gap:16px;">
          <button class="btn-main" id="btn-theme-dark" style="background:#000000; color:#00e676; border:1px solid #222222; box-shadow: 0 8px 25px rgba(0,0,0,0.8);" onclick="setTheme('dark')">ğŸŒ™ æ›œçŸ³é»‘ (é è¨­)</button>
          <button class="btn-main" id="btn-theme-light" style="background:#ffffff; color:#10b981; border:1px solid #e5e5ea; box-shadow: 0 8px 25px rgba(0,0,0,0.06);" onclick="setTheme('light')">â˜€ï¸ æ¥µç°¡ç™½ (Gogoroé¢¨æ ¼)</button>
          <button class="btn-main" id="btn-theme-metal" style="background:linear-gradient(145deg, #2c2c2e 0%, #1c1c1e 100%); color:#06b6d4; border:1px solid #3a3a3c; box-shadow: 0 8px 25px rgba(0,0,0,0.6);" onclick="setTheme('metal')">ğŸŒŠ æ·¨åŒ–è—</button>
        </div>
      </div>
    </div>

    <div id="set-content-b" style="display:none;">
      <div class="g-card">
        <select id="history-type" onchange="loadHistory(this.value)" style="margin-bottom:20px; font-weight:700;">
          <option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›ç´€éŒ„</option><option value="book">ğŸ“ ä¿ä¿®å» é ç´„ç´€éŒ„</option>
          <option value="shop">ğŸ›’ å•†åŸè³¼è²·ç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 400px; overflow-y: auto;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    
    <div id="set-content-c" style="display:none;">
      <div class="g-card"><h4 style="margin:0 0 10px 0; color:var(--text-primary); font-size:18px;">ğŸ“„ HYPASS æ•¸ä½ä¿å›ºå¡</h4><p style="font-size:14px; color:var(--text-secondary); margin:8px 0;">èªè­‰è»Šç‰Œï¼š<span id="contract-plate" style="color:var(--gold-color); font-weight:bold; font-size:18px;"></span></p></div>
    </div>
    <div class="version-tag">5.1 - æ¡Œé¢ RWD æ‰‹æ©Ÿæ¯”ä¾‹ç‰ˆ</div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><span class="nav-icon">â—“</span><span class="nav-text">åº§è‰™</span></div>
    <div class="nav-item" onclick="switchPage('shop', this)"><span class="nav-icon">ğŸ›’</span><span class="nav-text">å•†åŸ</span></div>
    <div class="nav-item" onclick="switchPage('book', this)"><span class="nav-icon">ğŸ“</span><span class="nav-text">é ç´„</span></div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><span class="nav-icon">ğŸ</span><span class="nav-text">ä»»å‹™</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span class="nav-icon">âš™ï¸</span><span class="nav-text">è¨­å®š</span></div>
  </div>

  <script>
    window.onerror = function(msg, url, line) { console.log("Error:", msg, "at line:", line); return false; };

    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let currentUser = null; let currentLocName = 'å°ç£'; let envData = { temp: 25, hum: 60, aqi: 50, pm25: 15 };
    
    const carData = { "Toyota": ["RAV4", "Corolla Cross", "Altis", "å…¶ä»–"], "Honda": ["CR-V", "HR-V", "Fit", "å…¶ä»–"], "Tesla": ["Model Y", "Model 3", "å…¶ä»–"], "Other": ["å…¶ä»–å“ç‰Œ"] };

    function normalizeCityName(cityStr) { return cityStr ? cityStr.replace(/è‡º/g, 'å°') : ''; }
    function formatTaipeiTime(dateString) { return dateString ? new Date(dateString).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false }) : '-'; }

    function getCarSizeRate(model) {
        if (!model) return 1.0; 
        const lModels = ['Model X', 'Model Y', 'RAV4', 'CR-V']; const sModels = ['Yaris', 'Fit', 'Swift'];
        if (lModels.includes(model)) return 1.3; if (sModels.includes(model)) return 0.8; return 1.0;
    }

    function setTheme(theme) {
      document.body.classList.remove('light-mode', 'metal-mode');
      document.getElementById('btn-theme-dark').style.borderColor = 'transparent'; document.getElementById('btn-theme-light').style.borderColor = 'transparent'; document.getElementById('btn-theme-metal').style.borderColor = 'transparent';
      if (theme === 'light') { document.body.classList.add('light-mode'); document.getElementById('btn-theme-light').style.borderColor = '#10b981'; } 
      else if (theme === 'metal') { document.body.classList.add('metal-mode'); document.getElementById('btn-theme-metal').style.borderColor = '#06b6d4'; } 
      else { theme = 'dark'; document.getElementById('btn-theme-dark').style.borderColor = '#00e676'; }
      localStorage.setItem('hypass_theme', theme);
    }
    setTheme(localStorage.getItem('hypass_theme') || 'light');

    function updateCarModels(brandId, modelId) { 
      const bSelect = document.getElementById(brandId).value; const mSelect = document.getElementById(modelId); mSelect.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>'; 
      if (carData[bSelect]) carData[bSelect].forEach(item => { mSelect.innerHTML += `<option value="${item}">${item}</option>`; });
    }

    function showForm(role) { document.getElementById('form-customer').style.display = (role === 'customer') ? 'block' : 'none'; document.getElementById('form-garage').style.display = (role === 'garage') ? 'block' : 'none'; }
    function switchPage(id, el) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.getElementById('page-' + id).classList.add('active'); if (el) el.classList.add('active'); if (id === 'book') loadGarages(); }
    function switchSetTab(t) { ['a','theme','b','c'].forEach(tab => { document.getElementById(`set-content-${tab}`).style.display = (t === tab) ? 'block' : 'none'; document.getElementById(`tab-set-${tab}`).className = `tab-btn ${t === tab ? 'active' : 'inactive'}`; }); }
    function switchBookingTab(t) { document.getElementById('booking-smart').style.display = (t === 'smart') ? 'block' : 'none'; document.getElementById('booking-manual').style.display = (t === 'manual') ? 'block' : 'none'; document.getElementById('tab-btn-smart').className = `tab-btn ${t === 'smart' ? 'active' : 'inactive'}`; document.getElementById('tab-btn-manual').className = `tab-btn ${t === 'manual' ? 'active' : 'inactive'}`; }

    async function updateProfile() {
      const payload = { name: document.getElementById('edit-name').value, phone: document.getElementById('edit-phone').value, license_plate: document.getElementById('edit-plate').value, yearly_mileage: parseInt(document.getElementById('edit-mileage').value) };
      if (!payload.name || !payload.phone || !payload.license_plate) return alert("å§“åã€é›»è©±ã€è»Šç‰Œä¸å¯ç‚ºç©ºï¼");
      const { error } = await supabaseClient.from('users').update(payload).eq('line_uid', currentUser.line_uid); 
      if (error) alert("æ›´æ–°å¤±æ•—ï¼š" + error.message); else { alert('âœ… æˆåŠŸæ›´æ–°ï¼'); location.reload(); }
    }

    async function scanFilter() {
      const res = await liff.scanCodeV2(); if (!res.value) return;
      await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated');
      const { error } = await supabaseClient.from('filters_uid').update({ status: 'activated', activated_by_uid: currentUser.line_uid, activated_at: new Date(), activation_type: 'DIY', installed_car_model: currentUser.car_brand, installed_location: currentLocName }).eq('uid', res.value);
      if (error) return alert("å•Ÿç”¨å¤±æ•—"); alert("âœ… å•Ÿç”¨æˆåŠŸï¼"); location.reload();
    }

    async function updateDynamicMarquee(aqi, health, status) {
        document.getElementById('ui-dynamic-msg').innerText = `ç³»çµ±é€£ç·šæ­£å¸¸ï¼Œç›®å‰å®¤å¤– AQI: ${aqi}ï¼Œæ¿¾ç¶²æŒçºŒé˜²è­·ä¸­ï¼`;
    }

    async function calculateDashboardStats() {
      if (!currentUser) return;
      const badge = document.getElementById('ui-shield-badge'); const badgeText = document.getElementById('ui-shield-text'); const pulseDot = document.getElementById('ui-pulse-dot');
      
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).single();
      
      if (filter && filter.activated_at) {
        const actDate = new Date(filter.activated_at); document.getElementById('ui-filter-date').innerText = actDate.getFullYear() + '/' + String(actDate.getMonth()+1).padStart(2, '0') + '/' + String(actDate.getDate()).padStart(2, '0');
        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000 * 60 * 60 * 24)));
        const algoParams = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        
        let mileageRate = currentUser.yearly_mileage ? (currentUser.yearly_mileage / 20000) : 1.0;
        let aqiRate = (envData.aqi > 150) ? 1.8 : (envData.aqi > 100 ? 1.4 : 1.0);
        let carSizeRate = getCarSizeRate(currentUser.car_model);
        let tempRate = envData.temp > 28 ? 1.2 : (envData.temp < 20 ? 0.8 : 1.0);
        let totalMultiplier = mileageRate * aqiRate * carSizeRate * tempRate;

        let baseWear = parseFloat(algoParams.baseWear || 0.27);
        let health = Math.max(0, Math.round(100 - (days * baseWear * totalMultiplier)));
        document.getElementById('ui-health').innerText = `${health}%`;
        
        if (health >= 60) { badgeText.innerText = 'æ¥µæ•ˆé˜²è­·ä¸­'; document.getElementById('ui-health').style.color = 'var(--accent-color)';} 
        else if (health >= 30) { badgeText.innerText = 'ç©©å®šç›£æ§ä¸­'; document.getElementById('ui-health').style.color = 'var(--accent-color)';} 
        else if (health > 0) { badge.style.setProperty('--accent-color', '#f59e0b'); badgeText.innerText = 'æ•ˆèƒ½è¡°é€€ä¸­'; document.getElementById('ui-health').style.color = '#f59e0b';} 
        else { badge.style.setProperty('--accent-color', '#ef4444'); badgeText.innerText = 'è«‹å³åˆ»æ›´æ›'; document.getElementById('ui-health').style.color = '#ef4444';}
        
        let totalPm25 = Math.round(days * 1250 * totalMultiplier);
        let displayPm25 = (totalPm25 / 10000).toFixed(1);
        document.getElementById('ui-pm25-w').innerText = displayPm25;
        
        let totalKwhSaved = (days * 0.25 * mileageRate).toFixed(1);
        document.getElementById('ui-esg-kwh').innerText = totalKwhSaved;
        let totalCo2 = (totalKwhSaved * 0.5).toFixed(1);
        document.getElementById('ui-esg-co2').innerText = totalCo2;

        let levelTitle = "æ¸…æ–°æ–°æ‰‹ LV.1"; let titleColor = "var(--text-secondary)";
        if(totalCo2 > 50) { levelTitle = "å¾¡é¢¨å°Šè€… LV.3"; titleColor = "#FFD700"; }
        else if(totalCo2 > 10) { levelTitle = "æ·¨åŒ–é”äºº LV.2"; titleColor = "var(--accent-color)"; }
        document.getElementById('ui-level-title').innerText = levelTitle;
        document.getElementById('ui-level-badge').style.color = titleColor;
        document.getElementById('ui-level-badge').style.borderColor = titleColor;

      } else {
        document.getElementById('ui-filter-date').innerText = 'å°šæœªå•Ÿç”¨';
        badge.style.setProperty('--accent-color', '#888888'); badgeText.innerText = 'ç³»çµ±å¾…å‘½'; pulseDot.style.animation = 'none';
      }
    }

    async function fetchEnvironmentalData(city, district) {
      try {
        let searchCity = normalizeCityName(city);
        let { data } = await supabaseClient.from('env_cache').select('*').eq('city', searchCity).eq('district', district).maybeSingle();
        if (!data) { const { data: fallback } = await supabaseClient.from('env_cache').select('*').limit(1).maybeSingle(); data = fallback || { temp: 25, hum: 60, aqi: 50, pm25: 15 }; }

        envData.temp = data.temp; envData.hum = data.hum; envData.aqi = data.aqi; envData.pm25 = data.pm25;
        document.getElementById('env-aqi').innerText = envData.aqi;
        
        let homeCityRaw = currentUser.city || 'å°åŒ—å¸‚'; document.getElementById('ui-home-city').innerText = homeCityRaw;
        document.getElementById('env-home-aqi').innerText = Math.round(envData.aqi * (0.9 + Math.random() * 0.2));
        calculateDashboardStats();
      } catch (e) { calculateDashboardStats(); }
    }

    function getGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`)
            .then(res => res.json())
            .then(d => {
              let city = d.address.city || d.address.county || ''; let district = d.address.suburb || d.address.town || '';
              currentLocName = `${city}${district}`; document.getElementById('ui-loc-name').innerText = currentLocName;
              fetchEnvironmentalData(city, district);
            }).catch(e => { document.getElementById('ui-loc-name').innerText = "å®šä½å®Œæˆ"; fetchEnvironmentalData('', '');});
        }, () => { fetchEnvironmentalData('', ''); }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }); 
      }
    }

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        const { data, error } = await supabaseClient.from('users').select('*').eq('line_uid', profile.userId).maybeSingle();
        if (data && data.name) {
          currentUser = data; document.getElementById('nav-bar').style.display = 'flex';
          if (data.role === 'customer') {
            document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
            document.getElementById('ui-plate-tag').innerText = data.license_plate || 'æœªç¶å®šè»Šç‰Œ';
            document.getElementById('edit-name').value = data.name; document.getElementById('edit-phone').value = data.phone; 
            document.getElementById('edit-plate').value = data.license_plate; document.getElementById('contract-plate').innerText = data.license_plate;
            if(data.yearly_mileage) document.getElementById('edit-mileage').value = data.yearly_mileage;

            switchPage('home', document.querySelector('.nav-item'));
            getGPS();
          }
        } else { switchPage('register', null); }
      } catch (err) { console.log("LIFF å•Ÿå‹•å¤±æ•—"); }
    }
    initApp();
  </script>
</body>
</html>
