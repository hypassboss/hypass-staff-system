<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·å¸•æ–¯å“¡å·¥ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans relative">

    <div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-blue-700 font-bold tracking-widest animate-pulse">ç³»çµ±å®‰å…¨é€£ç·šä¸­...</p>
    </div>

    <div id="register-view" class="hidden min-h-screen p-4 pb-10">
        <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 max-w-md mx-auto mt-4 border-t-4 border-blue-600">
            <h2 class="text-2xl font-bold mb-1 text-center text-slate-800">å“¡å·¥è³‡æ–™å»ºæª”</h2>
            <p class="text-xs text-rose-500 mb-6 text-center">é¦–æ¬¡ç™»å…¥éœ€è£œå…¨ä»¥ä¸‹è³‡æ–™</p>
            <div class="space-y-4 text-sm font-medium">
                <div><label class="block mb-1 text-slate-600">çœŸå¯¦å§“å</label><input type="text" id="reg-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></div>
                <div><label class="block mb-1 text-slate-600">è¯çµ¡æ‰‹æ©Ÿ</label><input type="tel" id="reg-phone" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></div>
                <div><label class="block mb-1 text-slate-600">é›»å­éƒµä»¶</label><input type="email" id="reg-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></div>
                <div><label class="block mb-1 text-slate-600">å…¥è·æ—¥æœŸ</label><input type="date" id="reg-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></div>
                <div>
                    <label class="block mb-1 text-slate-600">ä¸»è¦ä¸Šç­åœ°é»</label>
                    <select id="reg-loc" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
                        <option value="A">æµ·å¸•æ–¯ç§‘æŠ€ (å®‰å®šå€)</option>
                        <option value="B">HYPASS BOSS (å–„åŒ–å€)</option>
                    </select>
                </div>
                <div><label class="block mb-1 text-slate-600">è–ªè³‡åŒ¯æ¬¾å¸³è™Ÿ</label><input type="text" id="reg-bank" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></div>
                <button onclick="submitRegistration()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold mt-8">é€å‡ºè³‡æ–™</button>
            </div>
        </div>
    </div>

    <div id="app-view" class="hidden min-h-screen p-4 flex flex-col">
        <header class="bg-gradient-to-r from-blue-700 to-blue-800 text-white p-6 rounded-3xl shadow-lg mb-4 text-center">
            <h1 class="text-xl font-bold tracking-wide">æµ·å¸•æ–¯å“¡å·¥ç³»çµ±</h1>
            <p class="text-[10px] opacity-70 mt-1">@034qvauh</p>
            <div class="mt-4 inline-block bg-white/20 backdrop-blur-sm px-4 py-2 rounded-xl text-sm font-medium">
                <span id="user-info">å“¡å·¥è³‡æ–™è¼‰å…¥ä¸­...</span>
            </div>
        </header>

        <section class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-4">
            <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center"><span class="w-1 h-4 bg-blue-500 rounded mr-2"></span>æ¨¡çµ„ Aï¼šGPS è€ƒå‹¤æ‰“å¡</h3>
            <select id="clock-loc" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 text-base font-medium">
                <option value="A">æµ·å¸•æ–¯ç§‘æŠ€ (å®‰å®šå€)</option>
                <option value="B">HYPASS BOSS (å–„åŒ–å€)</option>
            </select>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="clock('ä¸Šç­')" class="bg-emerald-500 text-white py-6 rounded-2xl font-bold shadow-md active:scale-95 transition-all">ä¸Šç­</button>
                <button onclick="clock('ä¸‹ç­')" class="bg-rose-500 text-white py-6 rounded-2xl font-bold shadow-md active:scale-95 transition-all">ä¸‹ç­</button>
            </div>
            <div class="mt-4 text-center"><span id="gps-status" class="text-[10px] bg-slate-100 text-slate-500 px-3 py-1 rounded-full">ğŸ“ ç³»çµ±è‡ªå‹•é©—è­‰åœæ¬„</span></div>
        </section>

        <section class="grid grid-cols-2 gap-4 mb-4">
            <div onclick="openLeaveModal()" class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 text-center active:scale-95 transition-all cursor-pointer">
                <span class="text-2xl block mb-2">ğŸ“</span>
                <h4 class="font-bold text-sm text-slate-700">å‡å–®ç”³è«‹</h4>
                <p class="text-[10px] text-slate-400 mt-1">ç‰¹ä¼‘ / äº‹ç—…å‡</p>
            </div>
            <div onclick="alert('è–ªè³‡æ¨¡çµ„é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼')" class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 text-center active:scale-95 transition-all cursor-pointer">
                <span class="text-2xl block mb-2">ğŸ’°</span>
                <h4 class="font-bold text-sm text-slate-700">è–ªè³‡æ˜ç´°</h4>
                <p class="text-[10px] text-slate-400 mt-1">ç•¶æœˆçµç®—è¡¨</p>
            </div>
        </section>
        
        <section onclick="alert('è¦ç« ç³»çµ±é–‹ç™¼ä¸­ï¼')" class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 text-center active:scale-95 cursor-pointer mb-8">
            <span class="font-bold text-sm text-slate-700">ğŸ“– æŸ¥é–±å…¬å¸è¦ç« èˆ‡ä¿å¯†å”å®š</span>
        </section>
    </div>

    <div id="leave-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex flex-col justify-end">
        <div class="bg-white rounded-t-3xl p-6 pb-10 w-full max-h-[85vh] overflow-y-auto animate-[slideUp_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">å¡«å¯«å‡å–®</h2>
                <button onclick="closeLeaveModal()" class="text-slate-400 text-2xl font-bold px-2">&times;</button>
            </div>
            <div class="space-y-4 text-sm font-medium">
                <div>
                    <label class="block mb-1 text-slate-600">è«‹å‡é¡åˆ¥</label>
                    <select id="leave-type" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl">
                        <option value="ç‰¹ä¼‘">ç‰¹ä¼‘ (å¹´è³‡å‡)</option>
                        <option value="äº‹å‡">äº‹å‡</option>
                        <option value="ç—…å‡">ç—…å‡</option>
                        <option value="é¢±é¢¨å‡">é¢±é¢¨å‡</option>
                    </select>
                </div>
                <div><label class="block mb-1 text-slate-600">é–‹å§‹æ™‚é–“</label><input type="datetime-local" id="leave-start" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></div>
                <div><label class="block mb-1 text-slate-600">çµæŸæ™‚é–“</label><input type="datetime-local" id="leave-end" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></div>
                <div><label class="block mb-1 text-slate-600">è«‹å‡äº‹ç”± (é¸å¡«)</label><textarea id="leave-reason" rows="2" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl"></textarea></div>
                <button onclick="submitLeave()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg mt-6 active:scale-95 transition-all">é€å‡ºç”³è«‹</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>

    <script>
        // âš ï¸ ã€è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„çœŸå¯¦é€£ç·šè³‡è¨Šã€‘ âš ï¸
        const SB_URL = 'https://obbcgmgkbazwpfvgbupg.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'; 
        const LIFF_ID = '2009136875-gs1Va90A';
        // ==========================================

        const _db = supabase.createClient(SB_URL, SB_KEY);
        let userLineId = "";
        let currentUser = null;

        async function initApp() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) liff.login();
                else {
                    const profile = await liff.getProfile();
                    userLineId = profile.userId;
                    const { data, error } = await _db.from('profiles').select('*').eq('line_id', userLineId).single();
                    document.getElementById('loading').style.display = 'none';

                    if (data) {
                        currentUser = data;
                        document.getElementById('app-view').classList.remove('hidden');
                        document.getElementById('user-info').innerText = `æ‚¨å¥½ï¼Œ${data.full_name}`;
                        if(data.default_location) document.getElementById('clock-loc').value = data.default_location;
                    } else {
                        document.getElementById('register-view').classList.remove('hidden');
                    }
                }
            } catch (err) {
                document.getElementById('loading').innerHTML = `<p class="text-rose-500 font-bold">é€£ç·šç•°å¸¸</p>`;
            }
        }

        async function submitRegistration() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const date = document.getElementById('reg-date').value;
            const loc = document.getElementById('reg-loc').value;
            const bank = document.getElementById('reg-bank').value;

            if(!name || !phone || !email || !date || !bank) return alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«è³‡æ–™ï¼");
            document.getElementById('loading').style.display = 'flex';

            const { error } = await _db.from('profiles').insert([{ line_id: userLineId, full_name: name, phone: phone, email: email, onboard_date: date, default_location: loc, bank_account: bank }]);
            
            if (error) { document.getElementById('loading').style.display = 'none'; alert("å»ºæª”å¤±æ•—ï¼š" + error.message); } 
            else { alert("å»ºæª”æˆåŠŸï¼"); location.reload(); }
        }

        function clock(type) {
            if (!navigator.geolocation) return alert("è¨­å‚™ä¸æ”¯æ´ GPS å®šä½");
            document.getElementById('gps-status').innerText = "ğŸ“ GPS å®šä½èˆ‡åœæ¬„é©—è­‰ä¸­...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { error } = await _db.from('attendance').insert([{ user_id: currentUser.id, clock_type: type, location_id: document.getElementById('clock-loc').value, u_lat: pos.coords.latitude, u_lng: pos.coords.longitude }]);
                if (!error) {
                    alert(`ã€${type}ã€‘æ‰“å¡æˆåŠŸï¼`);
                    document.getElementById('gps-status').innerText = `âœ… æœ€å¾Œæ‰“å¡æ™‚é–“ï¼š${new Date().toLocaleTimeString()}`;
                } else alert("æ‰“å¡å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¯„åœæˆ–ç¶²è·¯ã€‚");
            }, () => alert("ç„¡æ³•å–å¾—ä½ç½®"), { enableHighAccuracy: true });
        }

        // --- æ–°å¢ï¼šè«‹å‡è¦–çª—é–‹é—œé‚è¼¯ ---
        function openLeaveModal() { document.getElementById('leave-modal').classList.remove('hidden'); }
        function closeLeaveModal() { document.getElementById('leave-modal').classList.add('hidden'); }

        // --- æ–°å¢ï¼šé€å‡ºå‡å–®é‚è¼¯ ---
        async function submitLeave() {
            const type = document.getElementById('leave-type').value;
            const start = document.getElementById('leave-start').value;
            const end = document.getElementById('leave-end').value;
            const reason = document.getElementById('leave-reason').value;

            if(!start || !end) return alert("è«‹é¸æ“‡è«‹å‡çš„é–‹å§‹èˆ‡çµæŸæ™‚é–“ï¼");

            document.getElementById('loading').style.display = 'flex';

            const { error } = await _db.from('leave_requests').insert([{
                user_id: currentUser.id,
                leave_type: type,
                start_time: start,
                end_time: end,
                reason: reason
            }]);

            document.getElementById('loading').style.display = 'none';

            if (error) {
                alert("ç”³è«‹å¤±æ•—ï¼š" + error.message);
            } else {
                alert("å‡å–®å·²é€å‡ºï¼ç³»çµ±å°‡å³æ™‚é€šçŸ¥è€é—†å¯©æ ¸ã€‚");
                closeLeaveModal();
            }
        }

        initApp();
    </script>
</body>
</html>

