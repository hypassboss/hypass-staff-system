<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | ç³»çµ±å…¥å£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>body { background: #f8fafc; font-family: 'PingFang TC', sans-serif; } input:focus, select:focus { outline: 2px solid #38bdf8; } .glass-card { background: rgba(255, 255, 255, 0.98); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.8); } .select-arrow { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-size: 1.5em 1.5em; background-position: right 0.5rem center; background-repeat: no-repeat; padding-right: 2rem; }</style>
</head>
<body class="text-slate-800">
    <div id="sys-loading" class="flex flex-col items-center justify-center min-h-screen text-center">
        <h1 class="text-3xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-indigo-600 mb-6 animate-pulse">HYPASS</h1>
        <div class="animate-spin h-10 w-10 border-4 border-sky-600 border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-sm text-slate-500 font-bold tracking-widest uppercase">å®‰å…¨é©—è­‰èˆ‡æ¨¡çµ„è¼‰å…¥ä¸­...</p>
    </div>

    <div id="sys-pending" class="hidden flex flex-col items-center justify-center min-h-screen text-center p-5"><div class="p-8 bg-white rounded-3xl shadow-xl w-full max-w-sm"><div class="text-6xl mb-6 grayscale opacity-50">â³</div><h2 class="text-2xl font-black text-slate-800 mb-2">å¸³è™Ÿå¯©æ ¸ä¸­</h2><p class="text-sm text-slate-500 font-medium">è«‹é€šçŸ¥ä¸»ç®¡é–‹é€šæ¬Šé™ã€‚</p></div></div>

    <div id="view-onboarding" class="hidden p-5 max-w-md mx-auto min-h-screen pt-10"><div class="glass-card p-6 rounded-3xl shadow-xl"><h2 class="text-xl font-black mb-6 text-center text-slate-800">ğŸ‘‹ æ­¡è¿åŠ å…¥ï¼å»ºç«‹å“¡å·¥æª”æ¡ˆ</h2>
        <form id="onboarding-form" class="space-y-4">
            <div class="grid grid-cols-3 gap-3"><div class="col-span-2"><input type="text" name="full_name" placeholder="çœŸå¯¦å§“å" required class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner"></div><div class="col-span-1"><select name="job_title" required class="w-full p-3 bg-sky-50 text-sky-800 rounded-xl text-sm font-black border-0 shadow-inner select-arrow"><option value="" disabled selected>è·ä½</option><option value="ä¸»ç®¡">ä¸»ç®¡</option><option value="æ¥­å‹™">æ¥­å‹™</option><option value="åŠ©ç†">åŠ©ç†</option></select></div></div>
            <div><input type="text" name="id_number" placeholder="èº«åˆ†è­‰å­—è™Ÿ" required class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner uppercase"></div>
            <div class="grid grid-cols-2 gap-3"><input type="email" name="email" placeholder="é›»å­ä¿¡ç®±" required class="p-3 bg-slate-50 rounded-xl text-sm border-0 shadow-inner"><input type="tel" name="phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" required class="p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner"></div>
            <div class="bg-slate-50 p-1 rounded-xl shadow-inner border border-slate-100"><label class="text-[10px] font-bold text-slate-400 ml-2 mt-1 block">è«‹é¸æ“‡æ‰€å±¬å·¥ä½œæ‰“å¡æ“šé»</label><select name="default_branch_id" id="reg-branch" required class="w-full p-3 bg-transparent text-base font-black text-slate-700 border-0 outline-none select-arrow"></select></div>
            <div><label class="text-[10px] font-bold text-slate-500 ml-1 mb-0.5 block">å…¥è·æ—¥æœŸ</label><input type="date" name="onboarding_date" required class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner"></div>
            <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100 shadow-inner"><label class="text-[10px] font-bold text-slate-500 ml-1 mb-1 block">é€šè¨Šåœ°å€</label><div class="grid grid-cols-2 gap-2 mb-2"><select id="addr-county" class="w-full p-2.5 bg-white rounded-xl text-sm font-bold border shadow-sm outline-none select-arrow" required onchange="updateDistricts()"><option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option></select><select id="addr-district" class="w-full p-2.5 bg-white rounded-xl text-sm font-bold border shadow-sm outline-none select-arrow" required><option value="" disabled selected>é„‰é®å¸‚å€</option></select></div><input type="text" id="addr-street" placeholder="è©³ç´°è¡—é“èˆ‡é–€ç‰Œ" required class="w-full p-2.5 bg-white rounded-xl text-sm border shadow-sm outline-none"></div>
            <div class="p-4 bg-emerald-50/80 rounded-2xl border border-emerald-100"><h3 class="text-xs font-black text-emerald-800 mb-3 flex items-center"><span class="text-base mr-1">ğŸ’°</span>è²¡å‹™èˆ‡ä¿éšªè³‡æ–™</h3><div class="mb-3"><select id="bank-select" required class="w-full p-2.5 text-sm font-bold border shadow-sm rounded-xl bg-white outline-none select-arrow"><option value="" disabled selected>è«‹é¸æ“‡æ’¥è–ªéŠ€è¡Œ</option><option value="004 å°ç£éŠ€è¡Œ">004 å°ç£éŠ€è¡Œ</option><option value="822 ä¸­åœ‹ä¿¡è¨—">822 ä¸­åœ‹ä¿¡è¨—</option><option value="013 åœ‹æ³°ä¸–è¯">013 åœ‹æ³°ä¸–è¯</option><option value="012 å°åŒ—å¯Œé‚¦">012 å°åŒ—å¯Œé‚¦</option><option value="812 å°æ–°éŠ€è¡Œ">812 å°æ–°éŠ€è¡Œ</option><option value="006 åˆä½œé‡‘åº«">006 åˆä½œé‡‘åº«</option></select></div><div class="grid grid-cols-2 gap-3 mb-3"><input type="text" name="bank_user_name" placeholder="å­˜æ‘ºæˆ¶å" required class="p-2.5 text-sm border shadow-sm rounded-xl bg-white"><input type="text" name="bank_account" placeholder="éŠ€è¡Œå¸³è™Ÿ" required class="p-2.5 text-sm border shadow-sm rounded-xl bg-white font-bold tracking-wider"></div><div class="flex justify-between items-center border-t border-emerald-200/50 pt-3"><span class="text-sm font-bold text-emerald-900">å¥ä¿çœ·å±¬åŠ ä¿äººæ•¸</span><select name="dependents_count" required class="w-24 p-2 text-center text-sm font-black border shadow-sm rounded-xl bg-white outline-none select-arrow"><option value="0">0 äºº</option><option value="1">1 äºº</option><option value="2">2 äºº</option></select></div></div>
            <div class="grid grid-cols-2 gap-3"><input type="text" name="emergency_name" placeholder="ç·Šæ€¥è¯çµ¡äºº" required class="p-3 bg-slate-50 border-0 shadow-inner rounded-xl text-sm font-bold"><input type="tel" name="emergency_phone" placeholder="è¯çµ¡äººé›»è©±" required class="p-3 bg-slate-50 border-0 shadow-inner rounded-xl text-sm font-bold"></div>
            <div class="bg-slate-100 p-4 rounded-2xl mt-5 border border-slate-200 shadow-inner"><h3 class="text-sm font-black text-slate-800 mb-3 flex items-center"><span class="text-lg mr-1.5">âš–ï¸</span>è˜åƒ±åˆç´„èˆ‡æœå‹™å®ˆå‰‡</h3><div class="text-[11px] text-slate-700 leading-relaxed h-32 overflow-y-auto bg-white p-3 rounded-xl border border-slate-200 mb-4 shadow-sm select-none"><li>æ‰“å¡ä¾æ“šGPSå®šä½ï¼Œç„¡è·é›¢é™åˆ¶é™åˆ¶ã€‚</li><li>å¿˜è¨˜æ‰“å¡éœ€æ–¼ç³»çµ±è£œç™»ï¼Œæ¯æœˆä¸Šé™3æ¬¡ã€‚</li><li>ä¿å¯†å”å®š(NDA)é•ç´„é‡‘å£¹ä½°è¬å…ƒæ•´ã€‚</li></div><div class="space-y-3 bg-white p-3 rounded-xl border border-slate-200"><label class="flex items-start space-x-3 cursor-pointer"><input type="checkbox" id="chk1" onchange="checkForm()" class="mt-0.5 h-4 w-4 rounded text-sky-600 focus:ring-sky-500"><span class="text-[11px] font-bold text-slate-800 leading-tight">åŒæ„ç³»çµ±ä»¥ GPS å®šä½ç‚ºè€ƒå‹¤å”¯ä¸€ä¾æ“šï¼Œ<strong class="text-red-600">é²åˆ°æˆ–è£œç™»ä¾è¦å®šè¾¦ç†ã€‚</strong></span></label><label class="flex items-start space-x-3 cursor-pointer"><input type="checkbox" id="chk2" onchange="checkForm()" class="mt-0.5 h-4 w-4 rounded text-sky-600 focus:ring-sky-500"><span class="text-[11px] font-bold text-slate-800 leading-tight">åŒæ„åš´å®ˆä¼æ¥­ä¿å¯†å”å®š(NDA)ï¼Œå¦‚æœ‰é•é¡˜è² æ“”<strong class="text-red-600">æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</strong></span></label></div></div>
            <button type="submit" id="btn-submit" disabled class="w-full bg-gradient-to-r from-sky-500 to-indigo-600 disabled:from-slate-300 disabled:to-slate-400 text-white font-black py-4 rounded-2xl mt-4 transition-all shadow-lg text-sm tracking-wider active:scale-95">æ•¸ä½ç°½ç½²ä¸¦æäº¤å¯©æ ¸</button>
        </form>
    </div></div>

    <script src="shared.js"></script>
    <script>
        function checkForm() { document.getElementById('btn-submit').disabled = !(document.getElementById('chk1').checked && document.getElementById('chk2').checked); }
        function initAddressForm() { const countySel = document.getElementById('addr-county'); if(countySel) { let opts = '<option value="" disabled selected>é¸æ“‡ç¸£å¸‚</option>'; for(let c in window.twAddrs) opts += `<option value="${c}">${c}</option>`; countySel.innerHTML = opts; } }
        function updateDistricts() { const c = document.getElementById('addr-county').value; const distSel = document.getElementById('addr-district'); if(c && window.twAddrs[c]) { distSel.innerHTML = '<option value="" disabled selected>é„‰é®å¸‚å€</option>' + window.twAddrs[c].map(d => `<option value="${d}">${d}</option>`).join(''); } }
        async function boot() {
            const user = await authGuard('index');
            if(user === true) { window.location.replace('app_hr.html'); }
            else if(user) { document.getElementById('sys-loading').classList.add('hidden'); document.getElementById('sys-pending').classList.remove('hidden'); }
            else { 
                document.getElementById('sys-loading').classList.add('hidden'); document.getElementById('view-onboarding').classList.remove('hidden'); 
                const { data } = await window._sb.from('branch_locations').select('id, branch_name').eq('is_active', true); 
                document.getElementById('reg-branch').innerHTML = data.map(b => `<option value="${b.id}">${b.branch_name}</option>`).join(''); initAddressForm();
            }
        }
        document.getElementById('onboarding-form').onsubmit = async (e) => {
            e.preventDefault(); document.getElementById('btn-submit').innerText = 'è³‡æ–™åŠ å¯†ä¸Šå‚³ä¸­...'; 
            const fd = new FormData(e.target); const payload = Object.fromEntries(fd.entries());
            payload.address = document.getElementById('addr-county').value + document.getElementById('addr-district').value + document.getElementById('addr-street').value;
            payload.bank_code = document.getElementById('bank-select').value.split(' ')[0]; payload.bank_name = document.getElementById('bank-select').value.split(' ')[1];
            payload.line_id = (await liff.getProfile()).userId; payload.dependents_count = parseInt(payload.dependents_count) || 0;
            const { data, error } = await window._sb.from('employees').insert([payload]).select(); 
            if(error) { alert(error.message); document.getElementById('btn-submit').innerText = 'æ•¸ä½ç°½ç½²ä¸¦æäº¤å¯©æ ¸'; } 
            else { await window._sb.functions.invoke('line-webhook', { body: { action: 'notify_signup', id: data[0].id, name: payload.full_name, role: payload.job_title }}); location.reload(); }
        };
        window.onload = boot;
    </script>
</body>
</html>
