<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypass 管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">載入中...</div>

    <div id="app" class="hidden min-h-screen p-6">
        <h1 class="text-2xl font-bold mb-4 text-center">海帕斯員工系統 (@034qvauh)</h1>
        <div class="bg-white p-6 rounded-3xl shadow-xl mb-6">
            <p id="user-info" class="text-blue-600 font-bold mb-4 text-center"></p>
            <label class="block text-xs text-gray-400 font-bold mb-2">打卡地點</label>
            <select id="loc" class="w-full p-4 border rounded-2xl mb-4 text-lg">
                <option value="A">海帕斯科技 (安定區)</option>
                <option value="B">HYPASS BOSS (善化區)</option>
            </select>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="clock('上班')" class="bg-emerald-500 text-white p-8 rounded-3xl font-bold text-xl shadow-lg">上班打卡</button>
                <button onclick="clock('下班')" class="bg-rose-500 text-white p-8 rounded-3xl font-bold text-xl shadow-lg">下班打卡</button>
            </div>
        </div>
        <p class="text-center text-[10px] text-gray-400 italic">系統會自動驗證 100m 以內之地理圍欄</p>
    </div>

    <script>
        // --- 核心連線設定 (嚴格修正引號與變數名) ---
        const SB_URL = 'https://obbcgmgkbazwpfvgbupg.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0';
        // 使用 _db 作為實例名稱，徹底避開 supabase 關鍵字衝突
        const _db = supabase.createClient(SB_URL, SB_KEY);

        let user = null;

        async function init() {
            try {
                // 初始化 LIFF
                await liff.init({ liffId: "2009136875-gs1Va90A" });
                
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                } else {
                    const profile = await liff.getProfile();
                    // 查詢員工資料
                    const { data, error } = await _db
                        .from('profiles')
                        .select('*')
                        .eq('line_id', profile.userId)
                        .single();
                    
                    document.getElementById('loading').style.display = 'none';

                    if (data) {
                        user = data;
                        document.getElementById('app').classList.remove('hidden');
                        document.getElementById('user-info').innerText = `你好，${data.full_name}`;
                    } else {
                        // 初次註冊
                        const name = prompt("首次登入，請輸入真實姓名：");
                        if(name) {
                            const { error: regError } = await _db
                                .from('profiles')
                                .insert([{ line_id: profile.userId, full_name: name }]);
                            
                            if (regError) alert("註冊失敗：" + regError.message);
                            else location.reload();
                        }
                    }
                }
            } catch (err) {
                console.error(err);
                document.getElementById('loading').innerText = "系統連線異常";
            }
        }

        function clock(type) {
            if (!navigator.geolocation) return alert("手機不支援 GPS");

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { error } = await _db.from('attendance').insert([{
                    user_id: user.id,
                    clock_type: type,
                    location_id: document.getElementById('loc').value,
                    u_lat: pos.coords.latitude,
                    u_lng: pos.coords.longitude
                }]);

                if (!error) alert(type + " 成功！");
                else alert("打卡失敗，請確認是否已授權 GPS 位置");
            }, (geoErr) => {
                alert("無法取得位置，請確保 GPS 已開啟並授權");
            });
        }

        init();
    </script>
</body>
</html>

