<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | ä¼æ¥­å“¡å·¥å°ˆå€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* å…¨å±€æ¨£å¼è¨­å®š */
        body { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); -webkit-tap-highlight-color: transparent; }
        /* è¦–åœ–åˆ‡æ›å‹•ç•« */
        .app-view { display: none; } .app-view.active { display: block; animation: fadeIn 0.3s ease; }
        /* æ¯›ç»ç’ƒå¡ç‰‡æ•ˆæœ - å„ªåŒ–é‚Šè· */
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        /* åº•éƒ¨å°èˆªæ¿€æ´»ç‹€æ…‹ */
        .nav-item.active { color: #0284c7; transform: translateY(-2px); }
        .nav-item.active .nav-icon { transform: scale(1.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        /* å‹•ç•«èˆ‡æ»¾å‹•æ¢éš±è— */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: none; } .modal.active { display: flex; animation: fadeIn 0.2s ease; z-index: 100; }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 font-sans min-h-screen pb-20"> <header class="bg-slate-900 text-white px-4 py-3 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div><h1 class="text-xl font-black italic uppercase tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-indigo-300">Hypass</h1><span class="text-[9px] tracking-[0.2em] text-slate-400">ENTERPRISE</span></div>
        <div id="user-status" class="text-[10px] font-bold bg-white/10 px-3 py-1 rounded-full border border-white/10 backdrop-blur-md flex items-center"><span class="inline-block w-1.5 h-1.5 bg-emerald-400 rounded-full mr-1.5 animate-pulse"></span>é€£ç·šä¸­...</div>
    </header>

    <main class="container mx-auto p-3 max-w-md"> <div id="sys-loading" class="text-center py-32 active-view"><div class="animate-spin h-8 w-8 border-4 border-sky-600 border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-xs text-slate-500 font-bold tracking-widest">SYSTEM LOADING...</p></div>
        <div id="sys-pending" class="text-center py-24 hidden"><div class="text-5xl mb-4 grayscale">â³</div><h2 class="text-xl font-black text-slate-700">å¯©æ ¸ä¸­</h2><p class="text-xs text-slate-500 mt-2">è«‹è€å¿ƒç­‰å€™ç®¡ç†å“¡é–‹é€šæ¬Šé™ã€‚</p></div>

        <div id="view-onboarding" class="hidden glass-card p-5 rounded-2xl shadow-xl">
             <p class="text-center text-red-500">è«‹è²¼ä¸Šå®Œæ•´çš„å»ºæª”è¡¨å–® HTML ä»£ç¢¼</p>
        </div>

        <div id="view-dashboard" class="hidden space-y-3">
            
            <div id="tab-home" class="app-view active space-y-3">
                <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-100/50 p-3 rounded-xl shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-1 -mr-1 text-amber-100 text-4xl opacity-50">ğŸ“¢</div>
                    <div class="flex items-center space-x-1.5 mb-1.5"><span class="text-sm">ğŸ””</span><h4 class="text-[10px] font-black text-amber-800 uppercase tracking-wider">æœ€æ–°å…¬å‘Š</h4></div>
                    <div id="ui-bulletin" class="text-xs font-medium text-slate-700 leading-relaxed line-clamp-2 pl-6">è¼‰å…¥ä¸­...</div>
                </div>

                <div class="bg-gradient-to-br from-slate-900 to-indigo-950 p-5 rounded-2xl text-white shadow-xl relative overflow-hidden">
                    <div class="absolute -bottom-4 -right-4 text-indigo-800/30 text-8xl">ğŸï¸</div>
                    <h3 id="ui-name" class="text-2xl font-black tracking-tight">--</h3>
                    <p id="ui-tenure" class="text-[10px] text-indigo-200 font-bold mb-4 tracking-wider opacity-80">ğŸ•’ å…¥è·æ—¥è¼‰å…¥ä¸­</p>
                    <div class="flex justify-between items-end bg-white/5 p-3 rounded-xl border border-white/10 backdrop-blur-sm relative z-10">
                        <span class="text-[10px] font-bold text-indigo-200 tracking-widest uppercase">æ³•å®šç‰¹ä¼‘é¤˜é¡</span>
                        <span id="ui-leave" class="text-xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-indigo-200">-- å¤© -- å°æ™‚</span>
                    </div>
                </div>

                <div class="glass-card p-4 rounded-2xl shadow-sm">
                    <button onclick="loadPunchHistory()" class="w-full mb-3 text-[11px] font-bold text-sky-700 bg-sky-50/80 border border-sky-100 py-2.5 rounded-xl transition hover:bg-sky-100 flex items-center justify-center space-x-1"><span>ğŸ”</span><span>æŸ¥è©¢è¿‘æœŸç´€éŒ„</span></button>
                    <select id="punch-branch" class="w-full mb-3 text-xs font-bold bg-white/80 text-slate-700 border border-slate-200 rounded-xl p-2.5 outline-none appearance-none text-center tracking-wide"></select>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="punch('IN')" class="bg-gradient-to-b from-sky-500 to-sky-600 border border-sky-400/50 text-white py-8 rounded-2xl font-black text-lg shadow-md active:scale-95 active:shadow-none transition-all flex flex-col items-center justify-center"><span class="text-2xl block mb-1 drop-shadow">ğŸ¢</span>ä¸Šç­</button>
                        <button onclick="punch('OUT')" class="bg-gradient-to-b from-white to-slate-50 text-slate-600 border border-slate-200 py-8 rounded-2xl font-black text-lg shadow-sm active:scale-95 active:shadow-none transition-all flex flex-col items-center justify-center"><span class="text-2xl block mb-1 grayscale opacity-75">ğŸ </span>ä¸‹ç­</button>
                    </div>
                </div>
            </div>

            <div id="tab-leave" class="app-view space-y-3">
                <h3 class="font-black text-lg text-slate-900 border-l-4 border-amber-500 pl-2">ç·šä¸Šè«‹å‡</h3>
                <div class="glass-card p-5 rounded-2xl shadow-sm">
                    <p class="text-center text-red-500">è«‹è²¼ä¸Šå®Œæ•´çš„è«‹å‡è¡¨å–® HTML ä»£ç¢¼</p>
                </div>
            </div>

            <div id="tab-payroll" class="app-view space-y-3">
                <h3 class="font-black text-lg text-slate-900 border-l-4 border-emerald-500 pl-2">è–ªè³‡æ˜ç´°</h3>
                <div class="glass-card p-5 rounded-2xl space-y-3 shadow-sm min-h-[300px]">
                    <div class="relative">
                        <select id="payroll-month" onchange="loadPayrollDetail()" class="w-full bg-emerald-50/80 text-emerald-900 font-bold border border-emerald-200 p-2.5 rounded-xl text-sm outline-none appearance-none pr-8 relative z-10"></select>
                        <span class="absolute right-3 top-3 text-emerald-700 text-xs z-0">â–¼</span>
                    </div>
                    
                    <div id="ui-payroll-detail" class="space-y-2 pt-2 animate-pulse">
                        <div class="text-center text-xs text-slate-400 py-10">æ­£åœ¨å®‰å…¨è¼‰å…¥è–ªè³‡è³‡æ–™...</div>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="app-view space-y-3">
                <h3 class="font-black text-lg text-slate-900 border-l-4 border-slate-400 pl-2">åŸºæœ¬è³‡æ–™</h3>
                <div class="glass-card p-5 rounded-2xl shadow-sm space-y-4">
                    <p class="text-center text-red-500">è«‹è²¼ä¸Šå®Œæ•´çš„åŸºæœ¬è³‡æ–™ HTML ä»£ç¢¼</p>
                </div>
            </div>

            <nav class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200/60 flex justify-around items-end pt-2 pb-5 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center w-16 text-slate-400 transition-colors duration-300 group">
                    <span class="nav-icon text-xl mb-0.5 transition-transform duration-300 group-active:scale-90">ğŸ </span><span class="text-[9px] font-bold tracking-widest">æ‰“å¡</span>
                </button>
                <button onclick="switchTab('leave')" class="nav-item flex flex-col items-center w-16 text-slate-400 transition-colors duration-300 group">
                    <span class="nav-icon text-xl mb-0.5 transition-transform duration-300 group-active:scale-90">ğŸ“…</span><span class="text-[9px] font-bold tracking-widest">è«‹å‡</span>
                </button>
                <button onclick="switchTab('payroll')" class="nav-item flex flex-col items-center w-16 text-slate-400 transition-colors duration-300 group">
                    <span class="nav-icon text-xl mb-0.5 transition-transform duration-300 group-active:scale-90">ğŸ’°</span><span class="text-[9px] font-bold tracking-widest">è–ªè³‡</span>
                </button>
                <button onclick="switchTab('profile')" class="nav-item flex flex-col items-center w-16 text-slate-400 transition-colors duration-300 group">
                    <span class="nav-icon text-xl mb-0.5 transition-transform duration-300 group-active:scale-90">ğŸ‘¤</span><span class="text-[9px] font-bold tracking-widest">è³‡æ–™</span>
                </button>
            </nav>
        </div>
    </main>

    <div id="record-modal" class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm items-end justify-center"><div class="bg-white w-full max-w-md rounded-t-3xl p-5 h-[70vh] flex flex-col"><div class="flex justify-between items-center mb-3"><h3 class="font-black text-base">è¿‘æœŸæ‰“å¡ç´€éŒ„</h3><button onclick="closeModal('record-modal')" class="bg-slate-100 p-2 rounded-full text-xs font-bold text-slate-500">âœ•</button></div><div id="ui-records-list" class="overflow-y-auto space-y-2 flex-1 no-scrollbar pb-4">è¼‰å…¥ä¸­...</div></div></div>
    <div id="doc-modal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-md items-center justify-center p-4"><div class="bg-white w-full max-w-md rounded-2xl p-5 relative max-h-[80vh] flex flex-col"><h3 id="doc-title" class="font-black text-base border-b pb-2 mb-3">æ–‡ä»¶</h3><div class="overflow-y-auto flex-1 text-xs text-slate-600 leading-relaxed space-y-2 mb-3"><p>1. å“¡å·¥çµ•å°æœå¾å…¬å¸è€ƒå‹¤è¦å®šï¼Œä»¥ç³»çµ±å®šä½ç‚ºå”¯ä¸€ä¾æ“šã€‚</p><p>2. å“¡å·¥åŒæ„é²åˆ°æ™‚æ•¸ç”±ç³»çµ±è‡ªå‹•ä»¥ç‰¹ä¼‘æŠµæ‰£ä»¥ç¶­æŒå…¨è–ªã€‚</p><p>3. å“¡å·¥å°æ–¼å…¬å¸å®¢æˆ¶åå–®ã€æŠ€è¡“ã€è²¡å‹™å…·çµ•å°ä¿å¯†ç¾©å‹™ï¼Œè‹¥æœ‰æ´©æ¼é¡˜è² æ“”æ–°å°å¹£å£¹ç™¾è¬å…ƒæ•´ä¹‹æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</p><p class="text-center mt-4 text-slate-400 text-[10px]">(æ•¸ä½å­˜è­‰å‰¯æœ¬ï¼Œæ­£æœ¬å­˜æ–¼ä¼ºæœå™¨)</p></div><div class="bg-amber-50 border border-amber-100 p-3 rounded-xl text-center"><p class="text-[9px] text-amber-700 font-bold mb-0.5">âœ”ï¸ ç¶“æ•¸ä½ç°½ç« èªè­‰ï¼Œå…·å‚™æ³•å¾‹æ•ˆåŠ›</p><p id="doc-sig" class="font-black text-amber-900 text-[10px]">ç°½ç½²äººï¼š--</p></div><button onclick="closeModal('doc-modal')" class="w-full mt-3 bg-slate-900 text-white font-bold py-2.5 rounded-xl text-sm">é—œé–‰</button></div></div>


    <script>
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„é‡‘é‘°
        const SUPABASE_URL = 'https://obbcgmgkbazwpfvgbupg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'; 
        const LIFF_ID = '2009148826-RoogHmxk';

        // ... (å…¶é¤˜ JavaScript å‡½å¼å¦‚ init, checkUser ç­‰ä¿æŒä¸è®Šï¼Œè«‹ä½¿ç”¨ä¸Šä¸€ç‰ˆå®Œæ•´ä»£ç¢¼) ...
        // ... é€™è£¡çœç•¥é‡è¤‡çš„ JS ä»£ç¢¼ä»¥ç¯€çœç¯‡å¹… ...

        // âœ… é‡é»ä¿®æ”¹ï¼šè–ªè³‡è¼‰å…¥é‚è¼¯ (è‡ªå‹•é¸æ“‡ç¬¬ä¸€é …ä¸¦è¼‰å…¥)
        async function loadPayrollMonths() {
            const sel = document.getElementById('payroll-month');
            const detailContainer = document.getElementById('ui-payroll-detail');
            
            sel.disabled = true; // è¼‰å…¥æ™‚é–å®š
            
            const { data } = await _sb.from('payroll_records')
                .select('pay_month')
                .eq('employee_id', currentUser.id)
                .order('pay_month', {ascending: false});

            if(!data || data.length === 0) { 
                sel.innerHTML = '<option>å°šç„¡è–ªè³‡ç´€éŒ„</option>'; 
                detailContainer.innerHTML = '<div class="text-center text-xs text-slate-400 py-10">ç›®å‰æ²’æœ‰è–ªè³‡è³‡æ–™</div>';
                detailContainer.classList.remove('animate-pulse');
                return; 
            }

            // å¡«å…¥é¸é …
            sel.innerHTML = data.map(m => `<option value="${m.pay_month}">${m.pay_month} è–ªè³‡æ˜ç´°</option>`).join('');
            sel.disabled = false; // è§£é–

            // ğŸŒŸ é—œéµä¿®æ”¹ï¼šè‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹æœˆä»½ï¼Œä¸¦ç«‹å³è§¸ç™¼è¼‰å…¥æ˜ç´°
            sel.selectedIndex = 0; 
            loadPayrollDetail(); 
        }

        // âœ… é‡é»ä¿®æ”¹ï¼šè–ªè³‡æ˜ç´°æ¸²æŸ“ (å„ªåŒ–è¦–è¦ºèˆ‡å‹•ç•«)
        async function loadPayrollDetail() {
            const month = document.getElementById('payroll-month').value;
            const detailContainer = document.getElementById('ui-payroll-detail');
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            detailContainer.innerHTML = '<div class="text-center text-xs text-slate-400 py-6">æ­£åœ¨è®€å–æ•¸æ“š...</div>';
            detailContainer.classList.add('animate-pulse');

            const { data } = await _sb.from('payroll_records')
                .select('*')
                .eq('employee_id', currentUser.id)
                .eq('pay_month', month)
                .single();
                
            detailContainer.classList.remove('animate-pulse'); // ç§»é™¤è¼‰å…¥å‹•ç•«

            if(!data) {
                detailContainer.innerHTML = '<div class="text-center text-xs text-red-400 py-6">è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
                return;
            }

            // æ¸²æŸ“æ˜ç´° (ä½¿ç”¨æ›´ç·Šæ¹Šçš„æ’ç‰ˆ)
            detailContainer.innerHTML = `
                <div class="bg-white/50 rounded-xl p-3 border border-slate-100 space-y-2 text-xs">
                    <div class="flex justify-between"><span class="font-bold text-slate-500">æœ¬è–ª</span><span class="font-black">NT$ ${data.base_pay.toLocaleString()}</span></div>
                    <div class="flex justify-between"><span class="font-bold text-slate-500">çé‡‘æ´¥è²¼</span><span class="font-black text-emerald-600">+ NT$ ${data.bonus.toLocaleString()}</span></div>
                    ${data.year_end_bonus > 0 ? `<div class="flex justify-between"><span class="font-bold text-slate-500">å¹´çµ‚çé‡‘</span><span class="font-black text-emerald-600">+ NT$ ${data.year_end_bonus.toLocaleString()}</span></div>` : ''}
                </div>
                <div class="bg-red-50/50 rounded-xl p-3 border border-red-100 space-y-2 text-xs">
                     <div class="flex justify-between items-center"><span class="font-bold text-slate-500">å‹å¥ä¿è‡ªä»˜é¡</span><span class="font-black text-red-500">- NT$ ${data.insurance_deduction.toLocaleString()}</span></div>
                     <div class="flex justify-between items-center text-[10px] opacity-70"><span class="font-bold text-slate-400">å‹é€€ææ’¥ (å…¬å¸è² æ“”6%)</span><span class="font-black text-slate-400">(${data.labor_pension.toLocaleString()})</span></div>
                </div>
                <div class="flex justify-between pt-2 items-end px-2">
                    <span class="text-xs font-black text-slate-700">æœ¬æœˆå¯¦é ˜é‡‘é¡</span>
                    <span class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-indigo-600">NT$ ${data.total_net_pay.toLocaleString()}</span>
                </div>
            `;
        }
        
        // ... (å…¶é¤˜è¾…åŠ©å‡½æ•°å¦‚ switchTab, openModal ç­‰ä¿æŒä¸å˜ï¼Œè¯·åŠ¡å¿…åŒ…å«) ...
        // ... (ä¸ºèŠ‚çœç¯‡å¹…ï¼Œæ­¤å¤„çœç•¥ï¼Œè¯·å‚è€ƒä¸Šä¸€ç‰ˆä»£ç ) ...

    </script>
</body>
</html>
