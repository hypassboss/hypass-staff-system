<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypass 管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">載入中...</div>

    <div id="app" class="hidden p-6">
        <h1 class="text-2xl font-bold mb-4">海帕斯員工系統 (@034qvauh)</h1>
        <div class="bg-white p-6 rounded-2xl shadow-md mb-6">
            <p id="user-info" class="text-blue-600 font-bold mb-4"></p>
            <select id="loc" class="w-full p-3 border rounded-xl mb-4">
                <option value="A">海帕斯科技 (安定區)</option>
                <option value="B">HYPASS BOSS (善化區)</option>
            </select>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="clock('上班')" class="bg-green-500 text-white p-4 rounded-xl font-bold">上班打卡</button>
                <button onclick="clock('下班')" class="bg-red-500 text-white p-4 rounded-xl font-bold">下班打卡</button>
            </div>
        </div>
    </div>

    <script>
        // 修正後的連線資訊
        const URL = 'https://obbcgmgkbazwpfvgbupg.supabase.co';
        const KEY = 'sb_publishable_kmM4pKdI1OmLUNKjQeH0VQ_wr11fwKV';
        const _db = supabase.createClient(URL, KEY);

        let user = null;

        async function init() {
            await liff.init({ liffId: "2009136875-gs1Va90A" });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                const { data } = await _db.from('profiles').select('*').eq('line_id', profile.userId).single();
                
                document.getElementById('loading').style.display = 'none';
                if (data) {
                    user = data;
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('user-info').innerText = `你好，${data.full_name}`;
                } else {
                    const name = prompt("首次登入，請輸入真實姓名：");
                    if(name) {
                        const { data: newUser } = await _db.from('profiles').insert([{ line_id: profile.userId, full_name: name }]).select().single();
                        location.reload();
                    }
                }
            }
        }

        function clock(type) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { error } = await _db.from('attendance').insert([{
                    user_id: user.id,
                    clock_type: type,
                    location_id: document.getElementById('loc').value,
                    u_lat: pos.coords.latitude,
                    u_lng: pos.coords.longitude
                }]);
                if (!error) alert(type + " 成功！");
                else alert("打卡失敗，請檢查網路或 GPS");
            });
        }
        init();
    </script>
</body>
</html>
