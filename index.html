<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | ä¼æ¥­å“¡å·¥å°ˆå€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background: #f1f5f9; -webkit-tap-highlight-color: transparent; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        #app-container { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); min-height: 100vh; position: relative; overflow-x: hidden; }
        @media (min-width: 768px) { #app-container { max-width: 480px; margin: 0 auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border-left: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; } }
        .app-view { display: none; } .app-view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        .glass-card { background: rgba(255, 255, 255, 0.98); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.8); }
        .nav-item.active { color: #0284c7; transform: translateY(-2px); font-weight: 900; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: none; } .modal.active { display: flex; z-index: 100; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input:focus, select:focus, textarea:focus { outline: 2px solid #38bdf8; outline-offset: -1px; }
    </style>
</head>
<body class="text-slate-800">
<div id="app-container" class="pb-24">
    
    <header class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div><h1 class="text-2xl font-black italic uppercase tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-sky-300 to-indigo-200">Hypass</h1><span class="text-[10px] text-sky-400 tracking-[0.2em] font-bold">ENTERPRISE</span></div>
        <div id="user-status" class="text-xs font-bold bg-white/10 px-3 py-1.5 rounded-full border border-white/20 flex items-center"><span class="animate-pulse mr-1.5 h-2 w-2 bg-emerald-400 rounded-full"></span>é€£ç·šä¸­...</div>
    </header>
    
    <main class="p-5">
        <div id="sys-loading" class="text-center py-40 active-view"><div class="animate-spin h-10 w-10 border-4 border-sky-600 border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-sm text-slate-500 font-bold tracking-wider">ç³»çµ±èˆ‡è¡Œäº‹æ›†åŒæ­¥ä¸­...</p></div>
        <div id="sys-pending" class="text-center py-32 hidden"><div class="text-6xl mb-6 grayscale opacity-50">â³</div><h2 class="text-2xl font-black text-slate-800 mb-2">å¸³è™Ÿå¯©æ ¸ä¸­</h2><p class="text-sm text-slate-500 font-medium">å·²é€šçŸ¥ä¸»ç®¡ï¼Œè«‹è€å¿ƒç­‰å€™æ¬Šé™é–‹é€šã€‚</p></div>

        <div id="view-onboarding" class="hidden glass-card p-6 rounded-3xl shadow-xl">
            <h2 class="text-xl font-black mb-6 text-center text-slate-800">ğŸ‘‹ æ­¡è¿åŠ å…¥ï¼å»ºç«‹å“¡å·¥æª”æ¡ˆ</h2>
            <form id="onboarding-form" class="space-y-4">
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2"><input type="text" name="full_name" placeholder="çœŸå¯¦å§“å" required class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner"></div>
                    <div class="col-span-1"><select name="job_title" required class="w-full p-3 bg-sky-50 text-sky-800 rounded-xl text-sm font-black border-0 shadow-inner appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3E%3Cpath stroke=\'%230284c7\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'M6 8l4 4 4-4\'/%3E%3C/svg%3E')] bg-[length:1.5em_1.5em] bg-[right_0.5rem_center] bg-no-repeat pr-8"><option value="" disabled selected>è·ä½</option><option value="ä¸»ç®¡">ä¸»ç®¡</option><option value="æ¥­å‹™">æ¥­å‹™</option><option value="åŠ©ç†">åŠ©ç†</option></select></div>
                </div>
                <div><input type="text" name="id_number" placeholder="èº«åˆ†è­‰å­—è™Ÿ" required class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner uppercase"></div>
                <div class="grid grid-cols-2 gap-3"><input type="email" name="email" placeholder="é›»å­ä¿¡ç®±" required class="p-3 bg-slate-50 rounded-xl text-sm border-0 shadow-inner"><input type="tel" name="phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" required class="p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner"></div>
                
                <div class="bg-slate-50 p-1 rounded-xl shadow-inner border border-slate-100">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 mt-1 block">è«‹é¸æ“‡æ‰€å±¬å·¥ä½œåœ°é» (æ“šé»)</label>
                    <select name="default_branch_id" id="reg-branch" required class="w-full p-3 bg-transparent text-base font-black text-slate-700 border-0 outline-none appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3E%3Cpath stroke=\'%236b7280\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'M6 8l4 4 4-4\'/%3E%3C/svg%3E')] bg-[length:1.5em_1.5em] bg-[right_0.5rem_center] bg-no-repeat"></select>
                </div>
                
                <div class="grid grid-cols-2 gap-3"><div class="col-span-1"><label class="text-[10px] font-bold text-slate-500 ml-1 mb-0.5 block">å…¥è·æ—¥æœŸ</label><input type="date" name="onboarding_date" required class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold border-0 shadow-inner"></div><div class="col-span-1"><label class="text-[10px] font-bold text-slate-500 ml-1 mb-0.5 block">é€šè¨Šåœ°å€</label><input type="text" name="address" placeholder="æ³•å¾‹é€é”åœ°" required class="w-full p-3 bg-slate-50 rounded-xl text-sm border-0 shadow-inner"></div></div>
                <div class="p-4 bg-emerald-50/80 rounded-2xl border border-emerald-100">
                    <h3 class="text-xs font-black text-emerald-800 mb-3 flex items-center"><span class="text-base mr-1">ğŸ’°</span>è²¡å‹™èˆ‡ä¿éšªè³‡æ–™</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3"><input type="text" name="bank_name" placeholder="éŠ€è¡Œåç¨±" required class="p-2.5 text-sm border shadow-sm rounded-xl bg-white"><input type="text" name="bank_code" placeholder="ä»£ç¢¼(ä¾‹:808)" required class="p-2.5 text-sm border shadow-sm rounded-xl bg-white font-bold text-center"><input type="text" name="bank_user_name" placeholder="æˆ¶å" required class="p-2.5 text-sm border shadow-sm rounded-xl bg-white"><input type="text" name="bank_account" placeholder="éŠ€è¡Œå¸³è™Ÿ" required class="p-2.5 text-sm border shadow-sm rounded-xl bg-white font-bold"></div>
                    <div class="flex justify-between items-center border-t border-emerald-200/50 pt-3"><span class="text-sm font-bold text-emerald-900">å¥ä¿çœ·å±¬åŠ ä¿äººæ•¸</span><input type="number" name="dependents_count" value="0" min="0" required class="w-20 p-2 text-center text-sm font-black border shadow-sm rounded-xl bg-white"></div>
                </div>
                <div class="grid grid-cols-2 gap-3"><input type="text" name="emergency_name" placeholder="ç·Šæ€¥è¯çµ¡äºº" required class="p-3 bg-slate-50 border-0 shadow-inner rounded-xl text-sm font-bold"><input type="tel" name="emergency_phone" placeholder="è¯çµ¡äººé›»è©±" required class="p-3 bg-slate-50 border-0 shadow-inner rounded-xl text-sm font-bold"></div>
                
                <div class="bg-slate-100 p-4 rounded-2xl mt-5 border border-slate-200 shadow-inner">
                    <h3 class="text-sm font-black text-slate-800 mb-3 flex items-center"><span class="text-lg mr-1.5">âš–ï¸</span>è˜åƒ±åˆç´„èˆ‡æœå‹™å®ˆå‰‡ (å¿…è®€)</h3>
                    <div class="text-[11px] text-slate-700 leading-relaxed h-56 overflow-y-auto bg-white p-4 rounded-xl border border-slate-200 mb-4 shadow-sm select-none">
                        <h4 class="font-black text-center text-sm mb-3 text-slate-900">HYPASS ä¼æ¥­è˜åƒ±åˆç´„èˆ‡å“¡å·¥æœå‹™å®ˆå‰‡</h4>
                        <p class="mb-2"><strong>ç”²æ–¹ï¼ˆé›‡ä¸»ï¼‰ï¼š</strong>æµ·å¸•æ–¯ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸<br><strong>ä¹™æ–¹ï¼ˆå—åƒ±äººï¼‰ï¼š</strong>æ–°é€²å“¡å·¥ (æ‚¨)</p>
                        <hr class="my-3 border-slate-200">
                        <p class="font-black text-slate-900 text-xs mb-1 mt-2">ç¬¬ä¸€ç« ï¼šè·ä½èˆ‡å·¥ä½œå…§å®¹</p><ul class="list-decimal pl-4 space-y-1 mb-3"><li>è·å‹™èªªæ˜ï¼šä¹™æ–¹åŒæ„æ“”ä»»ç”²æ–¹æ‰€æŒ‡æ´¾ä¹‹è·å‹™ï¼Œä¸¦å”åŠ©ç”²æ–¹å„é …æ¥­å‹™æ¨å‹•ã€‚</li><li>å·¥ä½œå€åŸŸï¼šç”²æ–¹å¾—è¦–ç‡Ÿé‹éœ€æ±‚ï¼ŒæŒ‡æ´¾ä¹™æ–¹æ–¼å¯¦é«”æ“šé»æˆ–æŒ‡å®šåˆ†å€åŸ·è¡Œè·å‹™ã€‚</li></ul>
                        <p class="font-black text-slate-900 text-xs mb-1">ç¬¬äºŒç« ï¼šè€ƒå‹¤ç®¡ç†èˆ‡æ‰“å¡è¦ç¯„</p><ul class="list-decimal pl-4 space-y-1 mb-3"><li>è€ƒå‹¤ä¾æ“šï¼šä¹™æ–¹åŒæ„ä»¥ App ä¹‹ GPS å®šä½æ‰“å¡ï¼Œä½œç‚ºå‡ºå‹¤ç´€éŒ„ä¹‹å”¯ä¸€åˆæ³•ä¾æ“šã€‚</li><li>æ‰“å¡ç¯„åœï¼šç³»çµ±æ™ºæ…§å®šä½åˆ†åº—ç¯„åœã€‚æ¥­å‹™è·ä½é–‹æ”¾å¤–å‹¤å®šä½ã€‚</li><li>é²åˆ°è™•ç†ï¼šæ¯æœˆçµ¦äºˆ 3 æ¬¡é²åˆ°å¯¬é™ï¼Œæ¯æ¬¡æœ€é«˜ 10 åˆ†é˜ã€‚è‹¥è¶…éå¯¬é™ï¼Œè©²ç¼ºå¤±æ™‚æ•¸å°‡ä¾æ¯”ä¾‹ä¸è¨ˆè–ªã€‚è‹¥ä¹™æ–¹æ¬²ç¶­æŒå…¨è–ªï¼Œæ‡‰ä¸»å‹•ç”³è«‹ä»¥å‰©é¤˜ç‰¹ä¼‘æŠµæ‰£ã€‚</li></ul>
                        <p class="font-black text-slate-900 text-xs mb-1">ç¬¬ä¸‰ç« ï¼šè«‹å‡èˆ‡ä¼‘å‡è¦ç¯„</p><ul class="list-decimal pl-4 space-y-1 mb-3"><li>è«‹å‡ç¨‹åºï¼šç·šä¸Šæå‰ç”³è«‹ï¼Œç¶“ä¸»ç®¡æ ¸å‡†å¾Œç”Ÿæ•ˆï¼›çªç™¼ç‹€æ³æ‡‰ç¬¬ä¸€æ™‚é–“å‘ŠçŸ¥ä¸¦è£œå–®ã€‚</li><li>é¢±é¢¨å‡åŸå‰‡ï¼šä¾æ”¿åºœç™¼å¸ƒï¼Œéµå¾ªã€Œæ”¾å‡ä½†è©²æ—¥ä¸æ”¯è–ªã€åŸå‰‡ï¼Œä¸æ‰£ç‰¹ä¼‘äº¦ä¸å½±éŸ¿å…¨å‹¤ã€‚</li><li>åŠ ç­ç”³è«‹ï¼šä¾‹å‡æ—¥å‡ºå‹¤é ˆæ–¼ç³»çµ±å¡«å¯«ã€Œèµ·è¨–æ™‚é–“ã€é€å‡ºåŠ ç­å–®ã€‚</li></ul>
                        <p class="font-black text-slate-900 text-xs mb-1">ç¬¬å››ç« ï¼šä¿å¯†å”å®š (NDA) èˆ‡æ™ºæ…§è²¡ç”¢æ¬Š</p><ul class="list-decimal pl-4 space-y-1 mb-3"><li>ä¿å¯†ç¾©å‹™ï¼šä¹™æ–¹å°ç”²æ–¹ä¹‹å®¢æˆ¶åå–®ã€ç ”ç™¼æŠ€è¡“ã€å•†æ¥­ç­–ç•¥ç­‰æœªå…¬é–‹ç‡Ÿæ¥­ç§˜å¯†ï¼Œè² çµ•å°ä¿å¯†ç¾©å‹™ã€‚æœªç¶“åŒæ„çµ•ä¸æ´©æ¼ã€‚</li><li>æ­¸é‚„ç¾©å‹™ï¼šé›¢è·æ™‚æ‡‰å°‡éš¸å±¬ç”²æ–¹ä¹‹æª”æ¡ˆã€è³‡æ–™å…¨æ•¸æ­¸é‚„æˆ–éŠ·æ¯€ã€‚</li><li>é•ç´„ç½°å‰‡ï¼šä¹™æ–¹è‹¥é•åä¿å¯†ç¾©å‹™ï¼ŒåŒæ„ç„¡æ¢ä»¶è² æ“”æ–°å°å¹£å£¹ä½°è¬å…ƒæ•´ä¹‹æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</li></ul>
                    </div>
                    <div class="space-y-3 bg-white p-3 rounded-xl border border-slate-200">
                        <label class="flex items-start space-x-3 cursor-pointer"><input type="checkbox" id="chk1" onchange="checkForm()" class="mt-0.5 h-4 w-4 rounded text-sky-600 focus:ring-sky-500"><span class="text-xs font-bold text-slate-800 leading-tight">æˆ‘å·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°ã€è˜åƒ±åˆç´„èˆ‡æœå‹™å®ˆå‰‡ã€‘å…¨æ¢æ–‡ã€‚</span></label>
                        <label class="flex items-start space-x-3 cursor-pointer"><input type="checkbox" id="chk2" onchange="checkForm()" class="mt-0.5 h-4 w-4 rounded text-sky-600 focus:ring-sky-500"><span class="text-[11px] font-bold text-slate-800 leading-tight">åŒæ„ç³»çµ±ä»¥ GPS å®šä½ç‚ºè€ƒå‹¤å”¯ä¸€ä¾æ“šï¼Œ<strong class="text-red-600">é²åˆ°æ™‚æ•¸å°‡ä¾æ¯”ä¾‹ä¸è¨ˆè–ªæˆ–ç”³è«‹ç‰¹ä¼‘æ‰£æŠµã€‚</strong></span></label>
                        <label class="flex items-start space-x-3 cursor-pointer"><input type="checkbox" id="chk3" onchange="checkForm()" class="mt-0.5 h-4 w-4 rounded text-sky-600 focus:ring-sky-500"><span class="text-[11px] font-bold text-slate-800 leading-tight">å¦‚é‡æ³•å®šé¢±é¢¨å‡ï¼Œå…¬å¸ä¾æ³•éµå¾ª<strong class="text-red-600">ã€Œæ”¾å‡ä½†è©²æ—¥ä¸æ”¯è–ªã€</strong>åŸå‰‡è¾¦ç†ï¼Œä¸æ‰£é™¤ç‰¹ä¼‘ã€‚</span></label>
                        <label class="flex items-start space-x-3 cursor-pointer"><input type="checkbox" id="chk4" onchange="checkForm()" class="mt-0.5 h-4 w-4 rounded text-sky-600 focus:ring-sky-500"><span class="text-[11px] font-bold text-slate-800 leading-tight">åŒæ„åš´å®ˆä¼æ¥­ä¿å¯†å”å®š(NDA)ï¼Œå¦‚æœ‰é•é¡˜è² æ“”<strong class="text-red-600">æ–°å°å¹£å£¹ä½°è¬å…ƒä¹‹æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</strong></span></label>
                    </div>
                </div>
                <button type="submit" id="btn-submit" disabled class="w-full bg-gradient-to-r from-sky-500 to-indigo-600 disabled:from-slate-300 disabled:to-slate-400 text-white font-black py-4 rounded-2xl mt-4 transition-all shadow-lg text-sm tracking-wider active:scale-95">æ•¸ä½ç°½ç½²ä¸¦æäº¤å¯©æ ¸</button>
            </form>
        </div>

        <div id="view-dashboard" class="hidden space-y-5">
            <div id="tab-home" class="app-view active space-y-5">
                <div class="bg-amber-50/80 border border-amber-200 p-4 rounded-2xl flex flex-col shadow-sm relative overflow-hidden"><div class="absolute top-0 right-0 -mt-2 -mr-2 text-6xl opacity-10 grayscale">ğŸ“¢</div><div class="flex items-center space-x-2 mb-3 pb-2 border-b border-amber-200/50 relative z-10"><span class="text-lg">ğŸ“¢</span><h4 class="text-xs font-black text-amber-900 tracking-widest">å…¬å¸å…¬å‘Š</h4></div><div id="ui-bulletin" class="pl-1 pr-1 max-h-24 overflow-y-auto no-scrollbar space-y-3 relative z-10">è¼‰å…¥ä¸­...</div></div>
                
                <div class="bg-gradient-to-br from-slate-900 to-indigo-900 p-6 rounded-[2rem] text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 text-8xl opacity-20 text-sky-300" id="ui-role-icon">ğŸ†”</div>
                    <div class="relative z-10">
                        <div class="flex items-end mb-1"><h3 id="ui-name" class="text-3xl font-black tracking-tight mr-3">--</h3><span id="ui-role-badge" class="bg-sky-500/30 border border-sky-400 px-2 py-1 rounded text-[10px] font-bold mb-1.5">è¼‰å…¥ä¸­</span></div>
                        <p id="ui-work-hours" class="text-xs text-sky-200 font-bold mb-5 tracking-wider opacity-90">ç­åˆ¥è¼‰å…¥ä¸­...</p>
                        <div class="flex flex-col bg-white/10 p-4 rounded-2xl border border-white/10 backdrop-blur-sm"><span class="text-xs font-bold text-slate-300 mb-1">æ³•å®šç‰¹ä¼‘é¤˜é¡</span><span id="ui-leave" class="text-3xl font-black text-amber-300 tracking-tight">--</span></div>
                    </div>
                </div>

                <div class="glass-card p-4 rounded-[1.5rem] shadow-sm">
                    <h4 class="text-xs font-black text-slate-600 mb-3 ml-1 flex justify-between items-center">
                        <span class="flex items-center"><span class="text-lg mr-1.5">ğŸ“…</span>å‡ºå‹¤è¡Œäº‹æ›† (åŒæ­¥æ”¿åºœç‰ˆ)</span>
                        <span class="text-[9px] bg-slate-100 px-2 py-1 rounded text-slate-400 border border-slate-200">ğŸ”´ä¼‘å‡ ğŸŸ¡è£œç­ âš«ï¸å·¥ä½œæ—¥</span>
                    </h4>
                    <div id="ui-mini-calendar" class="px-1 pb-1">
                        <div class="animate-pulse text-center py-4 text-xs text-slate-400 font-bold">è¼‰å…¥è¡Œäº‹æ›†ä¸­...</div>
                    </div>
                </div>

                <div class="glass-card p-5 rounded-[2rem] shadow-sm relative overflow-hidden">
                    <div class="mb-5 bg-sky-50/50 p-3 rounded-2xl border border-sky-100 flex items-center justify-center space-x-2">
                        <span class="text-lg">ğŸŒ</span><span class="text-xs font-bold text-slate-600 tracking-wide">æ™ºæ…§å®šä½ï¼šç³»çµ±å°‡è‡ªå‹•åµæ¸¬æ‚¨çš„æ‰€åœ¨æ“šé»</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="punch('IN')" class="bg-gradient-to-br from-sky-500 to-blue-600 text-white py-8 rounded-3xl font-black text-xl shadow-lg active:scale-95 flex flex-col items-center transition-all group"><span class="text-4xl mb-2">ğŸ¢</span>ä¸Šç­æ‰“å¡</button>
                        <button onclick="punch('OUT')" class="bg-white text-slate-700 border-2 border-slate-100 py-8 rounded-3xl font-black text-xl shadow-sm active:scale-95 flex flex-col items-center transition-all hover:bg-slate-50"><span class="text-4xl mb-2 grayscale opacity-80">ğŸ </span>ä¸‹ç­æ‰“å¡</button>
                    </div>
                    <button onclick="loadPunchHistory()" class="w-full mt-4 text-xs font-bold text-slate-400 bg-slate-50 py-3 rounded-2xl border border-slate-100 flex justify-center items-center space-x-2 active:scale-95 transition hover:bg-slate-100"><span>ğŸ” æŸ¥è©¢æˆ‘çš„è¿‘æœŸç´€éŒ„</span></button>
                </div>
            </div>

            <div id="tab-leave" class="app-view space-y-5">
                <h3 class="font-black text-2xl text-slate-900 pl-2 flex justify-between items-end"><span>ç·šä¸Šè«‹å‡åŠ ç­ç”³è«‹</span></h3>
                <div class="glass-card p-6 rounded-[2rem] shadow-sm">
                    <form id="leave-form" onsubmit="submitLeave(event)" class="space-y-4 border-b border-slate-100 pb-6 mb-5">
                        <select name="leave_type" id="leave-type-select" onchange="checkLeaveType()" class="w-full bg-slate-50 border-0 shadow-inner p-3 rounded-2xl text-sm font-bold appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3E%3Cpath stroke=\'%236b7280\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'M6 8l4 4 4-4\'/%3E%3C/svg%3E')] bg-[length:1.5em_1.5em] bg-[right_1rem_center] bg-no-repeat">
                            <option value="ç‰¹ä¼‘">ğŸ–ï¸ ç‰¹ä¼‘ (å¯æŠµæ‰£é²åˆ°æ™‚æ•¸)</option><option value="äº‹å‡">ğŸ“„ äº‹å‡</option><option value="ç—…å‡">ğŸ’Š ç—…å‡</option><option value="å…¬å‡">ğŸ’¼ å…¬å‡</option><option value="é¢±é¢¨å‡">ğŸŒªï¸ é¢±é¢¨å‡</option><option value="ç·Šæ€¥åŠ ç­">ğŸš¨ å‡æ—¥ç·Šæ€¥åŠ ç­</option>
                        </select>
                        <div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">èµ·å§‹æ™‚é–“</label><input type="datetime-local" name="start_time" required class="w-full bg-slate-50 border-0 shadow-inner p-3 rounded-2xl text-sm font-bold"></div><div><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">çµæŸæ™‚é–“</label><input type="datetime-local" name="end_time" required class="w-full bg-slate-50 border-0 shadow-inner p-3 rounded-2xl text-sm font-bold"></div></div>
                        <div id="salary-protection-ui" class="flex items-center justify-between p-4 bg-sky-50/80 rounded-2xl border border-sky-100 transition-all shadow-sm"><div id="sp-text"><p class="text-sm font-black text-sky-900 mb-0.5">è–ªè³‡ä¿å…¨</p><p class="text-xs font-bold text-sky-600">åŒæ„æ‰£ç‰¹ä¼‘ä»¥ç¶­æŒå…¨è–ª</p></div><label class="relative inline-flex items-center cursor-pointer scale-110" id="sp-toggle"><input type="checkbox" name="salary_protection" checked class="sr-only peer"><div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all shadow-inner"></div></label></div>
                        <button type="submit" id="btn-leave" class="w-full bg-gradient-to-r from-amber-400 to-orange-500 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition text-sm tracking-wider">é€å‡ºç”³è«‹å–®</button>
                    </form>
                    <h4 class="text-sm font-black text-slate-700 mb-3 ml-1">ğŸ“… è¿‘æœŸç”³è«‹ç´€éŒ„</h4><div id="ui-leave-list" class="space-y-3 max-h-56 overflow-y-auto no-scrollbar p-1">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div id="tab-payroll" class="app-view space-y-5">
                <h3 class="font-black text-2xl text-slate-900 pl-2">è–ªè³‡æ˜ç´°</h3>
                <div class="glass-card p-6 rounded-[2rem] space-y-4 shadow-sm">
                    <select id="payroll-month" onchange="loadPayrollDetail()" class="w-full bg-slate-50 text-slate-800 font-bold border-0 shadow-inner p-3 rounded-2xl text-sm outline-none appearance-none bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 20 20\'%3E%3Cpath stroke=\'%236b7280\' stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'1.5\' d=\'M6 8l4 4 4-4\'/%3E%3C/svg%3E')] bg-[length:1.5em_1.5em] bg-[right_1rem_center] bg-no-repeat"></select>
                    <div class="bg-white border border-slate-100 rounded-2xl p-5 space-y-4 mt-2 shadow-sm">
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">åº•è–ª</span><span id="p-base" class="text-base font-black text-slate-800">NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">çé‡‘æ´¥è²¼</span><span id="p-bonus" class="text-base font-black text-emerald-600">NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">å¹´çµ‚çé‡‘</span><span id="p-yeb" class="text-base font-black text-emerald-600">NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">å‹å¥ä¿è‡ªä»˜</span><span id="p-ins" class="text-base font-black text-red-500">- NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">äºŒä»£å¥ä¿</span><span id="p-2nd" class="text-base font-black text-red-500">- NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-xs font-bold text-slate-400">å‹é€€ææ’¥ (å…¬å¸è² æ“” 6%)</span><span id="p-pen" class="text-xs font-black text-slate-400">NT$ 0</span></div>
                        <div class="flex justify-between items-end pt-3 border-t border-slate-100"><span class="text-base font-black text-slate-800">ç¸½è¨ˆå¯¦é ˜</span><span id="p-net" class="text-3xl font-black text-sky-600 tracking-tight">NT$ 0</span></div>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="app-view space-y-5">
                <h3 class="font-black text-2xl text-slate-900 pl-2">åŸºæœ¬è³‡æ–™</h3>
                <div class="glass-card p-6 rounded-[2rem] shadow-sm space-y-6">
                    <div class="flex flex-col space-y-4 border-b border-slate-100 pb-6" id="ui-profile-info">è¼‰å…¥ä¸­...</div>
                    <div class="pt-2"><h4 class="text-xs font-black tracking-widest text-slate-400 uppercase mb-3 ml-1">æ•¸ä½åˆç´„å­˜è­‰ä¸­å¿ƒ</h4><button onclick="openDoc()" class="w-full text-left bg-white p-4 rounded-2xl border border-slate-200 font-bold text-sm flex justify-between items-center shadow-sm active:scale-95 transition hover:bg-slate-50"><span class="flex items-center"><span class="mr-3 text-xl">ğŸ“„</span>æŸ¥çœ‹è˜åƒ±åˆç´„èˆ‡ä¿å¯†å”å®š</span><span class="text-slate-400">â”</span></button></div>
                </div>
            </div>

            <nav class="absolute bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200/60 flex justify-around items-center py-3 pb-8 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] rounded-t-3xl">
                <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center w-16 text-slate-400 transition-all group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">ğŸ </span><span class="text-[10px] font-bold">æ‰“å¡</span></button><button onclick="switchTab('leave')" class="nav-item flex flex-col items-center w-16 text-slate-400 transition-all group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">ğŸ“…</span><span class="text-[10px] font-bold">è«‹å‡</span></button><button onclick="switchTab('payroll')" class="nav-item flex flex-col items-center w-16 text-slate-400 transition-all group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">ğŸ’°</span><span class="text-[10px] font-bold">è–ªè³‡</span></button><button onclick="switchTab('profile')" class="nav-item flex flex-col items-center w-16 text-slate-400 transition-all group"><span class="text-2xl mb-1 group-hover:scale-110 transition-transform">ğŸ‘¤</span><span class="text-[10px] font-bold">è³‡æ–™</span></button>
            </nav>
        </div>
    </main>

    <div id="alert-modal" class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm items-center justify-center z-[200] p-5"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center transform transition-all scale-95 opacity-0" id="alert-box"><div id="alert-icon" class="text-6xl mb-4">âœ…</div><h3 id="alert-title" class="text-xl font-black text-slate-800 mb-2">æç¤º</h3><p id="alert-msg" class="text-sm text-slate-600 font-bold leading-relaxed mb-6">è¨Šæ¯å…§å®¹</p><button onclick="closeAlert()" class="w-full bg-slate-900 text-white font-black py-3.5 rounded-xl shadow-md active:scale-95 transition">ç¢ºèª</button></div></div>
    <div id="record-modal" class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm items-end justify-center z-[100]"><div class="bg-[#f8fafc] w-full max-w-md rounded-t-[2rem] p-6 h-[75vh] flex flex-col shadow-2xl md:max-w-480px md:mx-auto md:relative"><div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-200"><h3 class="font-black text-xl text-slate-800">è¿‘æœŸæ‰“å¡ç´€éŒ„</h3><button onclick="closeModal('record-modal')" class="bg-slate-200 px-4 py-2 rounded-full text-sm font-bold text-slate-600 hover:bg-slate-300 transition">âœ• é—œé–‰</button></div><div id="ui-records-list" class="overflow-y-auto space-y-3 flex-1 no-scrollbar pb-8 p-1">è¼‰å…¥ä¸­...</div></div></div>
    <div id="doc-modal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-md items-center justify-center p-5 z-[100]"><div class="bg-white w-full max-w-md rounded-3xl p-6 relative flex flex-col shadow-2xl max-h-[85vh]"><h3 class="font-black text-lg border-b pb-3 mb-4 text-slate-800 text-center">ğŸ“œ è˜åƒ±åˆç´„èˆ‡æœå‹™å®ˆå‰‡</h3><div id="doc-content" class="overflow-y-auto pr-2 flex-1 mb-4 no-scrollbar"></div><div class="bg-emerald-50 border border-emerald-100 p-3 rounded-2xl text-center shadow-inner"><p class="text-[10px] text-emerald-700 font-bold mb-1">âœ”ï¸ ç¶“æ•¸ä½ç°½ç« èªè­‰ï¼Œå…·å‚™æ³•å¾‹æ•ˆåŠ›</p><p id="doc-sig" class="font-black text-emerald-900 text-xs">ç°½ç½²äººï¼š--</p></div><button onclick="closeModal('doc-modal')" class="w-full mt-4 bg-slate-900 hover:bg-slate-800 text-white font-bold py-3.5 rounded-2xl text-sm transition shadow-md active:scale-95">å·²è©³é–±ä¸¦é—œé–‰</button></div></div>
</div>

    <script>
        const SUPABASE_URL = 'https://obbcgmgkbazwpfvgbupg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'; // âš ï¸ è«‹å‹™å¿…å¡«å¯«
        const LIFF_ID = '2009148826-RoogHmxk'; 
        const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        window.branches = [];
        window.calData = {}; // å„²å­˜æ”¿åºœè¡Œäº‹æ›† API å›å‚³çš„è³‡æ–™

        // ğŸŒŸ è‡ªå‹•æŠ“å–æ”¿åºœè¡Œäº‹æ›† (è·¨å¹´ç„¡ç¸«è™•ç†)
        async function syncCalendar() {
            const y1 = new Date().getFullYear(); const y2 = y1 + 1;
            try {
                const [r1, r2] = await Promise.all([
                    fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${y1}.json`).then(r => r.json()),
                    fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${y2}.json`).then(r => r.json()).catch(() => [])
                ]);
                [...(r1||[]), ...(r2||[])].forEach(d => { window.calData[d.date] = d; });
            } catch(e) { console.warn('è¡Œäº‹æ›†åŒæ­¥å¤±æ•—ï¼Œå°‡å¥—ç”¨æœ¬åœ°è¦å‰‡'); }
        }

        async function init() {
            await syncCalendar(); // App å•Ÿå‹•å³ä¸‹è¼‰è¡Œäº‹æ›†
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1.5 h-2 w-2 bg-emerald-400 rounded-full"></span>' + profile.displayName;
            loadBranches('reg-branch'); checkUser(profile.userId);
        }

        async function checkUser(lineId) {
            const { data } = await _sb.from('employees').select('*').eq('line_id', lineId).single();
            document.getElementById('sys-loading').style.display = 'none';
            if (!data) document.getElementById('view-onboarding').style.display = 'block';
            else if (!data.is_approved || data.employment_status === 'é›¢è·') { 
                document.getElementById('sys-pending').style.display = 'block'; 
                if(data.employment_status === 'é›¢è·') document.querySelector('#sys-pending h2').innerText = 'å¸³è™Ÿå·²åœæ¬Š';
            }
            else { currentUser = data; renderUI(); document.getElementById('view-dashboard').style.display = 'block'; }
        }

        async function loadBranches(targetId) { 
            const { data } = await _sb.from('branch_locations').select('id, branch_name, lat, lng, radius_m').eq('is_active', true); 
            window.branches = data || [];
            const sel = document.getElementById(targetId); 
            if(sel) sel.innerHTML = window.branches.map(b => `<option value="${b.id}">${b.branch_name}</option>`).join(''); 
        }

        function switchTab(id) { document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active')); document.getElementById('tab-' + id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active')); document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active'); if(id === 'leave') loadLeaveHistory(); if(id === 'payroll') loadPayrollMonths(); }

        function checkLeaveType() {
            const type = document.getElementById('leave-type-select').value; const ui = document.getElementById('salary-protection-ui');
            if(type === 'é¢±é¢¨å‡') { document.getElementById('sp-text').innerHTML = '<p class="text-sm font-black text-emerald-900 mb-0.5">ğŸŒªï¸ æ³•å®šé¢±é¢¨å‡</p><p class="text-[11px] font-bold text-emerald-600">ä¾æ³•ä¸æ”¯è–ªï¼Œäº¦ä¸å½±éŸ¿å…¨å‹¤</p>'; ui.className = 'flex items-center justify-between p-4 bg-emerald-50/80 rounded-2xl border border-emerald-200 transition-all shadow-sm'; document.getElementById('sp-toggle').style.display = 'none'; } 
            else if (type === 'ç·Šæ€¥åŠ ç­') { document.getElementById('sp-text').innerHTML = '<p class="text-sm font-black text-red-900 mb-0.5">ğŸš¨ å‡æ—¥å‡ºå‹¤ç”³è«‹</p><p class="text-[11px] font-bold text-red-600">è«‹ç²¾ç¢ºå¡«å¯«é è¨ˆå‡ºå‹¤ä¹‹èµ·è¨–æ™‚é–“</p>'; ui.className = 'flex items-center justify-between p-4 bg-red-50/80 rounded-2xl border border-red-200 transition-all shadow-sm'; document.getElementById('sp-toggle').style.display = 'none'; }
            else { document.getElementById('sp-text').innerHTML = '<p class="text-sm font-black text-sky-900 mb-0.5">è–ªè³‡ä¿å…¨</p><p class="text-xs font-bold text-sky-600">åŒæ„æ‰£ç‰¹ä¼‘ä»¥ç¶­æŒå…¨è–ª</p>'; ui.className = 'flex items-center justify-between p-4 bg-sky-50/80 rounded-2xl border border-sky-100 transition-all shadow-sm'; document.getElementById('sp-toggle').style.display = 'block'; }
        }

        function checkForm() { document.getElementById('btn-submit').disabled = !(document.getElementById('chk1').checked && document.getElementById('chk2').checked && document.getElementById('chk3').checked && document.getElementById('chk4').checked); }

        async function renderUI() {
            document.getElementById('ui-name').innerText = currentUser.full_name; 
            document.getElementById('ui-role-badge').innerText = currentUser.job_title || 'å“¡å·¥';
            if(currentUser.job_title === 'æ¥­å‹™') { document.getElementById('ui-role-icon').innerText = 'ğŸ›µ'; }
            
            document.getElementById('ui-work-hours').innerText = `ğŸ•’ è¡¨å®šç­åˆ¥ï¼š${(currentUser.work_start_time||'09:00').slice(0,5)} ~ ${(currentUser.work_end_time||'18:00').slice(0,5)}`;
            const { data: lv } = await _sb.rpc('fn_get_annual_leave', { p_onboard_date: currentUser.onboarding_date }); if(lv) document.getElementById('ui-leave').innerText = `${lv.days} å¤© ${lv.hours%8} å°æ™‚`;
            const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const { data: blt } = await _sb.from('bulletin_board').select('*').gte('created_at', oneYearAgo.toISOString()).order('created_at', {ascending: false});
            if (blt && blt.length > 0) { document.getElementById('ui-bulletin').innerHTML = blt.map(b => `<div class="mb-2.5 border-b border-amber-100/50 pb-2 last:border-0 last:mb-0 last:pb-0 flex items-start"><span class="text-[10px] text-amber-600 font-black mr-2 mt-0.5 bg-amber-100 px-1.5 rounded">[${new Date(b.created_at).toISOString().split('T')[0]}]</span><div><span class="font-black text-slate-800 text-sm">${b.title}</span><span class="text-xs text-slate-600 font-medium leading-relaxed block mt-1">${b.content}</span></div></div>`).join(''); } else { document.getElementById('ui-bulletin').innerHTML = '<p class="text-xs text-slate-400 font-medium italic">ç›®å‰ç„¡æ­·å²å…¬å‘Š</p>'; }
            
            renderMiniCalendar();

            document.getElementById('ui-profile-info').innerHTML = `<div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ†”</span><span class="text-slate-700 font-bold text-sm">èº«åˆ†è­‰ï¼š${currentUser.id_number}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ“§</span><span class="text-slate-700 font-bold text-sm">${currentUser.email}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ“</span><span class="text-slate-700 font-bold text-sm">${currentUser.phone}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg text-sky-600">ğŸ‘”</span><span class="text-sky-700 font-black text-sm bg-sky-50 px-2 py-0.5 rounded-md border border-sky-100">${currentUser.job_title||'æœªæŒ‡æ´¾'}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ“</span><span class="text-slate-700 font-bold text-sm">å·¥ä½œåˆ†å€ï¼š${currentUser.work_region}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ‘¥</span><span class="text-slate-700 font-bold text-sm">çœ·å±¬åŠ ä¿ï¼š${currentUser.dependents_count || 0} äºº</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg text-amber-600">ğŸ“…</span><span class="text-slate-700 font-bold text-sm">å…¥è·æ—¥ï¼š${currentUser.onboarding_date}</span></div><div class="flex items-center space-x-3 border-t border-slate-50 pt-3 mt-1"><span class="w-6 text-center text-lg mt-0.5">â°</span><div class="text-blue-700 font-black text-sm bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 w-full text-center tracking-wider">${(currentUser.work_start_time||'09:00').slice(0,5)} ä¸Šç­ <span class="mx-2 text-blue-200">|</span> ${(currentUser.work_end_time||'18:00').slice(0,5)} ä¸‹ç­</div></div><div class="flex items-start space-x-3 mt-3"><span class="w-6 text-center text-lg mt-0.5">ğŸ </span><span class="text-slate-700 font-medium text-sm leading-relaxed">${currentUser.address}</span></div><div class="flex items-start space-x-3 mt-2 pt-3 border-t border-slate-50"><span class="w-6 text-center text-lg mt-0.5">ğŸ¦</span><div class="text-slate-800 font-black text-sm leading-tight">${currentUser.bank_name} (${currentUser.bank_code})<br><span class="text-xs font-bold text-slate-500 mt-1 block">${currentUser.bank_user_name} / ${currentUser.bank_account}</span></div></div><div class="flex items-start space-x-3 mt-2 pt-3 border-t border-slate-50"><span class="w-6 text-center text-lg mt-0.5">ğŸš¨</span><div class="text-slate-800 font-black text-sm leading-tight">ç·Šæ€¥è¯çµ¡äººï¼š${currentUser.emergency_name}<br><span class="text-xs font-bold text-slate-500 mt-1 block">${currentUser.emergency_phone}</span></div></div>`;
        }

        // ğŸŒŸ æ ¸å¿ƒï¼š4è¡Œç¶²æ ¼ + æ”¿åºœè¡Œäº‹æ›†è‡ªå‹•è¼‰å…¥ + é»ƒè‰²è£œç­æ¨™ç¤º
        function renderMiniCalendar() {
            const today = new Date(); 
            const currentWeekStart = new Date(today); currentWeekStart.setDate(today.getDate() - today.getDay());
            const startDay = new Date(currentWeekStart); startDay.setDate(currentWeekStart.getDate() - 7);
            
            const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']; 
            let html = '<div class="grid grid-cols-7 gap-1 mb-2">';
            for(let d of days) html += `<div class="text-center text-[10px] font-bold text-slate-400">${d}</div>`;
            html += '</div><div class="grid grid-cols-7 gap-1">';
            
            for(let i=0; i<28; i++) {
                let d = new Date(startDay); d.setDate(startDay.getDate() + i);
                let dStr = d.getFullYear() + String(d.getMonth()+1).padStart(2,'0') + String(d.getDate()).padStart(2,'0');
                
                let isToday = d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
                let isWeekend = d.getDay() === 0 || d.getDay() === 6;
                let dayInfo = window.calData[dStr];
                
                let isHoliday = false; let isMakeup = false; let label = '';
                
                if (dayInfo) {
                    isHoliday = dayInfo.isHoliday;
                    if(isHoliday) label = (dayInfo.description === 'æ˜ŸæœŸå…­' || dayInfo.description === 'æ˜ŸæœŸæ—¥') ? 'å‡æ—¥' : dayInfo.description;
                    if(!isHoliday && isWeekend) { isMakeup = true; label = 'è£œç­'; }
                } else {
                    isHoliday = isWeekend; if(isHoliday) label = 'å‡æ—¥';
                }
                
                let colorClass = isHoliday ? 'text-red-500' : (isMakeup ? 'text-amber-600' : 'text-slate-800');
                let bgClass = isToday ? 'bg-sky-100 border-sky-300 ring-1 ring-sky-200 shadow-sm' : 'bg-white border-slate-100';
                
                let noteHTML = '';
                if(isHoliday) noteHTML = `<span class="text-[8px] text-red-500 font-bold leading-none mt-1 truncate w-full text-center">${label}</span>`;
                else if(isMakeup) noteHTML = `<span class="text-[8px] text-amber-500 font-bold leading-none mt-1 truncate w-full text-center">${label}</span>`;
                else noteHTML = `<div class="w-1 h-1 rounded-full mt-1.5 bg-slate-300"></div>`;
                
                html += `<div class="py-1.5 flex flex-col items-center justify-center rounded-lg border ${bgClass} cursor-default hover:bg-slate-50 transition"><span class="text-xs font-black ${colorClass}">${d.getDate()}</span>${noteHTML}</div>`;
            }
            html += '</div>';
            document.getElementById('ui-mini-calendar').innerHTML = html;
        }

        // ğŸŒŸ æ™ºæ…§æ‰“å¡èˆ‡å‡æ—¥é›™é‡é˜²å‘†
        async function punch(type) {
            document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1.5 h-2 w-2 bg-amber-400 rounded-full"></span>é©—è­‰ä¸­...';

            const today = new Date(); 
            const dStr = today.getFullYear() + String(today.getMonth()+1).padStart(2,'0') + String(today.getDate()).padStart(2,'0');
            const dayInfo = window.calData[dStr];
            let isOffDay = dayInfo ? dayInfo.isHoliday : (today.getDay() === 0 || today.getDay() === 6);
            let holidayName = dayInfo && dayInfo.description && dayInfo.description.indexOf('æ˜ŸæœŸ') === -1 ? ` (${dayInfo.description})` : '';

            // å‡æ—¥é˜²å‘†ï¼šæŸ¥é©—æ˜¯å¦æœ‰åŠ ç­å–®
            if (isOffDay) {
                const todayStr = today.toLocaleDateString('en-CA');
                const { data: otAll } = await _sb.from('leave_requests').select('start_time, end_time').eq('employee_id', currentUser.id).eq('leave_type', 'ç·Šæ€¥åŠ ç­');
                let hasOvertime = otAll && otAll.some(ot => ot.start_time.includes(todayStr) || ot.end_time.includes(todayStr));
                
                if (!hasOvertime) {
                    document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1.5 h-2 w-2 bg-emerald-400 rounded-full"></span>å·²é€£ç·š';
                    if (type === 'IN') {
                        showAlert('ğŸ›‘ å‡æ—¥æ‰“å¡é˜»æ“‹', `ä»Šæ—¥ç‚ºæ’å®šä¹‹ä¼‘å‡æ—¥${holidayName}ï¼Œç„¡æ³•ç›´æ¥æ‰“å¡ã€‚<br><br>è‹¥éœ€å‡ºå‹¤ï¼Œè«‹å…ˆè‡³è«‹å‡å€é€å‡ºã€ğŸš¨ å‡æ—¥ç·Šæ€¥åŠ ç­å–®ã€‘ï¼Œé€å‡ºå¾Œå³å¯æ­£å¸¸æ‰“å¡ã€‚`, 'error');
                    } else {
                        showAlert('ğŸ›‘ éŒ¯èª¤', `ä»Šæ—¥ç‚ºä¼‘å‡æ—¥${holidayName}ï¼Œç³»çµ±æŸ¥ç„¡æ‚¨çš„åŠ ç­ç´€éŒ„ï¼Œç„¡æ³•é€²è¡Œä¸‹ç­æ‰“å¡ã€‚`, 'error');
                    }
                    return;
                }
            }

            document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1.5 h-2 w-2 bg-amber-400 rounded-full"></span>å®šä½ä¸­...';
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                
                // ğŸ“ å‰ç«¯è¼”åŠ©è·é›¢è¨ˆç®— (èˆ‡å¾Œå°é›™é‡é©—è­‰)
                let closestBranch = null; let minDistance = Infinity;
                window.branches.forEach(b => {
                    const R = 6371e3; const p1 = lat * Math.PI/180; const p2 = b.lat * Math.PI/180;
                    const dp = (b.lat-lat) * Math.PI/180; const dl = (b.lng-lng) * Math.PI/180;
                    const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
                    const d = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
                    if(d < minDistance) { minDistance = d; closestBranch = b; }
                });

                let isField = false; let targetBranchId = closestBranch ? closestBranch.id : null;
                // è‹¥ç‚ºæ¥­å‹™ä¸”ä¸åœ¨æ“šé»ç¯„åœå…§ï¼Œå•Ÿç”¨å¤–å‹¤æ¨¡å¼
                if (currentUser.job_title === 'æ¥­å‹™' && (!closestBranch || minDistance > closestBranch.radius_m)) {
                    isField = true; targetBranchId = window.branches[0].id; // çµ¦å®šå‡ ID ä»¥é€šé SQL çµæ§‹
                }

                const { data, error } = await _sb.rpc('fn_process_punch', { p_emp_id: currentUser.id, p_type: type, p_lat: lat, p_lng: lng, p_branch_id: targetBranchId, p_is_field: isField, p_is_offday: isOffDay });
                document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1.5 h-2 w-2 bg-emerald-400 rounded-full"></span>å·²é€£ç·š';
                
                if (error) { showAlert('âš ï¸ ç³»çµ±éŒ¯èª¤', error.message, 'error'); } 
                else {
                    let title = type === 'IN' ? 'ä¸Šç­æ‰“å¡' : 'ä¸‹ç­æ‰“å¡';
                    if(data.status === 'error') showAlert('âŒ å¤±æ•—', data.message, 'error');
                    else if (data.status === 'late' || data.status === 'warning') showAlert(`âš ï¸ ${title}ç•°å¸¸`, data.message, 'warning');
                    else showAlert(`âœ… ${title}æˆåŠŸ`, data.message, 'success');
                }
            }, () => {
                document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1.5 h-2 w-2 bg-red-400 rounded-full"></span>å®šä½å¤±æ•—';
                showAlert('ğŸ“ å®šä½æ¬Šé™æœªé–‹', 'è«‹è‡³æ‰‹æ©Ÿè¨­å®šä¸­é–‹å•Ÿ LINE æˆ–ç€è¦½å™¨çš„ GPS å®šä½æ¬Šé™ï¼', 'error');
            }, { enableHighAccuracy: true });
        }

        function showAlert(title, msg, type) {
            const box = document.getElementById('alert-box'); const icon = document.getElementById('alert-icon');
            document.getElementById('alert-title').innerText = title; document.getElementById('alert-msg').innerHTML = msg;
            if(type === 'error') { icon.innerText = 'âŒ'; document.getElementById('alert-title').className = 'text-xl font-black text-red-600 mb-2'; }
            else if(type === 'warning') { icon.innerText = 'âš ï¸'; document.getElementById('alert-title').className = 'text-xl font-black text-amber-600 mb-2'; }
            else { icon.innerText = 'ğŸ‰'; document.getElementById('alert-title').className = 'text-xl font-black text-emerald-600 mb-2'; }
            document.getElementById('alert-modal').classList.add('active'); setTimeout(() => { box.classList.remove('scale-95', 'opacity-0'); box.classList.add('scale-100', 'opacity-100'); }, 10);
        }
        function closeAlert() { const box = document.getElementById('alert-box'); box.classList.remove('scale-100', 'opacity-100'); box.classList.add('scale-95', 'opacity-0'); setTimeout(() => { document.getElementById('alert-modal').classList.remove('active'); }, 200); }

        async function loadPunchHistory() {
            document.getElementById('ui-records-list').innerHTML = 'è¼‰å…¥ä¸­...'; openModal('record-modal');
            const { data } = await _sb.from('attendance_logs').select('punch_type, punch_time, note, branch_locations(branch_name)').eq('employee_id', currentUser.id).order('punch_time', {ascending: false}).limit(30);
            document.getElementById('ui-records-list').innerHTML = data.length ? data.map(log => `<div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm"><div><span class="text-xs font-black bg-slate-100 px-2 py-1 rounded-md border border-slate-200">${log.punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span> <span class="text-sm font-bold text-slate-700 ml-2">${new Date(log.punch_time).toLocaleString('zh-TW').slice(5,-3)}</span><p class="text-xs text-slate-400 font-bold mt-1.5 flex items-center"><span class="mr-1">ğŸ“</span>${log.branch_locations?.branch_name||'å¤–å‹¤å®šä½'}</p></div><span class="text-[10px] font-black px-2 py-1 rounded-full ${log.note.includes('æ­£å¸¸')?'text-emerald-600 bg-emerald-50':'text-amber-600 bg-amber-50'}">${log.note}</span></div>`).join('') : '<div class="text-center text-sm text-slate-400 font-bold py-10">ç›®å‰ç„¡æ‰“å¡ç´€éŒ„</div>';
        }

        async function submitLeave(e) {
            e.preventDefault(); const fd = new FormData(e.target); const isTyphoon = fd.get('leave_type') === 'é¢±é¢¨å‡';
            
            // ğŸŒŸ å¼·åˆ¶ç¶å®šå°ç£æ™‚å€é˜²é£„ç§»
            const st = fd.get('start_time') + ':00+08:00';
            const et = fd.get('end_time') + ':00+08:00';
            const payload = { employee_id: currentUser.id, leave_type: fd.get('leave_type'), start_time: st, end_time: et, salary_protection: isTyphoon ? false : (fd.get('salary_protection') === 'on') };
            
            document.getElementById('btn-leave').innerText = 'ç”³è«‹é€å‡ºä¸­...';
            const { data, error } = await _sb.from('leave_requests').insert([payload]).select();
            if(!error && data) {
                await _sb.functions.invoke('line-webhook', { body: { action: 'notify_leave', id: data[0].id, name: currentUser.full_name, type: payload.leave_type, start: fd.get('start_time').replace('T', ' '), end: fd.get('end_time').replace('T', ' ') }});
                if(payload.leave_type === 'ç·Šæ€¥åŠ ç­') showAlert('âœ… åŠ ç­ç”³è«‹å·²é€å‡º', 'ä¸»ç®¡æ ¸å‡†å¾Œè©²æ™‚æ®µå°‡è¨ˆå…¥æœ‰æ•ˆåŠ ç­æ™‚æ•¸ã€‚æ‚¨å¯ä»¥ç«‹åˆ»åˆ‡æ›è‡³é¦–é é€²è¡Œæ‰“å¡ï¼', 'success');
                else showAlert('âœ… ç”³è«‹å·²é€å‡º', 'ä¸»ç®¡æ ¸å‡†å¾Œç³»çµ±æœƒè‡ªå‹•æ¨æ’­é€šçŸ¥æ‚¨ã€‚', 'success');
                e.target.reset(); checkLeaveType(); loadLeaveHistory();
            } else { showAlert('âŒ é€å‡ºå¤±æ•—', error.message, 'error'); }
            document.getElementById('btn-leave').innerText = 'é€å‡ºç”³è«‹å–®';
        }

        async function loadLeaveHistory() {
            const { data } = await _sb.from('leave_requests').select('*').eq('employee_id', currentUser.id).order('created_at', {ascending: false}).limit(10);
            document.getElementById('ui-leave-list').innerHTML = data.length ? data.map(l => {
                let badge = l.status === 'æ ¸å‡†' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : (l.status === 'æ ¸é§' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-slate-100 text-slate-600 border-slate-200');
                let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                let spTag = l.leave_type === 'é¢±é¢¨å‡' ? '<span class="text-[10px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded ml-2 font-bold">ä¸æ”¯è–ª</span>' : (l.salary_protection ? '<span class="text-[10px] text-sky-600 bg-sky-50 px-1.5 py-0.5 rounded ml-2 font-bold">ä¿è–ª</span>' : '');
                return `<div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><div class="flex justify-between items-center mb-2"><span class="font-black text-sm text-slate-800 flex items-center">${l.leave_type} ${spTag}</span><span class="text-[10px] font-black px-2.5 py-1 rounded-full border ${badge}">${l.status}</span></div><p class="text-xs font-bold text-slate-500 flex items-center"><span class="mr-1.5">ğŸ•’</span>${t1} ~ ${t2}</p></div>`;
            }).join('') : '<div class="text-center text-sm text-slate-400 font-bold py-8">å°šç„¡ç”³è«‹ç´€éŒ„</div>';
        }

        async function loadPayrollMonths() {
            const sel = document.getElementById('payroll-month'); const { data } = await _sb.from('payroll_records').select('pay_month').eq('employee_id', currentUser.id).order('pay_month', {ascending: false});
            if(!data || !data.length) { sel.innerHTML = '<option>å°šç„¡è–ªè³‡ç´€éŒ„</option>'; sel.disabled = true; resetPayrollUI(); return; }
            sel.disabled = false; sel.innerHTML = data.map(m => `<option value="${m.pay_month}">${m.pay_month} è–ªè³‡å–®</option>`).join(''); sel.selectedIndex = 0; loadPayrollDetail(); 
        }

        function resetPayrollUI() { document.getElementById('p-base').innerText = 'NT$ 0'; document.getElementById('p-bonus').innerText = 'NT$ 0'; document.getElementById('p-yeb').innerText = 'NT$ 0'; document.getElementById('p-ins').innerText = '- NT$ 0'; document.getElementById('p-2nd').innerText = '- NT$ 0'; document.getElementById('p-pen').innerText = 'NT$ 0'; document.getElementById('p-net').innerText = 'NT$ 0'; }

        async function loadPayrollDetail() {
            const month = document.getElementById('payroll-month').value; const { data } = await _sb.from('payroll_records').select('*').eq('employee_id', currentUser.id).eq('pay_month', month).single();
            if(!data) { resetPayrollUI(); return; }
            document.getElementById('p-base').innerText = `NT$ ${data.base_pay.toLocaleString()}`; document.getElementById('p-bonus').innerText = `NT$ ${data.bonus.toLocaleString()}`; document.getElementById('p-yeb').innerText = `NT$ ${data.year_end_bonus.toLocaleString()}`; document.getElementById('p-ins').innerText = `- NT$ ${data.insurance_deduction.toLocaleString()}`; document.getElementById('p-2nd').innerText = `- NT$ ${data.second_gen_health.toLocaleString()}`; document.getElementById('p-pen').innerText = `NT$ ${data.labor_pension.toLocaleString()}`; document.getElementById('p-net').innerText = `NT$ ${data.total_net_pay.toLocaleString()}`;
        }

        function openDoc() { 
            const htmlContent = `
                <div class="text-[11px] text-slate-700 leading-relaxed text-left">
                    <h4 class="font-black text-center text-sm mb-3 text-slate-900">HYPASS ä¼æ¥­è˜åƒ±åˆç´„èˆ‡å“¡å·¥æœå‹™å®ˆå‰‡</h4>
                    <p class="mb-2 text-sm"><strong>ç”²æ–¹ï¼ˆé›‡ä¸»ï¼‰ï¼š</strong>æµ·å¸•æ–¯ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸<br><strong>ä¹™æ–¹ï¼ˆå—åƒ±äººï¼‰ï¼š</strong><span class="text-sky-700 font-bold border-b border-sky-700 pb-0.5">${currentUser.full_name}</span></p>
                    <hr class="my-3 border-slate-200">
                    <p class="font-black text-slate-900 text-xs mb-1">ç¬¬ä¸€ç« ï¼šè·ä½èˆ‡å·¥ä½œå…§å®¹</p>
                    <ul class="list-decimal pl-4 space-y-1 mb-3"><li>è·å‹™èªªæ˜ï¼šä¹™æ–¹åŒæ„æ“”ä»»ç”²æ–¹æ‰€æŒ‡æ´¾ä¹‹è·å‹™ï¼Œä¸¦å”åŠ©ç”²æ–¹å„é …æ¥­å‹™æ¨å‹•ã€‚</li><li>å·¥ä½œå€åŸŸï¼šç”²æ–¹å¾—è¦–ç‡Ÿé‹éœ€æ±‚ï¼ŒæŒ‡æ´¾ä¹™æ–¹æ–¼å¯¦é«”æ“šé»æˆ–æŒ‡å®šåˆ†å€åŸ·è¡Œè·å‹™ã€‚</li></ul>
                    <p class="font-black text-slate-900 text-xs mb-1">ç¬¬äºŒç« ï¼šè€ƒå‹¤ç®¡ç†èˆ‡æ‰“å¡è¦ç¯„</p>
                    <ul class="list-decimal pl-4 space-y-1 mb-3"><li>è€ƒå‹¤ä¾æ“šï¼šä¹™æ–¹åŒæ„ä»¥ App ä¹‹ GPS å®šä½æ‰“å¡ï¼Œä½œç‚ºå‡ºå‹¤ç´€éŒ„ä¹‹å”¯ä¸€åˆæ³•ä¾æ“šã€‚</li><li>æ‰“å¡ç¯„åœï¼šç³»çµ±æ™ºæ…§å®šä½åˆ†åº—ç¯„åœã€‚æ¥­å‹™è·ä½é–‹æ”¾å¤–å‹¤å®šä½ã€‚</li><li>é²åˆ°è™•ç†ï¼šæ¯æœˆçµ¦äºˆ 3 æ¬¡é²åˆ°å¯¬é™ï¼Œæ¯æ¬¡æœ€é«˜ 10 åˆ†é˜ã€‚è‹¥è¶…éå¯¬é™ï¼Œè©²ç¼ºå¤±æ™‚æ•¸å°‡ä¾æ¯”ä¾‹ä¸è¨ˆè–ªã€‚è‹¥ä¹™æ–¹æ¬²ç¶­æŒå…¨è–ªï¼Œæ‡‰ä¸»å‹•ç”³è«‹ä»¥å‰©é¤˜ç‰¹ä¼‘æŠµæ‰£ã€‚</li></ul>
                    <p class="font-black text-slate-900 text-xs mb-1">ç¬¬ä¸‰ç« ï¼šè«‹å‡èˆ‡ä¼‘å‡è¦ç¯„</p>
                    <ul class="list-decimal pl-4 space-y-1 mb-3"><li>è«‹å‡ç¨‹åºï¼šç·šä¸Šæå‰ç”³è«‹ï¼Œç¶“ä¸»ç®¡æ ¸å‡†å¾Œç”Ÿæ•ˆï¼›çªç™¼ç‹€æ³æ‡‰ç¬¬ä¸€æ™‚é–“å‘ŠçŸ¥ä¸¦è£œå–®ã€‚</li><li>é¢±é¢¨å‡åŸå‰‡ï¼šä¾æ”¿åºœç™¼å¸ƒï¼Œéµå¾ªã€Œæ”¾å‡ä½†è©²æ—¥ä¸æ”¯è–ªã€åŸå‰‡ï¼Œä¸æ‰£ç‰¹ä¼‘äº¦ä¸å½±éŸ¿å…¨å‹¤ã€‚</li><li>åŠ ç­ç”³è«‹ï¼šä¾‹å‡æ—¥å‡ºå‹¤é ˆæ–¼ç³»çµ±å¡«å¯«ã€Œèµ·è¨–æ™‚é–“ã€é€å‡ºåŠ ç­å–®ã€‚</li></ul>
                    <p class="font-black text-slate-900 text-xs mb-1">ç¬¬å››ç« ï¼šä¿å¯†å”å®š (NDA) èˆ‡æ™ºæ…§è²¡ç”¢æ¬Š</p>
                    <ul class="list-decimal pl-4 space-y-1 mb-3"><li>ä¿å¯†ç¾©å‹™ï¼šä¹™æ–¹å°ç”²æ–¹ä¹‹å®¢æˆ¶æœªå…¬é–‹ç‡Ÿæ¥­ç§˜å¯†ï¼Œè² çµ•å°ä¿å¯†ç¾©å‹™ã€‚æœªç¶“åŒæ„çµ•ä¸æ´©æ¼ã€‚</li><li>æ­¸é‚„ç¾©å‹™ï¼šé›¢è·æ™‚æ‡‰å°‡éš¸å±¬ç”²æ–¹ä¹‹æª”æ¡ˆã€è³‡æ–™å…¨æ•¸æ­¸é‚„æˆ–éŠ·æ¯€ã€‚</li><li>é•ç´„ç½°å‰‡ï¼šä¹™æ–¹è‹¥é•åä¿å¯†ç¾©å‹™ï¼ŒåŒæ„ç„¡æ¢ä»¶è² æ“”æ–°å°å¹£å£¹ä½°è¬å…ƒæ•´ä¹‹æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</li></ul>
                </div>
            `;
            document.getElementById('doc-content').innerHTML = htmlContent; document.getElementById('doc-sig').innerText = `ç°½ç½²äººï¼š${currentUser.full_name}\næ™‚é–“ï¼š${new Date(currentUser.nda_signed_at).toLocaleString('zh-TW')}`; openModal('doc-modal'); 
        }
        
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        document.getElementById('onboarding-form').onsubmit = async (e) => {
            e.preventDefault(); document.getElementById('btn-submit').innerText = 'è³‡æ–™åŠ å¯†ä¸Šå‚³ä¸­...'; const fd = new FormData(e.target); const payload = Object.fromEntries(fd.entries());
            payload.line_id = (await liff.getProfile()).userId; payload.dependents_count = parseInt(payload.dependents_count) || 0;
            const { data, error } = await _sb.from('employees').insert([payload]).select(); 
            if(error) { alert(error.message); document.getElementById('btn-submit').innerText = 'æ•¸ä½ç°½ç½²ä¸¦æäº¤å¯©æ ¸'; } 
            else { 
                await _sb.functions.invoke('line-webhook', { body: { action: 'notify_signup', id: data[0].id, name: payload.full_name, role: payload.job_title }});
                location.reload(); 
            }
        };
        window.onload = init;
    </script>
</body>
</html>
