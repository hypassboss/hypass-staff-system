<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypass å“¡å·¥ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <p class="text-blue-600 font-bold animate-pulse text-lg">Hypass ç³»çµ±å®‰å…¨é€£ç·šä¸­...</p>
        </div>
    </div>

    <div id="register-view" class="hidden min-h-screen p-6">
        <div class="bg-white rounded-3xl shadow-xl p-8 max-w-md mx-auto mt-4 border-t-4 border-blue-600">
            <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">å“¡å·¥è³‡æ–™å»ºæª”</h2>
            <p class="text-xs text-red-500 mb-6 text-center">ä¾å…¬å¸è¦å®šï¼Œé¦–æ¬¡ç™»å…¥è«‹å‹™å¿…è£œå…¨ä»¥ä¸‹è³‡æ–™</p>
            
            <div class="space-y-4 text-sm">
                <div><label class="block font-bold mb-1 text-gray-600">çœŸå¯¦å§“å <span class="text-red-500">*</span></label><input type="text" id="reg-name" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"></div>
                <div><label class="block font-bold mb-1 text-gray-600">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="text-red-500">*</span></label><input type="tel" id="reg-phone" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl"></div>
                <div><label class="block font-bold mb-1 text-gray-600">è¯çµ¡ä¿¡ç®± <span class="text-red-500">*</span></label><input type="email" id="reg-email" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl"></div>
                <div><label class="block font-bold mb-1 text-gray-600">å…¥è·æ—¥æœŸ <span class="text-red-500">*</span></label><input type="date" id="reg-date" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl"></div>
                <div>
                    <label class="block font-bold mb-1 text-gray-600">ä¸»è¦ä¸Šç­åœ°é» <span class="text-red-500">*</span></label>
                    <select id="reg-loc" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                        <option value="A">æµ·å¸•æ–¯ç§‘æŠ€ (å®‰å®šå€)</option>
                        <option value="B">HYPASS BOSS (å–„åŒ–å€)</option>
                    </select>
                </div>
                <div><label class="block font-bold mb-1 text-gray-600">è–ªè³‡åŒ¯æ¬¾å¸³è™Ÿ <span class="text-red-500">*</span></label><input type="text" id="reg-bank" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl" placeholder="éŠ€è¡Œä»£ç¢¼+å¸³è™Ÿ"></div>
                
                <button onclick="submitRegistration()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg mt-6 active:scale-95 transition">é€å‡ºå¯©æ ¸</button>
            </div>
        </div>
    </div>

    <div id="app-view" class="hidden min-h-screen p-6 flex flex-col">
        <header class="bg-blue-700 text-white p-6 rounded-3xl shadow-lg mb-6 text-center relative overflow-hidden">
            <h1 class="text-xl font-bold relative z-10">æµ·å¸•æ–¯å“¡å·¥ç³»çµ±</h1>
            <p class="text-xs opacity-80 mt-1 relative z-10">@006rsfhs</p>
            <p id="user-info" class="text-sm font-medium mt-3 bg-blue-800 py-2 rounded-xl relative z-10"></p>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6 flex-grow">
            <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Clock-in Location</label>
            <select id="clock-loc" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl mb-6 text-lg font-medium focus:ring-2 focus:ring-blue-500">
                <option value="A">æµ·å¸•æ–¯ç§‘æŠ€ (å®‰å®šå€)</option>
                <option value="B">HYPASS BOSS (å–„åŒ–å€)</option>
            </select>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="clock('ä¸Šç­')" class="bg-emerald-500 text-white py-8 rounded-3xl font-bold text-lg shadow-md active:scale-95 transition flex flex-col items-center justify-center">
                    <span class="text-2xl mb-1">ğŸŒ¤ï¸</span>ä¸Šç­æ‰“å¡
                </button>
                <button onclick="clock('ä¸‹ç­')" class="bg-rose-500 text-white py-8 rounded-3xl font-bold text-lg shadow-md active:scale-95 transition flex flex-col items-center justify-center">
                    <span class="text-2xl mb-1">ğŸŒ™</span>ä¸‹ç­æ‰“å¡
                </button>
            </div>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-2xl">
            <p class="text-center text-xs text-blue-600 font-medium">ğŸ“ GPS åœæ¬„åŠå¾‘ 100m è‡ªå‹•é©—è­‰ç³»çµ±</p>
            <p id="gps-status" class="text-center text-[10px] text-gray-400 mt-1 italic">ç³»çµ±å°±ç·’</p>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ é‡‘é‘°è¨­å®šå€ âš ï¸
        // ==========================================
        const SB_URL = 'https://obbcgmgkbazwpfvgbupg.supabase.co'; 
        
        // ã€é‡è¦ã€‘è«‹å°‡ä¸‹æ–¹å¼•è™Ÿå…§çš„ä¸­æ–‡ï¼Œæ›æˆæ‚¨åœ¨ Supabase "Legacy anon" è¤‡è£½çš„ eyJ é–‹é ­é‡‘é‘°
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iYmNnbWdrYmF6d3BmdmdidXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTUxNDQsImV4cCI6MjA4NjczMTE0NH0.UlCKV_BDRWToqtG8ol69USBKgehBYpB4aUdM25oNwM0'; 
        
        const LIFF_ID = '2009136875-gs1Va90A';
        // ==========================================

        const _db = supabase.createClient(SB_URL, SB_KEY);
        let userLineId = "";
        let currentUser = null;

        // --- 1. ç³»çµ±åˆå§‹åŒ– ---
        async function initApp() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    userLineId = profile.userId;
                    
                    // æŸ¥è©¢è³‡æ–™åº«æ˜¯å¦å·²æœ‰æ­¤å“¡å·¥ç´€éŒ„
                    const { data, error } = await _db
                        .from('profiles')
                        .select('*')
                        .eq('line_id', userLineId)
                        .single();
                    
                    document.getElementById('loading').style.display = 'none';

                    if (data) {
                        // å·²è¨»å†Šï¼šé¡¯ç¤ºæ‰“å¡ä»‹é¢
                        currentUser = data;
                        document.getElementById('app-view').classList.remove('hidden');
                        document.getElementById('user-info').innerText = `å“¡å·¥ï¼š${data.full_name} ï½œ æ‰“å¡æº–å‚™å°±ç·’`;
                        if(data.default_location) {
                            document.getElementById('clock-loc').value = data.default_location;
                        }
                    } else {
                        // æœªè¨»å†Šï¼šé¡¯ç¤ºè¡¨å–®
                        document.getElementById('register-view').classList.remove('hidden');
                    }
                }
            } catch (err) {
                console.error("ç³»çµ±åˆå§‹åŒ–å¤±æ•—", err);
                document.getElementById('loading').innerHTML = `<p class="text-red-500 font-bold">é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡‘é‘°</p>`;
            }
        }

        // --- 2. è¨»å†Šè³‡æ–™é€å‡ºé‚è¼¯ ---
        async function submitRegistration() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const date = document.getElementById('reg-date').value;
            const loc = document.getElementById('reg-loc').value;
            const bank = document.getElementById('reg-bank').value.trim();

            if(!name || !phone || !email || !date || !bank) {
                return alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰å¿…å¡«è³‡æ–™ï¼");
            }

            // å­˜å…¥ Supabase Profiles è³‡æ–™è¡¨
            const { error } = await _db.from('profiles').insert([{
                line_id: userLineId,
                full_name: name,
                phone: phone,
                email: email,
                onboard_date: date,
                default_location: loc,
                bank_account: bank
            }]);

            if (error) {
                alert("è³‡æ–™å»ºæª”å¤±æ•—ï¼š" + error.message);
                console.error(error);
            } else {
                alert("è³‡æ–™å»ºæª”æˆåŠŸï¼è«‹é€šçŸ¥ç®¡ç†å“¡å¯©æ ¸ã€‚ç³»çµ±å°‡é‡æ–°è¼‰å…¥ã€‚");
                location.reload();
            }
        }

        // --- 3. GPS æ‰“å¡é‚è¼¯ ---
        function clock(type) {
            if (!navigator.geolocation) return alert("æ‚¨çš„è¨­å‚™ä¸æ”¯æ´ GPS å®šä½");

            document.getElementById('gps-status').innerText = "GPS å®šä½èˆ‡é©—è­‰ä¸­...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;

                const { error } = await _db.from('attendance').insert([{
                    user_id: currentUser.id,
                    clock_type: type,
                    location_id: document.getElementById('clock-loc').value,
                    u_lat: latitude,
                    u_lng: longitude
                }]);

                if (!error) {
                    alert(`ã€${type}ã€‘æ‰“å¡æˆåŠŸï¼å·²ç²¾ç¢ºè¨˜éŒ„æ™‚é–“èˆ‡åº§æ¨™ã€‚`);
                    document.getElementById('gps-status').innerText = `æœ€å¾Œæ‰“å¡ï¼š${new Date().toLocaleTimeString()}`;
                } else {
                    alert("æ‰“å¡å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ˜¯å¦è¶…å‡ºæ‰“å¡ç¯„åœæˆ–ç¶²è·¯ç•°å¸¸ã€‚");
                    document.getElementById('gps-status').innerText = "æ‰“å¡å¤±æ•—";
                    console.error("æ‰“å¡éŒ¯èª¤:", error);
                }
            }, (geoErr) => {
                alert("ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹åœ¨æ‰‹æ©Ÿè¨­å®šä¸­å…è¨± LINE å­˜å–æ‚¨çš„ GPS æ¬Šé™ã€‚");
                document.getElementById('gps-status').innerText = "å®šä½æˆæ¬Šå¤±æ•—";
            }, { enableHighAccuracy: true });
        }

        // å•Ÿå‹•ç¨‹å¼
        initApp();
    </script>
</body>
</html>
