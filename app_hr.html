<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hypass | å“¡å·¥å¤§å»³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background: #e2e8f0; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;}
        #app-container { background: #f1f5f9; min-height: 100vh; position: relative; overflow-x: hidden; padding-bottom: 90px; }
        .view-panel { display: none; animation: fadeIn 0.3s ease; } .view-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .glass-card { background: rgba(255, 255, 255, 0.98); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.8); }
        .modal { display: none; } .modal.active { display: flex; z-index: 200; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .select-arrow { appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-size: 1.5em 1.5em; background-position: right 0.5rem center; background-repeat: no-repeat; padding-right: 2rem; }
    </style>
</head>
<body class="text-slate-800">
    <div id="app-container" class="max-w-md mx-auto shadow-2xl">
        <header class="bg-slate-900 text-white px-5 py-4 shadow-md sticky top-0 z-50 flex items-center h-16">
            <button id="btn-back" onclick="backToDashboard()" class="hidden mr-3 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-xs font-bold transition">ğŸ”™ è¿”å›</button>
            <div><h1 class="text-xl font-black italic tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-sky-300 to-indigo-200" id="header-title">å“¡å·¥å¤§å»³</h1></div>
            <div class="ml-auto flex items-center space-x-2"><div id="user-status" class="text-[9px] font-bold bg-white/10 px-2 py-1 rounded-full border border-white/20 flex items-center"><span class="animate-pulse mr-1 h-1.5 w-1.5 bg-amber-400 rounded-full"></span>é€£ç·šä¸­</div></div>
        </header>

        <main class="p-5">
            <div id="view-dashboard" class="view-panel active">
                <div class="bg-amber-50/80 border border-amber-200 p-4 rounded-2xl flex flex-col shadow-sm relative overflow-hidden mb-5"><div class="absolute top-0 right-0 -mt-2 -mr-2 text-6xl opacity-10 grayscale">ğŸ“¢</div><div class="flex items-center space-x-2 mb-3 pb-2 border-b border-amber-200/50 relative z-10"><span class="text-lg">ğŸ“¢</span><h4 class="text-xs font-black text-amber-900 tracking-widest">å…¬å¸å…¬å‘Š</h4></div><div id="ui-bulletin" class="pl-1 pr-1 max-h-24 overflow-y-auto no-scrollbar space-y-3 relative z-10">è¼‰å…¥ä¸­...</div></div>
                
                <div class="bg-gradient-to-br from-sky-500 to-indigo-600 rounded-[2rem] p-6 text-white shadow-lg mb-6 relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-7xl opacity-20" id="ui-role-icon">ğŸ‘¨â€ğŸ’¼</div>
                    <h2 class="text-2xl font-black mb-1 flex items-center">
                        <span id="dash-name">--</span><span id="dash-role" class="ml-2 text-[10px] bg-white/20 px-2 py-0.5 rounded border border-white/30">--</span>
                    </h2>
                    <p class="text-xs font-bold text-sky-100 mb-4 tracking-wider" id="ui-work-hours">ç­åˆ¥è¼‰å…¥ä¸­...</p>
                    
                    <div class="bg-white/20 backdrop-blur-sm p-4 rounded-xl border border-white/20 mb-4 inline-block">
                        <span class="text-[10px] block mb-1 font-bold tracking-widest uppercase">å¹´åº¦å‰©é¤˜æ³•å®šç‰¹ä¼‘</span>
                        <div class="text-3xl font-black flex items-baseline tracking-tight text-amber-300" id="dash-leave">--</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/10 p-3 rounded-xl border border-white/10 text-xs shadow-sm">
                            <div class="font-bold text-sky-200 mb-2 border-b border-white/10 pb-1">ç•¶æœˆç´¯è¨ˆ</div>
                            <div class="flex justify-between mb-1 text-sky-50"><span>äº‹å‡</span><span class="font-black text-white" id="d-m-per">0 h</span></div>
                            <div class="flex justify-between mb-1 text-sky-50"><span>ç—…å‡</span><span class="font-black text-white" id="d-m-sic">0 h</span></div>
                            <div class="flex justify-between text-sky-50"><span>é²åˆ°</span><span class="font-black text-amber-300" id="d-m-lat">0 æ¬¡</span></div>
                        </div>
                        <div class="bg-white/10 p-3 rounded-xl border border-white/10 text-xs shadow-sm">
                            <div class="font-bold text-sky-200 mb-2 border-b border-white/10 pb-1">ç•¶å¹´ç´¯è¨ˆ</div>
                            <div class="flex justify-between mb-1 text-sky-50"><span>äº‹å‡</span><span class="font-black text-white" id="d-y-per">0 h</span></div>
                            <div class="flex justify-between mb-1 text-sky-50"><span>ç—…å‡</span><span class="font-black text-white" id="d-y-sic">0 h</span></div>
                            <div class="flex justify-between text-sky-50"><span>é²åˆ°</span><span class="font-black text-amber-300" id="d-y-lat">0 æ¬¡</span></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openView('punch', 'è€ƒå‹¤æ‰“å¡')" class="glass-card p-6 rounded-[2rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-sky-100 hover:bg-sky-50"><span class="text-4xl mb-3 drop-shadow-md">ğŸ¢</span><span class="font-black text-slate-700 tracking-wider">è€ƒå‹¤æ‰“å¡</span></button>
                    <button onclick="openView('leave', 'è«‹å‡è£œç™»åŠ ç­ç”³è«‹')" class="glass-card p-6 rounded-[2rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-amber-100 hover:bg-amber-50"><span class="text-4xl mb-3 drop-shadow-md">ğŸ“</span><span class="font-black text-slate-700 text-[11px] tracking-wide">è«‹å‡è£œç™»åŠ ç­ç”³è«‹</span></button>
                    <button onclick="openView('payroll', 'é›»å­è–ªè³‡å–®')" class="glass-card p-6 rounded-[2rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-emerald-100 hover:bg-emerald-50"><span class="text-4xl mb-3 drop-shadow-md">ğŸ’°</span><span class="font-black text-slate-700 tracking-wider">è–ªè³‡æŸ¥è©¢</span></button>
                    <button onclick="openView('profile', 'å€‹äººåˆç´„è³‡æ–™')" class="glass-card p-6 rounded-[2rem] flex flex-col items-center justify-center active:scale-95 transition shadow-sm border border-slate-200 hover:bg-slate-50"><span class="text-4xl mb-3 drop-shadow-md opacity-80">ğŸ‘¤</span><span class="font-black text-slate-700 tracking-wider">åˆç´„è³‡æ–™</span></button>
                </div>
            </div>

            <div id="view-punch" class="view-panel">
                <div class="glass-card p-5 rounded-[2rem] shadow-sm relative overflow-hidden mb-5">
                    <div class="text-center mb-5 border-b border-slate-100 pb-5"><p class="text-[10px] text-slate-400 font-bold mb-1 tracking-widest uppercase">CURRENT TIME</p><h2 id="live-clock" class="text-4xl font-black text-slate-800 tracking-tight font-mono">00:00:00</h2><p id="live-date" class="text-xs text-sky-600 font-bold mt-1 tracking-wide">----/--/-- æ˜ŸæœŸ-</p></div>
                    <div class="mb-5 bg-sky-50/50 p-3 rounded-2xl border border-sky-100 flex items-center justify-center space-x-2"><span class="text-lg">ğŸŒ</span><span class="text-[11px] font-bold text-slate-600 tracking-wide">ç„¡é‚Šç•Œå®šä½é˜²å‘†ç³»çµ±é‹è¡Œä¸­</span></div>
                    <div class="grid grid-cols-2 gap-4"><button onclick="punch('IN')" class="bg-gradient-to-br from-sky-500 to-blue-600 text-white py-8 rounded-3xl font-black text-xl shadow-lg active:scale-95 flex flex-col items-center transition-all group"><span class="text-4xl mb-2">ğŸ¢</span>ä¸Šç­æ‰“å¡</button><button onclick="punch('OUT')" class="bg-white text-slate-700 border-2 border-slate-100 py-8 rounded-3xl font-black text-xl shadow-sm active:scale-95 flex flex-col items-center transition-all hover:bg-slate-50"><span class="text-4xl mb-2 grayscale opacity-80">ğŸ </span>ä¸‹ç­æ‰“å¡</button></div>
                    <button onclick="loadPunchHistory()" class="w-full mt-4 text-xs font-bold text-slate-400 bg-slate-50 py-3 rounded-2xl border border-slate-100 flex justify-center items-center space-x-2 active:scale-95 transition hover:bg-slate-100"><span>ğŸ” æŸ¥è©¢æˆ‘çš„è¿‘æœŸç´€éŒ„</span></button>
                </div>
                <div class="glass-card p-4 rounded-[1.5rem] shadow-sm"><h4 class="text-xs font-black text-slate-600 mb-3 ml-1 flex justify-between items-center"><span class="flex items-center"><span class="text-lg mr-1.5">ğŸ“…</span>å‡ºå‹¤è¡Œäº‹æ›†</span><span class="text-[9px] bg-slate-100 px-2 py-1 rounded text-slate-400 border border-slate-200">ğŸ”´å‡ ğŸŸ¡è£œ âš«ï¸ç­</span></h4><div id="ui-mini-calendar" class="px-1 pb-1"></div></div>
            </div>

            <div id="view-leave" class="view-panel space-y-5">
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div class="glass-card rounded-[1.5rem] p-4 border border-sky-100 relative overflow-hidden shadow-sm"><div class="absolute -right-3 -bottom-3 text-5xl opacity-10 grayscale">ğŸ“…</div><h4 class="text-[10px] font-black tracking-widest text-sky-800 mb-2 border-b border-sky-100 pb-1 relative z-10">æœ¬æœˆç´¯è¨ˆ</h4><div class="grid grid-cols-2 gap-2 text-xs relative z-10"><div class="text-slate-500 font-bold">ç‰¹ä¼‘ <span id="st-m-ann" class="font-black text-slate-800 ml-1">0</span><span class="text-[9px] text-slate-400">h</span></div><div class="text-slate-500 font-bold">äº‹å‡ <span id="st-m-per" class="font-black text-slate-800 ml-1">0</span><span class="text-[9px] text-slate-400">h</span></div><div class="text-slate-500 font-bold">ç—…å‡ <span id="st-m-sic" class="font-black text-slate-800 ml-1">0</span><span class="text-[9px] text-slate-400">h</span></div><div class="text-slate-500 font-bold">é²åˆ° <span id="st-m-lat" class="font-black text-red-500 ml-1">0</span><span class="text-[9px] text-slate-400">æ¬¡</span></div></div></div>
                    <div class="glass-card rounded-[1.5rem] p-4 border border-indigo-100 relative overflow-hidden shadow-sm"><div class="absolute -right-3 -bottom-3 text-5xl opacity-10 grayscale">ğŸ“Š</div><h4 class="text-[10px] font-black tracking-widest text-indigo-800 mb-2 border-b border-indigo-100 pb-1 relative z-10">å¹´åº¦ç´¯è¨ˆ</h4><div class="grid grid-cols-2 gap-2 text-xs relative z-10"><div class="text-slate-500 font-bold">ç‰¹ä¼‘ <span id="st-y-ann" class="font-black text-slate-800 ml-1">0</span><span class="text-[9px] text-slate-400">h</span></div><div class="text-slate-500 font-bold">äº‹å‡ <span id="st-y-per" class="font-black text-slate-800 ml-1">0</span><span class="text-[9px] text-slate-400">h</span></div><div class="text-slate-500 font-bold">ç—…å‡ <span id="st-y-sic" class="font-black text-slate-800 ml-1">0</span><span class="text-[9px] text-slate-400">h</span></div><div class="text-slate-500 font-bold">é²åˆ° <span id="st-y-lat" class="font-black text-red-500 ml-1">0</span><span class="text-[9px] text-slate-400">æ¬¡</span></div></div></div>
                </div>
                <div class="glass-card p-6 rounded-[2rem] shadow-sm relative">
                    <form id="leave-form" onsubmit="submitLeave(event)" class="space-y-4 border-b border-slate-100 pb-6 mb-5">
                        <select name="leave_type" id="leave-type-select" onchange="checkLeaveType()" class="w-full bg-slate-50 border-0 shadow-inner p-3 rounded-2xl text-sm font-bold select-arrow">
                            <option value="ç‰¹ä¼‘">ğŸ–ï¸ ç‰¹ä¼‘ (æ‰£æŠµé²åˆ°å¿…é¸)</option><option value="äº‹å‡">ğŸ“„ äº‹å‡</option><option value="ç—…å‡">ğŸ’Š ç—…å‡</option><option value="å…¬å‡">ğŸ’¼ å…¬å‡</option><option value="é¢±é¢¨å‡">ğŸŒªï¸ é¢±é¢¨å‡</option><option value="ç·Šæ€¥åŠ ç­">ğŸš¨ å‡æ—¥ç·Šæ€¥åŠ ç­</option><option value="å¿˜è¨˜æ‰“å¡(è£œç™»)" class="text-amber-600 font-black">ğŸ“ å¿˜è¨˜æ‰“å¡ (è£œç™»ç”³è«‹)</option>
                        </select>
                        <div id="retro-punch-ui" class="hidden mb-1"><label class="text-xs font-bold text-slate-500 ml-1 mb-1.5 block">è«‹é¸æ“‡è£œç™»é¡å‹</label><div class="flex space-x-3 bg-slate-50 p-2 rounded-xl border border-slate-100 shadow-inner"><label class="flex-1 text-center py-2.5 bg-white rounded-lg border border-slate-200 cursor-pointer has-[:checked]:bg-sky-500 has-[:checked]:text-white has-[:checked]:border-sky-600 transition font-black text-sm text-slate-500 shadow-sm"><input type="radio" name="target_punch_type" value="IN" class="hidden" checked>ä¸Šç­è£œç™»</label><label class="flex-1 text-center py-2.5 bg-white rounded-lg border border-slate-200 cursor-pointer has-[:checked]:bg-amber-500 has-[:checked]:text-white has-[:checked]:border-amber-600 transition font-black text-sm text-slate-500 shadow-sm"><input type="radio" name="target_punch_type" value="OUT" class="hidden">ä¸‹ç­è£œç™»</label></div></div>
                        <div class="grid grid-cols-2 gap-3"><div class="col-span-1" id="box-start-time"><label id="label-start" class="text-xs font-bold text-slate-500 ml-1 mb-1 block">èµ·å§‹æ™‚é–“</label><input type="datetime-local" name="start_time" required class="w-full bg-slate-50 border-0 shadow-inner p-3 rounded-2xl text-sm font-bold"></div><div class="col-span-1" id="normal-end-ui"><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">çµæŸæ™‚é–“</label><input type="datetime-local" name="end_time" class="w-full bg-slate-50 border-0 shadow-inner p-3 rounded-2xl text-sm font-bold"></div></div>
                        <div id="salary-protection-ui" class="flex items-center justify-between p-4 bg-sky-50/80 rounded-2xl border border-sky-100 transition-all shadow-sm"><div id="sp-text"><p class="text-sm font-black text-sky-900 mb-0.5">è–ªè³‡ä¿å…¨</p><p class="text-xs font-bold text-sky-600">åŒæ„æ‰£ç‰¹ä¼‘ä»¥ç¶­æŒå…¨è–ª</p></div><label class="relative inline-flex items-center cursor-pointer scale-110" id="sp-toggle"><input type="checkbox" name="salary_protection" checked class="sr-only peer"><div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all shadow-inner"></div></label></div>
                        <button type="submit" id="btn-leave" class="w-full bg-gradient-to-r from-amber-400 to-orange-500 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition text-sm tracking-wider">é€å‡ºç”³è«‹å–®</button>
                    </form>
                    
                    <div class="flex justify-between items-center mb-3 ml-1 mt-4">
                        <h4 class="text-sm font-black text-slate-700">ğŸ“… ç”³è«‹ç´€éŒ„æŸ¥è©¢</h4>
                        <input type="month" id="leave-query-month" onchange="loadLeaveHistory()" class="bg-slate-50 border border-slate-200 text-xs font-bold p-1.5 rounded-lg outline-none text-slate-600">
                    </div>
                    <div id="ui-leave-list" class="space-y-3 max-h-56 overflow-y-auto no-scrollbar p-1">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div id="view-payroll" class="view-panel space-y-5">
                <div class="glass-card p-6 rounded-[2rem] space-y-4 shadow-sm">
                    <select id="payroll-month" onchange="loadPayrollDetail()" class="w-full bg-slate-50 text-slate-800 font-bold border-0 shadow-inner p-3 rounded-2xl text-sm outline-none select-arrow"></select>
                    <div class="bg-white border border-slate-100 rounded-2xl p-5 space-y-4 mt-2 shadow-sm">
                        <div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">åº•è–ª</span><span id="p-base" class="text-base font-black text-slate-800">NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">çé‡‘æ´¥è²¼</span><span id="p-bonus" class="text-base font-black text-emerald-600">NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">å¹´çµ‚çé‡‘</span><span id="p-yeb" class="text-base font-black text-emerald-600">NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">å‹å¥ä¿è‡ªä»˜</span><span id="p-ins" class="text-base font-black text-red-500">- NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-slate-500">äºŒä»£å¥ä¿</span><span id="p-2nd" class="text-base font-black text-red-500">- NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-xs font-bold text-slate-400">å‹é€€ææ’¥(å…¬å¸6%)</span><span id="p-pen" class="text-xs font-black text-slate-400">NT$ 0</span></div><div class="flex justify-between border-b border-slate-50 pb-2"><span class="text-sm font-bold text-amber-600">è«‹å‡æ‰£è–ª</span><span id="p-lvd" class="text-base font-black text-amber-600">- NT$ 0</span></div>
                        <div class="flex justify-between items-end pt-3 border-t border-slate-100"><span class="text-base font-black text-slate-800">ç¸½è¨ˆå¯¦é ˜</span><span id="p-net" class="text-3xl font-black text-sky-600 tracking-tight">NT$ 0</span></div>
                    </div>
                </div>
            </div>

            <div id="view-profile" class="view-panel space-y-5">
                <div class="glass-card p-6 rounded-[2rem] shadow-sm space-y-6">
                    <div class="flex flex-col space-y-4 border-b border-slate-100 pb-6" id="ui-profile-info">è¼‰å…¥ä¸­...</div>
                    <div class="pt-2"><h4 class="text-xs font-black tracking-widest text-slate-400 uppercase mb-3 ml-1">æ•¸ä½åˆç´„å­˜è­‰ä¸­å¿ƒ</h4><button onclick="openDoc()" class="w-full text-left bg-white p-4 rounded-2xl border border-slate-200 font-bold text-sm flex justify-between items-center shadow-sm active:scale-95 transition hover:bg-slate-50"><span class="flex items-center"><span class="mr-3 text-xl">ğŸ“„</span>æŸ¥çœ‹è˜åƒ±åˆç´„èˆ‡ä¿å¯†å”å®š</span><span class="text-slate-400">â”</span></button></div>
                </div>
            </div>
        </main>
    </div>

    <div id="alert-modal" class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm items-center justify-center p-5 z-[200]"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center transform transition-all scale-95 opacity-0" id="alert-box"><div id="alert-icon" class="text-6xl mb-4">âœ…</div><h3 id="alert-title" class="text-xl font-black text-slate-800 mb-2">æç¤º</h3><p id="alert-msg" class="text-sm text-slate-600 font-bold leading-relaxed mb-6">è¨Šæ¯å…§å®¹</p><div class="flex space-x-3" id="alert-btn-group"><button onclick="closeAlert(false)" id="alert-btn-cancel" class="hidden flex-1 bg-slate-100 text-slate-600 font-black py-3.5 rounded-xl shadow-sm active:scale-95 transition">ä¸è«‹å‡</button><button onclick="closeAlert(true)" id="alert-btn-confirm" class="w-full bg-slate-900 text-white font-black py-3.5 rounded-xl shadow-md active:scale-95 transition">ç¢ºèª</button></div></div></div>
    <div id="record-modal" class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm items-end justify-center z-[100]"><div class="bg-[#f8fafc] w-full max-w-md rounded-t-[2rem] p-6 h-[75vh] flex flex-col shadow-2xl md:max-w-480px md:mx-auto md:relative"><div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-200"><h3 class="font-black text-xl text-slate-800">è¿‘æœŸæ‰“å¡ç´€éŒ„</h3><button onclick="closeModal('record-modal')" class="bg-slate-200 px-4 py-2 rounded-full text-sm font-bold text-slate-600 hover:bg-slate-300 transition">âœ• é—œé–‰</button></div><div id="ui-records-list" class="overflow-y-auto space-y-3 flex-1 no-scrollbar pb-8 p-1">è¼‰å…¥ä¸­...</div></div></div>
    
    <div id="doc-modal" class="modal fixed inset-0 bg-slate-900/80 backdrop-blur-md items-center justify-center p-5 z-[100]"><div class="bg-white w-full max-w-md rounded-3xl p-6 relative flex flex-col shadow-2xl max-h-[85vh]"><h3 class="font-black text-lg border-b pb-3 mb-4 text-slate-800 text-center">ğŸ“œ è˜åƒ±åˆç´„èˆ‡æœå‹™å®ˆå‰‡</h3><div id="doc-content" class="overflow-y-auto pr-2 flex-1 mb-4 no-scrollbar text-[11px] text-slate-700 leading-relaxed text-left"></div><div class="bg-emerald-50 border border-emerald-100 p-3 rounded-2xl text-center shadow-inner"><p class="text-[10px] text-emerald-700 font-bold mb-1">âœ”ï¸ ç¶“æ•¸ä½ç°½ç« èªè­‰ï¼Œå…·å‚™æ³•å¾‹æ•ˆåŠ›</p><p id="doc-sig" class="font-black text-emerald-900 text-xs">ç°½ç½²äººï¼š--</p></div><button onclick="closeModal('doc-modal')" class="w-full mt-4 bg-slate-900 hover:bg-slate-800 text-white font-bold py-3.5 rounded-2xl text-sm transition shadow-md active:scale-95">å·²è©³é–±ä¸¦é—œé–‰</button></div></div>

    <script src="shared.js"></script>
    <script>
        window.calData = {}; 
        function updateClock() { const now = new Date(); const clockEl = document.getElementById('live-clock'); const dateEl = document.getElementById('live-date'); if (clockEl) clockEl.innerText = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }); if (dateEl) { const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']; const y = now.getFullYear(); const m = String(now.getMonth() + 1).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0'); dateEl.innerText = `${y}/${m}/${d} æ˜ŸæœŸ${days[now.getDay()]}`; } }
        setInterval(updateClock, 1000); updateClock(); 
        function syncCalendar() { const y1 = new Date().getFullYear(); const y2 = y1 + 1; Promise.all([ fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${y1}.json`).then(r => r.json()), fetch(`https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/${y2}.json`).then(r => r.json()).catch(() => []) ]).then(([r1, r2]) => { [...(r1||[]), ...(r2||[])].forEach(d => { window.calData[d.date] = d; }); if(document.getElementById('view-punch').classList.contains('active')) renderMiniCalendar(); }).catch(e => console.warn('è¡Œäº‹æ›†åŒæ­¥å»¶é²')); }

        async function bootHR() {
            const isAuth = await authGuard('hr');
            if(isAuth) {
                const u = window.currentUser; syncCalendar();
                document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1 h-1.5 w-1.5 bg-emerald-400 rounded-full"></span>å·²é€£ç·š';
                
                document.getElementById('dash-name').innerText = u.full_name; 
                document.getElementById('dash-role').innerText = u.job_title || 'å“¡å·¥';
                document.getElementById('ui-work-hours').innerText = `ğŸ•’ è¡¨å®šç­åˆ¥ï¼š${(u.work_start_time||'09:00').slice(0,5)} ~ ${(u.work_end_time||'18:00').slice(0,5)}`;
                if(u.job_title === 'æ¥­å‹™') document.getElementById('ui-role-icon').innerText = 'ğŸ›µ';
                
                const { data: lv, error: errLv } = await window._sb.rpc('fn_get_annual_leave_v2', { p_emp_id: u.id });
                if(errLv) { 
                    console.error("ç‰¹ä¼‘è¨ˆç®—ç•°å¸¸:", errLv); 
                    document.getElementById('dash-leave').innerHTML = '<span class="text-sm text-red-300">é€£ç·šä¸­</span>'; 
                } else if(lv) { 
                    let rHours = Math.round((lv.remain_hours % 8) * 10) / 10; 
                    document.getElementById('dash-leave').innerHTML = `${lv.remain_days}<span class="text-sm font-bold mx-1.5 text-amber-100/70 tracking-normal">å¤©</span>${rHours}<span class="text-sm font-bold ml-1.5 text-amber-100/70 tracking-normal">å°æ™‚</span>`; 
                }

                const { data: s, error: errS } = await window._sb.rpc('fn_get_emp_stats', { p_emp_id: u.id });
                if (errS) { console.error("çµ±è¨ˆè³‡æ–™ç•°å¸¸:", errS); }
                else if (s) { 
                    const fmt = v => Math.round(Number(v)*10)/10; 
                    document.getElementById('d-m-per').innerText = fmt(s.month.personal) + ' h';
                    document.getElementById('d-m-sic').innerText = fmt(s.month.sick) + ' h';
                    document.getElementById('d-m-lat').innerText = s.month.late + ' æ¬¡';
                    document.getElementById('d-y-per').innerText = fmt(s.year.personal) + ' h';
                    document.getElementById('d-y-sic').innerText = fmt(s.year.sick) + ' h';
                    document.getElementById('d-y-lat').innerText = s.year.late + ' æ¬¡';
                }
                
                const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                const { data: blt } = await window._sb.from('bulletin_board').select('*').gte('created_at', oneYearAgo.toISOString()).order('created_at', {ascending: false});
                if (blt && blt.length > 0) { document.getElementById('ui-bulletin').innerHTML = blt.map(b => `<div class="mb-2.5 border-b border-amber-100/50 pb-2 last:border-0 last:mb-0 last:pb-0 flex items-start"><span class="text-[10px] text-amber-600 font-black mr-2 mt-0.5 bg-amber-100 px-1.5 rounded">[${new Date(b.created_at).toISOString().split('T')[0]}]</span><div><span class="font-black text-slate-800 text-sm">${b.title}</span><span class="text-xs text-slate-600 font-medium leading-relaxed block mt-1">${b.content}</span></div></div>`).join(''); } else { document.getElementById('ui-bulletin').innerHTML = '<p class="text-xs text-slate-400 font-medium italic">ç›®å‰ç„¡æ­·å²å…¬å‘Š</p>'; }
            }
        }

        function openView(viewId, title) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); document.getElementById('view-' + viewId).classList.add('active');
            document.getElementById('header-title').innerText = title; document.getElementById('btn-back').classList.remove('hidden'); window.scrollTo({top: 0, behavior: 'smooth'});
            if(viewId === 'punch') renderMiniCalendar(); if(viewId === 'leave') loadLeaveHistory(); if(viewId === 'payroll') loadPayrollMonths(); if(viewId === 'profile') renderProfileUI();
        }
        function backToDashboard() { document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); document.getElementById('view-dashboard').classList.add('active'); document.getElementById('header-title').innerText = 'å“¡å·¥å¤§å»³'; document.getElementById('btn-back').classList.add('hidden'); bootHR(); }

        async function punch(type) {
            document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1 h-1.5 w-1.5 bg-amber-400 rounded-full"></span>é©—è­‰ä¸­';
            const today = new Date(); const dStr = today.getFullYear() + String(today.getMonth()+1).padStart(2,'0') + String(today.getDate()).padStart(2,'0'); const dayInfo = window.calData[dStr];
            let isOffDay = dayInfo ? dayInfo.isHoliday : (today.getDay() === 0 || today.getDay() === 6);
            if (isOffDay) {
                const { data: otAll } = await window._sb.from('leave_requests').select('start_time, end_time').eq('employee_id', window.currentUser.id).eq('leave_type', 'ç·Šæ€¥åŠ ç­');
                let hasOvertime = otAll && otAll.some(ot => ot.start_time.includes(today.toLocaleDateString('en-CA')));
                if (!hasOvertime) { document.getElementById('user-status').innerHTML = '<span class="mr-1 h-1.5 w-1.5 bg-emerald-400 rounded-full"></span>å·²é€£ç·š'; if (type === 'IN') showAlert('ğŸ›‘ å‡æ—¥æ‰“å¡é˜»æ“‹', `ä»Šæ—¥ç‚ºä¼‘å‡æ—¥ï¼Œç„¡æ³•ç›´æ¥æ‰“å¡ã€‚<br><br>è«‹å…ˆè‡³ã€Œè«‹å‡å€ã€é€å‡ºã€ğŸš¨ç·Šæ€¥åŠ ç­å–®ã€‘ã€‚`, 'error'); else showAlert('ğŸ›‘ éŒ¯èª¤', `ç³»çµ±æŸ¥ç„¡åŠ ç­ç´€éŒ„ï¼Œç„¡æ³•ä¸‹ç­æ‰“å¡ã€‚`, 'error'); return; }
            }
            document.getElementById('user-status').innerHTML = '<span class="animate-pulse mr-1 h-1.5 w-1.5 bg-amber-400 rounded-full"></span>å®šä½ä¸­';
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { data, error } = await window._sb.rpc('fn_process_punch', { p_emp_id: window.currentUser.id, p_type: type, p_lat: pos.coords.latitude, p_lng: pos.coords.longitude, p_is_offday: isOffDay });
                document.getElementById('user-status').innerHTML = '<span class="mr-1 h-1.5 w-1.5 bg-emerald-400 rounded-full"></span>å·²é€£ç·š';
                if (error) { showAlert('âš ï¸ ç³»çµ±éŒ¯èª¤', error.message, 'error'); } 
                else {
                    if(data.status === 'block_missing_out') showAlert('ğŸ›‘ ç³»çµ±æ””æˆª', data.message, 'error');
                    else if(data.status === 'error') showAlert('âŒ å¤±æ•—', data.message, 'error');
                    else if(data.status === 'late' || (data.status === 'warning' && data.message.includes('æ—©é€€'))) showAlert(`âš ï¸ æ‰“å¡ç•°å¸¸`, data.message + '<br><br><span class="text-xs text-amber-700 bg-amber-50 p-2 rounded-lg block mt-2 border border-amber-200 text-left">ğŸ’¡ ç³»çµ±å¯è‡ªå‹•è¨ˆç®—ç¼ºå¤±æ™‚æ•¸ï¼Œæ˜¯å¦ç«‹å³å¡«å¯«ç‰¹ä¼‘å–®æŠµæ‰£ï¼Œä»¥ç¶­æŒå…¨è–ªï¼Ÿ</span>', 'warning', () => { autoFillLeaveForm(type); });
                    else if (data.status === 'warning') showAlert(`âš ï¸ ç‹€æ…‹ç•°å¸¸`, data.message, 'warning');
                    else showAlert(`âœ… æ‰“å¡æˆåŠŸ`, data.message, 'success');
                }
            }, () => { document.getElementById('user-status').innerHTML = '<span class="mr-1 h-1.5 w-1.5 bg-red-400 rounded-full"></span>å®šä½å¤±æ•—'; showAlert('ğŸ“ å®šä½æœªé–‹', 'è«‹é–‹å•Ÿæ‰‹æ©Ÿ GPS æ¬Šé™ï¼', 'error'); }, { enableHighAccuracy: true });
        }

        let alertCallback = null;
        function showAlert(title, msg, type, callback = null) { alertCallback = callback; const box = document.getElementById('alert-box'); document.getElementById('alert-title').innerText = title; document.getElementById('alert-msg').innerHTML = msg; document.getElementById('alert-icon').innerText = type==='error'?'âŒ':(type==='warning'?'âš ï¸':'ğŸ‰'); document.getElementById('alert-title').className = `text-xl font-black mb-2 ${type==='error'?'text-red-600':(type==='warning'?'text-amber-600':'text-emerald-600')}`; if(callback) { document.getElementById('alert-btn-cancel').classList.remove('hidden'); document.getElementById('alert-btn-confirm').innerText = 'å‰å¾€å¡«å–®'; document.getElementById('alert-btn-confirm').className = 'flex-1 bg-amber-500 text-white font-black py-3.5 rounded-xl active:scale-95 transition'; } else { document.getElementById('alert-btn-cancel').classList.add('hidden'); document.getElementById('alert-btn-confirm').innerText = 'ç¢ºèª'; document.getElementById('alert-btn-confirm').className = 'w-full bg-slate-900 text-white font-black py-3.5 rounded-xl active:scale-95 transition'; } document.getElementById('alert-modal').classList.add('active'); setTimeout(() => { box.classList.remove('scale-95', 'opacity-0'); box.classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeAlert(isConfirm = true) { const box = document.getElementById('alert-box'); box.classList.remove('scale-100', 'opacity-100'); box.classList.add('scale-95', 'opacity-0'); setTimeout(() => { document.getElementById('alert-modal').classList.remove('active'); if(isConfirm && alertCallback) alertCallback(); alertCallback = null; }, 200); }
        function openModal(id) { document.getElementById(id).classList.add('active'); } function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function renderMiniCalendar() { if(!window.calData) return; const startDay = new Date(); startDay.setDate(startDay.getDate() - startDay.getDay() - 7); let html = '<div class="grid grid-cols-7 gap-1 mb-2">'; ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => html += `<div class="text-center text-[10px] font-bold text-slate-400">${d}</div>`); html += '</div><div class="grid grid-cols-7 gap-1">'; for(let i=0; i<28; i++) { let d = new Date(startDay); d.setDate(startDay.getDate() + i); let dStr = d.getFullYear() + String(d.getMonth()+1).padStart(2,'0') + String(d.getDate()).padStart(2,'0'); let isToday = dStr === new Date().getFullYear() + String(new Date().getMonth()+1).padStart(2,'0') + String(new Date().getDate()).padStart(2,'0'); let isWeekend = d.getDay()===0||d.getDay()===6; let info = window.calData[dStr]; let isHol = info?info.isHoliday:isWeekend; let isMk = info&&!isHol&&isWeekend; let lbl = info?info.description:(isHol?'å‡æ—¥':''); if(lbl.includes('æ˜ŸæœŸ'))lbl='å‡æ—¥'; html += `<div class="h-11 flex flex-col items-center justify-start pt-1.5 rounded-lg border ${isToday?'bg-sky-50 border-sky-300 ring-1 ring-sky-200 shadow-sm':'bg-white border-slate-100'} overflow-hidden"><span class="text-[13px] font-black ${isHol?'text-red-500':(isMk?'text-amber-600':'text-slate-800')} leading-none">${d.getDate()}</span>${isHol?`<span class="w-full text-center text-[10px] transform scale-[0.75] origin-top text-red-500 font-bold truncate mt-0.5">${lbl.slice(0,2)}</span>`:(isMk?`<span class="w-full text-center text-[10px] transform scale-[0.75] origin-top text-amber-600 font-bold truncate mt-0.5">è£œç­</span>`:`<div class="w-1 h-1 rounded-full mt-1.5 bg-slate-200"></div>`)}</div>`; } html += '</div>'; document.getElementById('ui-mini-calendar').innerHTML = html; }
        
        async function loadPunchHistory() { document.getElementById('ui-records-list').innerHTML = 'è¼‰å…¥ä¸­...'; openModal('record-modal'); const { data } = await window._sb.from('attendance_logs').select('punch_type, punch_time, note, lat, lng, branch_locations(branch_name)').eq('employee_id', window.currentUser.id).order('punch_time', {ascending: false}).limit(30); document.getElementById('ui-records-list').innerHTML = data.length ? data.map(l => `<div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm"><div><span class="text-xs font-black bg-slate-100 px-2 py-1 rounded-md border border-slate-200">${l.punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span> <span class="text-sm font-bold text-slate-700 ml-2">${new Date(l.punch_time).toLocaleString('zh-TW').slice(5,-3)}</span><p class="text-xs text-slate-400 font-bold mt-1.5 flex items-center"><span class="mr-1">ğŸ </span>${l.branch_locations?.branch_name||(l.note.includes('[è£œç™»')?'æ‰‹å‹•è£œç™»':'å¤–å‹¤å®šä½')} ${(l.lat&&l.lng)?`<a href="https://maps.google.com/?q=${l.lat},${l.lng}" target="_blank" class="text-sky-500 hover:text-sky-700 underline font-black ml-2 text-[10px]">ğŸ“åœ°åœ–</a>`:''}</p></div><span class="text-[10px] font-black px-2 py-1 rounded-full ${l.note.includes('æ­£å¸¸')?'text-emerald-600 bg-emerald-50':'text-amber-600 bg-amber-50'}">${l.note}</span></div>`).join('') : '<div class="text-center text-sm text-slate-400 font-bold py-10">ç›®å‰ç„¡æ‰“å¡ç´€éŒ„</div>'; }

        function autoFillLeaveForm(pType) { openView('leave', 'è«‹å‡è£œç™»åŠ ç­ç”³è«‹'); const now = new Date(); const st = (window.currentUser.work_start_time||'09:00').slice(0,5); const et = (window.currentUser.work_end_time||'18:00').slice(0,5); const dPx = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}T`; const nTx = String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0'); document.getElementById('leave-type-select').value = 'ç‰¹ä¼‘'; checkLeaveType(); document.querySelector('input[name="start_time"]').value = pType==='IN'?dPx+st:dPx+nTx; document.querySelector('input[name="end_time"]').value = pType==='IN'?dPx+nTx:dPx+et; }
        
        async function checkLeaveType() {
            const t = document.getElementById('leave-type-select').value; const sp = document.getElementById('salary-protection-ui'); const rUi = document.getElementById('retro-punch-ui'); const nEu = document.getElementById('normal-end-ui'); const bx = document.getElementById('box-start-time'); const lbl = document.getElementById('label-start'); const btn = document.getElementById('btn-leave');
            if (t === 'å¿˜è¨˜æ‰“å¡(è£œç™»)') {
                sp.style.display = 'none'; nEu.style.display = 'none'; rUi.style.display = 'block'; bx.className = 'col-span-2'; lbl.innerText = 'è£œç™»çœŸå¯¦æ™‚é–“';
                const { data: cnt } = await window._sb.rpc('fn_check_retro_limit', { p_emp_id: window.currentUser.id });
                if(cnt >= 3) { btn.disabled = true; btn.innerText = 'æœ¬æœˆè£œç™»é”ä¸Šé™ (3æ¬¡)'; btn.className = 'w-full bg-slate-400 text-white font-black py-4 rounded-2xl shadow-sm mt-4 text-sm tracking-wider cursor-not-allowed'; showAlert('ğŸ›‘ è£œç™»æ¬¡æ•¸é”æ¨™', 'æ‚¨æœ¬æœˆå¿˜è¨˜æ‰“å¡(è£œç™»)æ¬¡æ•¸å·²é” 3 æ¬¡ä¸Šé™ï¼Œç„¡æ³•å†è‡ªè¡Œç”³è«‹ï¼Œè«‹æ´½ä¸»ç®¡è™•ç†ã€‚', 'error'); } 
                else { btn.disabled = false; btn.innerText = `é€å‡ºè£œç™»ç”³è«‹ (æœ¬æœˆ ${cnt+1}/3)`; btn.className = 'w-full bg-gradient-to-r from-sky-500 to-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg mt-4 active:scale-95 transition text-sm tracking-wider'; }
            } else {
                rUi.style.display = 'none'; nEu.style.display = 'block'; bx.className = 'col-span-1'; lbl.innerText = 'èµ·å§‹æ™‚é–“'; btn.disabled = false; btn.innerText = 'é€å‡ºç”³è«‹å–®'; btn.className = 'w-full bg-gradient-to-r from-amber-400 to-orange-500 text-white font-black py-4 rounded-2xl shadow-lg mt-4 active:scale-95 transition text-sm tracking-wider';
                if(t === 'é¢±é¢¨å‡') { document.getElementById('sp-text').innerHTML = '<p class="text-sm font-black text-emerald-900 mb-0.5">ğŸŒªï¸ æ³•å®šé¢±é¢¨å‡</p><p class="text-[11px] font-bold text-emerald-600">ä¾æ³•ä¸æ”¯è–ªï¼Œäº¦ä¸å½±éŸ¿å…¨å‹¤</p>'; sp.className = 'flex items-center justify-between p-4 bg-emerald-50/80 rounded-2xl border border-emerald-200 transition-all shadow-sm'; document.getElementById('sp-toggle').style.display = 'none'; sp.style.display = 'flex'; } 
                else if (t === 'ç·Šæ€¥åŠ ç­') { document.getElementById('sp-text').innerHTML = '<p class="text-sm font-black text-red-900 mb-0.5">ğŸš¨ å‡æ—¥å‡ºå‹¤ç”³è«‹</p><p class="text-[11px] font-bold text-red-600">è«‹ç²¾ç¢ºå¡«å¯«é è¨ˆå‡ºå‹¤ä¹‹èµ·è¨–æ™‚é–“</p>'; sp.className = 'flex items-center justify-between p-4 bg-red-50/80 rounded-2xl border border-red-200 transition-all shadow-sm'; document.getElementById('sp-toggle').style.display = 'none'; sp.style.display = 'flex'; }
                else { document.getElementById('sp-text').innerHTML = '<p class="text-sm font-black text-sky-900 mb-0.5">è–ªè³‡ä¿å…¨</p><p class="text-xs font-bold text-sky-600">åŒæ„æ‰£ç‰¹ä¼‘ä»¥ç¶­æŒå…¨è–ª</p>'; sp.className = 'flex items-center justify-between p-4 bg-sky-50/80 rounded-2xl border border-sky-100 transition-all shadow-sm'; document.getElementById('sp-toggle').style.display = 'block'; sp.style.display = 'flex'; }
            }
        }
        
        async function submitLeave(e) {
            e.preventDefault(); const fd = new FormData(e.target); const isRet = fd.get('leave_type') === 'å¿˜è¨˜æ‰“å¡(è£œç™»)'; 
            
            // ğŸŒŸ é˜²å‘†ï¼šå‡æ—¥æ™‚é˜»æ“‹ç”³è«‹ç‰¹ä¼‘èˆ‡è£œç™»
            const stVal = fd.get('start_time');
            const startDateStr = stVal.split('T')[0];
            const parts = startDateStr.split('-');
            const dStr = parts[0] + parts[1] + parts[2];
            const dObj = new Date(startDateStr + 'T00:00:00+08:00');
            const dayInfo = window.calData[dStr];
            let isOffDay = dayInfo ? dayInfo.isHoliday : (dObj.getDay() === 0 || dObj.getDay() === 6);
            
            if (isOffDay && (fd.get('leave_type') === 'ç‰¹ä¼‘' || isRet)) {
                showAlert('ğŸ›‘ å‡æ—¥é˜²å‘†é˜»æ“‹', 'å‡æ—¥æ™‚ç„¡æ³•ç”³è«‹ã€Œç‰¹ä¼‘ã€èˆ‡ã€Œå¿˜è¨˜æ‰“å¡(è£œç™»)ã€ã€‚<br><br>è‹¥ç‚ºå‡æ—¥å‡ºå‹¤ï¼Œè«‹é¸æ“‡ã€å‡æ—¥ç·Šæ€¥åŠ ç­ã€‘ï¼', 'error');
                return;
            }

            const st = stVal + ':00+08:00'; let et = isRet ? st : fd.get('end_time') + ':00+08:00';
            const payload = { employee_id: window.currentUser.id, leave_type: fd.get('leave_type'), start_time: st, end_time: et, salary_protection: (fd.get('leave_type')==='é¢±é¢¨å‡'||isRet)?false:(fd.get('salary_protection')==='on'), target_punch_type: isRet?fd.get('target_punch_type'):null };
            document.getElementById('btn-leave').innerText = 'ç”³è«‹é€å‡ºä¸­...';
            const { data, error } = await window._sb.from('leave_requests').insert([payload]).select();
            if(!error) { await window._sb.functions.invoke('line-webhook', { body: { action: 'notify_leave', name: window.currentUser.full_name, type: payload.leave_type, start: st.slice(0,16).replace('T',' '), end: isRet?'':et.slice(0,16).replace('T',' ') }}); 
                if(payload.leave_type === 'ç·Šæ€¥åŠ ç­') showAlert('âœ… åŠ ç­å–®å·²é€å‡º', 'ä¸»ç®¡æ ¸å‡†å¾Œç”Ÿæ•ˆ', 'success'); else if(isRet) showAlert('âœ… è£œç™»å–®å·²é€å‡º', 'ä¸»ç®¡æ ¸å‡†å¾Œè‡ªå‹•è£œå…¥', 'success'); else showAlert('âœ… ç”³è«‹å·²é€å‡º', 'ä¸»ç®¡æ ¸å‡†å¾Œç”Ÿæ•ˆã€‚', 'success'); 
                e.target.reset(); checkLeaveType(); loadLeaveHistory(); } 
            else { showAlert('âŒ é€å‡ºå¤±æ•—', error.message, 'error'); } document.getElementById('btn-leave').innerText = 'é€å‡ºç”³è«‹å–®';
        }

        async function loadLeaveHistory() {
            const { data: s, error: errS } = await window._sb.rpc('fn_get_emp_stats', { p_emp_id: window.currentUser.id });
            if (errS) { console.error("çµ±è¨ˆè³‡æ–™ç•°å¸¸:", errS); } else if (s) { 
                const fmt = v => Math.round(Number(v)*10)/10; 
                document.getElementById('st-m-ann').innerText = fmt(s.month.annual) + ' h'; document.getElementById('st-m-per').innerText = fmt(s.month.personal) + ' h'; document.getElementById('st-m-sic').innerText = fmt(s.month.sick) + ' h'; document.getElementById('st-m-lat').innerText = s.month.late + ' æ¬¡'; document.getElementById('st-y-ann').innerText = fmt(s.year.annual) + ' h'; document.getElementById('st-y-per').innerText = fmt(s.year.personal) + ' h'; document.getElementById('st-y-sic').innerText = fmt(s.year.sick) + ' h'; document.getElementById('st-y-lat').innerText = s.year.late + ' æ¬¡'; 
            }

            // ğŸŒŸ ä¾ç…§æœˆä»½é¸æ“‡å™¨éæ¿¾ç´€éŒ„
            const qMonth = document.getElementById('leave-query-month') ? document.getElementById('leave-query-month').value : '';
            let query = window._sb.from('leave_requests').select('*').eq('employee_id', window.currentUser.id).order('created_at', {ascending: false});
            if (qMonth) { query = query.gte('start_time', qMonth + '-01T00:00:00+08:00').lte('start_time', qMonth + '-31T23:59:59+08:00'); } 
            else { query = query.limit(20); }

            const { data } = await query;
            document.getElementById('ui-leave-list').innerHTML = data && data.length ? data.map(l => {
                let badge = l.status === 'æ ¸å‡†' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : (l.status === 'æ ¸é§' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-slate-100 text-slate-600 border-slate-200');
                let t1 = new Date(l.start_time).toLocaleString('zh-TW').slice(5,-3); let t2 = new Date(l.end_time).toLocaleString('zh-TW').slice(5,-3);
                let spTag = l.leave_type === 'é¢±é¢¨å‡' ? '<span class="text-[10px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded ml-2 font-bold">ä¸æ”¯è–ª</span>' : (l.salary_protection ? '<span class="text-[10px] text-sky-600 bg-sky-50 px-1.5 py-0.5 rounded ml-2 font-bold">ä¿è–ª</span>' : '');
                if(l.leave_type === 'å¿˜è¨˜æ‰“å¡(è£œç™»)') { spTag = `<span class="text-[10px] text-amber-700 bg-amber-100 px-1.5 py-0.5 rounded ml-2 font-bold">è£œ${l.target_punch_type==='IN'?'ä¸Šç­':'ä¸‹ç­'}</span>`; t2 = ''; }
                return `<div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><div class="flex justify-between items-center mb-2"><span class="font-black text-sm text-slate-800 flex items-center">${l.leave_type.replace('(è£œç™»)','')} ${spTag}</span><span class="text-[10px] font-black px-2.5 py-1 rounded-full border ${badge}">${l.status}</span></div><p class="text-xs font-bold text-slate-500 flex items-center"><span class="mr-1.5">ğŸ•’</span>${t1} ${t2 ? '~ '+t2 : ''}</p></div>`;
            }).join('') : '<div class="text-center text-sm text-slate-400 font-bold py-8">æŸ¥ç„¡ç”³è«‹ç´€éŒ„</div>';
        }

        async function loadPayrollMonths() { const s = document.getElementById('payroll-month'); const { data } = await window._sb.from('payroll_records').select('pay_month').eq('employee_id', window.currentUser.id).order('pay_month', {ascending: false}); if(!data||!data.length){ s.innerHTML='<option>å°šç„¡è–ªè³‡ç´€éŒ„</option>'; s.disabled=true; return;} s.disabled=false; s.innerHTML = data.map(m=>`<option value="${m.pay_month}">${m.pay_month} è–ªè³‡å–®</option>`).join(''); loadPayrollDetail(); }
        async function loadPayrollDetail() { const m = document.getElementById('payroll-month').value; const { data } = await window._sb.from('payroll_records').select('*').eq('employee_id', window.currentUser.id).eq('pay_month', m).single(); if(data) { document.getElementById('p-base').innerText = `NT$ ${data.base_pay.toLocaleString()}`; document.getElementById('p-bonus').innerText = `NT$ ${data.bonus.toLocaleString()}`; document.getElementById('p-yeb').innerText = `NT$ ${data.year_end_bonus.toLocaleString()}`; document.getElementById('p-ins').innerText = `- NT$ ${data.insurance_deduction.toLocaleString()}`; document.getElementById('p-2nd').innerText = `- NT$ ${data.second_gen_health.toLocaleString()}`; document.getElementById('p-pen').innerText = `NT$ ${data.labor_pension.toLocaleString()}`; document.getElementById('p-lvd').innerText = `- NT$ ${(data.leave_deduction||0).toLocaleString()}`; document.getElementById('p-net').innerText = `NT$ ${data.total_net_pay.toLocaleString()}`; } }

        function renderProfileUI() {
            const u = window.currentUser;
            document.getElementById('ui-profile-info').innerHTML = `<div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ†”</span><span class="text-slate-700 font-bold text-sm">èº«åˆ†è­‰ï¼š${u.id_number}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ·ï¸</span><span class="text-slate-700 font-bold text-sm">å“¡å·¥ç·¨è™Ÿï¼š${u.employee_no||'æœªè¨­å®š'}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ“§</span><span class="text-slate-700 font-bold text-sm">${u.email}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ“</span><span class="text-slate-700 font-bold text-sm">${u.phone}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg text-sky-600">ğŸ‘”</span><span class="text-sky-700 font-black text-sm bg-sky-50 px-2 py-0.5 rounded-md border border-sky-100">${u.job_title||'æœªæŒ‡æ´¾'}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ“</span><span class="text-slate-700 font-bold text-sm">æ“šé»ï¼š${u.branch_locations?.branch_name||'æœªç¶å®š'}</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg">ğŸ‘¥</span><span class="text-slate-700 font-bold text-sm">çœ·å±¬åŠ ä¿ï¼š${u.dependents_count || 0} äºº</span></div><div class="flex items-center space-x-3"><span class="w-6 text-center text-lg text-amber-600">ğŸ“…</span><span class="text-slate-700 font-bold text-sm">å…¥è·æ—¥ï¼š${u.onboarding_date}</span></div><div class="flex items-center space-x-3 border-t border-slate-50 pt-3 mt-1"><span class="w-6 text-center text-lg mt-0.5">â°</span><div class="text-blue-700 font-black text-sm bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 w-full text-center tracking-wider">${(u.work_start_time||'09:00').slice(0,5)} ä¸Šç­ <span class="mx-2 text-blue-200">|</span> ${(u.work_end_time||'18:00').slice(0,5)} ä¸‹ç­</div></div><div class="flex items-start space-x-3 mt-2 pt-3 border-t border-slate-50"><span class="w-6 text-center text-lg mt-0.5">ğŸ¦</span><div class="text-slate-800 font-black text-sm leading-tight">${u.bank_name} (${u.bank_code})<br><span class="text-xs font-bold text-slate-500 mt-1 block">${u.bank_user_name} / ${u.bank_account}</span></div></div>`;
        }
        
        function openDoc() { 
            document.getElementById('doc-content').innerHTML = `
                <p class="font-black text-slate-900 text-xs mb-1 mt-2">ç¬¬ä¸€ç« ï¼šè·ä½èˆ‡å·¥ä½œå…§å®¹</p>
                <ul class="list-decimal pl-4 space-y-1 mb-3"><li>è·å‹™èªªæ˜ï¼šä¹™æ–¹åŒæ„æ“”ä»»ç”²æ–¹æ‰€æŒ‡æ´¾ä¹‹è·å‹™ï¼Œä¸¦å”åŠ©ç”²æ–¹å„é …æ¥­å‹™æ¨å‹•ã€‚</li><li>å·¥ä½œå€åŸŸï¼šç”²æ–¹å¾—è¦–ç‡Ÿé‹éœ€æ±‚ï¼ŒæŒ‡æ´¾ä¹™æ–¹æ–¼å¯¦é«”æ“šé»æˆ–æŒ‡å®šåˆ†å€åŸ·è¡Œè·å‹™ã€‚</li></ul>
                <p class="font-black text-slate-900 text-xs mb-1">ç¬¬äºŒç« ï¼šè€ƒå‹¤ç®¡ç†èˆ‡æ‰“å¡è¦ç¯„</p>
                <ul class="list-decimal pl-4 space-y-1 mb-3">
                    <li>è€ƒå‹¤ä¾æ“šï¼šä¹™æ–¹åŒæ„ä»¥ App ä¹‹ GPS å®šä½æ‰“å¡ï¼Œä½œç‚ºå‡ºå‹¤ç´€éŒ„ä¹‹å”¯ä¸€åˆæ³•ä¾æ“šã€‚</li>
                    <li>æ‰“å¡ç¯„åœï¼šç³»çµ±è‡ªå‹•åµæ¸¬ä¸¦è¨˜éŒ„å“¡å·¥æ‰€åœ¨åº§æ¨™èˆ‡æ“šé»ï¼Œç„¡è·é›¢é™åˆ¶ã€‚</li>
                    <li>é²åˆ°è™•ç†ï¼šæ¯æœˆçµ¦äºˆ 3 æ¬¡é²åˆ°å¯¬é™ï¼Œæ¯æ¬¡æœ€é«˜ 10 åˆ†é˜ã€‚è‹¥è¶…éå¯¬é™ï¼Œè©²ç¼ºå¤±æ™‚æ•¸å°‡ä¾æ¯”ä¾‹ä¸è¨ˆè–ªã€‚è‹¥ä¹™æ–¹æ¬²ç¶­æŒå…¨è–ªï¼Œæ‡‰ä¸»å‹•ç”³è«‹ä»¥å‰©é¤˜ç‰¹ä¼‘æŠµæ‰£ã€‚</li>
                    <li>å¿˜è¨˜æ‰“å¡èˆ‡è£œç™»ï¼šè‹¥å¿˜è¨˜æ‰“å¡ï¼Œæ‡‰æ–¼ç³»çµ±æå‡ºã€Œè£œç™»ç”³è«‹ã€ã€‚æ¯äººæ¯æœˆè£œç™»ä¸Šé™ç‚º 3 æ¬¡ï¼Œè¶…éæ¬¡æ•¸å°‡ç„¡æ³•ç”³è«‹ï¼Œè©²ç•°å¸¸æ™‚æ®µä»¥æ› è·æˆ–äº‹å‡è«–è™•ã€‚è‹¥å‰ä¸€æ—¥æ¼æ‰“ä¸‹ç­å¡ï¼Œé ˆå…ˆå®Œæˆè£œç™»ç”³è«‹æ–¹å¯é€²è¡Œæ¬¡æ—¥æ‰“å¡ã€‚</li>
                </ul>
                <p class="font-black text-slate-900 text-xs mb-1">ç¬¬ä¸‰ç« ï¼šè«‹å‡èˆ‡ä¼‘å‡è¦ç¯„</p>
                <ul class="list-decimal pl-4 space-y-1 mb-3"><li>è«‹å‡ç¨‹åºï¼šä¸€èˆ¬è«‹å‡æ‡‰è‡³å°‘æå‰ä¸‰æ—¥æ–¼ç·šä¸Šç”³è«‹ï¼›çªç™¼ç‹€æ³æ‡‰ç¬¬ä¸€æ™‚é–“å‘ŠçŸ¥ä¸¦è£œå–®ã€‚</li><li>é¢±é¢¨å‡åŸå‰‡ï¼šä¾æ”¿åºœç™¼å¸ƒï¼Œéµå¾ªã€Œæ”¾å‡ä½†è©²æ—¥ä¸æ”¯è–ªã€åŸå‰‡ï¼Œä¸æ‰£ç‰¹ä¼‘äº¦ä¸å½±éŸ¿å…¨å‹¤ã€‚</li><li>åŠ ç­ç”³è«‹ï¼šä¾‹å‡æ—¥å‡ºå‹¤é ˆæ–¼ç³»çµ±å¡«å¯«ã€Œèµ·è¨–æ™‚é–“ã€é€å‡ºåŠ ç­å–®ã€‚</li></ul>
                <p class="font-black text-slate-900 text-xs mb-1">ç¬¬å››ç« ï¼šä¿å¯†å”å®š (NDA) èˆ‡æ™ºæ…§è²¡ç”¢æ¬Š</p>
                <ul class="list-decimal pl-4 space-y-1 mb-3"><li>ä¿å¯†ç¾©å‹™ï¼šä¹™æ–¹å°ç”²æ–¹ä¹‹å®¢æˆ¶æœªå…¬é–‹ç‡Ÿæ¥­ç§˜å¯†ï¼Œè² çµ•å°ä¿å¯†ç¾©å‹™ã€‚æœªç¶“åŒæ„çµ•ä¸æ´©æ¼ã€‚</li><li>æ­¸é‚„ç¾©å‹™ï¼šé›¢è·æ™‚ï¼Œæ‡‰å°‡æ‰€æœ‰éš¸å±¬å…¬å¸ä¹‹è²¡ç”¢ã€æ©Ÿå¯†è³‡è¨Šã€è¨­å‚™ã€å¯¦é«”èˆ‡æ•¸ä½æª”æ¡ˆå…¨æ•¸æ­¸é‚„ï¼Œçµ•å°ä¸å¾—ç§è‡ªæ‹·è²æˆ–ä¿ç•™ã€‚</li><li>é•ç´„ç½°å‰‡ï¼šä¹™æ–¹è‹¥é•åä¿å¯†ç¾©å‹™ï¼ŒåŒæ„ç„¡æ¢ä»¶è² æ“”æ–°å°å¹£å£¹ä½°è¬å…ƒæ•´ä¹‹æ‡²ç½°æ€§é•ç´„é‡‘ã€‚</li></ul>
            `; 
            document.getElementById('doc-sig').innerText = `ç°½ç½²äººï¼š${window.currentUser.full_name}\næ™‚é–“ï¼š${new Date(window.currentUser.nda_signed_at).toLocaleString('zh-TW')}`; 
            openModal('doc-modal'); 
        }

        window.onload = bootHR;
    </script>
</body>
</html>
